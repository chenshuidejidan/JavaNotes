# é›¶ã€å…¥é—¨

1. ++iæ˜¯éæ³•çš„ï¼Œi++æ˜¯è¯­å¥ï¼Œä¸èƒ½ä½¿ç”¨a=i++çš„è¡¨è¾¾
2. :=å£°æ˜å˜é‡åªèƒ½åœ¨å‡½æ•°å†…éƒ¨ï¼Œå¯¹äºåŒ…çš„å˜é‡å¿…é¡»ä½¿ç”¨varçš„å½¢å¼
3. printfçš„æ‰“å°æ ¼å¼

```go
%d          åè¿›åˆ¶æ•´æ•°
%x, %o, %b  åå…­è¿›åˆ¶ï¼Œå…«è¿›åˆ¶ï¼ŒäºŒè¿›åˆ¶æ•´æ•°ã€‚
%f, %g, %e  æµ®ç‚¹æ•°ï¼š 3.141593 3.141592653589793 3.141593e+00
%t          å¸ƒå°”ï¼štrueæˆ–false
%c          å­—ç¬¦ï¼ˆruneï¼‰ (Unicodeç ç‚¹)
%s          å­—ç¬¦ä¸²
%p					æ‰“å°åœ°å€
%q          å¸¦åŒå¼•å·çš„å­—ç¬¦ä¸²"abc"æˆ–å¸¦å•å¼•å·çš„å­—ç¬¦'c'
%v          å˜é‡çš„è‡ªç„¶å½¢å¼ï¼ˆnatural formatï¼‰ï¼Œä¹Ÿå°±æ˜¯goè¯­è¨€çš„å½¢å¼è¾“å‡º
%+v 				å…ˆè¾“å‡ºå­—æ®µç±»å‹ï¼Œå†è¾“å‡ºè¯¥å­—æ®µçš„å€¼
%#v 				å…ˆè¾“å‡ºç»“æ„ä½“åå­—å€¼ï¼Œå†è¾“å‡ºç»“æ„ä½“ï¼ˆå­—æ®µç±»å‹+å­—æ®µçš„å€¼ï¼‰
%T          å˜é‡çš„ç±»å‹
%%          å­—é¢ä¸Šçš„ç™¾åˆ†å·æ ‡å¿—ï¼ˆæ— æ“ä½œæ•°ï¼‰
```

![å†…å­˜æ¨¡å‹](./picture/goè¯­è¨€è¦ç‚¹/å†…å­˜æ¨¡å‹.png)



# ä¸€ã€ç¨‹åºç»“æ„

## 1. å‘½å

å‡½æ•°å†…éƒ¨å®šä¹‰çš„å˜é‡åªåœ¨å‡½æ•°å†…éƒ¨æœ‰æ•ˆ

å‡½æ•°å¤–éƒ¨å®šä¹‰çš„å˜é‡åœ¨æ•´ä¸ªåŒ…ä¸­éƒ½æœ‰æ•ˆï¼Œå˜é‡åçš„å¼€å¤´å­—æ¯å¤§å°å†™å†³å®šäº†å˜é‡åœ¨åŒ…å¤–çš„å¯è§æ€§ï¼šå¯¹äºé¦–å­—æ¯å¤§å†™çš„å˜é‡åï¼Œå®ƒå°†æ˜¯**å¯¼å‡ºçš„**ï¼Œå³å¯ä»¥è¢«å…¶ä»–åŒ…è®¿é—®åˆ°ï¼ˆå‡½æ•°ååŒç†ï¼‰ï¼Œè€Œå¯¹äºé¦–å­—æ¯å°å†™çš„å˜é‡ï¼Œåªèƒ½åœ¨åŒ…å†…è¢«è®¿é—®



## 2. å£°æ˜

å››ç§ç±»å‹çš„ç”Ÿå‘½ varã€constã€typeã€func



## 3. å˜é‡



å·¦å€¼ä¸å³å€¼

ç­‰å·å·¦è¾¹çš„å˜é‡ï¼Œä»£è¡¨å˜é‡æ‰€åœ¨çš„å†…å­˜ç©ºé—´

ç­‰å·å³è¾¹çš„å˜é‡ï¼Œä»£è¡¨å˜é‡å†…å­˜ç©ºé—´å­˜å‚¨çš„æ•°æ®(å€¼)

```go
var a,b int
a = 1   //aå·¦å€¼ï¼Œä»£è¡¨çš„æ˜¯aæ‰€åœ¨çš„å†…å­˜ç©ºé—´
b = a   //aå³å€¼ï¼Œä»£è¡¨çš„æ˜¯aæ‰€åœ¨å†…å­˜ç©ºé—´æ‰€å­˜å‚¨çš„æ•°æ®ï¼š1
```



**å…ˆè®¡ç®—å³å€¼ï¼Œå†èµ‹å€¼ç»™å˜é‡ï¼š**

```go
func main() {
    x, y := 1, 2
    x, y = y+3, x+2     // å…ˆè®¡ç®—å‡ºå³å€¼ y+3ã€x+2ï¼Œç„¶åå†å¯¹ xã€y å˜é‡èµ‹å€¼ã€‚

    println(x, y)   //5 3
}
```



### 3.1 å˜é‡å£°æ˜

- `var å˜é‡å ç±»å‹ = è¡¨è¾¾å¼`

åœ¨å‡½æ•°å†…éƒ¨è¿˜å¯ä»¥ä½¿ç”¨ç®€çŸ­çš„å½¢å¼å£°æ˜ã€‚   `å˜é‡å:=è¡¨è¾¾å¼`

é›¶å€¼åˆå§‹åŒ–æœºåˆ¶å¯ä»¥ç¡®ä¿æ¯ä¸ªå£°æ˜çš„å˜é‡æ€»æ˜¯æœ‰ä¸€ä¸ªè‰¯å¥½å®šä¹‰çš„å€¼ï¼Œå› æ­¤åœ¨Goè¯­è¨€ä¸­ä¸å­˜åœ¨æœªåˆå§‹åŒ–çš„å˜é‡

```go
var i, j, k int                 // int, int, int
var b, f, s = true, 2.3, "four" // bool, float64, string
```

- **åŒ…çº§åˆ«**å£°æ˜çš„å˜é‡åœ¨mainå‡½æ•°æ‰§è¡Œå‰å®Œæˆåˆå§‹åŒ–ï¼ˆæ‰€ä»¥å£°æ˜é¡ºåºæ— å…³ç´§è¦ï¼‰
- **å‡½æ•°çº§åˆ«**çš„å˜é‡ï¼ˆå±€éƒ¨å˜é‡ï¼‰åœ¨è¯­å¥è¢«æ‰§è¡Œåˆ°çš„æ—¶å€™å®Œæˆåˆå§‹åŒ–ï¼ˆå¿…é¡»å…ˆå£°æ˜åä½¿ç”¨ï¼‰

### 3.2 æŒ‡é’ˆå˜é‡

é€šè¿‡æŒ‡é’ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥è¯»å–æˆ–è€…ä¿®æ”¹å¯¹åº”å˜é‡çš„å€¼ï¼Œè€Œä¸éœ€è¦çŸ¥é“å˜é‡çš„åå­—

å¦‚æœç”¨â€œvar x intâ€å£°æ˜è¯­å¥å£°æ˜ä¸€ä¸ªxå˜é‡ï¼Œé‚£ä¹ˆ&xè¡¨è¾¾å¼ï¼ˆå–xå˜é‡çš„å†…å­˜åœ°å€ï¼‰å°†äº§ç”Ÿä¸€ä¸ªæŒ‡å‘è¯¥æ•´æ•°å˜é‡çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆå¯¹åº”çš„æ•°æ®ç±»å‹æ˜¯`*int`ï¼ŒæŒ‡é’ˆè¢«ç§°ä¹‹ä¸ºâ€œæŒ‡å‘intç±»å‹çš„æŒ‡é’ˆâ€ã€‚å¦‚æœæŒ‡é’ˆåå­—ä¸ºpï¼Œé‚£ä¹ˆå¯ä»¥è¯´â€œpæŒ‡é’ˆæŒ‡å‘å˜é‡xâ€ï¼Œæˆ–è€…è¯´â€œpæŒ‡é’ˆä¿å­˜äº†xå˜é‡çš„å†…å­˜åœ°å€â€ã€‚åŒæ—¶`*p`è¡¨è¾¾å¼å¯¹åº”pæŒ‡é’ˆæŒ‡å‘çš„å˜é‡çš„å€¼ã€‚ä¸€èˆ¬`*p`è¡¨è¾¾å¼è¯»å–æŒ‡é’ˆæŒ‡å‘çš„å˜é‡çš„å€¼ï¼Œè¿™é‡Œä¸ºintç±»å‹çš„å€¼ï¼ŒåŒæ—¶å› ä¸º`*p`å¯¹åº”ä¸€ä¸ªå˜é‡ï¼Œæ‰€ä»¥è¯¥è¡¨è¾¾å¼ä¹Ÿå¯ä»¥å‡ºç°åœ¨èµ‹å€¼è¯­å¥çš„å·¦è¾¹ï¼Œè¡¨ç¤ºæ›´æ–°æŒ‡é’ˆæ‰€æŒ‡å‘çš„å˜é‡çš„å€¼

```go
x := 1
p := &x         // p, of type *int, points to x
fmt.Println(*p) // "1"
*p = 2          // equivalent to x = 2
fmt.Println(x)  // "2"
```

ä»»ä½•ç±»å‹çš„æŒ‡é’ˆçš„é›¶å€¼éƒ½æ˜¯`nil`

åœ¨Goè¯­è¨€ä¸­ï¼Œ**è¿”å›å‡½æ•°ä¸­å±€éƒ¨å˜é‡çš„åœ°å€ä¹Ÿæ˜¯å®‰å…¨çš„**ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼Œè°ƒç”¨få‡½æ•°æ—¶åˆ›å»ºå±€éƒ¨å˜é‡vï¼Œåœ¨å±€éƒ¨å˜é‡åœ°å€è¢«è¿”å›ä¹‹åä¾ç„¶æœ‰æ•ˆï¼Œå› ä¸ºæŒ‡é’ˆpä¾ç„¶å¼•ç”¨è¿™ä¸ªå˜é‡

```go
var p = f()

func f() *int {
    v := 1
    return &v
}

//æ¯æ¬¡è°ƒç”¨få‡½æ•°éƒ½å°†è¿”å›ä¸åŒçš„ç»“æœï¼š
fmt.Println(f() == f()) // "false"
```



1. æŒ‡é’ˆåªå£°æ˜æœªåˆå§‹åŒ–ï¼Œåˆ™æŒ‡å‘å†…å­˜åœ°å€ä¸º0çš„ä½ç½®ã€‚*0ï¼Œ0-255åœ°å€ä¸ºç³»ç»Ÿå ç”¨ï¼Œä¸å…è®¸ç”¨æˆ·è¿›è¡Œè¯»å†™æ“ä½œ

```go
var p *int
*p = 123   //panic: runtime error: invalid memory address or nil pointer dereference
```

2. é‡æŒ‡é’ˆï¼šæŒ‡å‘æœªçŸ¥çš„ç©ºé—´

ä¸å…è®¸è®¿é—®ç©ºæŒ‡é’ˆå’Œé‡æŒ‡é’ˆå¯¹åº”çš„å†…å­˜ç©ºé—´ã€‚ã€‚ã€‚



### 3.3 newå‡½æ•°

`new(T)`å°†ä¼šåˆ›å»ºä¸€ä¸ªTç±»å‹çš„åŒ¿åå˜é‡ï¼ŒåŒæ—¶åˆå§‹åŒ–ä¸ºTç±»å‹çš„0å€¼ï¼Œè¿”å›å˜é‡çš„åœ°å€ï¼Œå³*Tç±»å‹

```go
p := new(int)   // p, *int ç±»å‹, æŒ‡å‘åŒ¿åçš„ int å˜é‡
fmt.Println(*p) // "0"
*p = 2          // è®¾ç½® int åŒ¿åå˜é‡çš„å€¼ä¸º 2
fmt.Println(*p) // "2"
```

newåªæ˜¯ä¸€ç§è¯­æ³•ç³–ï¼Œé¿å…äº†å£°æ˜ä¸€ä¸ªä¸´æ—¶å˜é‡çš„åå­—

p := new(int) ä¹Ÿå°±ç›¸å½“äº var t int,  p := &t



### 3.4 å˜é‡çš„ç”Ÿå‘½å‘¨æœŸå’Œé€ƒé€¸åˆ†æ


- åŒ…çº§åˆ«å£°æ˜çš„å˜é‡çš„ç”Ÿå‘½å‘¨æœŸå’Œæ•´ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´
- **å±€éƒ¨å˜é‡**æœ‰åŠ¨æ€çš„ç”Ÿå‘½å‘¨æœŸï¼šä»åˆ›å»ºè¯¥å±€éƒ¨å˜é‡èµ·ï¼Œåˆ°è¯¥å˜é‡ä¸å†æœ‰å¼•ç”¨ä¸ºæ­¢ã€‚ã€‚å› æ­¤å±€éƒ¨å˜é‡å¯èƒ½è¶…å‡ºå…¶å±€éƒ¨ä½œç”¨åŸŸï¼Œåœ¨å‡½æ•°è¿”å›ä¹‹åä¾ç„¶å­˜åœ¨ã€‚ã€‚**å¯¹äºé€ƒé€¸çš„å±€éƒ¨å˜é‡ï¼Œå¿…é¡»åˆ†é…åœ¨å †ä¸Š**ï¼Œå¯¹äºæ²¡æœ‰é€ƒé€¸çš„å±€éƒ¨å˜é‡ï¼Œç¼–è¯‘å™¨å¯ä»¥é€‰æ‹©åˆ†é…åœ¨æ ˆä¸Šã€‚ï¼ˆä¹Ÿå¯ä»¥åˆ†é…åœ¨å †ä¸Šç”±gcè¿›è¡Œå›æ”¶ï¼‰

å‘ç”Ÿé€ƒé€¸çš„æƒ…å†µä¸»è¦æœ‰ä¸¤ç§ï¼š

1. æ–¹æ³•é€ƒé€¸ï¼šå½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­å®šä¹‰ä¹‹åï¼Œä½œä¸ºå‚æ•°ä¼ é€’æˆ–è¿”å›å€¼åˆ°å…¶ä»–æ–¹æ³•ä¸­
2. çº¿ç¨‹é€ƒé€¸ï¼šå¯èƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°çš„å˜é‡

è¿™é‡Œä¸»è¦é’ˆå¯¹**æ–¹æ³•é€ƒé€¸**è¿›è¡Œåˆ†æï¼Œé€šè¿‡é€ƒé€¸åˆ†æåˆ¤æ–­ä¸€ä¸ªå˜é‡åˆ°åº•æ˜¯åˆ†é…åœ¨æ ˆä¸Šè¿˜æ˜¯å †ä¸Š

**ç­–ç•¥**ï¼šç¼–è¯‘å™¨å¦‚æœä¸èƒ½è¯æ˜æŸä¸ªå˜é‡åœ¨å‡½æ•°è¿”å›åä¸å†è¢«å¼•ç”¨ï¼Œåˆ™åˆ†é…åœ¨å †ä¸Šã€‚å¦‚æœä¸€ä¸ªå˜é‡è¿‡å¤§ï¼Œä¹Ÿå¯èƒ½è¢«åˆ†é…åœ¨å †ä¸Š

**ç›®çš„ï¼š** å°½é‡åœ¨æ ˆä¸Šåˆ†é…ï¼Œå‡å°‘GCå‹åŠ›ã€‚æ ˆä¸Šåˆ†é…æ›´é«˜æ•ˆã€‚æœªé€ƒé€¸å¯¹è±¡å¯ä»¥è¿›è¡Œé”æ¶ˆé™¤



å·¥å…·ï¼š`go run -gcflags "-m -l"`

è¯´æ˜ï¼š

moved to heap:xxx å’Œ xxx escapes to heap éƒ½è¡¨ç¤ºé€ƒé€¸ï¼Œå‰è€…è¡¨ç¤ºå€¼ç±»å‹é€ƒé€¸ï¼Œåè€…è¡¨ç¤ºæŒ‡é’ˆç±»å‹é€ƒé€¸





#### 1. å‡½æ•°è¿”å›å±€éƒ¨å˜é‡åœ°å€å¼•èµ·é€ƒé€¸

å‡½æ•°**è¿”å›äº†å±€éƒ¨å˜é‡çš„æŒ‡é’ˆ**ï¼Œè¿™ç§æƒ…å†µè¯¥å˜é‡ä¸€å®šå‘ç”Ÿäº†é€ƒé€¸

```go
func f() (int, *int) {
	var a = 2
	var c = 2
	//è¿”å›å‡½æ•°å±€éƒ¨å˜é‡åœ°å€
	return a, &c
}

func main() {
	f()
}

/*
$ go run -gcflags "-m -l" addr_escape.go
# command-line-arguments
.\addr_escape.go:5:6: moved to heap: c
*/
```

å¯ä»¥çœ‹åˆ° c é€ƒé€¸äº†ï¼Œè€Œ a æ²¡æœ‰é€ƒé€¸



#### 2. è¢«å·²é€ƒé€¸çš„æŒ‡é’ˆå¼•ç”¨çš„æŒ‡é’ˆä¼šé€ƒé€¸

æŸä¸ªå€¼**å–åœ°å€ä¼ é€’ç»™å‡½æ•°**å¹¶ä¸ä¼šå‘ç”Ÿé€ƒé€¸

```go
func f() (int, *int) {
	var a = 2
	var c = 2
	//è¿”å›å‡½æ•°å±€éƒ¨å˜é‡åœ°å€
	return a, &c
}

func add(a *int, b *int) int {
	return *a + *b
}
func main() {
	x, y := f()
	add(&x, y)
}
/*
$ go run -gcflags "-m -l" addr_escape.go
# command-line-arguments
.\addr_escape.go:5:6: moved to heap: c
.\addr_escape.go:10:10: a does not escape
.\addr_escape.go:10:18: b does not escape
*/
```

å¯ä»¥çœ‹åˆ° add å‡½æ•° ä¼ äº† x çš„åœ°å€ï¼Œä¸ä¼šå¼•èµ·xé€ƒé€¸



è€Œ**è¢«å·²ç»é€ƒé€¸çš„å˜é‡å¼•ç”¨çš„æŒ‡é’ˆä¸€å®šä¼šå‘ç”Ÿé€ƒé€¸**

```go
func f() (int, *int) {
	var a = 2
	var c = 2
	//è¿”å›å‡½æ•°å±€éƒ¨å˜é‡åœ°å€
	return a, &c
}

func main() {
	x, y := f()
	fmt.Printf("addr_x: %p\naddr_y: %p\n", &x, y)
}

/*
$ go run -gcflags "-m -l" addr_escape.go
# command-line-arguments
.\addr_escape.go:7:6: moved to heap: c
.\addr_escape.go:13:2: moved to heap: x
.\addr_escape.go:14:12: ... argument does not escape
addr_x: 0xc000012120
addr_y: 0xc000012128
*/
```

```go
type T struct {
	TA *int
	TB int
}

func f() (int, int) {
	var a = 2
	var c = 2
	//è¿”å›å‡½æ•°å±€éƒ¨å˜é‡åœ°å€
	return a, c
}

func newT(ta *int, tb int) *T {
	t := T{TA: ta, TB: tb}
	return &t
}

func main() {
	x, y := f()
	t := newT(&x, y)
	_ = t
}

/*
$ go run -gcflags "-m -l" addr_escape.go
# command-line-arguments
.\addr_escape.go:15:11: leaking param: ta
.\addr_escape.go:16:2: moved to heap: t
.\addr_escape.go:21:2: moved to heap: x
*/
```

è¿™é‡Œté€ƒé€¸äº†ï¼ï¼ tåˆå¼•ç”¨äº†xçš„åœ°å€ï¼Œæ‰€ä»¥å¼•èµ· x é€ƒé€¸ï¼Œè¿™æ‰æ˜¯é€ƒé€¸çš„æ ¹æœ¬åŸå› ã€‚ã€‚

è‡³äºPrintfï¼š

fmt.Printf æºç ï¼Œpè¿™ä¸ªæŒ‡é’ˆæ˜¯é€šè¿‡newPrinterè¿”å›çš„ï¼Œpæ˜¯é€ƒé€¸çš„ï¼Œè€Œpå¼•ç”¨äº† argï¼Œargæ˜¯æŒ‡é’ˆçš„æ—¶å€™å°±ä¼šé€ æˆargé€ƒé€¸

```go
func Fprintf(w io.Writer, format string, a ...interface{}) (n int, err error) {
	p := newPrinter()		// p é€ƒé€¸äº†
	p.doPrintf(format, a)
...
}

func (p *pp) doPrintf(format string, a []interface{}) {
...
p.printArg(a[argNum], rune(c))
...
}

func (p *pp) printArg(arg interface{}, verb rune) {  
	p.arg = arg					// é€ƒé€¸çš„å˜é‡pï¼Œå¼•ç”¨äº†argï¼Œargæ˜¯æŒ‡é’ˆçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯ x ï¼Œé€ƒé€¸äº†ï¼Œä¸æ˜¯æŒ‡é’ˆä¸é€ƒé€¸
	p.value = reflect.Value{}
...
}
```



#### 3. mapã€sliceã€chanå¼•ç”¨çš„æŒ‡é’ˆé€ƒé€¸

**è¢«æŒ‡é’ˆç±»å‹çš„sliceã€mapå’Œchanå¼•ç”¨çš„æŒ‡é’ˆä¸€å®šå‘ç”Ÿé€ƒé€¸**

> å¤‡æ³¨ï¼šstack overflowä¸Šæœ‰äººæé—®ä¸ºä»€ä¹ˆä½¿ç”¨æŒ‡é’ˆçš„chanæ¯”ä½¿ç”¨å€¼çš„chanæ…¢30%ï¼Œç­”æ¡ˆå°±åœ¨è¿™é‡Œï¼šä½¿ç”¨æŒ‡é’ˆçš„chanå‘ç”Ÿé€ƒé€¸ï¼Œgcæ‹–æ…¢äº†é€Ÿåº¦ã€‚é—®é¢˜é“¾æ¥https://stackoverflow.com/questions/41178729/why-passing-pointers-to-channel-is-slower

```go
func main() {
	a := make([]*int, 1)
	b := 12
	a[0] = &b

	c := make(map[string]*int)
	d := 14
	c["aaa"] = &d

	e := make(chan *int, 1)
	f := 15
	e <- &f
}

/*
$ go run -gcflags "-m -l" slice_map_chan_escape.go
# command-line-arguments
.\slice_map_chan_escape.go:5:2: moved to heap: b
.\slice_map_chan_escape.go:9:2: moved to heap: d
.\slice_map_chan_escape.go:13:2: moved to heap: f
.\slice_map_chan_escape.go:4:11: make([]*int, 1) does not escape
.\slice_map_chan_escape.go:8:11: make(map[string]*int) does not escape
*/
```



æˆ‘ä»¬å¾—å‡ºäº†æŒ‡é’ˆ**å¿…ç„¶å‘ç”Ÿé€ƒé€¸**çš„ä¸‰ç§æƒ…å†µï¼ˆgo version go1.13.4 darwin/amd64)ï¼š

- åœ¨æŸä¸ªå‡½æ•°ä¸­newæˆ–å­—é¢é‡åˆ›å»ºå‡ºçš„å˜é‡ï¼Œå°†å…¶æŒ‡é’ˆä½œä¸ºå‡½æ•°è¿”å›å€¼ï¼Œåˆ™è¯¥å˜é‡ä¸€å®šå‘ç”Ÿé€ƒé€¸ï¼ˆæ„é€ å‡½æ•°è¿”å›çš„æŒ‡é’ˆå˜é‡ä¸€å®šé€ƒé€¸ï¼‰ï¼›
- è¢«å·²ç»é€ƒé€¸çš„å˜é‡å¼•ç”¨çš„æŒ‡é’ˆï¼Œä¸€å®šå‘ç”Ÿé€ƒé€¸ï¼›
- è¢«æŒ‡é’ˆç±»å‹çš„sliceã€mapå’Œchanå¼•ç”¨çš„æŒ‡é’ˆï¼Œä¸€å®šå‘ç”Ÿé€ƒé€¸ï¼›



åŒæ—¶æˆ‘ä»¬ä¹Ÿå¾—å‡ºä¸€äº›**å¿…ç„¶ä¸ä¼šé€ƒé€¸**çš„æƒ…å†µï¼š

- æŒ‡é’ˆè¢«æœªå‘ç”Ÿé€ƒé€¸çš„å˜é‡å¼•ç”¨ï¼›
- ä»…ä»…åœ¨å‡½æ•°å†…å¯¹å˜é‡åšå–å€æ“ä½œï¼Œè€Œæœªå°†æŒ‡é’ˆä¼ å‡ºï¼›



æœ‰ä¸€äº›æƒ…å†µ**å¯èƒ½å‘ç”Ÿé€ƒé€¸ï¼Œä¹Ÿå¯èƒ½ä¸ä¼šå‘ç”Ÿé€ƒé€¸**ï¼š

- å°†æŒ‡é’ˆä½œä¸ºå…¥å‚ä¼ ç»™åˆ«çš„å‡½æ•°ï¼›è¿™é‡Œè¿˜æ˜¯è¦çœ‹æŒ‡é’ˆåœ¨è¢«ä¼ å…¥çš„å‡½æ•°ä¸­çš„å¤„ç†è¿‡ç¨‹ï¼Œå¦‚æœå‘ç”Ÿäº†ä¸Šè¾¹çš„ä¸‰ç§æƒ…å†µï¼Œåˆ™ä¼šé€ƒé€¸ï¼›å¦åˆ™ä¸ä¼šé€ƒé€¸ï¼›



#### 4. æ ˆç©ºé—´ä¸è¶³é€ƒé€¸

åˆ›å»ºè¾ƒå°çš„sliceï¼Œæ²¡æœ‰é€ƒé€¸ï¼š

```go
func main() {
	stack()
}

func stack() {
	s := make([]int, 10, 10)
	s[0] = 1
}

/*
$ go run -gcflags "-m -l" stack_escape.go
# command-line-arguments
.\stack_escape.go:8:11: make([]int, 10, 10) does not escape
*/
```



åˆ›å»ºè¶…å¤§sliceï¼Œé€ƒé€¸ï¼š

```go
func main() {
	stack()
}

func stack() {
	s := make([]int, 10000, 10000)
	s[0] = 1
}

/*
$ go run -gcflags "-m -l" stack_escape.go
# command-line-arguments
.\stack_escape.go:8:11: make([]int, 10000, 10000) escapes to heap
*/
```



#### 5. åŠ¨æ€ç±»å‹é€ƒé€¸

```go
func main() {
	dynamic()
}

func dynamic() interface{} {
	i := 0
	return i
}

/*
$ go run -gcflags "-m -l" interface_escape.go
# command-line-arguments
.\interface_escape.go:9:2: i escapes to heap
*/
```



#### 6. é—­åŒ…å¼•ç”¨é€ƒé€¸

```go
func main() {
	f := fibonacci()
	for i := 0; i < 10; i++ {
		f()
	}
}
func fibonacci() func() int {
	a, b := 0, 1
	return func() int {
		a, b = b, a+b
		return a
	}
}

/*
$ go run -gcflags "-m" closure_escape.go
# command-line-arguments
.\closure_escape.go:11:9: can inline fibonacci.func1
.\closure_escape.go:10:2: moved to heap: a
.\closure_escape.go:10:5: moved to heap: b
.\closure_escape.go:11:9: func literal escapes to heap
*/
```





### 3.5 èµ‹å€¼

**å…ƒç»„èµ‹å€¼ï¼š**åœ¨èµ‹å€¼ä¹‹å‰ï¼Œ**èµ‹å€¼è¯­å¥å³è¾¹çš„æ‰€æœ‰è¡¨è¾¾å¼å°†ä¼šå…ˆè¿›è¡Œæ±‚å€¼**ï¼Œç„¶åå†ç»Ÿä¸€æ›´æ–°å·¦è¾¹å¯¹åº”å˜é‡çš„å€¼

```go
x, y = y, x
```

**ä¸¢å¼ƒä¸éœ€è¦çš„å€¼**ï¼š

```go
_, err = io.Copy(dst, src) // ä¸¢å¼ƒå­—èŠ‚æ•°
_, ok = x.(T)              // åªæ£€æµ‹ç±»å‹ï¼Œå¿½ç•¥å…·ä½“å€¼
```

**å¯èµ‹å€¼æ€§ï¼š**ç±»å‹å¿…é¡»`å®Œå…¨åŒ¹é…`æ‰èƒ½è¿›è¡Œèµ‹å€¼ï¼Œnilå¯ä»¥èµ‹å€¼ç»™ä»»ä½•æŒ‡é’ˆæˆ–å¼•ç”¨ç±»å‹çš„å˜é‡

å¯¹äºä¸¤ä¸ªå€¼æ˜¯å¦å¯ä»¥ç”¨`==`æˆ–`!=`è¿›è¡Œç›¸ç­‰æ¯”è¾ƒçš„èƒ½åŠ›ä¹Ÿå’Œå¯èµ‹å€¼èƒ½åŠ›æœ‰å…³ç³»ï¼šå¯¹äºä»»ä½•ç±»å‹çš„å€¼çš„ç›¸ç­‰æ¯”è¾ƒï¼Œç¬¬äºŒä¸ªå€¼å¿…é¡»æ˜¯å¯¹ç¬¬ä¸€ä¸ªå€¼ç±»å‹å¯¹åº”çš„å˜é‡æ˜¯å¯èµ‹å€¼çš„ï¼Œåä¹‹äº¦ç„¶



**é€€åŒ–èµ‹å€¼ï¼š** ç®€çŸ­æ¨¡å¼å¹¶ä¸æ€»æ˜¯é‡æ–°å®šä¹‰å˜é‡ï¼Œä¹Ÿå¯èƒ½æ˜¯éƒ¨åˆ†é€€åŒ–çš„èµ‹å€¼æ“ä½œã€‚ï¼ˆèƒ½åŒæ—¶å®Œæˆ**èµ‹å€¼**å’Œ**å®šä¹‰æ–°çš„å˜é‡**ï¼‰

```go
func main() {
    x := 100
    println(&x)

    x, y := 200, "abc"     // æ³¨æ„: x é€€åŒ–ä¸ºèµ‹å€¼æ“ä½œï¼Œä»…æœ‰ y æ˜¯å˜é‡å®šä¹‰ã€‚

    println(&x, x)
    println(y)
}

/*
0xc00002e770
0xc00002e770 200         // å¯¹æ¯”å˜é‡å†…å­˜åœ°å€ï¼Œå¯ä»¥ç¡®è®¤ x å±äºåŒä¸€å˜é‡ã€‚
abc
*/
```



**è°ƒæ•´ä½œç”¨åŸŸå¯ä»¥ä¿®æ­£èµ‹å€¼ï¼š**

```go
func main() {
    x := 100
    println(&x, x)

    {                         // ä½¿ç”¨å¤§æ‹¬å·å®šä¹‰ä½œç”¨åŸŸã€‚
        x, y := 200, 300      // ä¸åŒä½œç”¨åŸŸï¼Œå…¨éƒ¨æ˜¯æ–°å˜é‡å®šä¹‰ã€‚
        println(&x, x, y)
    }
}

/*
0xc00002e770 100
0xc00002e768 200 300    // ä¸¤ä¸ªxçš„åœ°å€ä¸ä¸€æ ·
*/
```



### 3.6 ç±»å‹

ä½¿ç”¨typeæ¥å£°æ˜ä¸€ä¸ªæ–°çš„ç±»å‹ï¼š`type ç±»å‹åå­— åº•å±‚ç±»å‹`

ç±»å‹å£°æ˜è¯­å¥ä¸€èˆ¬å‡ºç°åœ¨åŒ…ä¸€çº§ï¼Œå› æ­¤å¦‚æœæ–°åˆ›å»ºçš„ç±»å‹åå­—çš„é¦–å­—ç¬¦å¤§å†™ï¼Œåˆ™åœ¨åŒ…å¤–éƒ¨ä¹Ÿå¯ä»¥ä½¿ç”¨

```go
package tempconv

import "fmt"

type Celsius float64    // æ‘„æ°æ¸©åº¦
type Fahrenheit float64 // åæ°æ¸©åº¦

const (
    AbsoluteZeroC Celsius = -273.15 // ç»å¯¹é›¶åº¦
    FreezingC     Celsius = 0       // ç»“å†°ç‚¹æ¸©åº¦
    BoilingC      Celsius = 100     // æ²¸æ°´æ¸©åº¦
)

func CToF(c Celsius) Fahrenheit { return Fahrenheit(c*9/5 + 32) }

func FToC(f Fahrenheit) Celsius { return Celsius((f - 32) * 5 / 9) }
```

å®ƒä»¬è™½ç„¶æœ‰ç€ç›¸åŒçš„åº•å±‚ç±»å‹float64ï¼Œä½†æ˜¯**å®ƒä»¬æ˜¯ä¸åŒçš„æ•°æ®ç±»å‹**ï¼Œå› æ­¤å®ƒä»¬**ä¸å¯ä»¥è¢«ç›¸äº’æ¯”è¾ƒ**æˆ–**æ··åœ¨ä¸€ä¸ªè¡¨è¾¾å¼è¿ç®—**

**ç±»å‹è½¬æ¢T(x)ï¼š** åªæœ‰å½“ä¸¤ä¸ªç±»å‹çš„**åº•å±‚åŸºç¡€ç±»å‹ç›¸åŒ**æ—¶ï¼Œæ‰å…è®¸è¿™ç§è½¬å‹æ“ä½œï¼Œæˆ–è€…æ˜¯ä¸¤è€…éƒ½æ˜¯æŒ‡å‘ç›¸åŒåº•å±‚ç»“æ„çš„æŒ‡é’ˆç±»å‹ï¼Œè¿™äº›è½¬æ¢åªæ”¹å˜ç±»å‹è€Œä¸ä¼šå½±å“å€¼æœ¬èº«

æ•°å€¼ç±»å‹ä¹‹é—´çš„è½¬å‹ä¹Ÿæ˜¯å…è®¸çš„ï¼Œå¹¶ä¸”åœ¨å­—ç¬¦ä¸²å’Œä¸€äº›ç‰¹å®šç±»å‹çš„sliceä¹‹é—´ä¹Ÿæ˜¯å¯ä»¥è½¬æ¢çš„

æ¯”è¾ƒè¿ç®—ç¬¦`==`å’Œ`<`ä¹Ÿå¯ä»¥ç”¨æ¥æ¯”è¾ƒä¸€ä¸ªå‘½åç±»å‹çš„å˜é‡å’Œå¦ä¸€ä¸ªæœ‰ç›¸åŒç±»å‹çš„å˜é‡ï¼Œæˆ–æœ‰ç€ç›¸åŒåº•å±‚ç±»å‹çš„æœªå‘½åç±»å‹çš„å€¼ä¹‹é—´åšæ¯”è¾ƒã€‚**ä½†æ˜¯å¦‚æœä¸¤ä¸ªå€¼æœ‰ç€ä¸åŒçš„ç±»å‹ï¼Œåˆ™ä¸èƒ½ç›´æ¥è¿›è¡Œæ¯”è¾ƒ**ï¼š

```go
var c Celsius
var f Fahrenheit
fmt.Println(c == 0)          // "true"
fmt.Println(f >= 0)          // "true"
fmt.Println(c == f)          // compile error: type mismatch
fmt.Println(c == Celsius(f)) // "true"!
```

**Celsius(f)æ˜¯ç±»å‹è½¬æ¢æ“ä½œï¼Œå®ƒå¹¶ä¸ä¼šæ”¹å˜å€¼**ï¼Œä»…ä»…æ˜¯æ”¹å˜å€¼çš„ç±»å‹è€Œå·²ã€‚æµ‹è¯•ä¸ºçœŸçš„åŸå› æ˜¯å› ä¸ºcå’Œgéƒ½æ˜¯é›¶å€¼

åº•å±‚æ•°æ®ç±»å‹å†³å®šäº†å†…éƒ¨ç»“æ„å’Œè¡¨è¾¾æ–¹å¼ï¼Œä¹Ÿå†³å®šæ˜¯å¦å¯ä»¥åƒåº•å±‚ç±»å‹ä¸€æ ·å¯¹å†…ç½®è¿ç®—ç¬¦çš„ æ”¯æŒã€‚è¿™æ„å‘³ç€ï¼ŒCelsiuså’ŒFahrenheitç±»å‹çš„ç®—æœ¯è¿ç®—è¡Œä¸ºå’Œåº•å±‚çš„float64ç±»å‹æ˜¯ä¸€æ ·çš„ï¼Œ

### 3.7 åŒ…ã€æ–‡ä»¶ã€initå‡½æ•°

å¯¹äºåœ¨åŒ…çº§åˆ«å£°æ˜çš„å˜é‡ï¼Œå¦‚æœæœ‰åˆå§‹åŒ–è¡¨è¾¾å¼åˆ™ç”¨è¡¨è¾¾å¼åˆå§‹åŒ–ï¼Œè¿˜æœ‰ä¸€äº›æ²¡æœ‰åˆå§‹åŒ–è¡¨è¾¾å¼çš„ï¼Œä¾‹å¦‚æŸäº›è¡¨æ ¼æ•°æ®åˆå§‹åŒ–å¹¶ä¸æ˜¯ä¸€ä¸ªç®€å•çš„èµ‹å€¼è¿‡ç¨‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç‰¹æ®Šçš„initåˆå§‹åŒ–å‡½æ•°æ¥ç®€åŒ–åˆå§‹åŒ–å·¥ä½œã€‚**æ¯ä¸ªæ–‡ä»¶éƒ½å¯ä»¥åŒ…å«å¤šä¸ªinitåˆå§‹åŒ–å‡½æ•°**

```go
func init() { /* ... */ }
```

è¿™æ ·çš„initåˆå§‹åŒ–å‡½æ•°é™¤äº†**ä¸èƒ½è¢«è°ƒç”¨æˆ–å¼•ç”¨**å¤–ï¼Œå…¶ä»–è¡Œä¸ºå’Œæ™®é€šå‡½æ•°ç±»ä¼¼ã€‚åœ¨æ¯ä¸ªæ–‡ä»¶ä¸­çš„initåˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶æŒ‰ç…§å®ƒä»¬å£°æ˜çš„é¡ºåºè¢«è‡ªåŠ¨è°ƒç”¨



**åˆå§‹åŒ–å·¥ä½œæ˜¯è‡ªä¸‹è€Œä¸Šè¿›è¡Œçš„ï¼ŒmainåŒ…æœ€åè¢«åˆå§‹åŒ–**ã€‚ä»¥è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ç¡®ä¿åœ¨mainå‡½æ•°æ‰§è¡Œä¹‹å‰ï¼Œæ‰€æœ‰ä¾èµ–çš„åŒ…éƒ½å·²ç»å®Œæˆåˆå§‹åŒ–å·¥ä½œäº†ã€‚åŒæ—¶påŒ…è‹¥å¯¼å…¥äº†qåŒ…ï¼ŒpåŒ…åˆå§‹åŒ–çš„æ—¶å€™å°±è®¤ä¸ºqåŒ…å·²ç»åˆå§‹åŒ–å®Œæˆäº†



**mainåŒ…ï¼š** ç¼–è¯‘å™¨å‘ç°**åŒ…åä¸ºmainçš„åŒ…**ï¼Œå¹¶ä¸”**åŒ…å«main()å‡½æ•°**ï¼Œæ‰ä¼š**å°†è¯¥åŒ…ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶**ã€‚ç¼–è¯‘æ—¶ä¼šä½¿ç”¨mainåŒ…çš„ä»£ç æ‰€åœ¨ç›®å½•çš„åå­—ä½œä¸ºäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶å



**ç¼–è¯‘å™¨æŸ¥æ‰¾importçš„åŒ…ï¼š** é¦–å…ˆæŸ¥æ‰¾**Goçš„å®‰è£…ç›®å½•** `GOROOT`ï¼Œç„¶åæŒ‰é¡ºåºæŸ¥æ‰¾`GOPATH`å˜é‡é‡Œçš„ç›®å½•ï¼Œæœªæ‰¾åˆ°åˆ™ä¼šåœ¨æ‰§è¡Œrunæˆ–è€…buildçš„æ—¶å€™æŠ¥é”™



**å‘½åå¯¼å…¥ï¼š**

```go
import(
	"fmt"
  myfmt "mylib/fmt"   //å‘½åä¸ºæ–°çš„å
)
```

**ç©ºç™½æ ‡è¯†ç¬¦ï¼š** ç»™å¯¼å…¥çš„åŒ…èµ‹äºˆä¸€ä¸ªç©ºåå­—`_` ï¼Œå¯ä»¥é¿å…ä¸ä½¿ç”¨è¯¥åŒ…çš„æŠ¥é”™ï¼Œä½†æ˜¯**initå‡½æ•°ä¾ç„¶ä¼šæ‰§è¡Œ**ï¼Œä¾‹å¦‚æ•°æ®åº“é©±åŠ¨åŒ…çš„initå‡½æ•°å°†è‡ªå·±æ³¨å†Œåˆ°sqlåŒ…



**initå‡½æ•°ï¼š** ä¸€ä¸ªåŒ…å¯ä»¥åŒ…å«å¤šä¸ªinitå‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šä¿è¯æ‰€æœ‰çš„initå‡½æ•°éƒ½åœ¨mainå‡½æ•°å‰æ‰§è¡Œ

### 3.8 å˜é‡çš„ä½œç”¨åŸŸ

ä¸€ä¸ªå£°æ˜è¯­å¥å°†ç¨‹åºä¸­çš„å®ä½“å’Œä¸€ä¸ªåå­—å…³è”ï¼Œæ¯”å¦‚ä¸€ä¸ªå‡½æ•°æˆ–ä¸€ä¸ªå˜é‡ã€‚å£°æ˜è¯­å¥çš„ä½œç”¨åŸŸæ˜¯æŒ‡**æºä»£ç ä¸­å¯ä»¥æœ‰æ•ˆä½¿ç”¨è¿™ä¸ªåå­—çš„èŒƒå›´**

**ç”Ÿå‘½å‘¨æœŸå’Œä½œç”¨åŸŸï¼š**å£°æ˜è¯­å¥çš„ä½œç”¨åŸŸå¯¹åº”çš„æ˜¯ä¸€ä¸ªæºä»£ç çš„æ–‡æœ¬åŒºåŸŸï¼›å®ƒæ˜¯ä¸€ä¸ª**ç¼–è¯‘æ—¶çš„å±æ€§**ã€‚ä¸€ä¸ªå˜é‡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯æŒ‡ç¨‹åºè¿è¡Œæ—¶å˜é‡å­˜åœ¨çš„æœ‰æ•ˆæ—¶é—´æ®µï¼Œåœ¨æ­¤æ—¶é—´åŒºåŸŸå†…å®ƒå¯ä»¥è¢«ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†å¼•ç”¨ï¼›æ˜¯ä¸€ä¸ª**è¿è¡Œæ—¶çš„æ¦‚å¿µ**

```go
if x := f(); x == 0 {    //å¯ä»¥æ‰§è¡Œä¸€ä¸ªè¯­å¥ä¹‹åå†è¿›è¡Œåˆ¤æ–­
    fmt.Println(x)
} else if y := g(x); x == y {
    fmt.Println(x, y)
} else {
    fmt.Println(x, y)
}
fmt.Println(x, y) // compile error: x and y are not visible here
```



## 4. å¤§ç«¯å’Œå°ç«¯

ä½¿ç”¨goè¯­è¨€åˆ¤æ–­CPUæ˜¯å¤§ç«¯è¿˜æ˜¯å°ç«¯ï¼š

```go
func main() {
	var i int32 = 0x01020304
	u := unsafe.Pointer(&i)
	pb := (*int8)(u)
	fmt.Println(*pb)
}

/*
	  ä½åœ°å€ ------------> é«˜åœ°å€
å°ç«¯ï¼š	0x04 | 0x03 | 0x02 | 0x01
å¤§ç«¯ï¼š	0x01 | 0x02 | 0x03 | 0x04
*/

```

å¤§ç«¯åºï¼Œå°±æ˜¯é«˜ä½å­—èŠ‚æ”¾åœ¨ä½åœ°å€ï¼Œç¬¦åˆäººç±»çš„é˜…è¯»ä¹ æƒ¯

å°ç«¯åºï¼Œå°±æ˜¯ä½ä½å­—èŠ‚æ”¾åœ¨ä½åœ°å€ï¼Œç¬¦åˆè®¡ç®—æœºè¯»å–å†…å­˜çš„æ–¹å¼ï¼Œä»ä½åˆ°é«˜è¯»å–



å¤§å°ç«¯æ¨¡å¼å„æœ‰ä¼˜åŠ¿ï¼š

- å°ç«¯æ¨¡å¼å¼ºåˆ¶è½¬æ¢ç±»å‹æ—¶ä¸éœ€è¦è°ƒæ•´å­—èŠ‚å†…å®¹ï¼Œç›´æ¥æˆªå–ä½å­—èŠ‚å³å¯

- å¤§ç«¯æ¨¡å¼ç”±äºç¬¦å·ä½ä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå¾ˆæ–¹ä¾¿åˆ¤æ–­æ­£è´Ÿã€‚



javaè¦åˆ¤æ–­å¤§ç«¯è¿˜æ˜¯å°ç«¯å°±éº»çƒ¦å¾ˆå¤šï¼š

```java
public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException {
    Field field = Unsafe.class.getDeclaredField("theUnsafe"); //Unsafeæ„é€ æ–¹æ³•ç§æœ‰ï¼Œè‡ªèº«æœ‰ä¸ªé™æ€çš„å±æ€§æ˜¯è‡ªå·±çš„å®ä¾‹
    field.setAccessible(true);
    Unsafe unsafe = (Unsafe) field.get(null); //field.getæ–¹æ³•ï¼Œè·å–ç±»æˆ–è€…å®ä¾‹çš„fieldå€¼ï¼Œå®ä¾‹è¦ä¼ å…¥å®ä¾‹ï¼Œç±»çš„ä¼ ä»€ä¹ˆéƒ½å¯ä»¥
    long a = unsafe.allocateMemory(8);
    unsafe.putInt(a, 0x01020304);
    byte b = unsafe.getByte(a);
    System.out.println(b);
    unsafe.freeMemory(a);
}
```



# äºŒã€åŸºæœ¬æ•°æ®ç±»å‹

## 1. æ•´å½¢

æ•´å½¢ï¼šint8ã€int16ã€int32ã€int64 ä»¥åŠ uint8ã€uint16ã€uint32ã€uint64

intå’Œuintåˆ™æ ¹æ®æœºå™¨å­—é•¿å˜åŒ–ï¼Œ32æˆ–64ä½

Unicodeå­—ç¬¦`rune`ç±»å‹å’Œ`int32`ç±»å‹**ç­‰ä»·** `type rune = int32`

`byte`ç±»å‹å’Œ`uint8`ç±»å‹**ç­‰ä»· ** `type byte = int8`

> **ç±»å‹åˆ«å**ï¼š
>
> ```go
> type a int           //aå’Œintæ˜¯ä¸åŒç±»å‹
> type b = int         //bå’Œintæ˜¯å®Œå…¨ç›¸åŒçš„ç±»å‹
> 
> func main() {
> 	var x a
> 	var y b
> 	x = int(10)     //ç¼–è¯‘å‡ºé”™
> 	y = int(10)     //æ­£ç¡®
> }
> ```
>
> 

uintptrï¼šæ²¡æœ‰æŒ‡å®šå…·ä½“çš„bitå¤§å°ï¼Œä½†æ˜¯è¶³ä»¥å®¹çº³æŒ‡é’ˆ



`&^`**ä½æ¸…ç©º**è¿ç®—ç¬¦ï¼šz = x &^ yï¼Œå¦‚æœå¯¹åº”yä¸­bitä½ä¸º1çš„è¯, è¡¨è¾¾å¼ z = x &^ y ç»“æœzçš„å¯¹åº”çš„bitä½ä¸º0ï¼Œå¦åˆ™zå¯¹åº”çš„ bitä½ç­‰äºxç›¸åº”çš„bitä½çš„å€¼

```go
o := 0666
fmt.Printf("%d %[1]o %#[1]o\n", o) // "438 666 0666"
x := int64(0xdeadbeef)
fmt.Printf("%d %[1]x %#[1]x %#[1]X\n", x)  //3735928559 deadbeef 0xdeadbeef 0XDEADBEEF
```

- %ä¹‹åçš„`[1]`å‰¯è¯å‘Šè¯‰Printfå‡½æ•°å†æ¬¡ä½¿ç”¨ç¬¬ä¸€ä¸ªæ“ä½œæ•°
- %åçš„`#`å‰¯è¯å‘Šè¯‰Printfåœ¨ç”¨%oã€%xæˆ–%Xè¾“å‡ºæ—¶ç”Ÿæˆ0ã€0xæˆ–0Xå‰ç¼€ã€‚

```go
ascii := 'a'
fmt.Printf("%d %[1]c %[1]q\n", ascii)   // "97 a 'a'"
```

## 2. æµ®ç‚¹æ•°

goè¯­è¨€æä¾›äº†ä¸¤ç§ç²¾åº¦çš„æµ®ç‚¹æ•°ï¼šfloat32å’Œfloat64

### NaN

- æ­£æ— ç©·å¤§å’Œè´Ÿæ— ç©·å¤§ï¼Œåˆ†åˆ«ç”¨äºè¡¨ç¤ºå¤ªå¤§æº¢å‡ºçš„æ•°å­—å’Œé™¤é›¶çš„ç»“æœï¼›è¿˜æœ‰NaNéæ•°ï¼Œä¸€èˆ¬ç”¨äºè¡¨ç¤ºæ— æ•ˆçš„é™¤æ³•æ“ä½œç»“æœ0/0æˆ–Sqrt(-1)

```go
var z float64
fmt.Println(z, -z, 1/z, -1/z, z/z) // "0 -0 +Inf -Inf NaN"
```

å‡½æ•°`math.IsNaN`ç”¨äºæµ‹è¯•ä¸€ä¸ªæ•°æ˜¯å¦æ˜¯éæ•°NaNï¼Œ`math.NaN`åˆ™è¿”å›éæ•°å¯¹åº”çš„å€¼

å¦å¤–NaNå’Œæ­£è´Ÿæ— ç©·å¤§éƒ½æ˜¯ä¸èƒ½ç›´æ¥æ¯”è¾ƒçš„

```go
nan := math.NaN()
fmt.Println(nan == nan, nan < nan, nan > nan) // "false false false"
```

## 3. å¤æ•°

goè¯­è¨€æä¾›äº†ä¸¤ç§ç²¾åº¦çš„å¤æ•°ï¼šcomplex64å’Œcomplex128ï¼Œåˆ†åˆ«å¯¹åº”float32å’Œfloat64ä¸¤ç§ç²¾åº¦çš„æµ®ç‚¹æ•°ç²¾åº¦

```go
var x complex128 = complex(1, 2) // 1+2i
var y complex128 = complex(3, 4) // 3+4i
fmt.Println(x*y)                 // "(-5+10i)"
fmt.Println(real(x*y))           // "-5"
fmt.Println(imag(x*y))           // "10"
```

## 4. å¸ƒå°”ç±»å‹

`true = 0 == 0`  å’Œ `false = 0!= 0`

&&çš„ä¼˜å…ˆçº§æ¯”ï½œï½œé«˜

**å¸ƒå°”ç±»å‹ä¸ä¼šéšå¼è½¬æ¢ä¸º0ï¼Œ1**ï¼Œå¦‚æœ‰éœ€è¦åº”è¯¥æ‰‹åŠ¨è¿›è¡Œè½¬æ¢

## 5. å­—ç¬¦ä¸²


Go è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²åªæ˜¯ä¸€ä¸ª**åªè¯»**çš„å­—èŠ‚æ•°ç»„ï¼Œä¸‹å›¾å±•ç¤ºäº† `"hello"` å­—ç¬¦ä¸²åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼ï¼š

![](picture/goè¯­è¨€è¦ç‚¹/2019-12-31-15777265631608-in-memory-string.png)

å¦‚æœæ˜¯ä»£ç ä¸­å­˜åœ¨çš„å­—ç¬¦ä¸²ï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶æ ‡è®°æˆåªè¯»æ•°æ® `SRODATA`ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ä»£ç ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå½“æˆ‘ä»¬å°†è¿™æ®µä»£ç ç¼–è¯‘æˆæ±‡ç¼–è¯­è¨€æ—¶ï¼Œå°±èƒ½å¤Ÿçœ‹åˆ° `hello` å­—ç¬¦ä¸²æœ‰ä¸€ä¸ª `SRODATA` çš„æ ‡è®°ï¼š

```bash
$ cat main.go
package main

func main() {
	str := "hello"
	println([]byte(str))
}

$ GOOS=linux GOARCH=amd64 go tool compile -S main.go
...
go.string."hello" SRODATA dupok size=5
	0x0000 68 65 6c 6c 6f                                   hello
...
```

**åªè¯»**åªæ„å‘³ç€å­—ç¬¦ä¸²ä¼šåˆ†é…åˆ°åªè¯»çš„å†…å­˜ç©ºé—´



### 5.1 æ•°æ®ç»“æ„

**å­—ç¬¦ä¸²ç±»å‹è‡ªèº«å­˜å‚¨äº†é•¿åº¦ï¼Œæ‰€ä»¥ä¸éœ€è¦`\0`ä½œä¸ºç»“æŸæ ‡å¿—**

å­—ç¬¦ä¸²åº•å±‚ç»“æ„åœ¨`reflect.StringHeader`ä¸­å®šä¹‰

```go
type StringHeader struct {
	Data uintptr
	Len  int
}
```

å¯ä»¥é€šè¿‡åå°„è·å–é•¿åº¦ï¼š

```go
s := "hello, world"
fmt.Println((*reflect.StringHeader)(unsafe.Pointer(&s)).Len)
```



å­—ç¬¦ä¸²æ˜¯utf8ç¼–ç çš„ï¼Œå­—ç¬¦ä¸²é€šå¸¸è¢«è§£é‡ŠæˆUTF-8ç¼–ç çš„Unicodeç ç‚¹ï¼ˆ`rune`ï¼‰åºåˆ—(ä½¿ç”¨**for rangeå¾ªç¯**å³å¯)

å­—ç¬¦ä¸²æ˜¯**ä¸å¯æ”¹å˜çš„å­—èŠ‚åºåˆ—**ï¼Œlenå‡½æ•°è¿”å›å­—ç¬¦ä¸²çš„**å­—èŠ‚æ•°ç›®**ï¼æ‰€ä»¥ç¬¬iä¸ªå­—èŠ‚å¹¶ä¸ä¸€å®šæ˜¯å­—ç¬¦ä¸²çš„ç¬¬iä¸ªå­—ç¬¦ï¼Œå› ä¸ºå¯¹äºéASCIIå­—ç¬¦çš„UTF8ç¼–ç ä¼šè¦ä¸¤ä¸ªæˆ–å¤šä¸ªå­—èŠ‚

- **stringå¯ä»¥ä¸ºç©ºï¼ˆé•¿åº¦ä¸º0ï¼‰ï¼Œä½†ä¸ä¼šæ˜¯nil**ï¼›
- **stringå¯¹è±¡ä¸å¯ä»¥ä¿®æ”¹**ã€‚

```go
	s := "left foot"
	t := s
	s += "left foot, right foot"[9:]     //æ”¯æŒ åˆ‡ç‰‡æ“ä½œ
	fmt.Println(s)  //left foot, right foot
	fmt.Println(t)  //left foot    ä¸æ”¹å˜åŸæ¥çš„å­—ç¬¦ä¸²ï¼ˆå› ä¸ºå­—ç¬¦ä¸²æ˜¯ä¸å¯å˜çš„ï¼‰
```

å°è¯•ä¿®æ”¹å­—ç¬¦ä¸²çš„å†…éƒ¨æ•°æ®çš„æ“ä½œæ˜¯ç¦æ­¢çš„ï¼š`s[0]='L'. // compile error: cannot assign to s[0]`

```go
	m := "ä½ å¥½"
	fmt.Println(len(m))	//6
	fmt.Println(utf8.RuneCountInString(m))  //2
```

**åŸç”Ÿå­—ç¬¦ä¸²ï¼š** ä½¿ç”¨ä¸€å¯¹åå¼•å·è¡¨ç¤ºåŸç”Ÿå­—ç¬¦ä¸²ï¼ŒåŸç”Ÿå­—ç¬¦ä¸²é‡Œæƒ³è¦ä½¿ç”¨åå¼•å·å¯ä»¥é€šè¿‡æ‹¼æ¥æ™®é€šå­—ç¬¦ä¸²çš„å½¢å¼å®Œæˆ

### 5.2 å­—ç¬¦ä¸²ç¼–ç 

Utf-8ç¼–ç ï¼š

```go
0xxxxxxx                             runes 0-127    (ASCII)
110xxxxx 10xxxxxx                    128-2047       (values <128 unused)
1110xxxx 10xxxxxx 10xxxxxx           2048-65535     (values <2048 unused)
11110xxx 10xxxxxx 10xxxxxx 10xxxxxx  65536-0x10ffff (other values unused)
```

Utf-8ç¼–ç æ˜¯å‰ç¼€ç¼–ç ï¼Œæ²¡æœ‰ä»»ä½•å­—ç¬¦çš„ç¼–ç æ˜¯å…¶å®ƒå­—ç¬¦ç¼–ç çš„å­ä¸²ï¼Œæˆ–æ˜¯å…¶å®ƒç¼–ç åºåˆ—çš„å­—ä¸²ï¼Œå› æ­¤æœç´¢ä¸€ä¸ªå­—ç¬¦æ—¶åªè¦æœç´¢å®ƒçš„å­—èŠ‚ç¼–ç åºåˆ—å³å¯ï¼Œä¸ç”¨æ‹…å¿ƒå‰åçš„ä¸Šä¸‹æ–‡ä¼šå¯¹æœç´¢ç»“æœäº§ç”Ÿå¹²æ‰°

**ç›®å‰rune(unicodeç ç‚¹)åªä½¿ç”¨äº†21ä½**

**utf8è§£ç å™¨**å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£ç åŸç”Ÿçš„utf8ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œå¦å¤–**rangeå¾ªç¯å¤„ç†å­—ç¬¦ä¸²**çš„æ—¶å€™ä¼šéšå¼çš„è§£ç utf8

`for range`ä¸æ”¯æŒéutf8ç¼–ç çš„å­—ç¬¦ä¸²çš„éå†ï¼Œéutf8ç¼–ç çš„å­—ç¬¦ä¸²å¯ä»¥çœ‹åšæ˜¯**åªè¯»çš„äºŒè¿›åˆ¶æ•°ç»„**

**å­—ç¬¦ä¸²ä¸­å®é™…å­˜å‚¨çš„æ˜¯utf8ç¼–ç **ï¼Œä½¿ç”¨for rangeå¯ä»¥è·å¾—runeç ç‚¹



**å¦‚æœä¸æƒ³è§£ç utf8å­—ç¬¦ä¸²**ï¼Œæƒ³ç›´æ¥éå†åŸå§‹å­—èŠ‚ç ï¼Œå¯ä»¥å°†å­—ç¬¦ä¸²å¼ºè½¬ä¸º`[]byte`å­—èŠ‚æ•°ç»„ï¼Œæˆ–è€…ç›´æ¥æŒ‰ç…§ä¸‹æ ‡é¡ºåºè®¿é—®

```go
	s := "aä¸­å›½"
	for i := 0; i < len(s); {   //for range åº•å±‚å…¶å®å°±æ˜¯è¿™ç§æ–¹æ³•
		r, size := utf8.DecodeRuneInString(s[i:])
		fmt.Printf("%d\t%c\n", i, r)
		i += size
	}
	fmt.Println()
	for i, r := range s {
		fmt.Printf("%d\t%c\n", i, r)
	}
/*
0       a
1       ä¸­
4       å›½

0       a
1       ä¸­
4       å›½
*/

	str := "ä¸–"
	for _, c := range []byte(str) {   //è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ï¼Œï¼Œä¸€èˆ¬æ²¡æœ‰è¿è¡Œæ—¶å¼€é”€
		fmt.Printf("%x ", c)
	}
	fmt.Println()
	for i := 0; i < len(str); i++ {  //é€å­—èŠ‚è®¿é—®
		fmt.Printf("%x ", str[i])
	}
	fmt.Println()
	for _, c := range str {  				//æŒ‰runeè®¿é—®
		fmt.Printf("%x  ", c)
	}
/*
e4 b8 96    // 11100100  10111000 10010110
4e16        //     0100    1110  0001 0110
*/

```

**utf8ç¼–ç çš„å­—ç¬¦ä¸²è½¬æ¢ä¸º[]runeçš„unicodeç ç‚¹åºåˆ—([]int32)**ï¼šç¨‹åºå†…éƒ¨ä½¿ç”¨runeåºåˆ—æ›´æ–¹ä¾¿ï¼Œruneå¤§å°ä¸€è‡´ï¼Œæ”¯æŒæ•°ç»„ç´¢å¼•å’Œæ–¹ä¾¿åˆ‡å‰²ã€‚

- ç›´æ¥è¿›è¡Œ[]runeç±»å‹å’Œstringç±»å‹çš„è½¬æ¢å³å¯
- **[]runeå®é™…ä¸Šå°±æ˜¯[]int32ç±»å‹**ï¼Œåªæ˜¯ä¸ªåˆ«åï¼Œä¸æ˜¯é‡æ–°å®šä¹‰çš„ç±»å‹

```go
	//[]rune å’Œ string çš„äº’ç›¸è½¬æ¢

	s = "aä¸­ğŸ¶"
	fmt.Printf("% x\n", s) // "61 e4 b8 ad f0 9f 90 b6"
	r := []rune(s)
	fmt.Printf("%x\n", r) // "[61 4e2d 1f436]"
	fmt.Println(string(r)) // "aä¸­ğŸ¶"

	fmt.Printf("%#v\n", []rune("ä¸–ç•Œ"))    //[]int32{19990, 30028}
	fmt.Printf("%#v\n", string([]rune{'ä¸–', 'ç•Œ'}))   //"ä¸–ç•Œ"
```



**Javaä¸­charæ˜¯2å­—èŠ‚ï¼Œæ‰€ä»¥åªèƒ½ç¼–ç åˆ°unicodeç ç‚¹çš„FFFFï¼Œå³ä¸‰ä¸ªå­—èŠ‚utf-8ç¼–ç ï¼Œå››ä¸ªå­—èŠ‚çš„utf-8ç¼–ç ä¸€ä¸ªcharæ˜¯è£…ä¸ä¸‹çš„ï¼Œéœ€è¦ä¸¤ä¸ªchar**

**Goçš„byteç±»å‹å°±æ˜¯uint8ï¼Œå…¶ä»–è¯­è¨€çš„å­—ç¬¦å®é™…ä¸Šæ˜¯goçš„runeç±»å‹/unicodeç ç‚¹(int32)**

###  5.3 å¸¸ç”¨åŒ…

**å­—ç¬¦ä¸²å’Œbyteåˆ‡ç‰‡ï¼šbytesã€stringsã€strconvã€unicodeåŒ…**

- stringsåŒ…æä¾›äº†è®¸å¤šå¦‚å­—ç¬¦ä¸²çš„æŸ¥è¯¢ã€æ›¿æ¢ã€æ¯”è¾ƒã€æˆªæ–­ã€æ‹†åˆ†å’Œåˆå¹¶ç­‰åŠŸèƒ½ã€‚
- bytesåŒ…ä¹Ÿæä¾›äº†å¾ˆå¤šç±»ä¼¼åŠŸèƒ½çš„å‡½æ•°ï¼Œä½†æ˜¯é’ˆå¯¹å’Œå­—ç¬¦ä¸²æœ‰ç€ç›¸åŒç»“æ„çš„[]byteç±»å‹ã€‚å› ä¸ºå­—ç¬¦ä¸²æ˜¯åªè¯»çš„ï¼Œå› æ­¤é€æ­¥æ„å»ºå­—ç¬¦ä¸²ä¼šå¯¼è‡´å¾ˆå¤šåˆ†é…å’Œå¤åˆ¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨`bytes.Buffer`ç±»å‹å°†ä¼šæ›´æœ‰æ•ˆ
- strconvåŒ…æä¾›äº†å¸ƒå°”å‹ã€æ•´å‹æ•°ã€æµ®ç‚¹æ•°å’Œå¯¹åº”å­—ç¬¦ä¸²çš„ç›¸äº’è½¬æ¢ï¼Œè¿˜æä¾›äº†åŒå¼•å·è½¬ä¹‰ç›¸å…³çš„è½¬æ¢
- unicodeåŒ…æä¾›äº†IsDigitã€IsLetterã€IsUpperå’ŒIsLowerç­‰ç±»ä¼¼åŠŸèƒ½ï¼Œå®ƒä»¬ç”¨äºç»™å­—ç¬¦åˆ†ç±»ã€‚æ¯ä¸ªå‡½æ•°æœ‰ä¸€ä¸ªå•ä¸€çš„runeç±»å‹çš„å‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚è€ŒåƒToUpperå’ŒToLowerä¹‹ç±»çš„è½¬æ¢å‡½æ•°å°†ç”¨äºruneå­—ç¬¦çš„å¤§å°å†™è½¬æ¢ã€‚æ‰€æœ‰çš„è¿™äº›å‡½æ•°éƒ½æ˜¯éµå¾ªUnicodeæ ‡å‡†å®šä¹‰çš„å­—æ¯ã€æ•°å­—ç­‰åˆ†ç±»è§„èŒƒã€‚stringsåŒ…ä¹Ÿæœ‰ç±»ä¼¼çš„å‡½æ•°ï¼Œå®ƒä»¬æ˜¯ToUpperå’ŒToLowerï¼Œå°†åŸå§‹å­—ç¬¦ä¸²çš„æ¯ä¸ªå­—ç¬¦éƒ½åšç›¸åº”çš„è½¬æ¢ï¼Œç„¶åè¿”å›æ–°çš„å­—ç¬¦ä¸²

basenameå‡½æ•°

```go
fmt.Println(basename("a/b/c.go")) // "c"
fmt.Println(basename("c.d.go"))   // "c.d"
fmt.Println(basename("abc"))      // "abc"

func basename(s string) string {
    slash := strings.LastIndex(s, "/") // -1 if "/" not found
    s = s[slash+1:]
    if dot := strings.LastIndex(s, "."); dot >= 0 {
        s = s[:dot]
    }
    return s
}
```

ä¸€ä¸ª[]byte(s)è½¬æ¢æ˜¯åˆ†é…äº†ä¸€ä¸ªæ–°çš„å­—èŠ‚æ•°ç»„ç”¨äºä¿å­˜å­—ç¬¦ä¸²æ•°æ®çš„æ‹·è´ï¼Œç„¶åå¼•ç”¨è¿™ä¸ªåº•å±‚çš„å­—èŠ‚æ•°ç»„..Â å› ä¸ºstringæ˜¯ä¸å¯å˜çš„

**stringsæä¾›çš„å‡½æ•°**å¦‚ä¸‹ï¼š 

```go
func Contains(s, substr string) bool   //æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å­ä¸²
func Count(s, sep string) int   //ç»Ÿè®¡sepçš„æ•°é‡
func Fields(s string) []string  //å»æ‰ç©ºæ ¼ï¼Œå¹¶æŒ‰åŸç©ºæ ¼ä½ç½®è¿›è¡Œåˆ‡å‰²ï¼Œåˆ‡å‰²æˆå­—ç¬¦ä¸²æ•°ç»„
func HasPrefix(s, prefix string) bool
func Index(s, sep string) int   //è¿”å›æŒ‡å®šå­ä¸²çš„å¼€å§‹ä¸‹æ ‡ï¼Œæ‰¾ä¸åˆ°è¿”å›-1
func Join(a []string, sep string) string  //å°†å­—ç¬¦ä¸²åˆ‡ç‰‡ä½¿ç”¨sepæ‹¼æ¥æˆstring
```

**bytesä¹Ÿå¯¹åº”å…­ä¸ªå‡½æ•°**ï¼šå®ƒä»¬ä¹‹é—´å”¯ä¸€çš„åŒºåˆ«æ˜¯å­—ç¬¦ä¸²ç±»å‹å‚æ•°è¢«æ›¿æ¢æˆäº†å­—èŠ‚sliceç±»å‹çš„å‚æ•°ã€‚bytesåŒ…è¿˜æä¾›äº†Bufferç±»å‹ç”¨äºå­—èŠ‚sliceçš„ç¼“å­˜ã€‚ä¸€ä¸ªBufferå¼€å§‹æ˜¯ç©ºçš„ï¼Œä½†æ˜¯éšç€stringã€byteæˆ–[]byteç­‰ç±»å‹æ•°æ®çš„å†™å…¥å¯ä»¥åŠ¨æ€å¢é•¿ï¼Œä¸€ä¸ªbytes.Bufferå˜é‡å¹¶ä¸éœ€è¦åˆå§‹åŒ–ï¼Œå› ä¸ºé›¶å€¼ä¹Ÿæ˜¯æœ‰æ•ˆçš„

```go
func Contains(b, subslice []byte) bool
func Count(s, sep []byte) int
func Fields(s []byte) [][]byte
func HasPrefix(s, prefix []byte) bool
func Index(s, sep []byte) int
func Join(s [][]byte, sep []byte) []byte
```

```go
func intsToString(values []int) string {
    var buf bytes.Buffer
    buf.WriteByte('[')
    for i, v := range values {
        if i > 0 {
            buf.WriteString(", ")
        }
        fmt.Fprintf(&buf, "%d", v)
    }
    buf.WriteByte(']')
    return buf.String()
}
```

**å­—ç¬¦ä¸²å’Œæ•°å­—çš„ç›¸äº’è½¬æ¢**

å°†ä¸€ä¸ªæ•´æ•°è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œä¸€ç§æ–¹æ³•æ˜¯ç”¨fmt.Sprintfè¿”å›ä¸€ä¸ªæ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ï¼›å¦ä¸€ä¸ªæ–¹æ³•æ˜¯ç”¨strconv.Itoa(â€œæ•´æ•°åˆ°ASCIIâ€)ï¼š

```go
x := 123
y := fmt.Sprintf("%d", x)
fmt.Println(y, strconv.Itoa(x)) // 123 123
```

`FormatInt`å’Œ`FormatUint`å‡½æ•°å¯ä»¥ç”¨ä¸åŒçš„è¿›åˆ¶æ¥æ ¼å¼åŒ–æ•°å­—ï¼š

```go
fmt.Println(strconv.FormatInt(int64(x), 2)) // "1111011"
```

å¦‚æœè¦å°†ä¸€ä¸ªå­—ç¬¦ä¸²è§£æä¸ºæ•´æ•°ï¼Œå¯ä»¥ä½¿ç”¨strconvåŒ…çš„`Atoi`æˆ–`ParseInt`å‡½æ•°ï¼Œè¿˜æœ‰ç”¨äºè§£ææ— ç¬¦å·æ•´æ•°çš„ParseUintå‡½æ•°ï¼š

```go
x, err := strconv.Atoi("123")             // x is an int
y, err := strconv.ParseInt("123", 10, 64) // base 10, up to 64 bits
```

## 6. Â å¸¸é‡

- å­—é¢å€¼å¸¸é‡

- constå£°æ˜

- iotaå¸¸é‡ç”Ÿæˆå™¨

**å¸¸é‡èµ‹å€¼åä¸èƒ½è¿›è¡Œä¿®æ”¹**

å¸¸é‡å­˜å‚¨åœ¨æ•°æ®åŒº

### å‘½åå¸¸é‡å’Œå­—é¢å€¼å¸¸é‡

å‘½åå¸¸é‡æ—¢å¯ä»¥ç”³æ˜ä¸º`æ— ç±»å‹`çš„ï¼Œä¹Ÿå¯ä»¥ç”³æ˜ä¸º`æœ‰ç±»å‹`çš„ï¼Œå£°æ˜ä¸€ä¸ªå­—é¢é‡çš„æ—¶å€™ï¼Œå…¶å®æ˜¯å£°æ˜äº†ä¸€ä¸ª`åŒ¿åçš„æ— ç±»å‹å¸¸é‡`

```go
const untypedInteger       = 12345
const untypedFloatingPoint = 3.141592

const typedInteger int           = 12345
const typedFloatingPoint float64 = 3.141592
```



**å¸¸é‡æ˜¯å®Œå…¨ç²¾ç¡®çš„**ï¼Œä¸ç®¡æ˜¯å¤šå¤§çš„æ•´æ•°æˆ–è€…æ˜¯æµ®ç‚¹æ•°ï¼Œéƒ½æ˜¯ç²¾ç¡®çš„ï¼Œè¿™ç‚¹è·Ÿå˜é‡ä¸ä¸€æ ·

å£°æ˜ä¸€ä¸ªæœ‰ç±»å‹å¸¸é‡æ—¶ï¼Œå³è¾¹å¸¸é‡çš„å½¢å¼å¿…é¡»è¦ä¸å·¦è¾¹å¸¸é‡çš„ç±»å‹å…¼å®¹

```go
// è¿œè¿œå¤§äº int64 çš„æ•´æ•°
const myConst = 9223372036854775808543522345    //å¯ä»¥ç¼–è¯‘é€šè¿‡
const myConst int64 = 9223372036854775808543522345  // overflows int64 ä¸ä¼šç¼–è¯‘é€šè¿‡
```



**`å˜é‡ä¹‹é—´`æ˜¯`ä¸ä¼š`è¿›è¡Œéšå¼ç±»å‹è½¬æ¢çš„ï¼Œè€Œ`å¸¸é‡ä¸å˜é‡ä¼š`ç»å¸¸å‘ç”Ÿéšå¼ç±»å‹è½¬æ¢**

```go
var myInt int = 123.0     // æµ®ç‚¹æ•°å¸¸é‡éšå¼è½¬æ¢ä¸ºæ•´å‹å˜é‡
var myInt2 = 123   //çœç•¥å˜é‡ç±»å‹è¿›è¡Œå¸¸é‡-å˜é‡è½¬æ¢ï¼Œï¼Œï¼Œï¼Œé»˜è®¤ä½¿ç”¨ int
```



**å¸¸é‡çš„ç§ç±»æå‡ï¼š** é™¤äº†ç§»ä½è¿ç®—ï¼Œå¦‚æœäºŒå…ƒè¿ç®—çš„æ“ä½œæ•°æ˜¯ä¸åŒç§ç±»çš„æ— ç±»å‹å¸¸é‡ï¼Œè¿ç®—ç»“æœä½¿ç”¨ä»¥ä¸‹ç§ç±»ä¸­æœ€é åçš„ä¸€ä¸ªï¼šæ•´æ•°ã€Unicode å­—ç¬¦ã€æµ®ç‚¹æ•°ã€å¤æ•°

```go
var answer = 3 * 0.333     // answerä¼šæ˜¯æµ®ç‚¹æ•°ç±»å‹ float64
```



**å…³äºæ•°å­—å¸¸é‡çš„æ¯”è¾ƒï¼š**

```go
	a := int64(1)
	b := 1
	fmt.Println(a == 1)     // true , è¿›è¡Œéšå¼ç±»å‹è½¬æ¢æ¯”è¾ƒ
	fmt.Println(b == 1)     // true , åŒä¸Š
	//fmt.Println(a == b)   // mismatched types int64 and int
```



### æ— ç±»å‹å¸¸é‡

è®¸å¤šå¸¸é‡å¹¶æ²¡æœ‰ä¸€ä¸ªæ˜ç¡®çš„åŸºç¡€ç±»å‹ã€‚ç¼–è¯‘å™¨ä¸ºè¿™äº›æ²¡æœ‰æ˜ç¡®åŸºç¡€ç±»å‹çš„æ•°å­—å¸¸é‡æä¾›æ¯”åŸºç¡€ç±»å‹æ›´é«˜ç²¾åº¦çš„ç®—æœ¯è¿ç®—ï¼›ä½ å¯ä»¥è®¤ä¸ºè‡³å°‘æœ‰256bitçš„è¿ç®—ç²¾åº¦ã€‚è¿™é‡Œæœ‰å…­ç§æœªæ˜ç¡®ç±»å‹çš„å¸¸é‡ç±»å‹ï¼Œåˆ†åˆ«æ˜¯æ— ç±»å‹çš„å¸ƒå°”å‹ã€æ— ç±»å‹çš„æ•´æ•°ã€æ— ç±»å‹çš„å­—ç¬¦ã€æ— ç±»å‹çš„æµ®ç‚¹æ•°ã€æ— ç±»å‹çš„å¤æ•°ã€æ— ç±»å‹çš„å­—ç¬¦ä¸²

é™¤æ³•è¿ç®—ç¬¦/ä¼šæ ¹æ®æ“ä½œæ•°çš„ç±»å‹ç”Ÿæˆå¯¹åº”ç±»å‹çš„ç»“æœï¼Œä¸åŒå†™æ³•çš„å¸¸é‡é™¤æ³•å¯èƒ½äº§ç”Ÿä¸åŒçš„ç»“æœ

```go
var f float64 = 212
fmt.Println((f - 32) * 5 / 9)     // "100"; (f - 32) * 5 is a float64
fmt.Println(5 / 9 * (f - 32))     // "0";   5/9 is an untyped integer, 0
fmt.Println(5.0 / 9.0 * (f - 32)) // "100"; 5.0/9.0 is an untyped float
```

åªæœ‰å¸¸é‡å¯ä»¥æ˜¯æ— ç±»å‹çš„ã€‚å½“ä¸€ä¸ªæ— ç±»å‹çš„å¸¸é‡è¢«èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œå°±ä¼šè¿›è¡Œéšå¼çš„ç±»å‹è½¬æ¢

```go
var f float64 = 3 + 0i // untyped complex -> float64 ç›¸å½“äº  var f float64 = float64(3 + 0i)
f = 2                  // untyped integer -> float64 ç›¸å½“äº  f = float64(2)
```

å¯¹äºä¸€ä¸ªæ²¡æœ‰æ˜¾å¼ç±»å‹çš„å˜é‡å£°æ˜ï¼ˆåŒ…æ‹¬ç®€çŸ­å˜é‡å£°æ˜ï¼‰ï¼Œå¸¸é‡çš„å½¢å¼å°†éšå¼å†³å®šå˜é‡çš„é»˜è®¤ç±»å‹ã€‚æ— ç±»å‹æ•´æ•°å¸¸é‡è½¬æ¢ä¸ºintï¼Œå®ƒçš„å†…å­˜å¤§å°æ˜¯ä¸ç¡®å®šçš„ï¼Œä½†æ˜¯æ— ç±»å‹æµ®ç‚¹æ•°å’Œå¤æ•°å¸¸é‡åˆ™è½¬æ¢ä¸ºå†…å­˜å¤§å°æ˜ç¡®çš„float64å’Œcomplex128



# ä¸‰ã€å¤åˆæ•°æ®ç±»å‹

## 1. æ•°ç»„

é•¿åº¦å›ºå®šï¼Œæ‰€ä»¥ä¸€èˆ¬å¾ˆå°‘ç”¨ï¼Œä¸€èˆ¬ç”¨Sliceï¼Œå¯ä»¥åŠ¨æ€æ”¶ç¼©å’Œæ‰©å®¹

**goè¯­è¨€ä¸­æ•°ç»„æ˜¯å€¼è¯­ä¹‰ï¼Œä¸€ä¸ªæ•°ç»„å˜é‡å°±è¡¨ç¤ºæ•´ä¸ªæ•°ç»„ï¼Œè€Œä¸æ˜¯éšå¼æŒ‡å‘ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆ(Cè¯­è¨€)**

æ•°ç»„å˜é‡è¢«èµ‹å€¼æˆ–è€…ä¼ é€’çš„æ—¶å€™ï¼Œä¼š**å¤åˆ¶æ•´ä¸ªæ•°ç»„**ï¼Œä¸ºäº†å‡å°‘å¼€é”€ï¼Œå¯ä»¥ä¼ é€’æ•°ç»„çš„æŒ‡é’ˆï¼Œä½†æ˜¯æ•°ç»„æŒ‡é’ˆå¹¶ä¸æ˜¯æ•°ç»„

```go
const (
	apple int = iota
	banana
	orange
)

func main() {
	arr := []int{apple: 3, orange: 1, banana: 2, 10: 10}
	fmt.Println(arr)   //[3 2 1 0 0 0 0 0 0 0 10]
  
  a := [2]int{1, 2}
  b := [...]int{1:2, 0:1}
  c := [3]int{1,2}
  fmt.Println(a == b)   //true
  fmt.Println(a == c)   //Invalid operation: a == c (mismatched types [2]int and [3]int)
}
```

`[...]T{1, 2, 3}` å’Œ `[3]T{1, 2, 3}` åœ¨è¿è¡Œæ—¶æ˜¯å®Œå…¨ç­‰ä»·çš„ï¼Œ`[...]T` è¿™ç§åˆå§‹åŒ–æ–¹å¼ä¹Ÿåªæ˜¯ Go è¯­è¨€ä¸ºæˆ‘ä»¬æä¾›çš„ä¸€ç§è¯­æ³•ç³–ï¼Œå½“æˆ‘ä»¬ä¸æƒ³è®¡ç®—æ•°ç»„ä¸­çš„å…ƒç´ ä¸ªæ•°æ—¶å¯ä»¥é€šè¿‡è¿™ç§æ–¹æ³•å‡å°‘ä¸€äº›å·¥ä½œé‡

æ•°ç»„ä¼ çš„æ˜¯**å€¼**

```go
	a := [2]int{1, 2}	
	changeArr(a)
	fmt.Println(a)  //[1 2]

func changeArr(arr [2]int) {
	arr = [2]int{9, 9}
}
```

æ•°ç»„ç±»å‹éå¸¸åƒµåŒ–ï¼Œå› ä¸º**æ•°ç»„çš„ç±»å‹ä¸­å°è£…äº†æ•°ç»„çš„é•¿åº¦**ï¼Œåªæœ‰ç›¸åŒé•¿åº¦ç›¸åŒç±»å‹çš„æ•°ç»„æ‰å¯ä»¥è¿›è¡Œå‡½æ•°çš„å‚æ•°ä¼ é€’ï¼Œæ‰€ä»¥å¾ˆå°‘ä½¿ç”¨ï¼Œé™¤éæ˜¯å¯¹ç‰¹å®šé•¿åº¦çš„æ•°ç»„è¿›è¡Œæ“ä½œã€‚ã€‚ä¸€èˆ¬ä½¿ç”¨Sliceæ¥ä»£æ›¿æ•°ç»„

å¯¹æ•°ç»„æ¥è¯´ï¼Œ`Len()`å’Œ`Cap()`çš„å€¼æ˜¯æ°¸è¿œç›¸ç­‰çš„

è¿˜å¯ä»¥å®šä¹‰ç»“æ„ä½“æ•°ç»„ï¼Œå‡½æ•°æ•°ç»„ï¼Œæ¥å£æ•°ç»„ï¼Œé€šé“æ•°ç»„ç­‰



**é•¿åº¦ä¸º0çš„æ•°ç»„ä¸å ç”¨å†…å­˜ç©ºé—´ï¼Œå’Œæ— ç±»å‹çš„ç©ºstructä¸€æ ·å¯ä»¥ç”¨æ¥æ§åˆ¶channel**

### æŒ‡é’ˆæ•°ç»„

æŒ‡é’ˆæ•°ç»„èµ‹å€¼æ—¶æµ…æ‹·è´ï¼ŒæŒ‡é’ˆæŒ‡å‘çš„æ˜¯åŒä¸€ç‰‡å†…å­˜



### æ•°ç»„æŒ‡é’ˆ

```go
var arr [5]int{1,2,3,4,5}
var p *[5]int
p = &arr
fmt.Println((*p)[1])    //2
fmt.Println(p[1])		//2
fmt.Println((&arr)[1])	//2
fmt.Println(&arr[0])	//0xc00001a0e0
fmt.Println(&arr)		//&[1 2 3 4 5]
fmt.Printf("%p\n", &arr)//0xc00001a0e0
```

è®¿é—®æˆå‘˜çš„æ–¹æ³•ï¼š`(*p)[index]`ï¼Œä¹Ÿå¯ä»¥ç®€å†™ä¸º`p[index]`

## 2. Slice

**æ•°ç»„å­˜åœ¨çš„é—®é¢˜ï¼š**

	1. æ•°ç»„å®¹é‡å›ºå®šï¼Œä¸èƒ½è‡ªåŠ¨æ‹“å±•ï¼Œä¸”ç±»å‹æ˜¯å¸¦ç€é•¿åº¦çš„
	2. æ•°ç»„æ˜¯å€¼ä¼ é€’ï¼Œæ•°ç»„ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ä¼šä¼ é€’æ•°ç»„çš„æ‹·è´

Sliceï¼ˆåˆ‡ç‰‡ï¼‰ä»£è¡¨å˜é•¿çš„åºåˆ—ï¼Œåºåˆ—ä¸­æ¯ä¸ªå…ƒç´ éƒ½æœ‰ç›¸åŒçš„ç±»å‹ã€‚ä¸€ä¸ªsliceç±»å‹ä¸€èˆ¬å†™ä½œ[]Tï¼Œå…¶ä¸­Tä»£è¡¨sliceä¸­å…ƒç´ çš„ç±»å‹ã€‚Sliceæ²¡æœ‰å›ºå®šçš„é•¿åº¦

ä¸€ä¸ªsliceç”±ä¸‰ä¸ªéƒ¨åˆ†æ„æˆï¼š**æŒ‡é’ˆã€é•¿åº¦å’Œå®¹é‡**ã€‚æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€ä¸ªsliceå…ƒç´ å¯¹åº”çš„åº•å±‚æ•°ç»„å…ƒç´ çš„åœ°å€ï¼Œè¦æ³¨æ„çš„æ˜¯sliceçš„ç¬¬ä¸€ä¸ªå…ƒç´ å¹¶ä¸ä¸€å®šå°±æ˜¯æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚é•¿åº¦å¯¹åº”sliceä¸­å…ƒç´ çš„æ•°ç›®ï¼›é•¿åº¦ä¸èƒ½è¶…è¿‡å®¹é‡ï¼Œå®¹é‡ä¸€èˆ¬æ˜¯ä»sliceçš„å¼€å§‹ä½ç½®åˆ°åº•å±‚æ•°æ®çš„ç»“å°¾ä½ç½®ã€‚å†…ç½®çš„`len`å’Œ`cap`å‡½æ•°åˆ†åˆ«è¿”å›sliceçš„é•¿åº¦å’Œå®¹é‡

```go
// reflect.SliceHeader
type SliceHeader struct {
	Data uintptr
	Len  int
	Cap  int
}

// runtime.slice
type slice struct {
	array unsafe.Pointer
	len   int
	cap   int
}
```



å¦‚æœåˆ‡ç‰‡æ“ä½œè¶…å‡ºcap(s)çš„ä¸Šé™å°†å¯¼è‡´ä¸€ä¸ªpanicå¼‚å¸¸ï¼Œä½†æ˜¯è¶…å‡ºlen(s)åˆ™æ˜¯æ„å‘³ç€æ‰©å±•äº†sliceï¼Œå› ä¸ºæ–°sliceçš„é•¿åº¦ä¼šå˜å¤§

å’Œæ•°ç»„ä¸åŒçš„æ˜¯ï¼Œ**sliceä¹‹é—´ä¸èƒ½æ¯”è¾ƒ**ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨==æ“ä½œç¬¦æ¥åˆ¤æ–­ä¸¤ä¸ªsliceæ˜¯å¦å«æœ‰å…¨éƒ¨ç›¸ç­‰å…ƒç´ ã€‚ä¸è¿‡æ ‡å‡†åº“æä¾›äº†é«˜åº¦ä¼˜åŒ–çš„`bytes.Equal`å‡½æ•°æ¥åˆ¤æ–­ä¸¤ä¸ªå­—èŠ‚å‹sliceæ˜¯å¦ç›¸ç­‰ï¼ˆ[]byteï¼‰ï¼Œä½†æ˜¯å¯¹äºå…¶ä»–ç±»å‹çš„sliceï¼Œæˆ‘ä»¬å¿…é¡»è‡ªå·±å±•å¼€æ¯ä¸ªå…ƒç´ è¿›è¡Œæ¯”è¾ƒ

- **makeå‡½æ•°**åˆ›å»ºæŒ‡å®šlenå’Œcapçš„Sliceï¼Œçœç•¥capæ—¶capå°†å’Œlenç›¸ç­‰...åº•å±‚å°±æ˜¯**åˆ›å»ºäº†ä¸€ä¸ªåŒ¿åçš„æ•°ç»„**ï¼Œç„¶åè¿”å›Slice

```go
make([]T, len)
make([]T, len, cap) // same as make([]T, cap)[:len]
```

- **å†…ç½®çš„appendå‡½æ•°ç”¨äºå‘sliceè¿½åŠ å…ƒç´ **ï¼šæˆ‘ä»¬ä¸å¤ªå¥½çŸ¥é“æ–°çš„Sliceå’ŒåŸSliceæ˜¯å¦å¼•ç”¨äº†åŒä¸€ä¸ªåº•å±‚æ•°ç»„ï¼ˆå³æ˜¯å¦è¿›è¡Œäº†å†…å­˜çš„é‡æ–°åˆ†é…ï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½ç¡®å®šåœ¨åŸæ¥Sliceä¸Šçš„æ“ä½œæ˜¯å¦ä¼šå½±å“åˆ°æ–°çš„Sliceã€‚å› æ­¤é€šå¸¸ç›´æ¥å°†appendè¿”å›çš„ç»“æœèµ‹å€¼ç»™è¾“å…¥çš„Sliceå˜é‡

```go
runes = append(runes, r)

//appendå‡½æ•°ä¹Ÿå¯ä»¥è¿½åŠ å¤šä¸ªå…ƒç´ ï¼Œæˆ–è€…è¿½åŠ ä¸€ä¸ªslice
x = append(x, 4, 5, 6)
x = append(x, x...) // append the slice x
```



**capå¹¶ä¸æ˜¯æ€»å®¹é‡ï¼Œè€Œæ˜¯åˆ‡ç‰‡èµ·ç‚¹åˆ°æ•°ç»„å³è¾¹ç•Œçš„å®¹é‡**

Slice[i:j] é•¿åº¦ï¼šj-i.  å®¹é‡ï¼šk-i

```go
	a := [5]int{0,1,2,3,4}
	b := a[1:3]
	c := a[2:3]
	fmt.Println(len(b), cap(b))   //2 4
	fmt.Println(len(c), cap(c))   //1 3
```



### ç©ºsliceå’Œnil slice

- ä¸ºnilçš„Sliceæ²¡æœ‰åº•å±‚æ•°ç»„ï¼ˆæ•°ç»„æŒ‡é’ˆæ˜¯nilï¼‰ï¼Œlenå’Œcapéƒ½æ˜¯0ï¼Œå¯ä»¥è¿›è¡Œæ¯”è¾ƒã€‚ä½†æ˜¯énilçš„Sliceä¹Ÿå¯ä»¥lenå’Œcapä¸º0ï¼Œä¸æ™®é€šSliceä¸€æ ·ï¼Œ`Dataç›¸åŒ`

```go
var s []int    // len(s) == 0, s == nil
s = nil        // len(s) == 0, s == nil
s = []int(nil) // len(s) == 0, s == nil
s = []int{}    // len(s) == 0, s != nil
s = make([]int, 0) // len(s) == 0, s != nil


func main() {
	var a []int
	var b []int
	c := make([]int, 0)
	d := make([]int, 0)
	d1 := make([]int, 0)
	d2 := make([]int, 0)
	d3 := make([]int, 0)
	d4 := make([]int, 0)
	d5 := make([]int, 0)
	fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&a)))
	fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&b)))
	fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&c)))
	fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&d)))
	fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&d1)))
	fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&d2)))
	fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&d3)))
	fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&d4)))
	fmt.Println(*(*reflect.SliceHeader)(unsafe.Pointer(&d5)))
}

{0 0 0}
{0 0 0}
{824634367496 0 0}
{824634367496 0 0}
{824634367496 0 0}
{824634367496 0 0}
{824634367496 0 0}
{824634367496 0 0}
{824634367496 0 0}
```

é™¤äº†å’Œnilç›¸ç­‰æ¯”è¾ƒå¤–ï¼Œ**ä¸€ä¸ªnilå€¼çš„sliceçš„è¡Œä¸ºå’Œå…¶å®ƒä»»æ„0é•¿åº¦çš„sliceä¸€æ ·**ï¼›ä¾‹å¦‚reverse(nil)ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚é™¤äº†æ–‡æ¡£å·²ç»æ˜ç¡®è¯´æ˜çš„åœ°æ–¹ï¼Œæ‰€æœ‰çš„`Goè¯­è¨€å‡½æ•°åº”è¯¥ä»¥ç›¸åŒçš„æ–¹å¼å¯¹å¾…nilå€¼çš„sliceå’Œ0é•¿åº¦çš„slice`



**ç©ºsliceç”¨äºå®ç°filter**

```go
func Filter(s []byte, f func(x byte) bool) []byte {
  b := s[:0]
  for _,x := range s {
    if !f(x) {
      b = append(b, x)
    }
  }
  return b
}
```





### åˆ‡ç‰‡æŒ‡é’ˆ

åˆ‡ç‰‡æœ¬èº«å°±åŒ…å«äº†æ•°ç»„çš„æŒ‡é’ˆï¼Œæ‰€ä»¥åˆ‡ç‰‡çš„æŒ‡é’ˆæ˜¯æŒ‡é’ˆçš„æŒ‡é’ˆ

ç”±äºæ˜¯ä¸¤çº§æŒ‡é’ˆï¼Œæ‰€ä»¥è®¿é—®åˆ‡ç‰‡æˆå‘˜ï¼ˆå³æ•°ç»„æˆå‘˜ï¼‰åªèƒ½`(*p)[index]`ä¸èƒ½ç®€å†™



å½“ slice ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ç»“æ„ä½“ã€‚è‹¥ç›´æ¥ä¼  sliceï¼Œåœ¨è°ƒç”¨è€…çœ‹æ¥ï¼Œå®å‚ slice å¹¶ä¸ä¼šè¢«å‡½æ•°ä¸­çš„æ“ä½œæ”¹å˜ï¼›è‹¥ä¼ çš„æ˜¯ slice çš„æŒ‡é’ˆï¼Œåœ¨è°ƒç”¨è€…çœ‹æ¥ï¼Œæ˜¯ä¼šè¢«æ”¹å˜åŸ slice çš„ã€‚

å€¼çš„æ³¨æ„çš„æ˜¯ï¼Œä¸ç®¡ä¼ çš„æ˜¯ slice è¿˜æ˜¯ slice æŒ‡é’ˆï¼Œå¦‚æœæ”¹å˜äº† slice åº•å±‚æ•°ç»„çš„æ•°æ®ï¼Œä¼šååº”åˆ°å®å‚ slice çš„åº•å±‚æ•°æ®ã€‚åº•å±‚æ•°æ®åœ¨ slice ç»“æ„ä½“é‡Œæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä»…ç®¡ slice ç»“æ„ä½“è‡ªèº«ä¸ä¼šè¢«æ”¹å˜ï¼Œä¹Ÿå°±æ˜¯è¯´åº•å±‚æ•°æ®åœ°å€ä¸ä¼šè¢«æ”¹å˜ã€‚ ä½†æ˜¯é€šè¿‡æŒ‡å‘åº•å±‚æ•°æ®çš„æŒ‡é’ˆï¼Œå¯ä»¥æ”¹å˜åˆ‡ç‰‡çš„åº•å±‚æ•°æ®

```go
func main() {
	s := []int{1, 1, 1}
	f(s)
	fmt.Println(s)
}

func f(s []int) {
	// iåªæ˜¯ä¸€ä¸ªå‰¯æœ¬ï¼Œä¸èƒ½æ”¹å˜sä¸­å…ƒç´ çš„å€¼
	/*for _, i := range s {
		i++
	}
	*/

	for i := range s {
		s[i] += 1
	}
}
```

è¿è¡Œä¸€ä¸‹ï¼Œç¨‹åºè¾“å‡ºï¼š

```go
[2 2 2]
```

æœçœŸæ”¹å˜äº†åŸå§‹ slice çš„åº•å±‚æ•°æ®ã€‚è¿™é‡Œä¼ é€’çš„æ˜¯ä¸€ä¸ª slice çš„å‰¯æœ¬ï¼Œåœ¨ `f` å‡½æ•°ä¸­ï¼Œ`s` åªæ˜¯ `main` å‡½æ•°ä¸­ `s` çš„ä¸€ä¸ªæ‹·è´ã€‚åœ¨`f` å‡½æ•°å†…éƒ¨ï¼Œå¯¹ `s` çš„ä½œç”¨å¹¶ä¸ä¼šæ”¹å˜å¤–å±‚ `main` å‡½æ•°çš„ `s`ã€‚

è¦æƒ³çœŸçš„æ”¹å˜å¤–å±‚ `slice`ï¼Œåªæœ‰å°†è¿”å›çš„æ–°çš„ slice èµ‹å€¼åˆ°åŸå§‹ sliceï¼Œæˆ–è€…å‘å‡½æ•°ä¼ é€’ä¸€ä¸ªæŒ‡å‘ slice çš„æŒ‡é’ˆï¼š

```go
func myAppend(s []int) []int {
	// è¿™é‡Œ s è™½ç„¶æ”¹å˜äº†ï¼Œä½†å¹¶ä¸ä¼šå½±å“å¤–å±‚å‡½æ•°çš„ s
	s = append(s, 100)
	return s
}

func myAppendPtr(s *[]int) {
	// ä¼šæ”¹å˜å¤–å±‚ s æœ¬èº«
	*s = append(*s, 100)
	return
}

func main() {
	s := []int{1, 1, 1}
	newS := myAppend(s)

	fmt.Println(s)
	fmt.Println(newS)

	s = newS

	myAppendPtr(&s)
	fmt.Println(s)
}

//è¿è¡Œç»“æœ
//[1 1 1]
//[1 1 1 100]
//[1 1 1 100 100]
```



### åˆ‡ç‰‡æ‰©å®¹

æºä»£ç ä½äº runtime/slice.go ä¸­

```go
func growslice(et *_type, old slice, cap int) slice {  //capæ˜¯æ‰©å®¹åæœŸæœ›çš„æœ€å°å®¹é‡ï¼Œå³oldCap+appendCap
 ...
 newcap := old.cap
 doublecap := newcap + newcap
 if cap > doublecap {
  newcap = cap
 } else {
  if old.cap < 1024 {
   newcap = doublecap
  } else {
   for 0 < newcap && newcap < cap {
    newcap += newcap / 4
   }
   if newcap <= 0 {
    newcap = cap
   }
  }
 }
 ...
}
```

å¦‚æœ**æœŸæœ›å®¹é‡å¤§äºå½“å‰å®¹é‡çš„ä¸¤å€**å°±ä¼šä½¿ç”¨æœŸæœ›å®¹é‡

å¦åˆ™å¦‚æœå½“å‰åˆ‡ç‰‡çš„é•¿åº¦å°äº 1024 å°±ä¼šå°†å®¹é‡ç¿»å€ï¼› å¦‚æœå½“å‰åˆ‡ç‰‡çš„é•¿åº¦å¤§äº 1024 å°±ä¼šæ¯æ¬¡å¢åŠ  25% çš„å®¹é‡ï¼Œç›´åˆ°æ–°å®¹é‡å¤§äºæœŸæœ›å®¹é‡

```go
  // ä¾‹å¦‚
	s := []string{"a", "b"}
	s = append(s, "c", "d", "e")
	fmt.Printf("%d %d", len(s), cap(s))  //cap=5 > doublecap=4, æ‰€ä»¥è®¡ç®—å¾—åˆ° 5ï¼Œ5

	a := []int{1, 2}
	a = append(a, 4, 5, 6)
	fmt.Printf("%d %d", len(a), cap(a))  //è¿è¡Œç»“æœï¼š5,6 ???
```



ä¸Šé¢åªæ˜¯ç¡®å®šåˆ‡ç‰‡çš„å¤§è‡´å®¹é‡ï¼Œæ¥ä¸‹æ¥**è¿˜éœ€è¦æ ¹æ®åˆ‡ç‰‡ä¸­å…ƒç´ çš„å¤§å°å¯¹å®ƒä»¬è¿›è¡Œå†…å­˜å¯¹é½**ï¼Œæ‰€ä»¥æ–°Sliceçš„å®¹é‡ä¼šå¤§äºç­‰äºè€Sliceçš„ä¸¤å€æˆ–è€…1.25å€çš„

```go
capmem := roundupsize(uintptr(newcap) * uintptr(et.size))
newcap = int(capmem / ptrSize)
```

newcapå°±æ˜¯å‰é¢è®¡ç®—å‡ºçš„newcapï¼Œet.sizeä»£è¡¨sliceä¸­ä¸€ä¸ªå…ƒç´ çš„å¤§å°ï¼Œ**capmemè®¡ç®—å‡ºæ¥çš„æ˜¯æ­¤æ¬¡æ‰©å®¹éœ€è¦ç”³è¯·çš„å†…å­˜å¤§å°**ã€‚**roundupsizeå‡½æ•°æ˜¯å¤„ç†å†…å­˜å¯¹é½çš„å‡½æ•°**

ä¸Šé¢çš„ä¾‹å­ï¼Œroundupsizeå‡½æ•°ä¼šä¼ å…¥ 5*8 = 40

```go
func roundupsize(size uintptr) uintptr {
	if size < _MaxSmallSize {
		if size <= smallSizeMax-8 {
			return uintptr(class_to_size[size_to_class8[(size+smallSizeDiv-1)/smallSizeDiv]])
		} else {
			//â€¦â€¦
		}
	}
    //â€¦â€¦
}

const _MaxSmallSize = 32768
const smallSizeMax = 1024
const smallSizeDiv = 8
```

å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬æœ€ç»ˆå°†è¿”å›è¿™ä¸ªå¼å­çš„ç»“æœï¼š

```go
class_to_size[size_to_class8[(size+smallSizeDiv-1)/smallSizeDiv]]
```

(size+smallSizeDiv-1)/smallSizeDivï¼Œå…¶å®å°±æ˜¯ sizeâ—smallSizeDivçš„ç»“æœå‘ä¸Šå–æ•´

è¿™æ˜¯ `Go` æºç ä¸­æœ‰å…³å†…å­˜åˆ†é…çš„ä¸¤ä¸ª `slice`ã€‚`class_to_size`é€šè¿‡ `spanClass`è·å– `span`åˆ’åˆ†çš„ `object`å¤§å°ã€‚è€Œ `size_to_class8` è¡¨ç¤ºé€šè¿‡ `size` è·å–å®ƒçš„ `spanClass`ã€‚

```go
var size_to_class8 = [smallSizeMax/smallSizeDiv + 1]uint8{0, 1, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 18, 18, 19, 19, 19, 19, 20, 20, 20, 20, 21, 21, 21, 21, 22, 22, 22, 22, 23, 23, 23, 23, 24, 24, 24, 24, 25, 25, 25, 25, 26, 26, 26, 26, 26, 26, 26, 26, 27, 27, 27, 27, 27, 27, 27, 27, 28, 28, 28, 28, 28, 28, 28, 28, 29, 29, 29, 29, 29, 29, 29, 29, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31}

var class_to_size = [_NumSizeClasses]uint16{0, 8, 16, 32, 48, 64, 80, 96, 112, 128, 144, 160, 176, 192, 208, 224, 240, 256, 288, 320, 352, 384, 416, 448, 480, 512, 576, 640, 704, 768, 896, 1024, 1152, 1280, 1408, 1536, 1792, 2048, 2304, 2688, 3072, 3200, 3456, 4096, 4864, 5376, 6144, 6528, 6784, 6912, 8192, 9472, 9728, 10240, 10880, 12288, 13568, 14336, 16384, 18432, 19072, 20480, 21760, 24576, 27264, 28672, 32768}
```

æˆ‘ä»¬ä¼ è¿›å»çš„ `size` ç­‰äº 40ã€‚æ‰€ä»¥ `(size+smallSizeDiv-1)/smallSizeDiv = 5`ï¼›è·å– `size_to_class8` æ•°ç»„ä¸­ç´¢å¼•ä¸º `5` çš„å…ƒç´ ä¸º `4`ï¼›è·å– `class_to_size` ä¸­ç´¢å¼•ä¸º `4` çš„å…ƒç´ ä¸º `48`ã€‚

æœ€ç»ˆï¼Œæ–°çš„ slice çš„å®¹é‡ä¸º `6`ï¼š

```go
newcap = int(capmem / ptrSize) // 6
```



### åˆå¹¶åˆ‡ç‰‡ä¸åˆ é™¤å…ƒç´ 

```go
	a := [5]int{0, 1, 2, 3, 4}
	b := a[1:]
	c := a[1:2]
	c = append(c, b...)   //è§£æ„ï¼Œå°†ä¸€ä¸ªåˆ‡ç‰‡çš„æ‰€æœ‰å…ƒç´ è¿½åŠ åˆ°å¦ä¸€ä¸ªåˆ‡ç‰‡é‡Œ
	fmt.Println(b)  //[1 2 3 4]
	fmt.Println(c)  //[1 1 2 3 4]
```

ç”±äºappendè¿”å›äº†åˆ‡ç‰‡ï¼Œæ‰€ä»¥è¿˜å¯ä»¥å°†å¤šä¸ªappendæ“ä½œç»„åˆèµ·æ¥ï¼Œå®ç°åœ¨åˆ‡ç‰‡ä¸­é—´æ’å…¥å…ƒç´ 

```go
var a []int
a = append( a[:i], append([]int{1,2,3}, a[i:]...)... )   //åœ¨ç¬¬iä¸ªä½ç½®æ’å…¥åˆ‡ç‰‡
```

ä¸ºäº†é¿å…appendåˆ›å»ºä¸­é—´çš„ä¸´æ—¶åˆ‡ç‰‡ï¼Œå¯ä»¥ä½¿ç”¨`copy()å’Œappend()`ç»„åˆï¼šå®ƒä»¬ä¼šæ”¹å˜åº•å±‚æ•°ç»„

```go
a = append(a, x...)   //ä¿è¯åˆ‡ç‰‡ a æ‰©å±•åˆ°è¶³å¤Ÿçš„ç©ºé—´,æ²¡æœ‰å¯ä»¥ç›´æ¥æ‰©å±•åˆ‡ç‰‡çš„æ–¹æ³•
copy(a[i+len(x):], a[i:])
copy(a[i:], x)
```



åˆ©ç”¨copy()å‡½æ•°å®ç°åˆ é™¤å¼€å¤´å…ƒç´ 

```go
a = a[ : copy(a, a[N:] )]   //åˆ é™¤açš„å‰Nä¸ªå…ƒç´ 
```



åˆ©ç”¨append()åˆ é™¤ä¸­é—´å…ƒç´ 

```go
a = append( a[:i], a[i+N:] )   //åˆ é™¤ä»iå¼€å§‹çš„Nä¸ªå…ƒç´ 
```



åˆ©ç”¨copy()åˆ é™¤ä¸­é—´å…ƒç´ 

```go
a = a[ : i + copy(a[i:], a[i+N:])]    //åˆ é™¤ä»iå¼€å§‹çš„Nä¸ªå…ƒç´ 
```



### ä½¿ç”¨ç¬¬ä¸‰ä¸ªç´¢å¼•ä¿æŠ¤åº•å±‚æ•°ç»„

æœªä½¿ç”¨ç¬¬ä¸‰ä¸ªç´¢å¼•ï¼š

```go
	a := [5]int{0, 1, 2, 3, 4}
	b := a[1:]
	c := a[1:2]
	c = append(c, 200)
	fmt.Println(a)  //[0 1 200 3 4]
	fmt.Println(b)  //[1 200 3 4]
	fmt.Println(c)  //[1 200]
```

ä½¿ç”¨ç¬¬ä¸‰ä¸ªç´¢å¼•ï¼Œé™åˆ¶åˆ‡ç‰‡çš„å®¹é‡ï¼Œä¿æŠ¤åº•å±‚æ•°ç»„ã€‚å¦‚æœé™åˆ¶æ–°åˆ‡ç‰‡å®¹é‡å’Œé•¿åº¦ä¸€æ ·ï¼Œå°±å¯ä»¥åœ¨ç¬¬ä¸€ä¸ªappendæ“ä½œåˆ›å»ºæ–°çš„åº•å±‚æ•°ç»„ï¼Œä¸åŸæœ‰æ•°ç»„åˆ†ç¦»ï¼Œå®‰å…¨çš„è¿›è¡Œåç»­çš„ä¿®æ”¹

æŒ‡å®šåˆ‡ç‰‡ slice[i:j:k]ï¼Œåˆ™**é•¿åº¦ j-iï¼Œ å®¹é‡ k-i**

```go
	a := [5]int{0, 1, 2, 3, 4}
	b := a[1:]
	c := a[1:2:2]  //å®¹é‡ä¸º1
	c = append(c, 200)
	fmt.Println(a)  //[0 1 2 3 4]
	fmt.Println(b)  //[1 2 3 4]
	fmt.Println(c)  //[1 200]
```



### rangeè¿­ä»£sliceçš„é—®é¢˜

```go
func main() {
	slice := []int{1, 2, 3}
	for i, v := range slice {
		fmt.Printf("v:%d, v_addr:%p, elem_addr:%p\n", v, &v, &slice[i])
	}
}

// v:1, v_addr:0xc000018080, elem_addr:0xc000014180
// v:2, v_addr:0xc000018080, elem_addr:0xc000014188
// v:3, v_addr:0xc000018080, elem_addr:0xc000014190
```

væ¯æ¬¡éƒ½æ˜¯slice**å¯¹åº”çš„å€¼çš„ä¸€ä¸ªæ‹·è´**ï¼Œå¯¹vä¿®æ”¹æ˜¯ä¸ä¼šå¯¹åŸsliceèµ·ä½œç”¨çš„

ä½†**vçš„åœ°å€æ²¡æœ‰å˜åŒ–**ï¼Œæ‰€ä»¥for rangeé‡Œä½¿ç”¨é—­åŒ…ä¼šæœ‰é—®é¢˜ï¼Œåé¢é—­åŒ…éƒ¨åˆ†è¯¦è§£



### åˆ‡ç‰‡å¼•èµ·å†…å­˜æ³„æ¼é—®é¢˜

```go
func FindPhoneNumber(filename string) []byte {
  b,_ := ioutil.ReadFile(filename)
  return regexp.MustComplile("[0-9]+").Find(b)
}
```

è¿™æ®µä»£ç å°†åŠ è½½æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜ï¼Œç„¶åæœç´¢ç¬¬ä¸€ä¸ªå‡ºç°çš„ç”µè¯å·ç ï¼Œæœ€åä»¥åˆ‡ç‰‡æ–¹å¼è¿”å›

ä½†æ˜¯ç”±äºåˆ‡ç‰‡å¼•ç”¨äº†æ•´ä¸ªåŸå§‹æ•°ç»„ï¼Œå¯¼è‡´åƒåœ¾å›æ”¶æœŸä¸èƒ½åŠæ—¶é‡Šæ”¾åº•å±‚æ•°ç»„çš„ç©ºé—´ï¼Œéœ€è¦é•¿æ—¶é—´ä¿å­˜æ•´ä¸ªæ–‡ä»¶æ•°æ®ï¼Œé™ä½ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½

```go
func FindPhoneNumber(filename string) []byte {
  b,_ := ioutil.ReadFile(filename)
  b = regexp.MustComplile("[0-9]+").Find(b)
  return append( []byte{}, b...)   //è¿”å›ä¸€ä¸ªæ–°åˆ†é…å†…å­˜çš„åˆ‡ç‰‡
}
```



å†ä¾‹å¦‚ï¼Œä½¿ç”¨ `ioutil.ReadAll` è¯»å–äº†ä¸€ä¸ª10Mçš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶å‰512Kåˆ‡ç‰‡ä¸ºå¦å¤–ä¸€ä¸ªslice bä½¿ç”¨ã€‚åªè¦bè¿˜è¢«å¼•ç”¨ï¼Œé‚£ä¹ˆå…¶æŒ‡å‘çš„åº•å±‚æ•°ç»„ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚

### åˆ‡ç‰‡å¼ºåˆ¶ç±»å‹è½¬æ¢

å°†`[]float64` ç±»å‹çš„åˆ‡ç‰‡è½¬æ¢ä¸º`[]int`ç±»å‹ä»¥è¿›è¡Œé«˜é€Ÿæ’åº

éœ€è¦`unsafe.Pointer`æ¥è¿æ¥ä¸¤ä¸ªä¸åŒç±»å‹çš„æŒ‡é’ˆä¼ é€’

```go
func SortFloat64V1(a []float64) {
  //å¼ºè½¬æ–¹æ³•1ï¼Œå°†åˆ‡ç‰‡èµ·å§‹åœ°å€è½¬æ¢ä¸ºä¸€ä¸ªè¾ƒå¤§çš„æ•°ç»„æŒ‡é’ˆï¼Œç„¶åé‡æ–°åˆ‡ç‰‡
  var b []int = ((*[1<<20]int)(unsafe.Pointer(&a[0])))[:len(a):cap(a)]
  sort.Ints(b)
}

func SortFloat64V2(a []float64) {
  var c []int
  //å¼ºè½¬æ–¹æ³•2ï¼Œä½¿ç”¨reflect
  aHdr := (*reflect.SliceHeader)(unsafe.Pointer(&a))
  cHdr := (*reflect.SliceHeader)(unsafe.Pointer(&c))
	*cHdr = *aHdr
  sort.Ints(c)
}
```



### åˆ‡ç‰‡è¿˜æ˜¯ä¼ å€¼

åªæ˜¯åˆ‡ç‰‡ä¸­åŒ…å«äº† Len Cap å’Œä¸€ä¸ªæ•°ç»„æŒ‡é’ˆï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä¿®æ”¹ åˆ‡ç‰‡å†…å®¹



### append ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„

```go
var s []int
    var wg sync.WaitGroup
    for i := 0; i < 10; i++ {
        wg.Add(1)
        go func(i int) {
            s = append(s, i)
            wg.Done()
        }(i)
    }
    wg.Wait()
    fmt.Println(s)
```

ä¸€ç§å¯èƒ½çš„è¾“å‡ºï¼š[0 6 7 9]



### å¼ºè¡Œä¿®æ”¹Capåappendä¼šä¸ä¼šæ‰©å®¹

```go
	a := [3]int{1, 2, 3}
	c := a[:2]
	fmt.Printf("addr_c[0]: %p\n", &c[0])
	f := (*reflect.SliceHeader)(unsafe.Pointer(&c))
	f.Cap = 10
	g := (*[]int)(unsafe.Pointer(f))
	fmt.Printf("addr_g[0]: %p\n", &(*g)[0])
	fmt.Println(f.Len)
	fmt.Println(f.Cap)
	fmt.Println(len(*g))
	fmt.Println(cap(*g))
	i := append(*g, 2, 2, 2, 2, 2)
	fmt.Printf("addr_i[0]: %p\n", &i[0])


/*
addr_c[0]: 0xc0000a0220
addr_g[0]: 0xc0000a0220
2
10
2
10
addr_i[0]: 0xc0000a0220
*/
```

æ²¡æœ‰æ‰©å®¹ã€‚ã€‚ã€‚ä¼šä¸ä¼šå†…å­˜ä¸å®‰å…¨?



## 3. Map

mapç±»å‹å¯ä»¥å†™ä¸ºmap[K]Vï¼Œä¸€ä¸ªmapä¸­æ‰€æœ‰çš„keyéƒ½æ˜¯ç›¸åŒçš„ç±»å‹ï¼Œæ‰€æœ‰çš„valueä¹Ÿéƒ½æ˜¯ç›¸åŒçš„ç±»å‹

**key**å¯ä»¥æ˜¯ä»»ä½•å€¼ï¼Œä½†**å¿…é¡»æ”¯æŒ`==`æ“ä½œ**ï¼Œ**åˆ‡ç‰‡ã€å‡½æ•°ä»¥åŠåŒ…å«åˆ‡ç‰‡çš„ç»“æ„ä½“**ç±»å‹å…·æœ‰å¼•ç”¨è¯­ä¹‰ï¼Œä¸èƒ½ä½œä¸ºmapçš„key

ç»“æ„ä½“æ”¯æŒ`==`æ“ä½œçš„å‰ææ˜¯ï¼Œç»“æ„ä½“çš„æ¯ä¸ªæˆå‘˜éƒ½æ”¯æŒ`==`æ“ä½œ

åˆ›å»ºmapï¼š

```go
//1.
ages := make(map[string]int) // mapping from strings to ints

//2.
ages := map[string]int{
    "alice":   31,
    "charlie": 34,
}

//3.åˆ›å»ºä¸€ä¸ªç©ºçš„map
ages := map[string]int{}
```

åˆ é™¤mapä¸­çš„å…ƒç´ ï¼šè¿™ä¸ªæ“ä½œæ˜¯å®‰å…¨çš„ï¼Œå½“åˆ é™¤æŸä¸ªmapä¸­ä¸å­˜åœ¨çš„keyæ—¶ï¼Œä¼šè¿”å›valueå¯¹åº”çš„é›¶å€¼ï¼Œ**`ä½†æ˜¯å¹¶ä¸ä¼šåœ¨mapä¸­æ·»åŠ æ–°çš„é”®å€¼å¯¹`**

```go
delete(ages, "alice") // remove element ages["alice"]
ages["bob"] = ages["bob"] + 1 //ä¸å­˜åœ¨bobä¹Ÿæ˜¯å®‰å…¨çš„ï¼Œé¦–æ¬¡è®¿é—®è¿”å›0å€¼
ages["lili"]++   //å’Œä¸Šé¢æ„æ€ä¸€æ ·
```

- **å¯¹mapçš„å…ƒç´ å–å€çš„æ“ä½œæ˜¯ä¸å…è®¸çš„**ï¼Œä¾‹å¦‚`_ = &ages["bob"]`ï¼Œè¿™æ˜¯å› ä¸ºéšç€mapçš„å¢é•¿ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜é‡æ–°åˆ†é…ï¼Œä»è€Œä¹‹å‰çš„åœ°å€å¤±æ•ˆ
- ä½¿ç”¨rangeè¿­ä»£è®¿é—®mapçš„è®¿é—®é¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œæ¯æ¬¡éå†é¡ºåºéƒ½ä¸ç›¸åŒ
- è¦æ’åºkeyçš„æ–¹å¼è¾“å‡ºvalueï¼Œå¯ä»¥å…ˆè·å–å…¨éƒ¨çš„keyï¼Œæ’åºä¹‹åå†ä¾æ¬¡è·å–value

éœ€è¦æ³¨æ„ï¼š**ä½¿ç”¨varå£°æ˜çš„mapæ˜¯ä¸€ä¸ªnil**ï¼Œä¸å¯ä»¥è¿›è¡Œæ·»åŠ å…ƒç´ æ“ä½œï¼Œåº”è¯¥ä½¿ç”¨makeåˆ›å»ºä¸€ä¸ªä¸ä¸ºnilçš„map

mapä¹‹é—´ä¸èƒ½è¿›è¡Œæ¯”è¾ƒï¼Œä½†å¯ä»¥è¿›è¡Œnilçš„mapçš„æ¯”è¾ƒ

```go
	//var ages map[string]int
	ages := make(map[string]int)

	ages["lilei"] = 1  //ä½¿ç”¨varå£°æ˜çš„è¯ï¼Œä¼šæŠ¥ panic: assignment to entry in nil map
	ages["xiaohong"] = 2
	for name, age := range ages {
		fmt.Println(name, age)
	}
```

**åˆ¤æ–­mapä¸­æ˜¯å¦åŒ…å«æŸä¸ªkey**

```go
if age, ok := ages["bob"]; !ok { /* ... */ }
```







### ç©ºmapå’Œnil map

```go
	var ages map[string]int    // nil
	ages1 := make(map[string]int, 0)  // != nil
	ages2 := map[string]int{}  // != nil
	ages3 := map[string]int(nil)  // nil
```

å‘nilçš„mapä¸­æ·»åŠ å…ƒç´ ä¼šå¯¼è‡´ `panic: runtime error: assignment to entry in nil map`



### mapçš„åˆå§‹åŒ–

**å­—é¢é‡ï¼š**

```go
hash := map[string]int{
	"1": 2,
	"3": 4,
	"5": 6,
}
```

è¿™ç§ä½¿ç”¨å­—é¢é‡åˆå§‹åŒ–çš„æ–¹å¼æœ€ç»ˆéƒ½ä¼šé€šè¿‡ [`cmd/compile/internal/gc.maplit`](https://draveness.me/golang/tree/cmd/compile/internal/gc.maplit) åˆå§‹åŒ–

å½“å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ æ•°é‡å°‘äºæˆ–è€…ç­‰äº 25 ä¸ªæ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å­—é¢é‡åˆå§‹åŒ–çš„ç»“æ„ä½“è½¬æ¢æˆä»¥ä¸‹çš„ä»£ç ï¼Œå°†æ‰€æœ‰çš„é”®å€¼å¯¹ä¸€æ¬¡åŠ å…¥åˆ°å“ˆå¸Œè¡¨ä¸­ã€‚

```go
hash := make(map[string]int, 3)
hash["1"] = 2
hash["3"] = 4
hash["5"] = 6
```

ä¸€æ—¦å“ˆå¸Œè¡¨ä¸­å…ƒç´ çš„æ•°é‡è¶…è¿‡äº† 25 ä¸ªï¼Œç¼–è¯‘å™¨ä¼šåˆ›å»ºä¸¤ä¸ªæ•°ç»„åˆ†åˆ«å­˜å‚¨é”®å’Œå€¼ï¼Œè¿™äº›é”®å€¼å¯¹ä¼šé€šè¿‡å¦‚ä¸‹æ‰€ç¤ºçš„ for å¾ªç¯åŠ å…¥å“ˆå¸Œï¼š

```go
hash := make(map[string]int, 26)
vstatk := []string{"1", "2", "3", ... ï¼Œ "26"}
vstatv := []int{1, 2, 3, ... , 26}
for i := 0; i < len(vstak); i++ {
    hash[vstatk[i]] = vstatv[i]
}
```



**è¿è¡Œæ—¶ï¼š**

å½“åˆ›å»ºçš„å“ˆå¸Œè¢«åˆ†é…åˆ°æ ˆä¸Šå¹¶ä¸”å…¶å®¹é‡å°äº `BUCKETSIZE = 8` æ—¶ï¼ŒGo è¯­è¨€åœ¨ç¼–è¯‘é˜¶æ®µä¼šä½¿ç”¨å¦‚ä¸‹æ–¹å¼å¿«é€Ÿåˆå§‹åŒ–å“ˆå¸Œï¼Œè¿™ä¹Ÿæ˜¯ç¼–è¯‘å™¨å¯¹å°å®¹é‡çš„å“ˆå¸Œåšçš„ä¼˜åŒ–ï¼š

```go
var h *hmap
var hv hmap
var bv bmap
h := &hv
b := &bv
h.buckets = b
h.hash0 = fashtrand0()
```

é™¤äº†ä¸Šè¿°ç‰¹å®šçš„ä¼˜åŒ–ä¹‹å¤–ï¼Œæ— è®º `make` æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Œåªè¦æˆ‘ä»¬ä½¿ç”¨ `make` åˆ›å»ºå“ˆå¸Œï¼ŒGo è¯­è¨€ç¼–è¯‘å™¨éƒ½ä¼šåœ¨ç±»å‹æ£€æŸ¥æœŸé—´å°†å®ƒä»¬è½¬æ¢æˆ `runtime.makemap`ï¼Œä½¿ç”¨å­—é¢é‡åˆå§‹åŒ–å“ˆå¸Œä¹Ÿåªæ˜¯è¯­è¨€æä¾›çš„è¾…åŠ©å·¥å…·ï¼Œæœ€åè°ƒç”¨çš„éƒ½æ˜¯ `runtime.makemap`



```go
// makemap implements Go map creation for make(map[k]v, hint).
// If the compiler has determined that the map or the first bucket
// can be created on the stack, h and/or bucket may be non-nil.
// If h != nil, the map can be created directly in h.
// If h.buckets != nil, bucket pointed to can be used as the first bucket.
func makemap(t *maptype, hint int, h *hmap) *hmap {
	mem, overflow := math.MulUintptr(uintptr(hint), t.bucket.size)
	if overflow || mem > maxAlloc {
		hint = 0
	}

	// initialize Hmap
	if h == nil {
		h = new(hmap)
	}
	h.hash0 = fastrand()

	// Find the size parameter B which will hold the requested # of elements.
	// For hint < 0 overLoadFactor returns false since hint < bucketCnt.
    // ä¸»è¦ç®—å‡ºBçš„å€¼ï¼Œç›´åˆ° æ¡¶çš„æ•°é‡ * 6.5ï¼ˆè£…è½½å› å­ï¼‰ >= hint
	B := uint8(0)
	for overLoadFactor(hint, B) {
		B++
	}
	h.B = B

	// allocate initial hash table
	// if B == 0, the buckets field is allocated lazily later (in mapassign)
	// If hint is large zeroing this memory could take a while.
	if h.B != 0 {
		var nextOverflow *bmap
		h.buckets, nextOverflow = makeBucketArray(t, h.B, nil)
		if nextOverflow != nil {
			h.extra = new(mapextra)
			h.extra.nextOverflow = nextOverflow
		}
	}

	return h
}

// makeBucketArray initializes a backing array for map buckets.
// 1<<b is the minimum number of buckets to allocate.
// dirtyalloc should either be nil or a bucket array previously
// allocated by makeBucketArray with the same t and b parameters.
// If dirtyalloc is nil a new backing array will be alloced and
// otherwise dirtyalloc will be cleared and reused as backing array.
func makeBucketArray(t *maptype, b uint8, dirtyalloc unsafe.Pointer) (buckets unsafe.Pointer, nextOverflow *bmap) {
	base := bucketShift(b)
	nbuckets := base
	// For small b, overflow buckets are unlikely.
	// Avoid the overhead of the calculation.
    // å¦‚æœBå¤§äºç­‰äº0ï¼Œè¿˜è¦é¢„åˆ†é…ä¸€éƒ¨åˆ†æ¡¶ç”¨ä½œæº¢å‡ºæ¡¶
	if b >= 4 {
		// Add on the estimated number of overflow buckets
		// required to insert the median number of elements
		// used with this value of b.
		nbuckets += bucketShift(b - 4)
		sz := t.bucket.size * nbuckets
		up := roundupsize(sz)
		if up != sz {
			nbuckets = up / t.bucket.size
		}
	}

	if dirtyalloc == nil {
		buckets = newarray(t.bucket, int(nbuckets))
	} else {
		// dirtyalloc was previously generated by
		// the above newarray(t.bucket, int(nbuckets))
		// but may not be empty.
		buckets = dirtyalloc
		size := t.bucket.size * nbuckets
		if t.bucket.ptrdata != 0 {
			memclrHasPointers(buckets, size)
		} else {
			memclrNoHeapPointers(buckets, size)
		}
	}
	// å¾—åˆ°æº¢å‡ºæ¡¶çš„ä½ç½®
	if base != nbuckets {
		// We preallocated some overflow buckets.
		// To keep the overhead of tracking these overflow buckets to a minimum,
		// we use the convention that if a preallocated overflow bucket's overflow
		// pointer is nil, then there are more available by bumping the pointer.
		// We need a safe non-nil pointer for the last overflow bucket; just use buckets.
		nextOverflow = (*bmap)(add(buckets, base*uintptr(t.bucketsize)))
		last := (*bmap)(add(buckets, (nbuckets-1)*uintptr(t.bucketsize)))
		last.setoverflow(t, (*bmap)(buckets))
	}
	return buckets, nextOverflow
}
```



### mapçš„ç»“æ„

`runtime.hmap` æ˜¯æœ€æ ¸å¿ƒçš„ç»“æ„ä½“

```go
type hmap struct {
	count     int      //å“ˆå¸Œè¡¨ä¸­é”®å€¼å¯¹æ•°é‡
	flags     uint8	   //çŠ¶æ€æ ‡è¯†ï¼šæ­£åœ¨å†™ã€æ‰©å®¹ã€oldbucketséå†ç­‰
	B         uint8    //buckets æ•°é‡ï¼Œå¯¹æ•°è¡¨ç¤ºï¼Œbuckets = 2^Bï¼Œæ¡¶çš„æ•°é‡éƒ½æ˜¯2çš„å¹‚
	noverflow uint16   //æº¢å‡ºæ¡¶é‡Œbmapçš„å¤§è‡´æ•°é‡
	hash0     uint32   //å“ˆå¸Œç§å­ï¼Œå¼•å…¥éšæœºæ€§

	buckets    unsafe.Pointer	//æŒ‡å‘ []bmap æ•°ç»„
	oldbuckets unsafe.Pointer   //æ‰©å®¹æ—¶ï¼Œä¿å­˜ä¹‹å‰çš„buckets
	nevacuate  uintptr			//åˆ†æµæ¬¡æ•°ï¼Œæˆå€æ‰©å®¹åˆ†æµæ“ä½œè®¡æ•°å­—æ®µ

	extra *mapextra			//æº¢å‡ºæ¡¶
}

type mapextra struct {
	overflow    *[]*bmap
	oldoverflow *[]*bmap

	nextOverflow *bmap
}
```

![hmap-and-buckets](picture/goè¯­è¨€è¦ç‚¹/hmap-and-buckets.png)

æ¯ä¸ª`runtime.bmap`éƒ½èƒ½å­˜å‚¨8ä¸ªé”®å€¼å¯¹ï¼Œå½“å“ˆå¸Œè¡¨å­˜å‚¨çš„æ•°æ®è¿‡å¤šï¼Œå•ä¸ªæ¡¶å·²ç»è£…æ»¡ï¼Œå°±ä¼šä½¿ç”¨`extra.nextOverflow`ä¸­æ¡¶å­˜å‚¨æº¢å‡ºçš„æ•°æ®ï¼Œè¿™ä¸¤ç§æ¡¶åœ¨å†…å­˜ä¸­éƒ½æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œç§°ä¸ºæ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶

```go
// A bucket for a Go map.
type bmap struct {
	tophash [bucketCnt]uint8  //bmapä¸­åªå­˜æ”¾äº†tophashï¼Œå³hashçš„é«˜8ä½
}
```

è¿è¡Œæ—¶ï¼Œ`runtime.bmap`ä¸æ­¢è¿™ä¸ªå­—æ®µï¼Œå› ä¸º**Goä¸æ”¯æŒæ³›å‹ï¼Œmapå¯ä»¥å­˜æ”¾å¾ˆå¤šç§æ•°æ®ç±»å‹çš„é”®å€¼å¯¹ï¼Œæ‰€ä»¥é”®å€¼å¯¹å æ®çš„å†…å­˜ç©ºé—´å¤§å°åªèƒ½åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ¨å¯¼**ï¼Œæ‰€ä»¥å®šä¹‰çš„æ—¶å€™ä¸åŒ…å«è¿™äº›å­—æ®µã€‚æ ¹æ®ç¼–è¯‘æœŸé—´çš„ [`cmd/compile/internal/gc.bmap`](https://draveness.me/golang/tree/cmd/compile/internal/gc.bmap) å‡½æ•°é‡å»ºå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š

```go
type bmap struct {
    topbits  [8]uint8
    keys     [8]keytype
    values   [8]valuetype
    pad      uintptr
    overflow uintptr
}
```

éšç€å“ˆå¸Œè¡¨å­˜å‚¨æ•°æ®å¢å¤šï¼Œä¼šæ‰©å®¹å“ˆå¸Œè¡¨æˆ–è€…ä½¿ç”¨é¢å¤–çš„æ¡¶å­˜å‚¨æº¢å‡ºçš„æ•°æ®ï¼Œä¸ä¼šè®©å•ä¸ªæ¡¶ä¸­çš„æ•°æ®è¶…è¿‡8ä¸ªã€‚ã€‚æº¢å‡ºæ¡¶åªæ˜¯ä¸´æ—¶æ–¹æ¡ˆï¼Œè¿‡å¤šçš„æº¢å‡ºæ¡¶ä¹Ÿä¼šå¯¼è‡´å“ˆå¸Œè¡¨çš„æ‰©å®¹



### æŸ¥æ‰¾

å“ˆå¸Œä¼šä¾æ¬¡éå†æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶ä¸­çš„æ•°æ®ï¼Œå®ƒä¼šå…ˆæ¯”è¾ƒå“ˆå¸Œçš„é«˜ 8 ä½å’Œæ¡¶ä¸­å­˜å‚¨çš„ `tophash`ï¼Œåæ¯”è¾ƒä¼ å…¥çš„å’Œæ¡¶ä¸­çš„å€¼ä»¥åŠ é€Ÿæ•°æ®çš„è¯»å†™ã€‚ç”¨äºé€‰æ‹©æ¡¶åºå·çš„æ˜¯å“ˆå¸Œçš„æœ€ä½å‡ ä½ï¼Œè€Œç”¨äºåŠ é€Ÿè®¿é—®çš„æ˜¯å“ˆå¸Œçš„é«˜ 8 ä½ï¼Œè¿™ç§è®¾è®¡èƒ½å¤Ÿå‡å°‘åŒä¸€ä¸ªæ¡¶ä¸­æœ‰å¤§é‡ç›¸ç­‰ `tophash` çš„æ¦‚ç‡å½±å“æ€§èƒ½ã€‚

æ¯ä¸€ä¸ªæ¡¶éƒ½æ˜¯ä¸€æ•´ç‰‡çš„å†…å­˜ç©ºé—´ï¼Œå½“å‘ç°æ¡¶ä¸­çš„ `tophash` ä¸ä¼ å…¥é”®çš„ `tophash` åŒ¹é…ä¹‹åï¼Œæˆ‘ä»¬ä¼šé€šè¿‡æŒ‡é’ˆå’Œåç§»é‡è·å–å“ˆå¸Œä¸­å­˜å‚¨çš„é”® `keys[0]` å¹¶ä¸ `key` æ¯”è¾ƒï¼Œå¦‚æœä¸¤è€…ç›¸åŒå°±ä¼šè·å–ç›®æ ‡å€¼çš„æŒ‡é’ˆ `values[0]` å¹¶è¿”å›ã€‚

![hashmap-mapaccess](picture/goè¯­è¨€è¦ç‚¹/hashmap-mapaccess.png)

<img src="picture/goè¯­è¨€è¦ç‚¹/f39e10e1474fda593cbca86eb0c517e2.png" alt="img" style="zoom: 33%;" />

```go
func mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer {
	//...
	hash := t.hasher(key, uintptr(h.hash0))
	m := bucketMask(h.B)
    //æ‰¾åˆ°å¯¹åº”çš„bmapåœ°å€
	b := (*bmap)(add(h.buckets, (hash&m)*uintptr(t.bucketsize)))
    //å­˜åœ¨æ—§æ¡¶ï¼Œè¯´æ˜åœ¨æ¬è¿ï¼Œå»æ—§æ¡¶æ‰¾
	if c := h.oldbuckets; c != nil {
        // å¦‚æœä¸æ˜¯åŒsizeæ‰©å®¹ï¼Œè¯´æ˜æ–° bucket æ˜¯åŸæ¥çš„2å€
		if !h.sameSizeGrow() {
			m >>= 1
		}
        // keyåœ¨è€mapä¸­çš„ bucket ä½ç½®
		oldb := (*bmap)(add(c, (hash&m)*uintptr(t.bucketsize)))
        // tophash[0]å¦‚æœä¸º2ï¼Œ 3ï¼Œ 4ï¼Œè¡¨ç¤ºè¿™ä¸ªbmapå·²ç»æ¬èµ°äº†ï¼Œæ­£å¸¸çš„tophash>=5ï¼Œæˆ–è€…0ï¼Œ1è¡¨ç¤ºä¸ºç©º
		if !evacuatd(oldb) {
        // å¦‚æœè€çš„bucketè¿˜æ²¡æœ‰æ¬è¿åˆ°æ–°bucketï¼Œé‚£ä¹ˆå°±ç›´æ¥åœ¨è€çš„æ¡¶æ‰¾
		if !evacuated(oldb) {
			b = oldb
		}
	}
	top := tophash(hash)	// è®¡ç®—tophashç”¨äºåŠ é€Ÿ
bucketloop:
    //å¯¹bmapä¸­çš„keyéå†ï¼Œå¦‚æœæœ‰æº¢å‡ºæ¡¶ä¹Ÿè¦éå†
	for ; b != nil; b = b.overflow(t) {
		for i := uintptr(0); i < bucketCnt; i++ {
            // tophashåŠ é€Ÿï¼Œtophashä¸ç›¸ç­‰ç›´æ¥ä¸‹ä¸€ä¸ª
			if b.tophash[i] != top {
				if b.tophash[i] == emptyRest {
					break bucketloop
				}
				continue
			}
            // æ ¹æ®keyçš„å¤§å°ï¼Œå®šä½keyçš„ä½ç½®
			k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize))
			// keyæ˜¯æŒ‡é’ˆï¼Œè§£å¼•ç”¨
            if t.indirectkey() {
				k = *((*unsafe.Pointer)(k))
			}
            // keyç›¸ç­‰
			if t.key.equal(key, k) {
				// å®šä½åˆ°valueï¼Œå¦‚æœvalueæ˜¯æŒ‡é’ˆï¼Œä¹Ÿè¦è§£å¼•ç”¨
                e := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize))
				if t.indirectelem() {
					e = *((*unsafe.Pointer)(e))
				}
                // è¿”å›valueçš„æŒ‡é’ˆ
				return e
			}
		}
	}
	// å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¿”å›keyç›¸åº”çš„é›¶å€¼ï¼Œä¸ä¼šè¿”å›nilï¼ï¼ï¼
	return unsafe.Pointer(&zeroVal[0])
}
```



**åˆ¤æ–­bucketæ˜¯å¦æ¬è¿ï¼š**

```go
// ç©ºçš„ cellï¼Œä¹Ÿæ˜¯åˆå§‹æ—¶ bucket çš„çŠ¶æ€
empty          = 0
// ç©ºçš„ cellï¼Œè¡¨ç¤º cell å·²ç»è¢«è¿ç§»åˆ°æ–°çš„ bucket
evacuatedEmpty = 1
// key,value å·²ç»æ¬è¿å®Œæ¯•ï¼Œä½†æ˜¯ key éƒ½åœ¨æ–° bucket å‰åŠéƒ¨åˆ†ï¼Œ
// åé¢æ‰©å®¹éƒ¨åˆ†ä¼šå†è®²åˆ°ã€‚
evacuatedX     = 2
// åŒä¸Šï¼Œkey åœ¨ååŠéƒ¨åˆ†
evacuatedY     = 3
// tophash çš„æœ€å°æ­£å¸¸å€¼
minTopHash     = 4

func evacuated(b *bmap) bool {
    h := b.tophash[0]
    return h > empty && h < minTopHash
}
```

åˆ¤æ–­æ˜¯å¦åœ¨0-4ä¹‹é—´ã€‚ã€‚ä¸åœ¨å°±è¯´æ˜å·²ç»å…¨éƒ¨æ¬è¿åˆ°äº†æ–°çš„bucket



### éå†

æ¯æ¬¡éå†éƒ½ä¼šç”Ÿæˆä¸€ä¸ªéšæœºæ•°ä½œä¸ºå¼€å§‹çš„bucketï¼Œæ‰€ä»¥æ¯æ¬¡éå†çš„ç»“æœéƒ½æ˜¯ä¸åŒçš„ï¼

```go
// ç”Ÿæˆéšæœºæ•° r
r := uintptr(fastrand())
if h.B > 31-bucketCntBits {
    r += uintptr(fastrand()) << 31
}
// ä»å“ªä¸ª bucket å¼€å§‹éå†
it.startBucket = r & (uintptr(1)<<h.B - 1)
// ä» bucket çš„å“ªä¸ª cell å¼€å§‹éå†
it.offset = uint8(r >> h.B & (bucketCnt - 1))
```





### å†™å…¥å’Œæ‰©å®¹

å†™å…¥å’ŒæŸ¥æ‰¾å·®ä¸å¤šï¼Œå¦‚æœå½“å‰æ¡¶å·²ç»æ»¡äº†ï¼Œè°ƒç”¨`runtime.hmap.newoverflow`åˆ›å»ºæ–°æ¡¶æˆ–è€…ä½¿ç”¨ [`runtime.hmap`](https://draveness.me/golang/tree/runtime.hmap) é¢„å…ˆåœ¨ `noverflow` ä¸­åˆ›å»ºå¥½çš„æ¡¶æ¥ä¿å­˜æ•°æ®ï¼Œæ–°åˆ›å»ºçš„æ¡¶ä¸ä»…ä¼šè¢«è¿½åŠ åˆ°å·²æœ‰æ¡¶çš„æœ«å°¾ï¼Œè¿˜ä¼šå¢åŠ å“ˆå¸Œè¡¨çš„ `noverflow` è®¡æ•°å™¨ã€‚

è§¦å‘æ‰©å®¹çš„æ¡ä»¶ï¼š

1. æ²¡æœ‰åœ¨æ¬è¿
2. è£…è½½å› å­å·²ç»è¶…è¿‡ 6.5ï¼›
3. å“ˆå¸Œä½¿ç”¨äº†å¤ªå¤šæº¢å‡ºæ¡¶ `noverflow >= uint16(1)<<(min(B, 15)&15)`ï¼›

å› ä¸º Go è¯­è¨€å“ˆå¸Œçš„æ‰©å®¹ä¸æ˜¯ä¸€ä¸ªåŸå­çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ [`runtime.mapassign`](https://draveness.me/golang/tree/runtime.mapassign) è¿˜éœ€è¦åˆ¤æ–­å½“å‰å“ˆå¸Œæ˜¯å¦å·²ç»å¤„äºæ‰©å®¹çŠ¶æ€ï¼Œé¿å…äºŒæ¬¡æ‰©å®¹é€ æˆæ··ä¹±

æ‰©å®¹çš„å…¥å£æ˜¯ [`runtime.hashGrow`](https://draveness.me/golang/tree/runtime.hashGrow)ï¼š

1. `2å€æ‰©å®¹`
2. `ç­‰é‡æ‰©å®¹`

```go
func hashGrow(t *maptype, h *hmap) {
	bigger := uint8(1)
    // å¦‚æœè£…è½½å› å­æ²¡æœ‰è¶…è¿‡6.5ï¼Œè¿›è¡Œç­‰é‡æ‰©å®¹
	if !overLoadFactor(h.count+1, h.B) {
		// è¿›è¡Œç­‰é‡çš„å†…å­˜æ‰©å®¹ï¼Œæ‰€ä»¥ B ä¸å˜
        bigger = 0
		h.flags |= sameSizeGrow
	}
    // å°†è€ buckets æŒ‚åˆ° buckets ä¸Š
	oldbuckets := h.buckets
    // ç”³è¯·æ–°çš„ buckets ç©ºé—´
	newbuckets, nextOverflow := makeBucketArray(t, h.B+bigger, nil)
	
    // æäº¤ grow çš„åŠ¨ä½œ
	h.B += bigger
	h.flags = flags
	h.oldbuckets = oldbuckets
	h.buckets = newbuckets

    // æ¬è¿è¿›åº¦ä¸º 0
	h.nevacuate = 0
    // overflow buckets æ•°ä¸º 0
	h.noverflow = 0

	h.extra.oldoverflow = h.extra.overflow
	h.extra.overflow = nil
	h.extra.nextOverflow = nextOverflow
}
```

`hashGrow`å¹¶æ²¡æœ‰çœŸæ­£çš„æ¬è¿ï¼ŒæŒ‡ç¤ºåˆ†é…å¥½äº†æ–°çš„bucketã€‚çœŸæ­£æ¬è¿çš„æ“ä½œæ˜¯`growWork()`ï¼Œè°ƒç”¨è¿™ä¸ªæ“ä½œæ˜¯åœ¨`mapassignå’Œmapdelete`å‡½æ•°ä¸­ï¼Œå³ æ’å…¥ã€ä¿®æ”¹ã€åˆ é™¤keyçš„æ—¶å€™ä¼šå°è¯•æ¬è¿bucketã€‚æ£€æŸ¥oldbucketsæ˜¯å¦æ¬è¿å®Œæ¯•ï¼Œæ²¡æ¬è¿å®Œå°±æ¬è¿

```go
func growWork(t *maptype, h *hmap, bucket uintptr) {
    // ç¡®è®¤æ¬è¿è€çš„ bucket å¯¹åº”æ­£åœ¨ä½¿ç”¨çš„ bucketï¼Œåˆ™æ¬è¿è¿™ä¸ªæ¡¶
    evacuate(t, h, bucket&h.oldbucketmask())
    
    // å†æ¬è¿ä¸€ä¸ª bucketï¼Œä»¥åŠ å¿«æ¬è¿è¿›ç¨‹
    if h.growing() {
        evacuate(t, h, h.nevacuate)
    }
}

// oldbucketsä¸ä¸ºç©ºï¼Œè¯´æ˜è¿˜æ²¡æœ‰æ¬è¿å®Œæ¯•
func (h *hmap) growing() bool {
    return h.oldbuckets != nil
}
```



å“ˆå¸Œåœ¨æ‰©å®¹çš„è¿‡ç¨‹ä¸­ä¼šé€šè¿‡ [`runtime.makeBucketArray`](https://draveness.me/golang/tree/runtime.makeBucketArray) åˆ›å»ºä¸€ç»„æ–°æ¡¶å’Œé¢„åˆ›å»ºçš„æº¢å‡ºæ¡¶ï¼Œéšåå°†åŸæœ‰çš„æ¡¶æ•°ç»„è®¾ç½®åˆ° `oldbuckets` ä¸Šå¹¶å°†æ–°çš„ç©ºæ¡¶è®¾ç½®åˆ° `buckets` ä¸Šï¼Œæº¢å‡ºæ¡¶ä¹Ÿä½¿ç”¨äº†ç›¸åŒçš„é€»è¾‘æ›´æ–°ï¼Œä¸‹å›¾å±•ç¤ºäº†è§¦å‘æ‰©å®¹åçš„å“ˆå¸Œï¼š

![hashmap-hashgrow](picture/goè¯­è¨€è¦ç‚¹/hashmap-hashgrow.png)

ç­‰é‡æ‰©å®¹åˆ›å»ºçš„æ–°æ¡¶æ•°é‡å’Œæ—§æ¡¶ä¸€æ ·å¤šï¼ä¹‹åé€šè¿‡[`runtime.evacuate`](https://draveness.me/golang/tree/runtime.evacuate) å®Œæˆæ•°æ®çš„è¿ç§»ï¼Œå¯¹æ¡¶ä¸­å…ƒç´ è¿›è¡Œå†åˆ†é…

æˆå€æ‰©å®¹çš„å†åˆ†é…æ–¹å¼å°±æ˜¯å°†ä¸€ä¸ªæ—§æ¡¶çš„æ•°æ®åˆ†é…åˆ°ä¸¤ä¸ªæ–°æ¡¶ä¸­ï¼Œå› ä¸ºæ‰©å®¹æ˜¯æ‰©å¤§2å€ï¼Œå¯¹åº”æ”¾è¿›å»å°±å¥½äº†ï¼Œå¤šå¢åŠ ä¸€ä½æ©ç ï¼Œå¤š&ä¸€ä½å³å¯

å¦‚æœæ˜¯ç­‰é‡æ‰©å®¹çš„å†åˆ†é…ï¼Œæ—§æ¡¶å’Œæ–°æ¡¶æ˜¯ä¸€å¯¹ä¸€çš„



ç­‰é‡æ‰©å®¹æ˜¯ç”±äºæº¢å‡ºæ¡¶å¤ªå¤šï¼ˆæº¢å‡ºæ¡¶è¶…è¿‡å¸¸è§„æ¡¶æ•°ç›®ï¼‰ã€‚å¯èƒ½æ˜¯å‰é¢çš„å¾ˆå¤šé”®å€¼å¯¹è¢«åˆ é™¤ï¼Œå¯¼è‡´keyåœ¨æ¡¶ä¸­åˆ†é…ä¸å‡åŒ€äº†ã€‚æ‰€ä»¥é‡æ–°è¿å…¥æ–°æ¡¶ä¸­



**æ‰©å®¹çš„è§¦å‘ï¼š**

åœ¨å‘ map æ’å…¥æ–° key çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œæ¡ä»¶æ£€æµ‹ï¼Œç¬¦åˆä¸‹é¢è¿™ 2 ä¸ªæ¡ä»¶ï¼Œå°±ä¼šè§¦å‘æ‰©å®¹ï¼š

1. è£…è½½å› å­è¶…è¿‡é˜ˆå€¼ï¼Œæºç é‡Œå®šä¹‰çš„é˜ˆå€¼æ˜¯ 6.5ã€‚
2. overflow çš„ bucket æ•°é‡è¿‡å¤šï¼šå½“ B å°äº 15ï¼Œä¹Ÿå°±æ˜¯ bucket æ€»æ•° 2^B å°äº 2^15 æ—¶ï¼Œå¦‚æœ overflow çš„ bucket æ•°é‡è¶…è¿‡ 2^Bï¼Œå³**æº¢å‡ºæ¡¶çš„æ•°é‡è¶…è¿‡äº†æ­£å¸¸æ¡¶çš„æ•°é‡**ï¼›å½“ B >= 15ï¼Œä¹Ÿå°±æ˜¯ bucket æ€»æ•° 2^B å¤§äºç­‰äº 2^15ï¼Œå¦‚æœ overflow çš„ bucket æ•°é‡è¶…è¿‡ 2^15ã€‚

å¯¹äº1çš„æƒ…å†µï¼Œæ˜¯ç”±äºå…ƒç´ è¿‡å¤šï¼Œæ‰€ä»¥æˆå€æ‰©å®¹

å¯¹äº2çš„æƒ…å†µï¼Œæ˜¯ç”±äºåˆ†å¸ƒä¸å‡åŒ€ï¼Œæ‰€ä»¥ç­‰é‡æ‰©å®¹ï¼ˆä¾‹å¦‚æ’å…¥mapçš„keyå“ˆå¸Œå‡ ä¹éƒ½ä¸€æ ·ï¼Œè½åˆ°ç›¸åŒçš„bucketï¼Œäº§ç”Ÿå¾ˆå¤šçš„æº¢å‡ºæ¡¶ï¼ŒæŸ¥æ‰¾æ•ˆç‡æ¥è¿‘O(n)äº†ï¼‰



### æ— æ³•å¯¹mapçš„k/vå–åœ°å€

å› ä¸ºmapä¼šæ¶‰åŠæ‰©å®¹ï¼Œkeyçš„valueçš„åœ°å€éƒ½æ˜¯ä¼šå˜åŒ–çš„ï¼Œæ‰€ä»¥å–åœ°å€ä¸èƒ½é€šè¿‡ç¼–è¯‘

å³ä½¿ä½¿ç”¨å…¶ä»–æ–¹å¼ï¼Œä¾‹å¦‚unsafe.Pointerè·å–åˆ°äº†keyæˆ–valueçš„åœ°å€ï¼Œä¹Ÿä¸èƒ½é•¿æœŸæŒæœ‰ï¼Œå› ä¸ºä¸€æ—¦è§¦å‘æ‰©å®¹ï¼Œkeyå’Œvalueçš„ä½ç½®å°±ä¼šå˜åŒ–ï¼Œä¹‹æ°”é‚£ä¿å­˜çš„åœ°å€ä¹Ÿå°±å¤±æ•ˆäº†



### åˆ é™¤

åˆ é™¤å’Œå†™å…¥é€»è¾‘ç±»ä¼¼ï¼Œå¦‚æœåˆ é™¤æœŸé—´é‡åˆ°äº†å“ˆå¸Œè¡¨è¿ç§»ï¼Œå°±ä¼šåˆ†æµæ¡¶ä¸­å…ƒç´ ï¼Œåˆ†æµç»“æŸä¹‹åä¼šæ‰¾åˆ°æ¡¶ä¸­çš„ç›®æ ‡å…ƒç´ å®Œæˆé”®å€¼å¯¹çš„åˆ é™¤æ“ä½œ

```go
func mapdelete(t *maptype, h *hmap, key unsafe.Pointer) {
	// ...
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å¹¶å‘æ“ä½œï¼Œæœ‰å¹¶å‘å†™ç›´æ¥panic
	if h.flags&hashWriting != 0 {
		throw("concurrent map writes")
	}
	hash := t.hasher(key, uintptr(h.hash0))
	
    // è®¾ç½®å†™æ ‡å¿—
	h.flags ^= hashWriting

	bucket := hash & bucketMask(h.B)
    
    // åœ¨æ‰©å®¹ï¼Œè§¦å‘ä¸€æ¬¡è¿ç§»æ“ä½œ
	if h.growing() {
		growWork(t, h, bucket)
	}
	b := (*bmap)(add(h.buckets, bucket*uintptr(t.bucketsize)))
	bOrig := b
	top := tophash(hash)
search:
	for ; b != nil; b = b.overflow(t) {
		for i := uintptr(0); i < bucketCnt; i++ {
			if b.tophash[i] != top {
				if b.tophash[i] == emptyRest {
					break search
				}
				continue
			}
			k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize))
			k2 := k
			if t.indirectkey() {
				k2 = *((*unsafe.Pointer)(k2))
			}
			if !t.key.equal(key, k2) {
				continue
			}
            
            // å¦‚æœkeyæ˜¯æŒ‡é’ˆï¼Œç½®ä¸ºnilï¼Œå¦‚æœæ˜¯éæŒ‡é’ˆï¼Œç½®ä¸ºé›¶å€¼
			// Only clear key if there are pointers in it.
			if t.indirectkey() {
				*(*unsafe.Pointer)(k) = nil
			} else if t.key.ptrdata != 0 {
				memclrHasPointers(k, t.key.size)
			}
			e := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize))
			
            // å¦‚æœvalueæ˜¯æŒ‡é’ˆï¼Œç½®ä¸ºnilï¼Œå¦‚æœæ˜¯éæŒ‡é’ˆï¼Œç½®ä¸ºé›¶å€¼
            if t.indirectelem() {
				*(*unsafe.Pointer)(e) = nil
			} else if t.elem.ptrdata != 0 {
				memclrHasPointers(e, t.elem.size)
			} else {
				memclrNoHeapPointers(e, t.elem.size)
			}
			b.tophash[i] = emptyOne
			// ...
		}
	}

	if h.flags&hashWriting == 0 {
		throw("concurrent map writes")
	}
	h.flags &^= hashWriting
}

```



### éçº¿ç¨‹å®‰å…¨

mapä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸€æ—¦å‘ç°å¹¶å‘å†™ï¼Œç›´æ¥panic

å†™æ“ä½œæœ‰ä¸ªæ ‡å¿—ä½ï¼Œä¸€æ—¦å‘ç°æ ‡å¿—ä½è¢«è®¾ç½®äº†ï¼Œç›´æ¥panicã€‚èµ‹å€¼å’Œåˆ é™¤æ“ä½œåœ¨æ£€æµ‹å®Œå†™æ ‡å¿—ä½æ˜¯å¤ä½ä¹‹åï¼Œå…ˆå°†å†™æ ‡å¿—ä½ç½®ä½ï¼Œä¹‹åæ‰ä¼šè¿›è¡Œå†™æ“ä½œ

```go
	if h.flags&hashWriting != 0 {
		throw("concurrent map writes")
	}

	// Set hashWriting after calling t.hasher, since t.hasher may panic,
	// in which case we have not actually done a write.
	h.flags ^= hashWriting
```



å³ä½¿æ˜¯ä¸ç›¸åŒçš„keyä¹Ÿæ˜¯ä¸èƒ½å¹¶å‘å†™çš„ï¼

```go
func main() {
	m := make(map[int]int)
	go func() {
		for i := 0; i < 100; i++ {
			m[i] = i
		}
	}()
	for i := 100; i < 200; i++ {
		m[i] = i
	}
	fmt.Println(m)
}

/*
fatal error: concurrent map writes
*/
```



ç”šè‡³è¯»å’Œå†™ä¹Ÿä¼španicï¼š

```go
func main() {
	m := make(map[int]int)
	go func() {
		for i := 0; i < 100; i++ {
			m[i] = i
		}
	}()
	for i := 0; i < 100; i++ {
		fmt.Println(m)
	}
}
/*
fatal error: concurrent map iteration and map write
*/
```







[ç”±æµ…åˆ°æ·±ï¼Œå…¥é—¨Goè¯­è¨€Mapå®ç°åŸç† - Goè¯­è¨€ä¸­æ–‡ç½‘ - Golangä¸­æ–‡ç¤¾åŒº (studygolang.com)](https://studygolang.com/articles/32943)

[Golang Mapå®ç°ï¼ˆä¸€ï¼‰ - æ¬ç –ç¨‹åºå‘˜å¸¦ä½ é£ - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/-lee/p/12777241.html)

[Golang Map å®ç° ï¼ˆå››ï¼‰ mapçš„èµ‹å€¼å’Œæ‰©å®¹ - Goè¯­è¨€ä¸­æ–‡ç½‘ - Golangä¸­æ–‡ç¤¾åŒº (studygolang.com)](https://studygolang.com/articles/28350)

[æ·±å…¥ç†è§£ Go mapï¼šèµ‹å€¼å’Œæ‰©å®¹è¿ç§» - Goè¯­è¨€ä¸­æ–‡ç½‘ - Golangä¸­æ–‡ç¤¾åŒº (studygolang.com)](https://studygolang.com/articles/19251)



### sync.map

[æ ¹æ®æ‹“æ‰‘å›¾ç†è§£golangçš„sync.Mapå·¥ä½œåŸç†](https://segmentfault.com/a/1190000020946989)

<img src="picture/goè¯­è¨€è¦ç‚¹/sync.mapç»“æ„.png" alt="sync.mapç»“æ„" style="zoom: 67%;" />

```go
type Map struct {
    //äº’æ–¥é”ï¼Œç”¨äºé”å®šdirty map
    mu Mutex    
    
    //ä¼˜å…ˆè¯»map,æ”¯æŒåŸå­æ“ä½œï¼Œæ³¨é‡Šä¸­æœ‰readOnlyä¸æ˜¯è¯´readæ˜¯åªè¯»ï¼Œè€Œæ˜¯å®ƒçš„ç»“æ„ä½“ã€‚readå®é™…ä¸Šæœ‰å†™çš„æ“ä½œ
    read atomic.Value 
    
    // dirtyæ˜¯ä¸€ä¸ªå½“å‰æœ€æ–°çš„mapï¼Œå…è®¸è¯»å†™ï¼Œä¼šåŠ é”
    dirty map[interface{}]*entry 
    
    // ä¸»è¦è®°å½•readè¯»å–ä¸åˆ°æ•°æ®åŠ é”è¯»å–read mapä»¥åŠdirty mapçš„æ¬¡æ•°ï¼Œå½“missesç­‰äºdirtyçš„é•¿åº¦æ—¶ï¼Œä¼šå°†dirtyå¤åˆ¶åˆ°read
    misses int 
}

// readOnly ä¸»è¦ç”¨äºå­˜å‚¨ï¼Œé€šè¿‡åŸå­æ“ä½œå­˜å‚¨åœ¨ Map.read ä¸­å…ƒç´ ã€‚
type readOnly struct {
    // readçš„map, ç”¨äºå­˜å‚¨æ‰€æœ‰readæ•°æ®
    m       map[interface{}]*entry
    
    // å¦‚æœæ•°æ®åœ¨dirtyä¸­ä½†æ²¡æœ‰åœ¨readä¸­ï¼Œè¯¥å€¼ä¸ºtrue,ä½œä¸ºä¿®æ”¹æ ‡è¯†
    amended bool 
}

// entry ä¸º Map.dirty çš„å…·ä½“mapå€¼
type entry struct {
    // nil: è¡¨ç¤ºä¸ºè¢«åˆ é™¤ï¼Œè°ƒç”¨Delete()å¯ä»¥å°†read mapä¸­çš„å…ƒç´ ç½®ä¸ºnil
    // expunged: ä¹Ÿæ˜¯è¡¨ç¤ºè¢«åˆ é™¤ï¼Œä½†æ˜¯è¯¥é”®åªåœ¨readè€Œæ²¡æœ‰åœ¨dirtyä¸­ï¼Œè¿™ç§æƒ…å†µå‡ºç°åœ¨å°†readå¤åˆ¶åˆ°dirtyä¸­ï¼Œå³å¤åˆ¶çš„è¿‡ç¨‹ä¼šå…ˆå°†nilæ ‡è®°ä¸ºexpungedï¼Œç„¶åä¸å°†å…¶å¤åˆ¶åˆ°dirty
    //  å…¶ä»–: è¡¨ç¤ºå­˜ç€çœŸæ­£çš„æ•°æ®
    p unsafe.Pointer // *interface{}
}
```

<img src="picture/goè¯­è¨€è¦ç‚¹/sync.map.png" alt="sync.map" style="zoom: 80%;" />



sync.Mapçš„åŸç†å¾ˆç®€å•ï¼Œä½¿ç”¨äº†ç©ºé—´æ¢æ—¶é—´ç­–ç•¥ï¼Œé€šè¿‡å†—ä½™çš„ä¸¤ä¸ªæ•°æ®ç»“æ„(readã€dirty),å®ç°åŠ é”å¯¹æ€§èƒ½çš„å½±å“ã€‚

é€šè¿‡å¼•å…¥ä¸¤ä¸ªmapå°†è¯»å†™åˆ†ç¦»åˆ°ä¸åŒçš„mapï¼Œå…¶ä¸­**read mapæä¾›å¹¶å‘è¯»å’Œå·²å­˜å…ƒç´ åŸå­å†™**ï¼Œè€Œ**dirty mapåˆ™è´Ÿè´£è¯»å†™**ã€‚

è¿™æ ·**read mapå°±å¯ä»¥åœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹è¿›è¡Œå¹¶å‘è¯»å–**,å½“read mapä¸­æ²¡æœ‰è¯»å–åˆ°å€¼æ—¶,å†**åŠ é”è¿›è¡Œåç»­è¯»å–,å¹¶ç´¯åŠ æœªå‘½ä¸­æ•°**ã€‚

å½“æœªå‘½ä¸­æ•°å¤§äºç­‰äºdirty mapé•¿åº¦,å°†dirty mapä¸Šå‡ä¸ºread mapã€‚

ä»ç»“æ„ä½“çš„å®šä¹‰å¯ä»¥å‘ç°ï¼Œè™½ç„¶å¼•å…¥äº†ä¸¤ä¸ªmapï¼Œä½†æ˜¯åº•å±‚æ•°æ®å­˜å‚¨çš„æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘çš„æ˜¯åŒä¸€ä»½å€¼ã€‚



åœ¨æ–°å¢çš„æ—¶å€™ï¼Œåˆ†ä¸ºå››ç§æƒ…å†µï¼š

1. keyåŸå…ˆå°±å­˜åœ¨äº`read`ä¸­ï¼Œè·å–keyæ‰€å¯¹åº”å†…å­˜åœ°å€ï¼Œ**åŸå­æ€§ä¿®æ”¹**
2. keyå­˜åœ¨ï¼Œä½†æ˜¯keyæ‰€å¯¹åº”çš„å€¼è¢«æ ‡è®°ä¸º expungedï¼Œè§£é”ï¼Œè§£é™¤æ ‡è®°ï¼Œå¹¶æ›´æ–°dirtyä¸­çš„keyï¼Œä¸readä¸­è¿›è¡ŒåŒæ­¥ï¼Œç„¶åä¿®æ”¹keyå¯¹åº”çš„å€¼
3. readä¸­æ²¡æœ‰keyï¼Œä½†æ˜¯dirtyä¸­å­˜åœ¨è¿™ä¸ªkeyï¼Œç›´æ¥ä¸Šé”ä¿®æ”¹dirtyä¸­keyçš„å€¼
4. readå’Œdirtyä¸­éƒ½æ²¡æœ‰å€¼ï¼Œå…ˆåˆ¤æ–­è‡ªä»readä¸Šæ¬¡åŒæ­¥dirtyçš„å†…å®¹åæœ‰æ²¡æœ‰å†ä¿®æ”¹è¿‡dirtyçš„å†…å®¹ï¼Œæ²¡æœ‰çš„è¯(`readOnly.amend=false`)ï¼Œå…ˆåŒæ­¥readå’Œdirtyçš„å€¼ï¼Œç„¶åæ·»åŠ æ–°çš„key valueåˆ°dirtyä¸Šé¢

å…³äºç¬¬å››ç‚¹ï¼Œå› ä¸º read åŒæ­¥ dirty æ•°æ®çš„æ—¶å€™ï¼Œæ˜¯ç›´æ¥æŠŠ dirty æŒ‡å‘ map çš„æŒ‡é’ˆäº¤ç»™äº† read.mï¼Œç„¶åå°† dirtyçš„æŒ‡é’ˆè®¾ç½®ä¸ºnilï¼Œæ‰€ä»¥åŒæ­¥ä¹‹å dirtyå°±æ˜¯nilï¼Œæ‰€ä»¥è¿˜éœ€è¦ å¤åˆ¶ read åˆ° dirty



åˆ é™¤çš„æ—¶å€™ï¼š

1. readä¸­æ²¡æœ‰ï¼Œä¸”Mapå­˜åœ¨ä¿®æ”¹ï¼Œåˆ™å°è¯•åˆ é™¤dirtyä¸­çš„mapä¸­çš„key

2. readä¸­æ²¡æœ‰ï¼Œä¸”Mapä¸å­˜åœ¨ä¿®æ”¹ï¼Œé‚£å°±æ˜¯æ²¡æœ‰è¿™ä¸ªkeyï¼Œæ— éœ€æ“ä½œ
3. readä¸­æœ‰ï¼Œå°è¯•**å°†keyå¯¹åº”çš„å€¼è®¾ç½®ä¸ºnil**ï¼Œåé¢è¯»å–çš„æ—¶å€™å°±çŸ¥é“è¢«åˆ äº†ï¼Œå› ä¸ºdirtyä¸­mapçš„å€¼è·Ÿreadçš„mapä¸­çš„å€¼æŒ‡å‘çš„éƒ½æ˜¯åŒä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œæ‰€ä»¥ï¼Œä¿®æ”¹äº†readä¹Ÿå°±æ˜¯ä¿®æ”¹äº†dirty



rangeéå†çš„æ—¶å€™ï¼š

éå†çš„é€»è¾‘å°±æ¯”è¾ƒç®€å•äº†ï¼ŒMapåªæœ‰ä¸¤ç§çŠ¶æ€ï¼Œè¢«ä¿®æ”¹è¿‡å’Œæ²¡æœ‰ä¿®æ”¹è¿‡

ä¿®æ”¹è¿‡ï¼šå°†dirtyçš„æŒ‡é’ˆäº¤ç»™readï¼Œreadå°±æ˜¯æœ€æ–°çš„æ•°æ®äº†ï¼Œç„¶åéå†readçš„map

æ²¡æœ‰ä¿®æ”¹è¿‡ï¼šéå†readçš„mapå°±å¥½äº†



## 4. ç»“æ„ä½“

```go
type Employee struct {
    ID        int
    Name,Address      string
    DoB       time.Time
    Position  string
    Salary    int
    ManagerID int
}

var dilbert Employee    // åˆ›å»ºä¸€ä¸ªç»“æ„ä½“å¹¶åˆå§‹åŒ–æ‰€æœ‰çš„æˆå‘˜ä¸ºå¯¹åº”çš„é›¶å€¼ï¼ï¼ï¼  ç»“æ„ä½“åˆå§‹å€¼å¹¶ä¸æ˜¯nil
```

æ‰€ä»¥**ä¸å­˜åœ¨æ²¡æœ‰åˆå§‹åŒ–çš„ç»“æ„ä½“å˜é‡**

ä¸‹é¢çš„EmployeeByIDå‡½æ•°å°†æ ¹æ®ç»™å®šçš„å‘˜å·¥IDè¿”å›å¯¹åº”çš„å‘˜å·¥ä¿¡æ¯ç»“æ„ä½“çš„æŒ‡é’ˆã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç‚¹æ“ä½œç¬¦æ¥è®¿é—®å®ƒé‡Œé¢çš„æˆå‘˜ï¼š

```Go
func EmployeeByID(id int) *Employee { /* ... */ }

fmt.Println(EmployeeByID(dilbert.ManagerID).Position) // "Pointy-haired boss"

id := dilbert.ID
EmployeeByID(id).Salary = 0 // fired for... no real reason
```

å¦‚æœå°†EmployeeByIDå‡½æ•°çš„è¿”å›å€¼ä»`*Employee`æŒ‡é’ˆç±»å‹æ”¹ä¸ºEmployeeå€¼ç±»å‹ï¼Œé‚£ä¹ˆæ›´æ–°è¯­å¥å°†ä¸èƒ½ç¼–è¯‘é€šè¿‡ï¼Œå› ä¸ºåœ¨èµ‹å€¼è¯­å¥çš„å·¦è¾¹å¹¶ä¸ç¡®å®šæ˜¯ä¸€ä¸ªå˜é‡ï¼ˆè°ƒç”¨å‡½æ•°è¿”å›çš„æ˜¯å€¼ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå¯å–åœ°å€çš„å˜é‡ï¼‰

**ä¸€ä¸ªå‘½åä¸ºSçš„ç»“æ„ä½“ç±»å‹å°†ä¸èƒ½å†åŒ…å«Sç±»å‹çš„æˆå‘˜ï¼šå› ä¸ºä¸€ä¸ªèšåˆçš„å€¼ä¸èƒ½åŒ…å«å®ƒè‡ªèº«**ã€‚ä½†æ˜¯Sç±»å‹çš„ç»“æ„ä½“**å¯ä»¥åŒ…å«`*S`æŒ‡é’ˆç±»å‹**çš„æˆå‘˜ï¼Œè¿™å¯ä»¥è®©æˆ‘ä»¬åˆ›å»ºé€’å½’çš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚é“¾è¡¨å’Œæ ‘ç»“æ„ç­‰(å› ä¸ºè¿™ä¸ªç‰¹)

- å¯ä»¥ä½¿ç”¨ç©ºçš„structå’Œmapæ¥æ¨¡æ‹Ÿsetã€‚**struct{}è¡¨ç¤ºç©ºçš„structï¼Œå®ƒçš„å¤§å°ä¸º0ï¼Œä¹Ÿä¸åŒ…å«ä»»ä½•ä¿¡æ¯**

```go
seen := make(map[string]struct{}) // set of strings
```

### ç»“æ„ä½“å­—é¢å€¼

ä¸¤ç§æ–¹å¼æŒ‡å®šå­—é¢å€¼

```go
type T struct{ a, b int }
var _ = p.T{a: 1, b: 2}
var _ = p.T{1, 2}  
```



å› ä¸ºç»“æ„ä½“é€šå¸¸é€šè¿‡æŒ‡é’ˆå¤„ç†ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å†™æ³•æ¥åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ªç»“æ„ä½“å˜é‡ï¼Œå¹¶è¿”å›ç»“æ„ä½“çš„åœ°å€ï¼š

```Go
pp := &Point{1, 2}
```

å®ƒå’Œä¸‹é¢çš„è¯­å¥æ˜¯ç­‰ä»·çš„

```Go
pp := new(Point)
*pp = Point{1, 2}
```

### åŒ¿åæˆå‘˜

åªå£°æ˜ä¸€ä¸ªæˆå‘˜å¯¹åº”çš„æ•°æ®ç±»å‹è€Œä¸æŒ‡åæˆå‘˜çš„åå­—ï¼Œè¿™ç±»æˆå‘˜å°±å«åŒ¿åæˆå‘˜ã€‚å¾—ç›ŠäºåŒ¿ååµŒå…¥çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬**å¯ä»¥ç›´æ¥è®¿é—®å¶å­å±æ€§è€Œä¸éœ€è¦ç»™å‡ºå®Œæ•´çš„è·¯å¾„**

```go
type Circle struct {
    Point
    Radius int
}

type Wheel struct {
    Circle
    Spokes int
}

var w Wheel
w.X = 8            // equivalent to w.Circle.Point.X = 8
w.Y = 8            // equivalent to w.Circle.Point.Y = 8
w.Radius = 5       // equivalent to w.Circle.Radius = 5
w.Spokes = 20
```

ä½†æ˜¯ï¼Œ**ç»“æ„ä½“å­—é¢å€¼å¹¶æ²¡æœ‰ç®€çŸ­è¡¨ç¤ºåŒ¿åæˆå‘˜çš„è¯­æ³•**ï¼Œ å› æ­¤ä¸‹é¢çš„è¯­å¥éƒ½ä¸èƒ½ç¼–è¯‘é€šè¿‡ï¼š

```Go
w = Wheel{8, 8, 5, 20}                       // compile error: unknown fields
w = Wheel{X: 8, Y: 8, Radius: 5, Spokes: 20} // compile error: unknown fields
```

å¯ä»¥ä½¿ç”¨ä¸‹é¢ä¸¤ç§å†™æ³•ï¼š

```go
w = Wheel{Circle{Point{8, 8}, 5}, 20}

w = Wheel{
    Circle: Circle{
        Point:  Point{X: 8, Y: 8},
        Radius: 5,
    },
    Spokes: 20, // NOTE: trailing comma necessary here (and at Radius)
}
```

åŒ¿åæˆå‘˜å¹¶ä¸è¦æ±‚æ˜¯ç»“æ„ä½“ç±»å‹ï¼Œå‘½åç±»å‹ä¹Ÿå¯ä»¥ä½œä¸ºåŒ¿åæˆå‘˜ã€‚åŒ¿åç±»å‹çš„æ–¹æ³•é›†ã€‚ã€‚.è¿ç®—ä¸ä»…å¯ä»¥è·å¾—åŒ¿åæˆå‘˜çš„åµŒå¥—æˆå‘˜ï¼Œä¹Ÿå¯ä»¥è·å¾—å®ƒä»¬çš„æ–¹æ³•



**å½“åŒ¿ååµŒå…¥æ˜¯éå…¬å¼€çš„æ—¶ï¼Œæ— æ³•ç›´æ¥é€šè¿‡ç»“æ„ä½“å­—é¢é‡çš„æ–¹å¼åˆå§‹åŒ–åŒ¿åçš„å†…éƒ¨ç±»å‹ï¼Œä¸è¿‡ç”±äºç±»å‹æå‡ï¼Œä¾ç„¶å¯ä»¥è®¾ç½®å†…éƒ¨ç±»å‹çš„å…¬å¼€æˆå‘˜çš„å€¼ï¼ˆå†…éƒ¨ç±»å‹çš„æ ‡è¯†ç¬¦æå‡åˆ°äº†å¤–éƒ¨ç±»å‹ï¼‰**!!!!!!!!!!!!!!!!!

```go
package important

type a struct {
	aa int
	AA int
}

type B struct {
	a
	bb int
	BB int
}



package main

import (
	"fmt"
	"myLearnProject/important"
)

func main() {
	b := important.B{
		BB: 1,
		//bb: 1,  //Unexported field 'bb' usage in struct literal
		//AA: 1,  //Unknown field 'AA' in struct literal
	}
	b.AA = 2
	fmt.Printf("%v", b) //{{0 2} 0 1}
}
```



### newå’Œmake

newï¼šç”³è¯·äº†å†…å­˜ï¼Œä½†æ˜¯ä¸ä¼šå°†å†…å­˜åˆå§‹åŒ–ï¼Œåªä¼šå°†å†…å­˜ç½®é›¶ï¼Œè¿”å›ä¸€ä¸ªæŒ‡é’ˆã€‚

- `newobject`->`mallocgc`

makeï¼šç”³è¯·äº†å†…å­˜ï¼Œè¿”å›å·²åˆå§‹åŒ–çš„ç»“æ„ä½“çš„é›¶å€¼ã€‚

- åœ¨ç¼–è¯‘æœŸé—´çš„ç±»å‹æ£€æŸ¥é˜¶æ®µï¼ŒGo è¯­è¨€ä¼šå°†ä»£è¡¨ `make` å…³é”®å­—çš„ `OMAKE` èŠ‚ç‚¹æ ¹æ®å‚æ•°ç±»å‹çš„ä¸åŒè½¬æ¢æˆäº† `OMAKESLICE`ã€`OMAKEMAP` å’Œ `OMAKECHAN` ä¸‰ç§ä¸åŒç±»å‹çš„èŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹ä¼šè°ƒç”¨ä¸åŒçš„è¿è¡Œæ—¶å‡½æ•°æ¥åˆå§‹åŒ–ç›¸åº”çš„æ•°æ®ç»“æ„ã€‚





## 5. JSON

```go
type Movie struct {
    Title  string
    Year   int  `json:"released"`      //tagå¯ä»¥ä½¿æˆå‘˜å˜ä¸ºjsonåçš„å­—æ®µåæ›´æ”¹
    Color  bool `json:"color,omitempty"`  //omitemptyè¡¨ç¤ºå½“è¯¥æˆå‘˜ä¸ºç©ºæˆ–é›¶å€¼æ—¶JSONå¯¹è±¡ä¸ç”Ÿæˆè¯¥å­—æ®µ
    Actors []string
}

var movies = []Movie{
    {Title: "Casablanca", Year: 1942, Color: false,
        Actors: []string{"Humphrey Bogart", "Ingrid Bergman"}},
    {Title: "Cool Hand Luke", Year: 1967, Color: true,
        Actors: []string{"Paul Newman"}},
    {Title: "Bullitt", Year: 1968, Color: true,
        Actors: []string{"Steve McQueen", "Jacqueline Bisset"}},
    // ...
}
```

è¿™æ ·çš„æ•°æ®éå¸¸é€‚åˆjsonæ ¼å¼ï¼Œå°†ä¸€ä¸ªGoè¯­è¨€ä¸­ç±»ä¼¼moviesçš„**ç»“æ„ä½“sliceè½¬ä¸ºJSON**çš„è¿‡ç¨‹å«**ç¼–ç»„**ï¼ˆmarshalingï¼‰ã€‚ç¼–ç»„é€šè¿‡è°ƒç”¨`json.Marshal`å‡½æ•°å®Œæˆï¼Œè¦è¾“å‡ºæ ¼å¼åŒ–çš„jsonå¯ä»¥ä½¿ç”¨`json.MarshallIndent`å‡½æ•°

```go
data, err := json.Marshal(movies)
if err != nil {
    log.Fatalf("JSON marshaling failed: %s", err)
}
fmt.Printf("%s\n", data)
/*
[{"Title":"Casablanca","released":1942,"Actors":["Humphrey Bogart","Ingr
id Bergman"]},{"Title":"Cool Hand Luke","released":1967,"color":true,"Ac
tors":["Paul Newman"]},{"Title":"Bullitt","released":1968,"color":true,"
Actors":["Steve McQueen","Jacqueline Bisset"]}]
*/
data, err := json.MarshalIndent(movies, "", "    ")  //æ ¼å¼åŒ–çš„json
```

ä½¿ç”¨`json.Unmarshal`è¿›è¡Œè§£ç ï¼Œå°†jsonè§£ç ä¸ºgoè¯­è¨€çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥**åªè§£ç æˆ‘ä»¬å…³æ³¨çš„å­—æ®µ**

```go
var titles []struct{ Title string }
if err := json.Unmarshal(data, &titles); err != nil {
    log.Fatalf("JSON unmarshaling failed: %s", err)
}
fmt.Println(titles) // "[{Casablanca} {Cool Hand Luke} {Bullitt}]"
```

## 6. æ–‡æœ¬å’ŒHTMLæ¨¡ç‰ˆ





## 7. golangç±»å‹æ€»ç»“

åŸºæœ¬ç±»å‹(å†…ç½®ç±»å‹)ï¼šæ•°å€¼ï¼Œå­—ç¬¦ä¸²ï¼Œå¸ƒå°”

å¤åˆç±»å‹ï¼šæ•°ç»„å’Œç»“æ„ä½“

å¼•ç”¨ç±»å‹ï¼šæŒ‡é’ˆã€åˆ‡ç‰‡ã€mapã€channel

æ¥å£ç±»å‹ï¼šæ¥å£

å‡½æ•°ç±»å‹



## 8. å…³äºå¯ç­‰æ€§

`==`æ“ä½œçš„å‰ææ˜¯ä¸¤ä¸ªæ“ä½œæ•°çš„**ç±»å‹å¿…é¡»ç›¸åŒ**ï¼Œå¦‚æœç±»å‹ä¸åŒï¼Œç¼–è¯‘æ—¶å°±ä¼šæŠ¥é”™ï¼Œè€Œä¸”ç±»å‹éå¸¸ä¸¥æ ¼ï¼Œä¸ä¼šè¿›è¡Œç±»å‹çš„éšå¼è½¬æ¢ï¼Œå³ä½¿åº•å±‚ç±»å‹ç›¸åŒä¹Ÿä¸èƒ½ç›´æ¥æ¯”è¾ƒ

ä¾‹å¦‚ï¼š

```go
    var a int8
    var b int16
    // ç¼–è¯‘é”™è¯¯ï¼šinvalid operation a == b (mismatched types int8 and int16)
    fmt.Println(a == b)
    

    type int8 myint8
    var a int8
    var b myint8
    // ç¼–è¯‘é”™è¯¯ï¼šinvalid operation a == b (mismatched types int8 and myint8)
    fmt.Println(a == b)
```

### åŸºæœ¬ç±»å‹

åŸºæœ¬ç±»å‹åªè¦ç±»å‹ç›¸åŒå¯ä»¥ç›´æ¥æ¯”è¾ƒ

æ³¨æ„æµ®ç‚¹æ•°ä¸èƒ½ç²¾ç¡®è¡¨ç¤º

```go
var a float64 = 0.1
var b float64 = 0.2
var c float64 = 0.3
fmt.Println(a + b == c) // false
```



### å¤åˆç±»å‹

å¯¹äºæ•°ç»„å’Œç»“æ„ä½“è¿™ç§å¤åˆç±»å‹ï¼Œéœ€è¦é€ä¸ªå…ƒç´ /é€ä¸ªå­—æ®µæ¯”è¾ƒï¼Œæ ¹æ®å…ƒç´ çš„ç±»å‹å†æŒ‰ç›¸åº”è§„åˆ™è¿›è¡Œæ¯”è¾ƒ

æ³¨æ„é•¿åº¦ä¸åŒçš„ä¸¤ä¸ªæ•°ç»„ç±»å‹ä¸åŒï¼Œä¸èƒ½ç›´æ¥æ¯”è¾ƒ

```go
type A struct {
    a int
    b string
}
aa := A { a : 1, b : "test1" }
bb := A { a : 1, b : "test1" }
cc := A { a : 1, b : "test2" }
fmt.Println(aa == bb)   //true
fmt.Println(aa == cc)	//false
```

å¦‚æœæ•°ç»„æˆ–è€…ç»“æ„ä½“ä¸­å«æœ‰ä¸å¯æ¯”è¾ƒç±»å‹ï¼ˆä¾‹å¦‚mapï¼Œsliceç­‰ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°ç»„/ç»“æ„ä½“ä¹Ÿæ˜¯ä¸å¯æ¯”è¾ƒçš„



### å¼•ç”¨ç±»å‹

å¼•ç”¨ç±»å‹æ˜¯é—´æ¥æŒ‡å‘ä»–ä»¬æ‰€å¼•ç”¨çš„æ•°æ®çš„ï¼Œä¿å­˜çš„æ˜¯æ•°æ®çš„åœ°å€

å¼•ç”¨ç±»å‹çš„æ¯”è¾ƒå®é™…ä¸Šæ˜¯**åˆ¤æ–­ä¸¤ä¸ªå˜é‡æ˜¯ä¸æ˜¯æŒ‡å‘åŒä¸€ä»½æ•°æ®**ï¼Œä»–ä»¬ä¸ä¼šæ¯”è¾ƒå®é™…æŒ‡å‘çš„æ•°æ®

ç‰¹æ®Šè§„å®šï¼š

- `åˆ‡ç‰‡`ä¹‹é—´ä¸å…è®¸æ¯”è¾ƒã€‚`åˆ‡ç‰‡`åªèƒ½ä¸`nil`å€¼æ¯”è¾ƒã€‚
- `map`ä¹‹é—´ä¸å…è®¸æ¯”è¾ƒã€‚`map`åªèƒ½ä¸`nil`å€¼æ¯”è¾ƒã€‚

å› ä¸ºinterface{}ç±»å‹çš„åˆ‡ç‰‡å¯ä»¥æŒ‡å‘è‡ªå·±ï¼Œé€’å½’å¼•ç”¨ï¼Œå¦‚æœæ¯”è¾ƒé‡Œé¢çš„å…ƒç´ ï¼Œå¯èƒ½ä¼šç›´æ¥çˆ†æ ˆï¼Œgolangè§„å®š**åˆ‡ç‰‡ä¸å…è®¸æ¯”è¾ƒ**ï¼Œä½¿ç”¨`==`æ“ä½œçš„æ—¶å€™ç›´æ¥ç¼–è¯‘æŠ¥é”™

å¯¹äºmapï¼Œå› ä¸ºmapç±»å‹çš„å€¼ç±»å‹å¯èƒ½æ˜¯ä¸å¯æ¯”è¾ƒçš„ç±»å‹ï¼Œæ‰€ä»¥mapä¹Ÿä¸å…è®¸æ¯”è¾ƒ

mapçš„keyæ˜¯ä½¿ç”¨`==`æ¥åˆ¤æ–­çš„ï¼Œæ‰€ä»¥æ‰€æœ‰ä¸å¯æ¯”è¾ƒç±»å‹éƒ½ä¸å¯ä»¥ä½œä¸ºmapçš„key



çœ‹çœ‹æŒ‡é’ˆçš„æ¯”è¾ƒï¼š

```go
type A struct {
    a int
    b string
}

aa := &A { a : 1, b : "test1" }
bb := &A { a : 1, b : "test1" }
cc := aa
fmt.Println(aa == bb)
fmt.Println(aa == cc)
```

å› ä¸º`aa`å’Œ`bb`æŒ‡å‘çš„ä¸¤ä¸ªä¸åŒçš„ç»“æ„ä½“ï¼Œè™½ç„¶å®ƒä»¬æŒ‡å‘çš„å€¼æ˜¯ç›¸ç­‰çš„ï¼ˆè§ä¸Šé¢å¤åˆç±»å‹çš„æ¯”è¾ƒï¼‰ï¼Œä½†æ˜¯å®ƒä»¬ä¸ç­‰ã€‚ `aa`å’Œ`cc`æŒ‡å‘ç›¸åŒçš„ç»“æ„ä½“ï¼Œæ‰€ä»¥å®ƒä»¬ç›¸ç­‰ã€‚



å†çœ‹channelï¼š

```go
ch1 := make(chan int, 1)
ch2 := make(chan int, 1)
ch3 := ch1

fmt.Println(ch1 == ch2)
fmt.Println(ch1 == ch3)
```

`ch1`å’Œ`ch2`è™½ç„¶ç±»å‹ç›¸åŒï¼Œä½†æ˜¯æŒ‡å‘ä¸åŒçš„`channel`ï¼Œæ‰€ä»¥å®ƒä»¬ä¸ç­‰ã€‚ `ch1`å’Œ`ch3`æŒ‡å‘ç›¸åŒçš„`channel`ï¼Œæ‰€ä»¥å®ƒä»¬ç›¸ç­‰ã€‚



### æ¥å£ç±»å‹

æ¥å£ç±»å‹çš„å€¼æ˜¯ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆçš„ï¼šåŠ¨æ€ç±»å‹å’ŒåŠ¨æ€å€¼

æ¥å£æ¯”è¾ƒï¼Œå¿…é¡»è¦**åŠ¨æ€ç±»å‹ç›¸åŒ(ä¸€ä¸ªæ¥å£å¯ä»¥è½¬åŒ–ä¸ºå¦ä¸€ä¸ªæ¥å£)**ï¼Œå¹¶ä¸”**åŠ¨æ€å€¼ç›¸ç­‰**ï¼Œè¿™ä¸¤ä¸ªæ¥å£å€¼æ‰æ˜¯ç›¸ç­‰çš„

```go
type A struct {
    a int
    b string
}

var aa interface{} = A { a: 1, b: "test" }
var bb interface{} = A { a: 1, b: "test" }
var cc interface{} = A { a: 2, b: "test" }

fmt.Println(aa == bb) // true
fmt.Println(aa == cc) // false

var dd interface{} = &A { a: 1, b: "test" }
var ee interface{} = &A { a: 1, b: "test" }
fmt.Println(dd == ee) // false
```

`aa`å’Œ`bb`åŠ¨æ€ç±»å‹ç›¸åŒï¼ˆéƒ½æ˜¯`A`ï¼‰ï¼ŒåŠ¨æ€å€¼ä¹Ÿç›¸åŒï¼ˆç»“æ„ä½“`A`ï¼Œè§ä¸Šé¢å¤åˆç±»å‹çš„æ¯”è¾ƒè§„åˆ™ï¼‰ï¼Œæ•…ä¸¤è€…ç›¸ç­‰ã€‚ `aa`å’Œ`cc`åŠ¨æ€ç±»å‹ç›¸åŒï¼ŒåŠ¨æ€å€¼ä¸åŒï¼Œæ•…ä¸¤è€…ä¸ç­‰ã€‚

 `dd`å’Œ`ee`åŠ¨æ€ç±»å‹ç›¸åŒï¼ˆéƒ½æ˜¯`*A`ï¼‰ï¼ŒåŠ¨æ€å€¼ä½¿ç”¨æŒ‡é’ˆï¼ˆå¼•ç”¨ï¼‰ç±»å‹çš„æ¯”è¾ƒï¼Œç”±äºä¸æ˜¯æŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œæ•…ä¸ç­‰ã€‚



### å‡½æ•°ç±»å‹

ä¸èƒ½æ¯”è¾ƒ



# å››ã€å‡½æ•°



## 1. å¤šè¿”å›å€¼

å¦‚æœä¸€ä¸ªå‡½æ•°æ‰€æœ‰çš„è¿”å›å€¼éƒ½æœ‰æ˜¾å¼çš„å˜é‡åï¼Œé‚£ä¹ˆè¯¥å‡½æ•°çš„returnè¯­å¥å¯ä»¥çœç•¥æ“ä½œæ•°ã€‚è¿™ç§°ä¹‹ä¸ºbare return

```Go
func CountWordsAndImages(url string) (words, images int, err error) {
    resp, err := http.Get(url)
    if err != nil {
        return
    }
    doc, err := html.Parse(resp.Body)
    resp.Body.Close()
    if err != nil {
        err = fmt.Errorf("parsing HTML: %s", err)
        return
    }
    words, images = countWordsAndImages(doc)
    return
}
```

æ¯ä¸€ä¸ªreturnè¯­å¥ç­‰ä»·äºï¼š`return words, images, err`

## 2. é”™è¯¯

### é”™è¯¯å¤„ç†ç­–ç•¥

1. **é”™è¯¯ä¼ æ’­æ–¹å¼**ï¼šå‡½æ•°ä¸­æŸä¸ªå­ç¨‹åºçš„å¤±è´¥ï¼Œä¼šå˜æˆè¯¥å‡½æ•°çš„å¤±è´¥ï¼Œå³æŠŠé”™è¯¯è¿”å›ç»™è°ƒç”¨è€…

```go
resp, err := http.Get(url)
if err != nil{
    return nil, err
}
```

æˆ–è€…ä¸ç›´æ¥è¿”å›é”™è¯¯ï¼Œè€Œæ˜¯æ„é€ ä¸€ä¸ªé”™è¯¯ä¿¡æ¯è¿”å›ã€‚é”™è¯¯æœ€ç»ˆç”±mainå‡½æ•°å¤„ç†æ—¶ï¼Œé”™è¯¯ä¿¡æ¯åº”æä¾›æ¸…æ™°çš„ä»åŸå› åˆ°åæœçš„å› æœé“¾

```Go
doc, err := html.Parse(resp.Body)
resp.Body.Close()
if err != nil {
    return nil, fmt.Errorf("parsing %s as HTML: %v", url,err)
}
```



2. **é‡æ–°å°è¯•**ï¼šå¦‚æœé”™è¯¯çš„å‘ç”Ÿæ˜¯å¶ç„¶æ€§çš„ï¼Œæˆ–ç”±ä¸å¯é¢„çŸ¥çš„é—®é¢˜å¯¼è‡´çš„ã€‚ä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹©æ˜¯é‡æ–°å°è¯•å¤±è´¥çš„æ“ä½œã€‚åœ¨é‡è¯•æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é™åˆ¶é‡è¯•çš„æ—¶é—´é—´éš”æˆ–é‡è¯•çš„æ¬¡æ•°ï¼Œé˜²æ­¢æ— é™åˆ¶çš„é‡è¯•

```go
func WaitForServer(url string) error {
    const timeout = 1 * time.Minute
    deadline := time.Now().Add(timeout)
    for tries := 0; time.Now().Before(deadline); tries++ {
        _, err := http.Head(url)
        if err == nil {
            return nil // success
        }
        log.Printf("server not responding (%s);retryingâ€¦", err)
        time.Sleep(time.Second << uint(tries)) // exponential back-off
    }
    return fmt.Errorf("server %s failed to respond after %s", url, timeout)
}
```



3. å¦‚æœé”™è¯¯å‘ç”Ÿåç¨‹åºæ— æ³•ç»§ç»­æ‰§è¡Œï¼Œå°±è¦é‡‡ç”¨ç¬¬ä¸‰ç§ç­–ç•¥**è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œç»“æŸç¨‹åº**ï¼Œè¿™ç§ç­–ç•¥åªåº”è¯¥åœ¨mainå‡½æ•°ä¸­æ‰§è¡Œï¼Œåº“å‡½æ•°åªåº”è¯¥å‘ä¸Šä¼ æ’­ï¼Œé™¤éè¯¥é”™è¯¯æ„å‘³ç€ç¨‹åºå†…éƒ¨åŒ…å«ä¸ä¸€è‡´æ€§ï¼Œå³é‡åˆ°äº†bugï¼Œæ‰èƒ½åœ¨åº“å‡½æ•°ä¸­ç»“æŸç¨‹åº

```go
if err := WaitForServer(url); err != nil {
    fmt.Fprintf(os.Stderr, "Site is down: %v\n", err)
    os.Exit(1)
}

//æˆ–è€…é‡‡ç”¨log.Fatalfï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„æ•ˆæœ
if err := WaitForServer(url); err != nil {
    log.Fatalf("Site is down: %v\n", err)
}
```



4. åªè¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œä¸ä¸­æ–­ç¨‹åº

```go
if err := Ping(); err != nil {
    log.Printf("ping failed: %v; networking disabled",err)
}
```



5. ç›´æ¥å¿½ç•¥æ‰é”™è¯¯





### æ–‡ä»¶ç»“å°¾é”™è¯¯EOF

ioåŒ…ä¿è¯ä»»ä½•ç”±**æ–‡ä»¶ç»“æŸå¼•èµ·çš„è¯»å–å¤±è´¥**éƒ½è¿”å›åŒä¸€ä¸ªé”™è¯¯â€”â€”`io.EOF`

å¯ä»¥ä»¥æ­¤æ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦è¯»å–å®Œæ¯•

```go
in := bufio.NewReader(os.Stdin)
for {
    r, _, err := in.ReadRune()
    if err == io.EOF {
        break // finished reading
    }
    if err != nil {
        return fmt.Errorf("read failed:%v", err)
    }
    // ...use râ€¦
}
```

## 3. åŒ¿åå‡½æ•°å’Œé—­åŒ…

å½“åŒ¿åå‡½æ•°éœ€è¦è¢«é€’å½’è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»é¦–å…ˆå£°æ˜ä¸€ä¸ªå˜é‡ï¼Œå†å°†åŒ¿åå‡½æ•°èµ‹å€¼ç»™è¿™ä¸ªå˜é‡ã€‚å¦‚æœä¸åˆ†æˆä¸¤éƒ¨ï¼Œå‡½æ•°å­—é¢é‡æ— æ³•ä¸visitAllç»‘å®šï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•é€’å½’è°ƒç”¨è¯¥åŒ¿åå‡½æ•°ï¼Œ`å› ä¸ºæ­¤æ—¶visitAllè¿˜æ²¡å£°æ˜`

```go
visitAll := func(items []string) {
    // ...
    visitAll(m[item]) // compile error: undefined: visitAll
    // ...
}
```

åº”è¯¥æŒ‰ä¸‹é¢çš„æ ¼å¼ï¼š

```go
var visitAll func(items []string)
visitAll = func(items []string) {
    // ...
    visitAll(m[item]) // compile error: undefined: visitAll
    // ...
}
```



### é—­åŒ…


åŒ¿åå‡½æ•°ä¸­æ•è·å¤–éƒ¨å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œè¿™ç§åŒ¿åå‡½æ•°ä¸€èˆ¬ç§°ä¸º`é—­åŒ…`ã€‚**é—­åŒ…å¯¹æ•è·çš„å¤–éƒ¨å˜é‡å¹¶ä¸æ˜¯ä»¥å€¼ä¼ é€’çš„æ–¹å¼è®¿é—®ï¼Œè€Œæ˜¯ä»¥å¼•ç”¨ä¼ é€’çš„æ–¹å¼è®¿é—®**

```go
func Inc() (i int) {    //æœ€åè¿”å›43
  defer func() {i++}
  return 42
}
```

é—­åŒ…å¯èƒ½å¸¦æ¥ä¸€äº›éšå«é—®é¢˜ï¼šå› ä¸ºæ˜¯é—­åŒ…ï¼Œæ‰€ä»¥æ˜¯åŠ ä¸Šdeferæ‰§è¡Œæ—¶éƒ½æ˜¯å¼•ç”¨çš„åŒä¸€ä¸ªå˜é‡iï¼Œç»“æŸæ—¶iæ˜¯3

```go
func main() {
  for i:=0; i<3; i++ {
    defer func(){ fmt.Print(i) }()
  }
}
// 333
```

**å¾ªç¯å˜é‡ä½œç”¨åŸŸé—®é¢˜**ï¼šåœ¨ for å¾ªç¯å¼•è¿›çš„ä¸€ä¸ªå—ä½œç”¨åŸŸå†…è¿›è¡Œå£°æ˜ã€‚åœ¨å¾ªç¯é‡Œåˆ›å»ºçš„æ‰€æœ‰å‡½æ•°å˜é‡å…±äº«ç›¸åŒçš„å˜é‡ï¼Œå°±æ˜¯ä¸€ä¸ªå¯è®¿é—®çš„å­˜å‚¨ä½ç½®ï¼Œè€Œä¸æ˜¯å›ºå®šçš„å€¼

```go
var slice []func()

func main() {
	sli := []int{1, 2, 3, 4, 5}
	var a = 10
	for _, v := range sli {
		fmt.Println(&v)
		slice = append(slice, func(){
			a++
			fmt.Println(v, &v)
			fmt.Println(a, &a) // ç›´æ¥æ‰“å°ç»“æœ
		})
	}

	for _, val  := range slice {
		val()
	}
}

/*
5  0xc00000a0b8
11 0xc00000a098
5  0xc00000a0b8
12 0xc00000a098
5  0xc00000a0b8
13 0xc00000a098
5  0xc00000a0b8
14 0xc00000a098
5  0xc00000a0b8
15 0xc00000a098
*/
```



è§£å†³åŠæ³•ï¼šå¯ä»¥**ä½œä¸ºå‚æ•°ä¼ é€’è¿›åŒ¿åå‡½æ•°**ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨




## 4. å¯å˜å‚æ•°

```go
func sum(vals...int) int {
    total := 0
    for _, val := range vals {
        total += val
    }
    return total
}
```

valsè¢«çœ‹ä½œæ˜¯[]intçš„åˆ‡ç‰‡ï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶ä¸æ˜¯åˆ‡ç‰‡ï¼Œå’Œä»¥åˆ‡ç‰‡ä½œä¸ºå‚æ•°è¿˜æ˜¯ä¸åŒçš„



å¦‚æœåˆ‡ç‰‡ä½œä¸ºå‚æ•°ä¼ é€’çš„æ—¶å€™ï¼Œéœ€è¦**å¯¹åˆ‡ç‰‡è¿›è¡Œç»“æ„**ï¼Œå³ä¼ å…¥åˆ‡ç‰‡çš„...

**å¯å˜å‚æ•°å¿…é¡»æ˜¯å¯å˜å‚æ•°å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°**



## 5. deferå»¶è¿Ÿè°ƒç”¨æœºåˆ¶

1. å¤´æ’æ³•
2. å‚æ•°é¢„è®¡ç®—

> `defer` ä¼ å…¥çš„å‡½æ•°ä¸æ˜¯åœ¨é€€å‡ºä»£ç å—çš„ä½œç”¨åŸŸæ—¶æ‰§è¡Œçš„ï¼Œå®ƒåªä¼šåœ¨å½“å‰å‡½æ•°å’Œæ–¹æ³•è¿”å›ä¹‹å‰è¢«è°ƒç”¨ã€‚

å¯¹äºå‡½æ•°æˆ–æ–¹æ³•å‰åŠ äº†diferå…³é”®å­—çš„ï¼Œå½“æ‰§è¡Œåˆ°è¯¥æ¡è¯­å¥æ—¶ï¼Œ`å‡½æ•°`å’Œ`å‚æ•°è¡¨è¾¾å¼`å¾—åˆ°è®¡ç®—ï¼Œä½†**ç›´åˆ°åŒ…å«è¯¥deferè¯­å¥çš„å‡½æ•°æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œdeferåçš„å‡½æ•°æ‰ä¼šè¢«æ‰§è¡Œ**ï¼Œä¸è®ºåŒ…å«deferè¯­å¥çš„å‡½æ•°æ˜¯é€šè¿‡returnæ­£å¸¸ç»“æŸï¼Œè¿˜æ˜¯ç”±äºpanicå¯¼è‡´çš„å¼‚å¸¸ç»“æŸã€‚ä½ å¯ä»¥åœ¨ä¸€ä¸ªå‡½æ•°ä¸­æ‰§è¡Œå¤šæ¡deferè¯­å¥ï¼Œå®ƒä»¬çš„**æ‰§è¡Œé¡ºåºä¸å£°æ˜é¡ºåºç›¸å**ã€‚æ³¨æ„**åœ¨deferä¹‹åæ‰§è¡Œå®Œæ¯•**æ‰ä¼šæ‰§è¡Œdiferè¯­å¥

```go
//å¤„ç†æ–‡ä»¶è¯»å†™
func ReadFile(filename string) ([]byte, error) {
    f, err := os.Open(filename)
    if err != nil {
        return nil, err
    }
    defer f.Close()
    return ReadAll(f)
}
```

```Go
//å¤„ç†äº’æ–¥é”
var mu sync.Mutex
var m = make(map[string]int)
func lookup(key string) int {
    mu.Lock()
    defer mu.Unlock()
    return m[key]
}
```



### å¤šé‡defer

æ³¨æ„ï¼š

```go
//æ³¨æ„deferåŠ è½½å’Œä¼ å€¼çš„æ—¶é—´

func main() {
	a := 10
	defer func() {            
		fmt.Println(a)
	}()

	defer func(a int) {			// æ­¤æ—¶ï¼Œå°†a=10ä¼ é€’ç»™äº†funcçš„å‡½æ•°å‚æ•°ï¼Œåªæ˜¯å‡½æ•°è¢«å»¶è¿Ÿæ‰§è¡Œ
		fmt.Println(a)      
	}(a)

	a = 100
}

/*
10
100
*/
```



### ä½¿ç”¨deferè®°å½•å‡½æ•°æ‰§è¡Œæ—¶é—´

**è®°å½•å‡½æ•°çš„æ‰§è¡Œæ—¶é—´ï¼š** bigSlowOperationè¢«è°ƒæ—¶ï¼Œ**traceä¼šè¿”å›ä¸€ä¸ªåŒ¿åå‡½æ•°func()**ï¼Œè¯¥**å‡½æ•°å€¼ä¼šåœ¨bigSlowOperationé€€å‡ºæ—¶è¢«è°ƒç”¨**ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œ æˆ‘ä»¬å¯ä»¥åªé€šè¿‡ä¸€æ¡è¯­å¥æ§åˆ¶å‡½æ•°çš„å…¥å£å’Œæ‰€æœ‰çš„å‡ºå£ï¼Œç”šè‡³å¯ä»¥è®°å½•å‡½æ•°çš„è¿è¡Œæ—¶é—´ï¼Œå¦‚ä¾‹å­ä¸­çš„startã€‚éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼š**ä¸è¦å¿˜è®°deferè¯­å¥åçš„åœ†æ‹¬å·**ï¼Œå¦åˆ™æœ¬è¯¥åœ¨è¿›å…¥æ—¶æ‰§è¡Œçš„æ“ä½œä¼šåœ¨é€€å‡ºæ—¶æ‰§è¡Œï¼Œè€Œæœ¬è¯¥åœ¨é€€å‡ºæ—¶æ‰§è¡Œçš„ï¼Œæ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œ

```go
func bigSlowOperation() {
    defer trace("bigSlowOperation")() // don't forget the extra parentheses
    // ...lots of workâ€¦
    time.Sleep(10 * time.Second) // simulate slow operation by sleeping
}
func trace(msg string) func() {
    start := time.Now()
    log.Printf("enter %s", msg)
    return func() { 
        log.Printf("exit %s (%s)", msg,time.Since(start)) 
    }
}
```

`defer`åœ¨**returnä¹‹å**æ‰§è¡Œï¼Œä½†æ˜¯å¯ä»¥ä¿®æ”¹returnè¿”å›ç»™è°ƒç”¨è€…çš„å€¼



### deferçš„å°å‘-å¾ªç¯

å¾ªç¯ä½“ä¸­çš„deferè¯­å¥ä¼šè¢«å»¶è¿Ÿåˆ°å¾ªç¯æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰ä¼šæ‰§è¡Œï¼Œè§£å†³æ–¹æ³•æ˜¯æŠŠå¾ªç¯ä½“ä¸­çš„deferæ”¾åˆ°å¦ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œæ¯æ¬¡å¾ªç¯è°ƒç”¨è¯¥å‡½æ•°

```go
for _, filename := range filenames {
    if err := doFile(filename); err != nil {
        return err
    }
}
func doFile(filename string) error {
    f, err := os.Open(filename)
    if err != nil {
        return err
    }
    defer f.Close()
    // ...process fâ€¦
}
```



### deferçš„å°å‘-è¿”å›å€¼

```go
func hello1(i *int) (j int) {
	defer func() {
		j = 19
	}()
	j = *i
	return j
}

func hello2(i *int) (j int) {
	defer func() {
		j = 19
	}()
	return *i
}

func hello3(i *int) int {
	defer func() {
		*i = 19
	}()
	return *i
}

func main() {
	i := 10
	j := hello1(&i)
	fmt.Println(i, j)
	i = 10
	j = hello2(&i)
	fmt.Println(i, j)
	i = 10
	j = hello3(&i)
	fmt.Println(i, j)
}
```

è¾“å‡ºï¼š

```go
10 19
10 19
19 10
```

æ€»ç»“ï¼š

- **å‘½åè¿”å›å€¼ï¼šå°±å¥½æ¯”å‡½æ•°å‚æ•°ä¸€æ ·ï¼Œå‡½æ•°ä½“å†…å¯¹å‘½åè¿”å›å€¼çš„ä»»ä½•ä¿®æ”¹ï¼Œéƒ½ä¼šå½±å“å®ƒã€‚**
- **éå‘½åè¿”å›å€¼ï¼šå–å†³äº return æ—¶å€™çš„å€¼**ï¼Œä¹‹ådeferçš„ä¿®æ”¹ä¸èƒ½å½±å“åˆ°è¿”å›å€¼äº†



## 6. error æ¥å£

```go
type error interface {
    Error() string
}
```

åˆ›å»ºerroræœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯è°ƒç”¨errors.Newå‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„error

```go
err = errors.New("é”™è¯¯ä¿¡æ¯")
```

**errorsåŒ…ï¼š**

```go
package errors

func New(text string) error { return &errorString{text} }  //è¿”å›errorå¯¹è±¡çš„åœ°å€ï¼Œé¿å…ä¸¤ä¸ªerrorç›¸ç­‰
type errorString struct { text string }		//errorStringå®ç°äº†erroræ¥å£çš„å…¨éƒ¨æ–¹æ³•
func (e *errorString) Error() string { return e.text }  //*errorStringå®ç°äº†erroræ¥å£çš„Error()æ–¹æ³•
```

ä½¿ç”¨errors.Newå‡½æ•°çš„æƒ…å†µè¿˜æ˜¯æ¯”è¾ƒå°‘

æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ä¸€ä¸ªæ›´æ–¹ä¾¿çš„å°è£…å‡½æ•°ï¼š**fmt.Errorf**ï¼Œä»–è¿˜ä¼šå¤„ç†å­—ç¬¦ä¸²çš„æ ¼å¼åŒ–

```go
func Errorf(format string, args ...interface{}) error {
  return errors.New(Sprintf(format, args...))   //Errorfå‡½æ•°å®é™…ä¸Šè¿˜æ˜¯è°ƒç”¨çš„errors.New()
}
```



è¿”å›é”™è¯¯ï¼Œè°ƒç”¨è€…è‡ªè¡Œæ•è·é”™è¯¯ä¿¡æ¯



**errorè¿”å›çš„æ˜¯ä¸€èˆ¬æ€§é”™è¯¯ï¼Œå¯ä»¥è¿›è¡Œå¤„ç†ï¼Œç»§ç»­è¿è¡Œã€‚ã€‚ã€‚panicä¸€èˆ¬æ˜¯è®©ç¨‹åºä¸èƒ½ç»§ç»­è¿è¡Œçš„é”™è¯¯**

## 7. Panicå¼‚å¸¸

ç¼–è¯‘å™¨æŠŠpanicè½¬æ¢ä¸º `runtime.gopanic`

1. åˆ›å»ºæ–°çš„ [runtime._panic](https://draveness.me/golang/tree/runtime._panic) å¹¶æ·»åŠ åˆ°æ‰€åœ¨ Goroutine çš„ `_panic` é“¾è¡¨çš„æœ€å‰é¢ï¼›
2. åœ¨å¾ªç¯ä¸­ä¸æ–­ä»å½“å‰ Goroutine çš„ `_defer` ä¸­é“¾è¡¨è·å– [runtime._defer](https://draveness.me/golang/tree/runtime._defer) å¹¶è°ƒç”¨ [runtime.reflectcall](https://draveness.me/golang/tree/runtime.reflectcall) è¿è¡Œå»¶è¿Ÿè°ƒç”¨å‡½æ•°ï¼›
3. è°ƒç”¨ [runtime.fatalpanic](https://draveness.me/golang/tree/runtime.fatalpanic) ä¸­æ­¢æ•´ä¸ªç¨‹åºï¼›
   1. æ‰“å°panicçš„ä¿¡æ¯
   2. è°ƒç”¨`exit(2)`é€€å‡ºç¨‹åº

ç¼–è¯‘å™¨ä¼šå°†å…³é”®å­— `recover` è½¬æ¢æˆ [runtime.gorecover](https://draveness.me/golang/tree/runtime.gorecover)ï¼š

```go
func gorecover(argp uintptr) interface{} {
	gp := getg()
	p := gp._panic
	if p != nil && !p.recovered && argp == uintptr(p.argp) {
		p.recovered = true
		return p.arg
	}
	return nil
}
```

![](picture/goè¯­è¨€è¦ç‚¹/2021-08-11_152842.png)



```c
type g struct {
	_panic       *_panic // innermost panic - offset known to liblink
	_defer       *_defer // innermost defer    
}

type _panic struct {
	argp      unsafe.Pointer // pointer to arguments of deferred call run during panic; cannot move - known to liblink
	arg       interface{}    // argument to panic
	link      *_panic        // link to earlier panic
	pc        uintptr        // where to return to in runtime if this panic is bypassed
	sp        unsafe.Pointer // where to return to in runtime if this panic is bypassed
	recovered bool           // whether this panic is over
	aborted   bool           // the panic was aborted
	goexit    bool
}

type _defer struct {
	siz     int32 // includes both arguments and results
	started bool
	heap    bool
	// openDefer indicates that this _defer is for a frame with open-coded
	// defers. We have only one defer record for the entire frame (which may
	// currently have 0, 1, or more defers active).
	openDefer bool
	sp        uintptr  // sp at time of defer
	pc        uintptr  // pc at time of defer
	fn        *funcval // can be nil for open-coded defers
	_panic    *_panic  // panic that is running defer
	link      *_defer

	// If openDefer is true, the fields below record values about the stack
	// frame and associated function that has the open-coded defer(s). sp
	// above will be the sp for the frame, and pc will be address of the
	// deferreturn call in the function.
	fd   unsafe.Pointer // funcdata for the function associated with the frame
	varp uintptr        // value of varp for the stack frame
	// framepc is the current pc associated with the stack frame. Together,
	// with sp above (which is the sp associated with the stack frame),
	// framepc/sp can be used as pc/sp pair to continue a stack trace via
	// gentraceback().
	framepc uintptr
}
```



- `panic` åªä¼šè§¦å‘**å½“å‰** Goroutine çš„ `defer`ï¼›
- `recover` åªæœ‰åœ¨ `defer` ä¸­è°ƒç”¨æ‰ä¼šç”Ÿæ•ˆï¼›
- `panic` å…è®¸åœ¨ `defer` ä¸­åµŒå¥—å¤šæ¬¡è°ƒç”¨ï¼›







- Goçš„ç±»å‹ç³»ç»Ÿä¼šåœ¨ç¼–è¯‘æ—¶æ•è·å¾ˆå¤šé”™è¯¯ï¼Œä½†æœ‰äº›é”™è¯¯åªèƒ½åœ¨è¿è¡Œæ—¶æ£€æŸ¥ï¼Œå¦‚`æ•°ç»„è®¿é—®è¶Šç•Œã€ç©ºæŒ‡é’ˆå¼•ç”¨`ç­‰ã€‚è¿™äº›è¿è¡Œæ—¶é”™è¯¯ä¼šå¼•èµ·paincå¼‚å¸¸

ä¸€èˆ¬è€Œè¨€ï¼Œå½“panicå¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œç¨‹åºä¼š**ä¸­æ–­è¿è¡Œ**ï¼Œå¹¶ç«‹å³æ‰§è¡Œåœ¨è¯¥goroutineä¸­**è¢«å»¶è¿Ÿçš„å‡½æ•°**ï¼ˆdefer æœºåˆ¶ï¼‰ã€‚éšåï¼Œç¨‹åº**å´©æºƒå¹¶è¾“å‡ºæ—¥å¿—ä¿¡æ¯**ã€‚æ—¥å¿—ä¿¡æ¯åŒ…æ‹¬panic valueå’Œå‡½æ•°è°ƒç”¨çš„å †æ ˆè·Ÿè¸ªä¿¡æ¯

- **ç›´æ¥è°ƒç”¨å†…ç½®çš„panicå‡½æ•°ä¹Ÿä¼šå¼•å‘panicå¼‚å¸¸**ï¼ŒæŸäº›ä¸è¯¥å‘ç”Ÿçš„åœºæ™¯å‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸»åŠ¨è°ƒç”¨panicè¡¨ç¤ºè·¯å¾„ä¸å¯è¾¾

## 8. recoveræ•è·å¼‚å¸¸

panicå¼‚å¸¸ä¸€æ—¦å‘ç”Ÿå°±ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚ã€‚

goè¯­è¨€ä¸ºæˆ‘ä»¬æä¾›äº†ä¸“é—¨æ‹¦æˆªè¿è¡Œæ—¶panicçš„å†…å»ºå‡½æ•° `recover`ï¼Œå®ƒå¯ä»¥ä½¿å½“å‰ç¨‹åºä»è¿è¡Œæ—¶panicçš„çŠ¶æ€ä¸­æ¢å¤ï¼Œå¹¶é‡æ–°è·å¾—æµç¨‹æ§åˆ¶æƒ...

**recoveråªæœ‰åœ¨deferè°ƒç”¨çš„å‡½æ•°ä¸­æœ‰æ•ˆ**ï¼Œdeferç›´æ¥è°ƒç”¨recoverä¸è¡Œï¼Œ**å¿…é¡»åŒ…è£…åœ¨å¦ä¸€ä¸ªå‡½æ•°ä¸­**

**åŒ…å«recoverçš„deferå¿…é¡»åœ¨å¯èƒ½å‡ºç°é”™è¯¯çš„è¯­å¥ä¹‹å‰å£°æ˜**

`func recover() interface{}`



```go
func errGenFunc(i int){
    arr := [10]int{}
    
    defer func(){  //deferä¸­é€šè¿‡åŒ¿åå‡½æ•°è°ƒç”¨recoverè¿›è¡Œé”™è¯¯æ‹¦æˆª
        recover()  //å¯ä»¥ä»panicå¼‚å¸¸ä¸­é‡æ–°è·å–æ§åˆ¶æƒ
    }()
    
    fmt.Println(arr[i])  //å¯èƒ½è¶Šç•Œï¼Œå¼•å‘panicå¼‚å¸¸ï¼Œä½¿ç¨‹åºåœæ­¢
}

func post(){fmt.Println("post....")}

func main(){
    errGenFunc(100)
    post()
}

/*
post...    //ä»panicä¸­æ¢å¤ï¼Œæ­£å¸¸æ‰§è¡Œåç»­ç¨‹åº
*/
```



Goè¯­è¨€åº“çš„ä¹ æƒ¯ï¼šå³ä½¿åŒ…å†…éƒ¨ä½¿ç”¨äº†panicï¼Œåœ¨å¯¼å‡ºå‡½æ•°æ—¶ä¹Ÿä¼šè¢«è½¬åŒ–ä¸ºæ˜ç¡®çš„é”™è¯¯å€¼

```go
//æ›´å¥½çš„å¤„ç†æ–¹å¼åº”è¯¥æ˜¯ï¼š
func Xxxx() {
  defer func(){
    if err := recover(); err! = nil{
      fmt.Errorf("Xxx: internal error: %v", err)   //å¤„ç†é”™è¯¯ä¿¡æ¯
    }
	}()
  
  .....
} 

```





## 9 for range 





# äº”ã€æ–¹æ³•

åœ¨å‡½æ•°å®šä¹‰æ—¶ï¼Œå‡½æ•°åå‰åŠ ä¸Šä¸€ä¸ªé™„åŠ å‚æ•°ï¼Œå°±å˜æˆäº†æ–¹æ³•ï¼Œè¡¨ç¤ºä¸ºè¿™ç§ç±»å‹å®šä¹‰äº†ä¸€ç§ç‹¬å çš„æ–¹æ³•

```go
type Point struct{ X, Y float64 }

// traditional function
func Distance(p, q Point) float64 {
    return math.Hypot(q.X-p.X, q.Y-p.Y)
}

// same thing, but as a method of the Point type
func (p Point) Distance(q Point) float64 {
    return math.Hypot(q.X-p.X, q.Y-p.Y)
}
```

**æ–¹æ³•å¿…é¡»å®šä¹‰åœ¨ä¸è¯¥ç±»å‹çš„åŒä¸€ä¸ªåŒ…ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç»™intè¿™ç§å†…ç½®ç±»å‹å®šä¹‰æ–¹æ³•**

å’Œå‡½æ•°ä¸€æ ·ï¼Œ**ä¸æ”¯æŒé‡è½½**

## 1. æ–¹æ³•çš„æŒ‡é’ˆæ¥æ”¶è€…å’Œå€¼æ¥æ”¶è€…

1. **ä¸ç®¡æ˜¯æŒ‡é’ˆæ¥æ”¶è€…è¿˜æ˜¯å€¼æ¥æ”¶è€…å®ç°äº†ä¸€ä¸ªæ¥å£çš„æ–¹æ³•ï¼Œéƒ½å¯ä»¥é€šè¿‡è¯¥ç±»å‹çš„å€¼å’ŒæŒ‡é’ˆè°ƒç”¨æ¥å£çš„æ–¹æ³•**ã€‚goè¯­è¨€ä¼šè¿›è¡Œè‡ªåŠ¨çš„ç±»å‹è½¬æ¢ï¼Œè¿™å®é™…ä¸Šæ˜¯è¯­æ³•ç³–èµ·ä½œç”¨çš„ã€‚
2. **å¦‚æœä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…æ¥å®ç°ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆåªæœ‰è¯¥ç±»å‹çš„æŒ‡é’ˆæ‰èƒ½å®ç°å¯¹åº”æ¥å£ï¼ˆis interface aï¼‰ã€‚**
3. **å¦‚æœä½¿ç”¨å€¼æ¥æ”¶è€…æ¥å®ç°ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆè¯¥ç±»å‹çš„å€¼å’ŒæŒ‡é’ˆéƒ½å®ç°äº†å¯¹åº”æ¥å£ã€‚**

å®ç°äº†å€¼æ¥æ”¶è€…çš„æ–¹æ³•ï¼Œç›¸å½“äºè‡ªåŠ¨å®ç°äº†æŒ‡é’ˆæ¥æ”¶è€…çš„æ–¹æ³•ï¼›è€Œå®ç°äº†æŒ‡é’ˆæ¥æ”¶è€…çš„æ–¹æ³•æ˜¯ä¸ä¼šè‡ªåŠ¨å®ç°å€¼æ¥æ”¶è€…çš„æ–¹æ³•çš„ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼šå€¼ç±»å‹çš„æ–¹æ³•é›†åªåŒ…æ‹¬ä½¿ç”¨å€¼æ¥æ”¶è€…å®ç°çš„æ–¹æ³•ã€‚è€ŒæŒ‡é’ˆç±»å‹çš„æ–¹æ³•é›†åŒ…å«å€¼å’ŒæŒ‡é’ˆæ¥æ”¶è€…å®ç°çš„æ–¹æ³•

å› ä¸ºå¹¶ä¸æ˜¯æ€»èƒ½è·å–ä¸€ä¸ªå€¼çš„åœ°å€

| Values | Methods Receivers |
| :----: | :---------------: |
|   T    |       (t T)       |
|   *T   | (t T) and (t *T)  |



ä¾‹å¦‚ï¼Œä½¿ç”¨å€¼æ¥æ”¶è€…å®ç°æ¥å£ï¼š

```go
type buyer interface {
	buy()
}

type student struct {
	name string
}

func (s student) buy() {
	fmt.Println(s.name, "ä¹°ä¹°ä¹°")
}

func showBuyer(b buyer) {
	fmt.Println(b)
}

func main() {
	s := student{"å°æ˜"}
  
  //ä½¿ç”¨å€¼æ¥æ”¶è€…å®ç°æ¥å£ï¼Œè¯¥ç±»å‹çš„å€¼å’ŒæŒ‡é’ˆéƒ½å¯ä»¥è°ƒç”¨æ¥å£æ–¹æ³•
	s.buy()       
	(&s).buy()
	
  //ä½¿ç”¨å€¼æ¥æ”¶è€…å®ç°æ¥å£ï¼Œè¯¥ç±»å‹çš„å€¼å’ŒæŒ‡é’ˆéƒ½å®ç°äº†è¯¥æ¥å£
	showBuyer(s)
	showBuyer(&s)
}
```

ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…å®ç°æ¥å£ï¼š
```go
type buyer2 interface {
	buy()
}

type student2 struct {
	name string
}

func (s *student2) buy() {
	fmt.Println(s.name, "ä¹°ä¹°ä¹°")
}

func showBuyer2(b buyer2) {
	fmt.Println(b)
}

func main() {
	s := student2{"å°æ˜"}
  
  //ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…å®ç°æ¥å£ï¼Œè¯¥ç±»å‹çš„å€¼å’ŒæŒ‡é’ˆéƒ½å¯ä»¥è°ƒç”¨æ¥å£æ–¹æ³•
	(&s).buy()
	s.buy()
	
  //ä½¿ç”¨æŒ‡é’ˆæ¥å£è€…å®ç°æ¥å£ï¼Œåªæœ‰è¯¥ç±»å‹çš„æŒ‡é’ˆæ‰å®ç°äº†æ¥å£
  //æ‰€ä»¥ä¸èƒ½æŠŠè¯¥ç±»å‹çš„å€¼ä½œä¸º buyer2 æ¥å£ç±»å‹è¿›è¡Œä¼ é€’ï¼Œå®ƒä¸æ˜¯è¯¥æ¥å£ç±»å‹
	showBuyer2(s) //Cannot use 's' (type student2) as type buyer2Type does not implement 'buyer2' as 'buy' method has a pointer receiver
	showBuyer2(&s)
}

```



## 2. æ–¹æ³•å€¼å’Œæ–¹æ³•è¡¨è¾¾å¼

```go
func (p point) distance(q point) float64 {...}
func (cp coleredPoint) distance(cp2 coleredPoint) float64 {...}
func (cp coleredPoint) show() {...}
func (c color) distance(c2 color) float64 {...}

func main(){
  	cp := coleredPoint{point{1, 1},"red"}
	cp2 := coleredPoint{point{2, 2}, "green"}

	cpdistance := coleredPoint.distance
	pdistance := cp.point.distance
	cdistance := cp.color.distance

	fmt.Println(cpdistance(cp, cp2)) //func (cp coleredPoint) distance(cp2 coleredPoint) float64{...}

	fmt.Println(pdistance(cp2.point))
	fmt.Println(cdistance(cp2.color))
}
```



## 3. goè¯­è¨€å¯ä»¥æ–¹æ³•é‡å†™ï¼Œä¸èƒ½é‡è½½

ç›¸äº’åµŒå¥—çš„ç»“æ„ä½“å¯ä»¥å®šä¹‰ç›¸åŒçš„æ–¹æ³•åï¼Œæ ¹æ®è‡ªå·±çš„ç±»å‹è°ƒç”¨å¯¹åº”çš„æ–¹æ³•

ä½†æ˜¯åŒä¸€ä¸ªç»“æ„ä½“ä¸èƒ½å®šä¹‰åŒåçš„æ–¹æ³•ï¼ˆgoè¯­è¨€æ²¡æœ‰é‡è½½æœºåˆ¶ï¼‰

```c
type a struct {}
type A struct {}
type B struct {
	A
	a
}

func (*A) gogo() {
	fmt.Println("gogogo")
	return
}

func (*a) gogo() {
	fmt.Println("gagaga")
	return
}

//func (*B) gogo() {
//	fmt.Println("gigigi")
//	return
//}

func main() {
	r := A{}
	b := B{}
	r.gogo()
	(&r).gogo()
	b.gogo()   //å‡ºé”™
	return
}
```



## 4. æ–¹æ³•æ“ä½œçš„æ˜¯å‰¯æœ¬ï¼

å…¶å®å°±æ˜¯æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç»“æ„ä½“çš„å¯¹è±¡æˆ–è€…å¯¹è±¡çš„æŒ‡é’ˆ

æ‰€ä»¥å°±æ˜¯å€¼ä¼ é€’çš„

**è¦ä¿®æ”¹å¯¹è±¡çš„å±æ€§ï¼Œæ–¹æ³•çš„æ¥æ”¶è€…åº”è¯¥æ˜¯æŒ‡é’ˆ** ï¼ˆ***åªéœ€è¦æ¥æ”¶è€…æ˜¯æŒ‡é’ˆå³å¯ï¼Œä¸éœ€è¦è°ƒç”¨è€…æ˜¯æŒ‡é’ˆ***ï¼Œå°±ç®—è°ƒç”¨è€…æ˜¯å¯¹è±¡ï¼Œä¹Ÿä¼šè¿›è¡Œéšå¼è½¬æ¢ï¼Œè½¬æ¢ä¸ºæŒ‡é’ˆï¼‰

```go
func main() {
	p := person{
		name: "xiaoming",
		age:  10,
	}
	p.addAge()
	fmt.Printf("%v\n", p)   //{xiaoming 10}
    p.addAgePointer()
	fmt.Printf("%v\n", p)   //{xiaoming 11}
}

func (p *person) addAgePointer() {
	p.age = p.age + 1
}

func (p person) addAge() {
    p.age = p.age + 1
}
```





# å…­ã€æ¥å£ç®€ä»‹



## 1. æ¥å£åŸºæœ¬ä»‹ç»

Printfå’ŒSprintfåº•å±‚éƒ½æ˜¯è°ƒç”¨äº†Fprintfï¼š

Printfå°±æ˜¯æ‰“å°åˆ°os.Stdoutæ ‡å‡†è¾“å‡ºä¸Š

Sprintfå°±æ˜¯æ‰“å°åˆ°ä¸€ä¸ªbytes.Bufferï¼Œç„¶åè¿”å›äº†bufçš„string

```go
package fmt

func Fprintf(w io.Writer, format string, args ...interface{}) (int, error)
func Printf(format string, args ...interface{}) (int, error) {
    return Fprintf(os.Stdout, format, args...)
}
func Sprintf(format string, args ...interface{}) string {
    var buf bytes.Buffer
    Fprintf(&buf, format, args...)
    return buf.String()
}
```

**ç©ºæ¥å£**ï¼šinterface{}ç±»å‹ï¼Œå®ƒæ²¡æœ‰ä»»ä½•æ–¹æ³•ï¼Œç©ºæ¥å£ç±»å‹å¯¹å®ç°å®ƒçš„ç±»å‹æ²¡æœ‰è¦æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†ä»»æ„ä¸€ä¸ªå€¼èµ‹ç»™ç©ºæ¥å£ç±»å‹

```go
var any interface{}
any = true
any = 12.34
any = "hello"
any = map[string]int{"one": 1}
any = new(bytes.Buffer)
```



### æ¥å£æ£€æŸ¥

```go
//1. ç©ºå€¼nilå¼ºè½¬ä¸º *GobCodec ç±»å‹ï¼Œå†è½¬æ¢(èµ‹å€¼)ä¸ºCodecæ¥å£ï¼ŒIDEå°±å¯ä»¥å¸®æˆ‘ä»¬éªŒè¯GobCodecæ˜¯å¦å®ç°äº†Codecæ¥å£
var _ Codec = (*GobCodec)(nil) 

//2. æ•ˆæœå·®ä¸å¤š
var _ Codec = new(GobCodec)    
```



## 2. sortæ¥å£

`sort.Interface` æ¥å£å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼Œè‡ªå®šä¹‰æ’åºè§„åˆ™å¿…é¡»å®ç°è¿™ä¸‰ä¸ªæ¥å£

```go
package sort
type Interface interface{
  Len() int    //æ±‚å¾…æ’åºå…ƒç´ ä¸ªæ•°çš„æ–¹æ³•
  Less(i, j int) bool     //æ¯”è¾ƒ i j ä½ç½®å…ƒç´ å¤§å°çš„æ–¹æ³•
  Swap(i, j int)  //äº¤æ¢ i j ä½ç½®å…ƒç´ çš„æ–¹æ³•
}
```

å¯¹äº int ã€ float64 å’Œ string æ•°ç»„æˆ–æ˜¯åˆ†ç‰‡çš„æ’åºï¼Œ go åˆ†åˆ«æä¾›äº† sort.Ints() ã€ sort.Float64s() å’Œ sort.Strings() å‡½æ•°ï¼Œ é»˜è®¤éƒ½æ˜¯ä»å°åˆ°å¤§æ’
go çš„ sort åŒ…å¯ä»¥ä½¿ç”¨ sort.Reverse() æ¥è°ƒæ¢ slice.Interface.Lessï¼Œäº¤æ¢åè°ƒç”¨sort.Sortå‡½æ•°è¿›è¡Œæ’åº

```go
intList := [] int {2, 4, 3, 5, 7, 6, 9, 8, 1, 0}
sort.Ints(intList)    //é¡ºåºæ’åº
sort.Sort(sort.Reverse(sort.IntSlice(a)))   //é€†åºæ’åº
```



### ä¾¿æ·çš„æ’åºç»“æ„

`sort.StringSlice`ç»“æ„ç±»å‹å¯ä»¥ä¾¿æ·çš„å¯¹[]stringè¿›è¡Œæ’åºï¼Œ`sort.IntSlice`å¯ä»¥ä¾¿æ·çš„å¯¹[]intè¿›è¡Œæ’åºï¼ˆå®é™…ä¸Šè¿˜æ˜¯[]stringå’Œ[]intï¼Œåªæ˜¯å¸®æˆ‘ä»¬å®šä¹‰å¥½äº†è‡ªå®šä¹‰æ’åºçš„ä¸‰ä¸ªæ–¹æ³•ï¼‰ï¼Œ**ç±»å‹è½¬æ¢ä¸ºsort.Interfaceäº†ï¼Œæ‰€ä»¥æ”¯æŒé€†åºæ’åº**

ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨`sort.Strings(a []string)`å’Œ`sort.Ints(a []int)`æ¥è¿›è¡Œæ’åºï¼Œä½†æ˜¯ç±»å‹æ²¡æœ‰å˜ä¸ºsort.Interfaceï¼Œå› æ­¤**ä¸æ”¯æŒä½¿ç”¨ sort.Reverse è¿›è¡Œé€†åº**

```go
	nums := []int{1, 8, 5, 5, 3, 8}
	s := sort.IntSlice(nums)   //è½¬æ¢ä¸º sort.IntSlice ç±»å‹è¿›è¡Œæ’åº
	sort.Sort(sort.Reverse(s))
	fmt.Println(s)   // [8 8 5 5 3 1]

	strs := []string{"acd", "ab", "d", "b"}
	sort.Strings(strs)  //ä½¿ç”¨sort.Strings()å‡½æ•°è¿›è¡Œæ’åº
	fmt.Println(strs) // [ab acd b d]
```



### Sliceçš„è‡ªå®šä¹‰æ’åº

 sortåŒ…æä¾›äº†ä¸‰ä¸ªsliceçš„æ’åºå‡½æ•° `Slice`, `SliceStable`, `SliceIsSorted`

```go
package sort

func Slice(slice interface{}, less func(i, j int) bool) {
	rv := reflectValueOf(slice)
	swap := reflectSwapper(slice)
	length := rv.Len()
	quickSort_func(lessSwap{less, swap}, 0, length, maxDepth(length))
}

// ç¨³å®šæ’åº
func SliceStable(slice interface{}, less func(i, j int) bool) {
	rv := reflectValueOf(slice)
	swap := reflectSwapper(slice)
	stable_func(lessSwap{less, swap}, rv.Len())
}

// åˆ¤æ–­æ˜¯å¦æ’åº
func SliceIsSorted(slice interface{}, less func(i, j int) bool) bool {
	rv := reflectValueOf(slice)
	n := rv.Len()
	for i := n - 1; i > 0; i-- {
		if less(i, i-1) {
			return false
		}
	}
	return true
}
```

ä¸¾ä¾‹ï¼š leetcode179ï¼Œæ±‚æ•°ç»„å…ƒç´ æ‹¼æ¥ç»„åˆåçš„æœ€å¤§æ•°

```go
func largestNumber(nums []int) string {
	strs := make([]string, len(nums))
	for i:=0; i<len(nums); i++{
		strs[i] = strconv.Itoa(nums[i])
	}
	sort.Slice(strs, func(i, j int) bool {
		return strs[i]+strs[j] > strs[j]+strs[i]
	})
	if strs[0] == "0" {
		return "0"
	}
	return strings.Join(strs, "")
}
```





### ç»“æ„ä½“è‡ªå®šä¹‰æ’åº

ç»“æ„ä½“åˆ‡ç‰‡åªè¦å®ç°äº† sort.Interfaceæ¥å£ï¼ˆå®šä¹‰Lenï¼ŒSwapï¼ŒLessæ–¹æ³•ï¼‰ï¼Œå°±å¯ä»¥æŒ‰ç…§è‡ªå®šä¹‰çš„è§„åˆ™è¿›è¡Œæ’åº

```go
type Person struct {
    Name string
    Age  int
}

// æŒ‰ç…§ Person.Age ä»å¤§åˆ°å°æ’åº
type PersonSlice [] Person

// PersonSliceå®ç°äº†sortæ¥å£çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥å½“ä½œsort.Interfaceæ¥ä½¿ç”¨
func (a PersonSlice) Len() int {return len(a)}
func (a PersonSlice) Swap(i, j int){a[i], a[j] = a[j], a[i]}
func (a PersonSlice) Less(i, j int) bool {return a[i].Age < a[j].Age}
 
func main() {
    people := [] Person{
        {"zhang san", 12},
        {"li si", 30},
        {"wang wu", 52},
        {"zhao liu", 26},
    }
 
  	//ç­‰ä»·äºï¼šsort.Sort(sort.Interface(PersonSlice(people)))
    sort.Sort(PersonSlice(people))    // æŒ‰ç…§ Age å‡åºæ’åº
    fmt.Println(people)
 
    sort.Sort(sort.Reverse(PersonSlice(people)))    // æŒ‰ç…§ Age é™åºæ’åº
    fmt.Println(people)
 
}

// è¿˜å¯ä»¥æŠŠ Less å‡½æ•°å’Œ PersonSlice å°è£…åˆ° PersonWrapperï¼Œä½¿å¾—è°ƒç”¨è€…å¯ä»¥è‡ªå·±ä¼ å…¥æ’åºçš„ Less æ–¹æ³•
```



## 3. http.Handleræ¥å£

```go
package http

type Handler interface {
    ServeHTTP(w ResponseWriter, r *Request)
}

func ListenAndServe(address string, h Handler) error
```

**ListenAndServeå‡½æ•°**éœ€è¦ä¸€ä¸ªä¾‹å¦‚â€œlocalhost:8000â€çš„æœåŠ¡å™¨åœ°å€ï¼Œå’Œä¸€ä¸ªæ‰€æœ‰è¯·æ±‚éƒ½å¯ä»¥åˆ†æ´¾çš„Handleræ¥å£å®ä¾‹ã€‚å®ƒä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°è¿™ä¸ªæœåŠ¡å› ä¸ºä¸€ä¸ªé”™è¯¯è€Œå¤±è´¥ï¼ˆæˆ–è€…å¯åŠ¨å¤±è´¥ï¼‰ï¼Œå®ƒçš„è¿”å›å€¼ä¸€å®šæ˜¯ä¸€ä¸ªéç©ºçš„é”™è¯¯

```go
func main() {
    db := database{"shoes": 50, "socks": 5}
    log.Fatal(http.ListenAndServe("localhost:8000", db))
}

type dollars float32
func (d dollars) String() string { return fmt.Sprintf("$%.2f", d) }

type database map[string]dollars
func (db database) ServeHTTP(w http.ResponseWriter, req *http.Request) {
    for item, price := range db {
        fmt.Fprintf(w, "%s: %s\n", item, price)
    }
}
```

**ServeMuxå¤šè·¯è¯·æ±‚å™¨**ï¼Œä½äº`net/http`åŒ…ï¼Œå¯ä»¥ç®€åŒ–URLå’Œhandlersçš„URL

```go
func main() {
    db := database{"shoes": 50, "socks": 5}
    mux := http.NewServeMux()
    mux.Handle("/list", http.HandlerFunc(db.list))   //å°†database.listå‡½æ•°è½¬åŒ–ä¸ºhttp.HandlerFuncç±»å‹
    mux.Handle("/price", http.HandlerFunc(db.price))
    log.Fatal(http.ListenAndServe("localhost:8000", mux))
}

type database map[string]dollars

func (db database) list(w http.ResponseWriter, req *http.Request) {
    for item, price := range db {
        fmt.Fprintf(w, "%s: %s\n", item, price)
    }
}

func (db database) price(w http.ResponseWriter, req *http.Request) {
    item := req.URL.Query().Get("item")
    price, ok := db[item]
    if !ok {
        w.WriteHeader(http.StatusNotFound) // 404
        fmt.Fprintf(w, "no such item: %q\n", item)
        return
    }
    fmt.Fprintf(w, "%s\n", price)
}
```

`http.HandlerFunc`æ¥å£å®šä¹‰äº†ServlHttpæ–¹æ³•ï¼Œæ‰€æœ‰func(w ResponseWriter, r *Request)éƒ½å¯ä»¥è½¬åŒ–ä¸ºHandlerFunc

ServeHTTPæ–¹æ³•çš„è¡Œä¸ºæ˜¯**è°ƒç”¨äº†å®ƒçš„å‡½æ•°æœ¬èº«**ã€‚å› æ­¤HandlerFuncæ˜¯ä¸€ä¸ª**è®©å‡½æ•°å€¼æ»¡è¶³ä¸€ä¸ªæ¥å£çš„é€‚é…å™¨**ï¼Œè¿™é‡Œå‡½æ•°å’Œè¿™ä¸ªæ¥å£ä»…æœ‰çš„æ–¹æ³•æœ‰ç›¸åŒçš„å‡½æ•°ç­¾åã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªæŠ€å·§è®©ä¸€ä¸ªå•ä¸€çš„ç±»å‹ä¾‹å¦‚databaseä»¥å¤šç§æ–¹å¼æ»¡è¶³http.Handleræ¥å£ï¼šä¸€ç§é€šè¿‡å®ƒçš„listæ–¹æ³•ï¼Œä¸€ç§é€šè¿‡å®ƒçš„priceæ–¹æ³•ç­‰ç­‰

```go
package  

type HandlerFunc func(w ResponseWriter, r *Request)

func (f HandlerFunc) ServeHTTP(w ResponseWriter, r *Request) {
    f(w, r)
}
```

ä¸ºäº†æ–¹ä¾¿ï¼Œnet/httpåŒ…æä¾›äº†ä¸€ä¸ª**å…¨å±€çš„ServeMuxå®ä¾‹DefaultServerMux**å’Œ**åŒ…çº§åˆ«çš„http.Handleå’Œhttp.HandleFuncå‡½æ•°**ã€‚ç°åœ¨ï¼Œä¸ºäº†ä½¿ç”¨DefaultServeMuxä½œä¸ºæœåŠ¡å™¨çš„ä¸»handlerï¼Œæˆ‘ä»¬ä¸éœ€è¦å°†å®ƒä¼ ç»™ListenAndServeå‡½æ•°ï¼›nilå€¼å°±å¯ä»¥å·¥ä½œã€‚

ç„¶åæœåŠ¡å™¨çš„ä¸»å‡½æ•°å¯ä»¥ç®€åŒ–æˆï¼š

```go
func main() {
    db := database{"shoes": 50, "socks": 5}
    http.HandleFunc("/list", db.list)
    http.HandleFunc("/price", db.price)
    log.Fatal(http.ListenAndServe("localhost:8000", nil))
}
```



## 4. ç±»å‹æ–­è¨€

**x.(T)è¢«ç§°ä¸ºæ–­è¨€ç±»å‹**ï¼Œè¿™é‡Œxè¡¨ç¤ºä¸€ä¸ªæ¥å£çš„ç±»å‹å’ŒTè¡¨ç¤ºä¸€ä¸ªç±»å‹ã€‚ä¸€ä¸ªç±»å‹æ–­è¨€æ£€æŸ¥å®ƒæ“ä½œå¯¹è±¡çš„åŠ¨æ€ç±»å‹æ˜¯å¦å’Œæ–­è¨€çš„ç±»å‹åŒ¹é…

1. **å¦‚æœæ–­è¨€çš„Tæ˜¯ä¸€ä¸ªå…·ä½“ç±»å‹ï¼Œä¼šæ£€æŸ¥xçš„åŠ¨æ€ç±»å‹æ˜¯å¦å’ŒTç›¸åŒï¼Œæ–­è¨€æˆåŠŸï¼Œè¿”å›xçš„åŠ¨æ€å€¼ï¼Œæ–­è¨€å¤±è´¥åˆ™æŠ›å‡ºpanicå¼‚å¸¸**

```go
var w io.Writer
w = os.Stdout
f := w.(*os.File)      // success: f == os.Stdout
c := w.(*bytes.Buffer) // panic: interface holds *os.File, not *bytes.Buffer
```

2. **å¦‚æœæ–­è¨€çš„Tæ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œä¼šæ£€æŸ¥xçš„åŠ¨æ€ç±»å‹æ˜¯å¦æ»¡è¶³Tæ¥å£ï¼Œæ–­è¨€æˆåŠŸåˆ™ä¼šæŠŠxçš„ç±»å‹è½¬åŒ–ä¸ºTï¼Œæ–­è¨€å¤±è´¥åˆ™ä¼španicå¼‚å¸¸ï¼Œå¦‚æœTæ˜¯nilæ¥å£å€¼ï¼Œé‚£ä¹ˆä¸ç®¡xéƒ½ä»€ä¹ˆç±»å‹éƒ½ä¼šå¤±è´¥**

```go
var w io.Writer
w = os.Stdout
rw := w.(io.ReadWriter) // success: *os.File has both Read and Write
w = new(ByteCounter)
rw = w.(io.ReadWriter) // panic: *ByteCounter has no Read method
w = rw             // io.ReadWriter is assignable to io.Writer
w = rw.(io.Writer) // fails only if rw == nil
```



å¯¹äºæ¥å£å€¼çš„åŠ¨æ€ç±»å‹ç»å¸¸æ˜¯ä¸ç¡®å®šçš„ï¼Œæˆ‘ä»¬ä¼šå»æ£€éªŒå®ƒæ˜¯å¦æ˜¯ä¸€äº›ç‰¹å®šçš„ç±»å‹ï¼Œè¿™æ—¶å¦‚æœä½¿ç”¨ä¸¤ä¸ªå‚æ•°å»æ¥å—æ–­è¨€çš„ç»“æœï¼Œä¾¿ä¼šå¾—åˆ°æˆåŠŸä¸å¦çš„æ ‡å¿—

```go
var w io.Writer = os.Stdout
if f, ok := w.(*os.File); ok {
    // ...use f...
}
```



## 5. -----åŸºäºç±»å‹æ–­è¨€åŒºåˆ«é”™è¯¯ç±»å‹

osåŒ…ä¸­æ–‡ä»¶æ“ä½œè¿”å›çš„é”™è¯¯é›†åˆï¼š

```go
package os

func IsExist(err error) bool      //åˆ›å»ºæ–‡ä»¶ï¼Œæ–‡ä»¶å·²å­˜åœ¨
func IsNotExist(err error) bool   //è¯»å–æ“ä½œï¼Œæ–‡ä»¶ä¸å­˜åœ¨
func IsPermission(err error) bool //æƒé™æ‹’ç»
```

å¯ä»¥ä½¿ç”¨ä¸€ä¸ªä¸“é—¨çš„ç±»å‹æ¥æè¿°ç»“æ„åŒ–çš„é”™è¯¯

```go
package os

// PathError records an error and the operation and file path that caused it.
type PathError struct {
    Op   string
    Path string
    Err  error
}

func (e *PathError) Error() string {
    return e.Op + " " + e.Path + ": " + e.Err.Error()
}

var ErrNotExist = errors.New("file does not exist")
func IsNotExist(err error) bool {
    if pe, ok := err.(*PathError); ok {
        err = pe.Err
    }
    return err == syscall.ENOENT || err == ErrNotExist
}
```



## 6. -----é€šè¿‡ç±»å‹æ–­è¨€æŸ¥è¯¢æ¥å£



## 7. å†…éƒ¨ç±»å‹å’Œå¤–éƒ¨ç±»å‹çš„æ¥å£é—®é¢˜

ç”±äº**ç±»å‹æå‡**ï¼Œå¦‚æœå†…éƒ¨ç±»å‹å®ç°äº†æŸä¸ªæ¥å£ï¼Œé‚£ä¹ˆå†…éƒ¨ç±»å‹å®ç°çš„æ¥å£ä¼šè‡ªåŠ¨**æå‡åˆ°å¤–éƒ¨ç±»å‹**ï¼Œå³**å¤–éƒ¨ç±»å‹ä¹ŸåŒæ ·å®ç°äº†è¿™ä¸ªæ¥å£**

å¦‚æœå†…éƒ¨ç±»å‹æ˜¯æŒ‡é’ˆæ¥æ”¶è€…å®ç°çš„æ¥å£ï¼Œé‚£ä¹ˆå¯¹åº”å¤–éƒ¨ç±»å‹çš„æŒ‡é’ˆæ‰èƒ½å®ç°æ¥å£



å¦‚æœå†…éƒ¨ç±»å‹å’Œå¤–éƒ¨ç±»å‹å®ç°äº†åŒä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆå†…éƒ¨ç±»å‹å®ç°çš„æ¥å£ä¸ä¼šè¢«è‡ªåŠ¨æå‡ï¼Œé€šè¿‡å¤–éƒ¨ç±»å‹è®¿é—®å¤–éƒ¨ç±»å‹å®ç°çš„æ–¹æ³•ï¼Œå†…éƒ¨ç±»å‹è®¿é—®å†…éƒ¨ç±»å‹å®ç°çš„æ–¹æ³•





## 8. å‡½æ•°ã€æ–¹æ³•ã€æ¥å£æ€»ç»“

å‡½æ•°åˆ†ä¸º`å…·åå‡½æ•°`å’Œ`åŒ¿åå‡½æ•°`

å½“åŒ¿åå‡½æ•°å¼•ç”¨äº†å¤–éƒ¨ä½œç”¨åŸŸä¸­çš„å˜é‡æ—¶å°±æˆäº†`é—­åŒ…å‡½æ•°`ï¼Œé—­åŒ…æ˜¯å‡½æ•°å¼å˜æˆè¯­è¨€çš„æ ¸å¿ƒ

`æ–¹æ³•`æ˜¯ç»‘å®šåˆ°å…·ä½“ç±»å‹çš„ç‰¹æ®Šå‡½æ•°ï¼Œå¿…é¡»åœ¨ç¼–è¯‘æ—¶`é™æ€ç»‘å®š`

`æ¥å£`å®šä¹‰äº†æ–¹æ³•çš„é›†åˆï¼Œè¿™äº›æ–¹æ³•ä¾æ‰˜äºè¿è¡Œæ—¶çš„æ¥å£å¯¹è±¡ï¼Œæ‰€ä»¥æ˜¯åœ¨è¿è¡Œæ—¶`åŠ¨æ€ç»‘å®š`çš„







# ä¸ƒã€Goroutineså’ŒChannels

Goè¯­è¨€ä¸­çš„å¹¶å‘ç¨‹åºå¯ä»¥ç”¨ä¸¤ç§æ‰‹æ®µæ¥å®ç°ï¼š

1. æœ¬ç« çš„goroutineå’Œchannelï¼Œå…¶æ”¯æŒâ€œé¡ºåºé€šä¿¡è¿›ç¨‹â€ï¼ˆcommunicating sequential processesï¼‰æˆ–è¢«ç®€ç§°ä¸ºCSPã€‚CSPæ˜¯ä¸€ç§ç°ä»£çš„å¹¶å‘ç¼–ç¨‹æ¨¡å‹ï¼Œåœ¨è¿™ç§ç¼–ç¨‹æ¨¡å‹ä¸­å€¼ä¼šåœ¨ä¸åŒçš„è¿è¡Œå®ä¾‹ï¼ˆgoroutineï¼‰ä¸­ä¼ é€’ï¼Œå°½ç®¡å¤§å¤šæ•°æƒ…å†µä¸‹ä»ç„¶æ˜¯è¢«é™åˆ¶åœ¨å•ä¸€å®ä¾‹ä¸­ã€‚
2. è¦†ç›–æ›´ä¸ºä¼ ç»Ÿçš„å¹¶å‘æ¨¡å‹ï¼šå¤šçº¿ç¨‹å…±äº«å†…å­˜



## 1. Goroutines-å¹¶å‘

Goè¯­è¨€ä¸­ï¼Œæ¯ä¸€ä¸ªå¹¶å‘çš„æ‰§è¡Œå•å…ƒå«åšä¸€ä¸ªgoroutine

å½“ä¸€ä¸ªç¨‹åºå¯åŠ¨çš„æ—¶å€™ï¼Œå…¶ä¸»å‡½æ•°å³åœ¨ä¸€ä¸ªå•ç‹¬çš„goroutineä¸­è¿è¡Œï¼ˆmain goroutineï¼‰ï¼Œä½¿ç”¨go è¯­å¥åˆ›å»ºä¸€ä¸ªæ–°çš„goroutine.

**goroutineå¹¶ä¸æ˜¯çº¿ç¨‹ï¼Œè€Œæ˜¯å¯¹çº¿ç¨‹çš„å¤šè·¯å¤ç”¨**

ä¸€ä¸ªgoroutineå¯åŠ¨æ—¶çš„æ ˆå¤§å°ä»…ä¸º2KBï¼Œè€Œä¸€ä¸ªOSçº¿ç¨‹çš„æ ˆå¤§å°ä¸€èˆ¬æ˜¯2MBï¼Œè¿™ä¸ªæ ˆä¼šç”¨æ¥å­˜å‚¨å½“å‰æ­£åœ¨è¢«è°ƒç”¨æˆ–æŒ‚èµ·ï¼ˆæŒ‡åœ¨è°ƒç”¨å…¶å®ƒå‡½æ•°æ—¶ï¼‰çš„å‡½æ•°çš„å†…éƒ¨å˜é‡

å½“ä¸€ä¸ªgoroutineè¢«é˜»å¡æ—¶ï¼Œå®ƒ**ä¹Ÿä¼šé˜»å¡æ‰€å¤ç”¨çš„OSçº¿ç¨‹**ï¼Œruntimeä¼šæŠŠä½äºè¢«é˜»å¡çº¿ç¨‹ä¸Šçš„**å…¶ä»–goroutineç§»åŠ¨åˆ°å…¶ä»–æœªè¢«é˜»å¡çš„çº¿ç¨‹ä¸Š**ç»§ç»­è¿è¡Œ



**ä¿®æ”¹é€»è¾‘å¤„ç†å™¨çš„æ•°é‡**

```go
runtime.GOMAXPROCS(1)      //åˆ†é…ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨ç»™è°ƒåº¦å™¨ä½¿ç”¨
```



```go
runtime.GOMAXPROCS(runtime.NumCPU())   //åˆ†é…é€»è¾‘å¤„ç†å™¨çš„æ•°é‡=cpuæ ¸å¿ƒæ•°ï¼Œæ¯ä¸ªcpuæ ¸å¿ƒéƒ½åˆ†é…ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨
```

### åŠ¨æ€æ ˆ

å›ºå®šæ ˆå¤§å°çš„ç¼ºé™·ï¼šå¤ªå°çš„æ ˆç©ºé—´è™½ç„¶æé«˜äº†ç©ºé—´åˆ©ç”¨ç‡ï¼Œä½†æ˜¯é€’å½’è°ƒç”¨å®¹æ˜“æ ˆæº¢å‡ºã€‚å¤ªå¤§çš„æ ˆç©ºé—´å¯¹é‚£äº›åªéœ€è¦å¾ˆå°æ ˆç©ºé—´çš„çº¿ç¨‹æ¥è¯´æ˜¯ä¸€ä¸ªå·¨å¤§çš„ç©ºé—´æµªè´¹

ä¾‹å¦‚Linuxä¸­ï¼Œæ ˆå¤§å°é»˜è®¤ä¸º8MBï¼Œè¿è¡Œå†…å­˜è¶…è¿‡ä¸Šé™æ—¶ç¨‹åºå°±ä¼šå´©æºƒï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥è°ƒå¤§å†…æ ¸å‚æ•°ä¸­çš„ stack sizeï¼Œæˆ–è€…åœ¨åˆ›å»ºçº¿ç¨‹æ—¶æ˜¾ç¤ºçš„ä¼ å…¥æ‰€éœ€è¦å¤§å°çš„å†…å­˜å—ã€‚å‰è€…ä¼šå½±å“ç³»ç»Ÿå†…æ‰€æœ‰çº¿ç¨‹ï¼Œåè€…åˆéœ€è¦ç²¾ç¡®è®¡ç®—threadå¤§å°ï¼Œéƒ½æœ‰ç¼ºé™·

æˆ‘ä»¬å¯ä»¥åœ¨å‡½æ•°è°ƒç”¨å¤„æ’æ¡©ï¼Œ æ¯æ¬¡è°ƒç”¨çš„æ—¶å€™æ£€æŸ¥å½“å‰æ ˆçš„ç©ºé—´æ˜¯å¦èƒ½å¤Ÿæ»¡è¶³æ–°å‡½æ•°çš„æ‰§è¡Œï¼Œæ»¡è¶³çš„è¯ç›´æ¥æ‰§è¡Œï¼Œå¦åˆ™**åˆ›å»ºæ–°çš„æ ˆç©ºé—´å¹¶å°†è€çš„æ ˆæ‹·è´åˆ°æ–°çš„æ ˆç„¶åå†æ‰§è¡Œ**ã€‚ä½†æ˜¯Linux threadæ¨¡å‹ä¸èƒ½æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œå®ç°çš„è¯åªèƒ½åœ¨ç”¨æˆ·ç©ºé—´å®ç°ï¼Œgoè¯­è¨€çš„runtimeå°±å®ç°äº†è¿™ä¸ªç‰¹æ€§

goroutineçš„æ ˆå¤§å°å¯ä»¥æ ¹æ®éœ€è¦åŠ¨æ€è°ƒæ•´ï¼Œä¸€ä¸ªgoroutineä¼šä»¥ä¸€ä¸ªå¾ˆå°çš„æ ˆå¼€å§‹å…¶ç”Ÿå‘½å‘¨æœŸï¼Œ**ä¸€èˆ¬åªéœ€è¦2KB**ã€‚ä¸€ä¸ªgoroutineçš„æ ˆï¼Œå’Œæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸€æ ·ï¼Œä¼šä¿å­˜å…¶æ´»è·ƒæˆ–æŒ‚èµ·çš„å‡½æ•°è°ƒç”¨çš„**æœ¬åœ°å˜é‡**ï¼Œä½†æ˜¯å’ŒOSçº¿ç¨‹ä¸å¤ªä¸€æ ·çš„æ˜¯ï¼Œä¸€ä¸ªgoroutineçš„**æ ˆå¤§å°å¹¶ä¸æ˜¯å›ºå®šçš„**ï¼›æ ˆçš„å¤§å°ä¼šæ ¹æ®éœ€è¦åŠ¨æ€åœ°ä¼¸ç¼©ï¼Œ**goroutineçš„æ ˆçš„æœ€å¤§å€¼æœ‰1GB**

ç”±äºæ ˆä¼šå˜åŒ–ï¼Œæ‰€ä»¥ä¼šå°†ä¹‹å‰çš„æ•°æ®ç§»åŠ¨åˆ°æ–°çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥**æŒ‡é’ˆä¸å†æ˜¯å›ºå®šä¸å˜çš„**

æ­¤å¤–ï¼Œä¸€äº›long runningçš„goroutineå¯èƒ½ç”±äºæŸæ¬¡å‡½æ•°è°ƒç”¨ä¸­å¼•å‘äº†æ ˆçš„æ‰©å®¹ï¼Œ è¢«è°ƒç”¨å‡½æ•°è¿”å›åå¾ˆå¤§éƒ¨åˆ†ç©ºé—´éƒ½æœªè¢«åˆ©ç”¨ï¼Œä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œéœ€è¦èƒ½å¤Ÿå¯¹æ ˆè¿›è¡Œ**æ”¶ç¼©**ï¼Œä»¥èŠ‚çº¦å†…å­˜æé«˜åˆ©ç”¨ç‡

### goroutineså’Œçº¿ç¨‹

æ¯ä¸€ä¸ª**OSçº¿ç¨‹**éƒ½æœ‰ä¸€ä¸ª**å›ºå®šå¤§å°çš„å†…å­˜**å—ï¼ˆä¸€èˆ¬ä¼šæ˜¯2MBï¼‰æ¥åšæ ˆï¼Œè¿™ä¸ªæ ˆä¼šç”¨æ¥å­˜å‚¨å½“å‰æ­£åœ¨è¢«è°ƒç”¨æˆ–æŒ‚èµ·ï¼ˆæŒ‡åœ¨è°ƒç”¨å…¶å®ƒå‡½æ•°æ—¶ï¼‰çš„å‡½æ•°çš„å†…éƒ¨å˜é‡ã€‚



## 2. Channels-é€šä¿¡

Go è¯­è¨€çš„ Channel åœ¨è¿è¡Œæ—¶ä½¿ç”¨ [runtime.hchan](https://draveness.me/golang/tree/runtime.hchan) ç»“æ„ä½“è¡¨ç¤ºã€‚æˆ‘ä»¬åœ¨ Go è¯­è¨€ä¸­åˆ›å»ºæ–°çš„ Channel æ—¶ï¼Œå®é™…ä¸Šåˆ›å»ºçš„éƒ½æ˜¯å¦‚ä¸‹æ‰€ç¤ºçš„ç»“æ„ï¼š

```go
type hchan struct {
	qcount   uint
	dataqsiz uint
	buf      unsafe.Pointer
	elemsize uint16
	closed   uint32
	elemtype *_type
	sendx    uint
	recvx    uint
	recvq    waitq
	sendq    waitq

	lock mutex
}
```

[runtime.hchan](https://draveness.me/golang/tree/runtime.hchan) ç»“æ„ä½“ä¸­çš„äº”ä¸ªå­—æ®µ `qcount`ã€`dataqsiz`ã€`buf`ã€`sendx`ã€`recv` æ„å»ºåº•å±‚çš„å¾ªç¯é˜Ÿåˆ—ï¼š

- `qcount` â€” Channel ä¸­çš„å…ƒç´ ä¸ªæ•°ï¼›

- `dataqsiz` â€” Channel ä¸­çš„å¾ªç¯é˜Ÿåˆ—çš„é•¿åº¦ï¼›

- `buf` â€” Channel çš„ç¼“å†²åŒºæ•°æ®æŒ‡é’ˆï¼›

- `sendx` â€” Channel çš„å‘é€æ“ä½œå¤„ç†åˆ°çš„ä½ç½®ï¼›

- `recvx` â€” Channel çš„æ¥æ”¶æ“ä½œå¤„ç†åˆ°çš„ä½ç½®ï¼›

- `recvq`å’Œ`sendq` ï¼šé˜»å¡gç»„æˆçš„åŒå‘é“¾è¡¨

  ```go
  type waitq struct {
  	first *sudog
  	last  *sudog
  }
  ```



**å‘é€æ•°æ®**ï¼š

æˆ‘ä»¬åœ¨è¿™é‡Œå¯ä»¥ç®€å•æ¢³ç†å’Œæ€»ç»“ä¸€ä¸‹ä½¿ç”¨ `ch <- i` è¡¨è¾¾å¼å‘ Channel å‘é€æ•°æ®æ—¶é‡åˆ°çš„å‡ ç§æƒ…å†µï¼š

1. å¦‚æœå½“å‰ Channel çš„ `recvq` ä¸Šå­˜åœ¨å·²ç»è¢«é˜»å¡çš„ Goroutineï¼Œé‚£ä¹ˆä¼šç›´æ¥å°†æ•°æ®å‘é€ç»™å½“å‰ Goroutine å¹¶å°†å…¶è®¾ç½®æˆä¸‹ä¸€ä¸ªè¿è¡Œçš„ Goroutineï¼›
2. å¦‚æœ Channel å­˜åœ¨ç¼“å†²åŒºå¹¶ä¸”å…¶ä¸­è¿˜æœ‰ç©ºé—²çš„å®¹é‡ï¼Œæˆ‘ä»¬ä¼šç›´æ¥å°†æ•°æ®å­˜å‚¨åˆ°ç¼“å†²åŒº `sendx` æ‰€åœ¨çš„ä½ç½®ä¸Šï¼›
3. å¦‚æœä¸æ»¡è¶³ä¸Šé¢çš„ä¸¤ç§æƒ…å†µï¼Œä¼šåˆ›å»ºä¸€ä¸ª [`runtime.sudog`](https://draveness.me/golang/tree/runtime.sudog) ç»“æ„å¹¶å°†å…¶åŠ å…¥ Channel çš„ `sendq` é˜Ÿåˆ—ä¸­ï¼Œå½“å‰ Goroutine ä¹Ÿä¼šé™·å…¥é˜»å¡ç­‰å¾…å…¶ä»–çš„åç¨‹ä» Channel æ¥æ”¶æ•°æ®ï¼›

å‘é€æ•°æ®çš„è¿‡ç¨‹ä¸­åŒ…å«å‡ ä¸ªä¼šè§¦å‘ Goroutine è°ƒåº¦çš„æ—¶æœºï¼š

1. å‘é€æ•°æ®æ—¶å‘ç° Channel ä¸Šå­˜åœ¨ç­‰å¾…æ¥æ”¶æ•°æ®çš„ Goroutineï¼Œç«‹åˆ»è®¾ç½®å¤„ç†å™¨çš„ `runnext` å±æ€§ï¼Œä½†æ˜¯å¹¶ä¸ä¼šç«‹åˆ»è§¦å‘è°ƒåº¦ï¼›
2. å‘é€æ•°æ®æ—¶å¹¶æ²¡æœ‰æ‰¾åˆ°æ¥æ”¶æ–¹å¹¶ä¸”ç¼“å†²åŒºå·²ç»æ»¡äº†ï¼Œè¿™æ—¶ä¼šå°†è‡ªå·±åŠ å…¥ Channel çš„ `sendq` é˜Ÿåˆ—å¹¶è°ƒç”¨ [`runtime.goparkunlock`](https://draveness.me/golang/tree/runtime.goparkunlock) è§¦å‘ Goroutine çš„è°ƒåº¦è®©å‡ºå¤„ç†å™¨çš„ä½¿ç”¨æƒï¼›



**æ¥æ”¶æ•°æ®**ï¼š

æˆ‘ä»¬æ¢³ç†ä¸€ä¸‹ä» Channel ä¸­æ¥æ”¶æ•°æ®æ—¶å¯èƒ½ä¼šå‘ç”Ÿçš„äº”ç§æƒ…å†µï¼š

1. æœ‰å‘é€é˜»å¡gï¼Œ`è¯»å–g`æˆ–è€…`ç¼“å†²åŒºçš„å†…å®¹`ï¼Œç„¶åç»™å½“å‰ Goroutine è®¾ç½®æˆä¸‹ä¸€ä¸ªè¿è¡Œçš„ Goroutineï¼›
2. å¦‚æœ Channel çš„ç¼“å†²åŒºä¸­åŒ…å«æ•°æ®ï¼Œé‚£ä¹ˆç›´æ¥è¯»å– `recvx` ç´¢å¼•å¯¹åº”çš„æ•°æ®ï¼›
3. åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šæŒ‚èµ·å½“å‰çš„ Goroutineï¼Œå°† [`runtime.sudog`](https://draveness.me/golang/tree/runtime.sudog) ç»“æ„åŠ å…¥ `recvq` é˜Ÿåˆ—å¹¶é™·å…¥ä¼‘çœ ç­‰å¾…è°ƒåº¦å™¨çš„å”¤é†’ï¼›

æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä» Channel æ¥æ”¶æ•°æ®æ—¶ï¼Œä¼šè§¦å‘ Goroutine è°ƒåº¦çš„ä¸¤ä¸ªæ—¶æœºï¼š

1. å½“ Channel ä¸ºç©ºæ—¶ï¼›
2. å½“ç¼“å†²åŒºä¸­ä¸å­˜åœ¨æ•°æ®å¹¶ä¸”ä¹Ÿä¸å­˜åœ¨æ•°æ®çš„å‘é€è€…æ—¶ï¼›







ä½¿ç”¨makeè¯­å¥åˆ›å»ºæ— bufferçš„channelï¼š`ch := make(chan int)`æˆ–è€…`ch := make(chan int, 0)`

è¿˜å¯ä»¥æŒ‡å®šbufferå¤§å°ï¼š`ch := make(chan int, 3)`ï¼Œå¸¦bufferçš„channel

channelå¯¹åº”ä¸€ä¸ªmakeåˆ›å»ºçš„åº•å±‚æ•°æ®ç»“æ„çš„å¼•ç”¨ï¼Œæ‰€ä»¥å¤åˆ¶æˆ–è€…å‡½æ•°å‚æ•°ä¼ é€’çš„æ—¶å€™ï¼Œæ‹·è´äº†channelçš„å¼•ç”¨ï¼Œå› æ­¤**è°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…å¼•ç”¨äº†åŒä¸€ä¸ªchannelå¯¹è±¡**ï¼Œå¦‚æœä¸¤ä¸ªchannelå¼•ç”¨çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆä»–ä»¬==æ¯”è¾ƒçš„ç»“æœä¸ºçœŸ



**å‘é€å’Œæ¥æ”¶ï¼š**

```go
ch <- x   //å‘é€åˆ°channelï¼Œ<-å†™åœ¨channelä¹‹å
x = <- ch //ä»channelæ¥æ”¶ï¼Œ<-å†™åœ¨channelä¹‹å‰
```

**å…³é—­channelï¼ˆ`å†™`ï¼‰ï¼š** ä½¿ç”¨`close(ch)`å¯ä»¥å…³é—­channelï¼ŒéšååŸºäºè¯¥channelçš„ä»»ä½•å‘é€æ“ä½œéƒ½ä¼šå¯¼è‡´panicå¼‚å¸¸ï¼Œ**ä½†æ˜¯æ¥æ”¶æ“ä½œä¾ç„¶å¯ä»¥è¿›è¡Œ**



### æ— bufferçš„channel

æ— bufferçš„channelçš„**å‘é€æ“ä½œ**å°†ä¼šå¯¼è‡´**å‘é€è€…goroutineé˜»å¡**ï¼Œç›´åˆ°å¦ä¸€ä¸ªgoroutineåœ¨ç›¸åŒçš„channelä¸Šæ‰§è¡Œæ¥æ”¶æ“ä½œ

åŒç†ï¼Œæ¥å—æ“ä½œå…ˆå‘ç”Ÿï¼Œä¹Ÿä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰å¦ä¸€ä¸ªgoroutineåœ¨ç›¸åŒçš„channelä¸Šæ‰§è¡Œå‘é€æ“ä½œ

æ‰€ä»¥æ— bufferçš„channelä¹Ÿå«åš**åŒæ­¥channel**ï¼Œå‘é€å’Œæ¥æ”¶æ“ä½œéƒ½ä¼šå¯¼è‡´ä¸¤ä¸ªgoroutineåšä¸€æ¬¡åŒæ­¥æ“ä½œ



- happens-beforeï¼šå¹¶ä¸æ˜¯è¯´xåœ¨æ—¶é—´ä¸Šå…ˆäºyæ—¶é—´å‘ç”Ÿï¼Œè€Œæ˜¯è¦ä¿è¯åœ¨æ­¤ä¹‹å‰çš„æ—¶é—´éƒ½å·²ç»å®Œæˆäº†
- å¦‚æœxæ—¢ä¸æ˜¯åœ¨yä¹‹å‰ï¼Œä¹Ÿä¸æ˜¯åœ¨yäº‹ä»¶ä¹‹åï¼Œæˆ‘ä»¬å°±è¯´xå’Œyæ˜¯**å¹¶å‘**çš„ï¼Œä¹Ÿä¸ä¸€å®šåŒæ—¶å‘ç”Ÿï¼Œåªæ˜¯ä¸èƒ½ç¡®å®šå‘ç”Ÿçš„å…ˆåé¡ºåº



- **ç©ºç»“æ„ä½“**`struct{}`ç±»å‹çš„`channel`ï¼Œå®ƒä¸èƒ½è¢«å†™å…¥ä»»ä½•æ•°æ®ï¼Œåªæœ‰é€šè¿‡`close()`å‡½æ•°è¿›è¡Œå…³é—­æ“ä½œï¼Œæ‰èƒ½è¿›è¡Œè¾“å‡ºæ“ä½œã€‚`struct`{}ç±»å‹çš„`channel`**ä¸å ç”¨ä»»ä½•å†…å­˜**ï¼Œç”¨æ¥åšåŒæ­¥ç”¨

```go
	ch := make(chan struct{}) 
	times := make([]struct{}, 10)
	for range times {
		go func() {
			handle()
			ch <- struct{}{}
		}()
	}
	// å¦‚æœæ³¨é‡Šæ‰è¿™æ®µï¼Œå‡½æ•°ä¼šç«‹å³è¿”å›ï¼Œè€Œè¿™æ®µä¼šè®©å‡½æ•°ç­‰å¾…æ‰€æœ‰çš„goroutineæ‰§è¡Œå®Œæˆï¼Œè¿›è¡Œä¸€ä¸ªåŒæ­¥ï¼Œå†ok è¿”å›
	// è€ŒåŠ ä¸Šä¹‹åï¼Œä¸»å‡½æ•°æ…¢æ…¢çš„æ’ç©ºchannelï¼Œå­goroutineæ…¢æ…¢çš„è¿›è¡Œå†™å…¥
	//for range times {
	//	<-ch
	//}
	fmt.Println("ok")
```





### ä¸²è”çš„channels(Pipeline)

å¤šä¸ªchannelä¸²è”èµ·æ¥å°±å½¢æˆäº†pipeline

å¦‚æœå‘é€è€…çŸ¥é“æ²¡æœ‰æ›´å¤šçš„å€¼éœ€è¦å‘é€åˆ°channeläº†ï¼Œå°±å¯ä»¥è®©æ¥æ”¶ç€ä¹ŸçŸ¥é“æ²¡æœ‰æ›´å¤šçš„å€¼å¯ä»¥æ¥æ”¶äº†ï¼Œè¿™æ ·æ¥æ”¶è€…å¯ä»¥åœæ­¢ä¸å¿…è¦çš„æ¥æ”¶ç­‰å¾…ï¼Œè¿™å¯ä»¥é€šè¿‡å†…ç½®çš„closeå‡½æ•°æ¥å…³é—­channelä»¥å®ç°

ä½†æ˜¯ **å½“ä¸€ä¸ªè¢«å…³é—­çš„channleä¸­å·²ç»å‘é€çš„æ•°æ®éƒ½è¢«æ¥æ”¶æˆåŠŸå**ï¼Œåç»­çš„æ¥æ”¶æ“ä½œå°†ä¸ä¼šå†é˜»å¡ï¼Œå®ƒä»¬**ä¼šç«‹å³è¿”å›0å€¼**ï¼Œä¼šæ”¶åˆ°æ— ä¼‘æ­¢çš„0åºåˆ—ï¼Œè§£å†³åŠæ³•æ˜¯æ¥æ”¶è€…å¤šæ¥æ”¶ä¸€ä¸ªokå‚æ•°ï¼Œè‡ªå·±è¿›è¡Œåˆ¤æ–­ï¼Œä¾‹å¦‚ï¼š

```go
	for {
		x, ok := <-squares
		if !ok {
			break
		}
		fmt.Println(x)
	}
```

ä½†æ˜¯è¿™ç§æ–¹æ³•æ¯”è¾ƒç¹çï¼Œæ›´ç®€æ´çš„æ–¹æ³•å¯ä»¥ç›´æ¥ä½¿ç”¨rangeå¾ªç¯åœ¨channelä¸Šè¿­ä»£ã€‚**rangeå¾ªç¯åœ¨channelè¢«å…³é—­ä¸”æ²¡æœ‰å€¼å¯æ¥æ”¶æ—¶ä¼šè‡ªåŠ¨è·³å‡ºå¾ªç¯**

```go
func counter(out chan<- int) {
    for x := 0; x < 100; x++ {
        out <- x
    }
    close(out)
}

func squarer(out chan<- int, in <-chan int) {
    for v := range in {
        out <- v * v
    }
    close(out)
}

func printer(in <-chan int) {
    for v := range in {
        fmt.Println(v)
    }
}

func main() {
    naturals := make(chan int)
    squares := make(chan int)
    go counter(naturals)
    go squarer(squares, naturals)
    printer(squares)
}
```

**å°†åŒå‘channelèµ‹å€¼ç»™å•å‘channelä¼šè¿›è¡Œéšå¼è½¬æ¢ï¼Œä½†æ˜¯åè¿‡æ¥æ˜¯ä¸å¯ä»¥è½¬æ¢çš„**



### å¸¦bufferçš„channel

å¸¦bufferçš„channelå†…éƒ¨æŒæœ‰ä¸€ä¸ªå…ƒç´ é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—çš„æœ€å¤§å®¹é‡åœ¨makeçš„æ—¶å€™è¿›è¡ŒæŒ‡å®š

`ch = make(chan string, 3)`

å½“é˜Ÿåˆ—æ»¡äº†çš„æ—¶å€™ï¼Œå‘é€æ“ä½œçš„goroutineæ‰é˜»å¡ï¼Œå½“é˜Ÿåˆ—ç©ºäº†çš„æ—¶å€™ï¼Œæ¥æ”¶æ“ä½œçš„goroutineæ‰é˜»å¡

**ä½¿ç”¨lenå‡½æ•°è·å–channelä¸­æœ‰æ•ˆå…ƒç´ ä¸ªæ•°ï¼Œä½¿ç”¨capè·å¾—channelçš„ç¼“å­˜å®¹é‡**

**å¸¦bufferçš„channelè¿˜å¯ä»¥ç”¨æ¥ç®¡ç†ä¸€ç»„å¯å¤ç”¨çš„èµ„æº(å®ç°ä¸€ä¸ªpool)**



### æ— bufferçš„channelå’Œbufferå¤§å°ä¸º1çš„channel

æ— bufferçš„channelå¿…é¡»ç­‰å¾…åˆ°æ¥æ”¶æ–¹å’Œå‘é€æ–¹åŒæ—¶å‡†å¤‡å¥½æ—¶æ‰èƒ½è¿›è¡Œæ•°æ®ä¼ é€’ï¼Œå¦åˆ™ä¼šé˜»å¡

æœ‰bufferçš„channelå½“ç¼“å†²åŒºæ»¡æ—¶ï¼Œå‘é€æ•°æ®ä¼šé˜»å¡ï¼Œå½“ç¼“å†²åŒºç©ºæ—¶ï¼Œæ¥å—æ•°æ®ä¼šé˜»å¡ï¼Œä¸éœ€è¦åŒæ—¶åšå¥½å‡†å¤‡



**æ— ç¼“å†²é€šé“ï¼Œå¦‚æœæ¥æ”¶æ–¹å’Œå‘é€æ–¹åœ¨ä¸€ä¸ªç¨‹åºä¸­ï¼Œä¼šå¯¼è‡´æ­»é”ï¼š**å®¹é‡å¤§å°ä¸º0ï¼Œå‘é€æ–¹å°†æ•°æ®å‘é€åˆ°channelåä¼šé˜»å¡è‡ªå·±ï¼Œç›´åˆ°æ¥æ”¶æ–¹è¿›è¡Œè¯»å–ä¸ºæ­¢ï¼Œåä¹‹äº¦ç„¶ï¼Œä¸€èˆ¬ç”¨äº**goroutineåŒæ­¥**

```go
func main() {
	c := make(chan int)
  fmt.Println(len(c))   //0
	c <- 1
	fmt.Println(<-c)    //fatal error: all goroutines are asleep - deadlock!
}
```

**ä¿®æ”¹ä¸ºbufferå¤§å°ä¸º1çš„channelåˆ™ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼š**å®¹é‡å¤§å°ä¸º1ï¼Œå‘é€æ–¹å°†æ•°æ®å‘é€åˆ°channelåä¸ä¼šé˜»å¡è‡ªå·±(å¦‚æœbufferå®¹é‡è¶³å¤Ÿ)ï¼Œä¸€èˆ¬ç”¨äº**é€šä¿¡å’Œèµ„æºå…±äº«**

```go
func main() {
	c := make(chan int, 1)
  fmt.Println(len(c))   //1
	c <- 1
	fmt.Println(<-c) //1
}
```

å†çœ‹ä¸¤ä¸ªä¾‹å­ï¼š

```go
func main() {
    var c = make(chan int) 
    var a string

    go func() {
        a = "hello world" 
        <-c 
    }()

    c <- 0  // ä¸»çº¿ç¨‹èµ°åˆ°è¿™é‡Œä¼šå µå¡ï¼Œ ç›´åˆ° c ä¸­çš„ 0 è¢«å–èµ°ï¼Œ æ‰€ä»¥åç¨‹é‡Œçš„ hello world ä¸€å®šä¼šè¢«è¾“å‡ºã€‚
    fmt.Println(a)
}
```

```go
func main() {
    var c = make(chan int, 1) 
    var a string

    go func() {
        a = "hello world" 
        <-c 
    }()

    c <- 0  // ä¸»çº¿ç¨‹èµ°åˆ°è¿™é‡Œä¸ä¼šå µå¡ï¼Œä¹Ÿå°±æ˜¯ hello world å¯èƒ½æ¥ä¸åŠè¾“å‡ºï¼Œä¸»çº¿ç¨‹å°±ç»“æŸäº†ã€‚
    fmt.Println(a)
}
```



### åŸºäºselectçš„å¤šè·¯å¤ç”¨

![](picture/goè¯­è¨€è¦ç‚¹/2021-07-24_151458.png)

[(5æ¡æ¶ˆæ¯) ã€æˆ‘çš„æ¶æ„å¸ˆä¹‹è·¯ã€‘- golangæºç åˆ†æä¹‹selectçš„åº•å±‚å®ç°_GavinXujiacançš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/qq_25870633/article/details/83339538)

selectçš„åŸºæœ¬ç»“æ„ï¼š**å¦‚æœæœ‰defaultåˆ™ä¸ä¼šé˜»å¡ï¼Œå¦‚è¿‡æ²¡æœ‰defaultåˆ™æ˜¯é˜»å¡è°ƒç”¨ï¼Œé˜»å¡ç›´åˆ°ä¸€ä¸ªé€šé“æœ‰äº‹ä»¶ä¸ºæ­¢**ï¼ˆå…³é—­çš„chançš„è¯»æ“ä½œæ˜¯ç›´æ¥å°±ç»ªçš„ï¼‰

```go
select {
case <-ch1:
    // ...
case x := <-ch2:
    // ...use x...
case ch3 <- y:
    // ...
default:
    // ...
}
```



`time.Tick`å‡½æ•°è¿”å›ä¸€ä¸ªchannelï¼Œç¨‹åºä¼šå‘¨æœŸæ€§åœ°åƒä¸€ä¸ªèŠ‚æ‹å™¨ä¸€æ ·å‘è¿™ä¸ªchannelå‘é€äº‹ä»¶ã€‚æ¯ä¸€ä¸ªäº‹ä»¶çš„å€¼æ˜¯ä¸€ä¸ªæ—¶é—´æˆ³

ä½†æ˜¯å¦‚æœä¸æ˜¯æ•´ä¸ªç¨‹åºéƒ½éœ€è¦è¿™ä¸ªchannelï¼Œå¯ä»¥ä½¿ç”¨`time.NewTicker`ï¼Œé€šè¿‡ `time.NewTicker.C`è½¬åŒ–ä¸ºchannelï¼Œç”¨å®Œä¹‹åä½¿ç”¨`ticker.Stop()`å°†tickerçš„goroutineç»“æŸæ‰

```go
func main() {
	abort := make(chan struct{})
	go func() {
		os.Stdin.Read(make([]byte, 1)) // read a single byte
		abort <- struct{}{}
	}()

	fmt.Println("Commencing countdown.  Press return to abort.")
	ticker := time.NewTicker(1 * time.Second)
	for countdown := 10; countdown > 0; countdown-- {
		fmt.Println(countdown)
		select {
		case <-ticker.C:
			fmt.Println(countdown)
		case <-abort:
			fmt.Println("Launch aborted!")
			return
		}
	}
	fmt.Println("launch....")
}
```



**åœ¨forå¾ªç¯é‡Œï¼Œå³ä½¿é€šé“è¢«å…³é—­äº†ï¼Œä¾ç„¶æœ‰æœºä¼šè¢«select**ï¼Œé€šé“è¯»å–çš„ç»“æœæ˜¯é€šé“çš„`é›¶å€¼`å’Œ`false`ï¼š

```go
const (
	fmtTime = "2006-01-02 15:04:05"
)

func main() {
	c1 := make(chan int, 2)
	c2 := make(chan int, 3)
	var wg sync.WaitGroup
	wg.Add(2)
  
	go func() {
		for i := 0; i < 2; i++ {
			c1 <- i
		}
		close(c1)
		wg.Done()
	}()
	go func() {
		for i := 0; i < 3; i++ {
			c2 <- i
		}
		close(c2)
		wg.Done()
	}()
	wg.Wait()
	
  for i := 0; i < 10; i++ {
		select {
		case x, ok := <-c1:
			fmt.Printf("%s : ä»c1è¯»å–åˆ° x=%v, ok=%v\n", time.Now().Format(fmtTime), x, ok)
			time.Sleep(500 * time.Millisecond)
		case x, ok := <-c2:
			fmt.Printf("%s : ä»c2è¯»å–åˆ° x=%v, ok=%v\n", time.Now().Format(fmtTime), x, ok)
			time.Sleep(500 * time.Millisecond)
		default:
			fmt.Printf("%s : æ²¡æœ‰è¯»å–åˆ°ä¿¡æ¯ã€‚ã€‚ã€‚\n", time.Now().Format(fmtTime))
		}
	}
}

/*
2021-01-25 15:46:46 : ä»c2è¯»å–åˆ° x=0, ok=true
2021-01-25 15:46:46 : ä»c2è¯»å–åˆ° x=1, ok=true
2021-01-25 15:46:47 : ä»c2è¯»å–åˆ° x=2, ok=true
2021-01-25 15:46:47 : ä»c1è¯»å–åˆ° x=0, ok=true
2021-01-25 15:46:48 : ä»c2è¯»å–åˆ° x=0, ok=false
2021-01-25 15:46:48 : ä»c1è¯»å–åˆ° x=1, ok=true
2021-01-25 15:46:49 : ä»c2è¯»å–åˆ° x=0, ok=false
2021-01-25 15:46:49 : ä»c1è¯»å–åˆ° x=0, ok=false
2021-01-25 15:46:50 : ä»c1è¯»å–åˆ° x=0, ok=false
2021-01-25 15:46:50 : ä»c1è¯»å–åˆ° x=0, ok=false
*/
```



**nilå€¼çš„channelï¼š** å‘nilçš„channelè¯»æˆ–è€…å†™éƒ½ä¼šè¢«æ°¸è¿œé˜»å¡ï¼Œæ‰€ä»¥selectä¸€ä¸ªnilçš„channelä¼šæ°¸è¿œéƒ½selectä¸åˆ°ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥**ç¦ç”¨æˆ–è€…æ¿€æ´»case**ï¼Œä¾‹å¦‚æƒ³è¦ä¿®æ”¹ä¸Šé¢çš„forå¾ªç¯ï¼Œè®©é€šé“å…³é—­åå°±ä¸å†è¯»å–ï¼š

```go
	for i := 0; i < 10; i++ {
		select {
		case x, ok := <-c1:
			fmt.Printf("%s : ä»c1è¯»å–åˆ° x=%v, ok=%v\n", time.Now().Format(fmtTime), x, ok)
			if !ok {
				c1 = nil
			}
			time.Sleep(500 * time.Millisecond)
		case x, ok := <-c2:
			fmt.Printf("%s : ä»c2è¯»å–åˆ° x=%v, ok=%v\n", time.Now().Format(fmtTime), x, ok)
			if !ok {
				c2 = nil
			}
			time.Sleep(500 * time.Millisecond)
		default:
			fmt.Printf("%s : æ²¡æœ‰è¯»å–åˆ°ä¿¡æ¯ã€‚ã€‚ã€‚\n", time.Now().Format(fmtTime))
		}
	}

/*
2021-01-25 15:52:06 : ä»c2è¯»å–åˆ° x=0, ok=true
2021-01-25 15:52:07 : ä»c1è¯»å–åˆ° x=0, ok=true
2021-01-25 15:52:07 : ä»c2è¯»å–åˆ° x=1, ok=true
2021-01-25 15:52:08 : ä»c2è¯»å–åˆ° x=2, ok=true
2021-01-25 15:52:08 : ä»c2è¯»å–åˆ° x=0, ok=false
2021-01-25 15:52:09 : ä»c1è¯»å–åˆ° x=1, ok=true
2021-01-25 15:52:09 : ä»c1è¯»å–åˆ° x=0, ok=false
2021-01-25 15:52:10 : æ²¡æœ‰è¯»å–åˆ°ä¿¡æ¯ã€‚ã€‚ã€‚
2021-01-25 15:52:10 : æ²¡æœ‰è¯»å–åˆ°ä¿¡æ¯ã€‚ã€‚ã€‚
2021-01-25 15:52:10 : æ²¡æœ‰è¯»å–åˆ°ä¿¡æ¯ã€‚ã€‚ã€‚
*/

//å¦‚æœæ²¡æœ‰defaultï¼Œåˆ™ä¼šå‡ºç° fatal error: all goroutines are asleep - deadlock!
```



ä¸ºäº†é¿å…æ­»é”ï¼Œæˆ‘ä»¬çš„forå¾ªç¯æ¡ä»¶å¯ä»¥ä¿®æ”¹ä¸ºï¼š`for ok1 || ok2 {...}`



### goroutineå¹¶å‘çš„é€€å‡º

goè¯­è¨€å¹¶æ²¡æœ‰æä¾›åœ¨ä¸€ä¸ªgoroutineä¸­ç»ˆæ­¢å¦ä¸€ä¸ªgoroutineçš„æ–¹æ³•ï¼Œå› ä¸ºè¿™æ ·ä¼šå¯¼è‡´goroutineä¹‹é—´çš„å…±äº«å˜é‡è½åœ¨ä¸ºå®šä¹‰çš„çŠ¶æ€ä¸Š



### ä¼˜é›…å…³é—­channel

ä¸è¦ä»reveiverä¾§å…³é—­channelï¼ˆå¯¼è‡´å‘é€è€…panicï¼‰

ä¸è¦åœ¨æœ‰å¤šä¸ªsenderçš„æ—¶å€™å…³é—­channelï¼ˆåŒä¸Šï¼‰

ä½¿ç”¨sync.Onceç¡®ä¿åªå…³é—­ä¸€æ¬¡ï¼ˆå¤šæ¬¡å…³é—­ä¼šç›´æ¥panicï¼‰



1. å¦‚æœæ˜¯1ä¸ªsenderï¼šç›´æ¥senderç«¯å…³é—­
2. å¦‚æœå¤šä¸ªsenderï¼Œ1ä¸ªreceiverï¼šå¢åŠ ä¸€ä¸ªä¼ é€’å…³é—­ä¿¡å·çš„channelï¼Œreceiveré€šè¿‡ä¿¡å·channelä¸‹è¾¾å…³é—­channelçš„æŒ‡ä»¤ï¼Œsendersç›‘å¬åˆ°å…³é—­ä¿¡å·ååœæ­¢å‘é€æ•°æ®ã€‚ä¸‹é¢ä»£ç ä¸­senderä¹Ÿæ²¡æœ‰æ˜ç¡®å…³é—­ï¼Œå› ä¸ºchannelä¼šè¢«gcå›æ”¶çš„ã€‚æˆ–è€…å¯ä»¥ä½¿ç”¨`context`ï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœ

```go
func main() {
    rand.Seed(time.Now().UnixNano())
    const Max = 100000
    const NumSenders = 1000
    dataCh := make(chan int, 100)
    stopCh := make(chan struct{})
    // senders
    for i := 0; i < NumSenders; i++ {
        go func() {
            for {
                select {
                case <- stopCh:
                    return
                case dataCh <- rand.Intn(Max):
                }
            }
        }()
    }
    // the receiver
    go func() {
        for value := range dataCh {
            if value == Max-1 {
                fmt.Println("send stop signal to senders.")
                close(stopCh)
                return
            }
            fmt.Println(value)
        }
    }()
    select {
    case <- time.After(time.Hour):
    }
}
```



3. å¤šä¸ªsenderï¼Œå¤šä¸ªreceiverï¼šå¦‚æœé‡‡ç”¨2ä¸€æ ·çš„æ–¹æ¡ˆï¼Œå…³é—­stopChä¹Ÿä¼šäº§ç”Ÿé‡å¤å…³é—­ï¼Œå¯¼è‡´panicã€‚å› æ­¤éœ€è¦ä¸€ä¸ªä¸­é—´äººã€‚å½“Mä¸ªreceiveréƒ½å‘å®ƒå‘é€dataChçš„è¯·æ±‚ï¼Œä¸­é—´äººæ”¶åˆ°åä¸‹è¾¾å…³é—­dataChçš„æŒ‡ä»¤

```go
func main() {
    rand.Seed(time.Now().UnixNano())
    const Max = 100000
    const NumReceivers = 10
    const NumSenders = 1000
    dataCh := make(chan int, 100)
    stopCh := make(chan struct{})
    // It must be a buffered channel.
    toStop := make(chan string, 1)
    var stoppedBy string
    // moderator
    go func() {
        stoppedBy = <-toStop
        close(stopCh)
    }()
    // senders
    for i := 0; i < NumSenders; i++ {
        go func(id string) {
            for {
                value := rand.Intn(Max)
                if value == 0 {
                    select {
                    case toStop <- "sender#" + id:
                    default:
                    }
                    return
                }
                select {
                case <- stopCh:
                    return
                case dataCh <- value:
                }
            }
        }(strconv.Itoa(i))
    }
    // receivers
    for i := 0; i < NumReceivers; i++ {
        go func(id string) {
            for {
                select {
                case <- stopCh:
                    return
                case value := <-dataCh:
                    if value == Max-1 {
                        select {
                        case toStop <- "receiver#" + id:
                        default:
                        }
                        return
                    }
                    fmt.Println(value)
                }
            }
        }(strconv.Itoa(i))
    }
    select {
    case <- time.After(time.Hour):
    }
}
```





### Channelçš„æ•°æ®ç»“æ„

```go
type hchan struct {
   qcount   uint           // å…ƒç´ æ•°é‡
   dataqsiz uint           // åº•å±‚ç¯å½¢æ•°ç»„çš„é•¿åº¦
   buf      unsafe.Pointer // æŒ‡å‘ç¯å½¢æ•°ç»„çš„æŒ‡é’ˆï¼Œåªé’ˆå¯¹æœ‰ç¼“å†²çš„channel
   elemsize uint16	// å…ƒç´ å¤§å°
   closed   uint32	// æ˜¯å¦å…³é—­
   elemtype *_type 	// å…ƒç´ ç±»å‹
   sendx    uint   		   // å·²å‘é€å…ƒç´ ç´¢å¼•
   recvx    uint   		   // å·²æ¥æ”¶å…ƒç´ ç´¢å¼•
   recvq    waitq  		   // ç­‰å¾…æ¥æ”¶çš„goroutineé˜Ÿåˆ—
   sendq    waitq  		   // æ¥å¾…å‘é€çš„goroutineé˜Ÿåˆ—
   lock mutex		// ä¿æŠ¤å­—æ®µçš„é”
}

// waitq æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œsudogå®é™…æ˜¯goroutineçš„ä¸€ä¸ªå°è£…
type waitq struct {
    first *sudog
    last  *sudog
}
```

ä¾‹å¦‚åˆ›å»ºä¸€ä¸ªå®¹é‡6çš„å…ƒç´ ç±»å‹intçš„channelï¼Œç»“æ„å¦‚ä¸‹ï¼š

<img src="picture/goè¯­è¨€è¦ç‚¹/channelç»“æ„.png" alt="channelç»“æ„" style="zoom:50%;" />



### channelå‘é€å’Œæ¥æ”¶

channel çš„å‘é€å’Œæ¥æ”¶æ“ä½œæœ¬è´¨ä¸Šéƒ½æ˜¯ â€œ**å€¼çš„æ‹·è´**â€ï¼Œæ— è®ºæ˜¯ä» sender goroutine çš„æ ˆåˆ° chan bufï¼Œè¿˜æ˜¯ä» chan buf åˆ° receiver goroutineï¼Œæˆ–è€…æ˜¯ç›´æ¥ä» sender goroutine åˆ° receiver goroutineã€‚

```go
type user struct {
    name string
    age int8
}
var u = user{name: "Ankur", age: 25}
var g = &u
func modifyUser(pu *user) {
    fmt.Println("modifyUser Received Vaule", pu)
    pu.name = "Anand"
}
func printUser(u <-chan *user) {
    time.Sleep(2 * time.Second)
    fmt.Println("printUser goRoutine called", <-u)
}
func main() {
    c := make(chan *user, 5)
    c <- g
    fmt.Println(g)
    // modify g
    g = &user{name: "Ankur Anand", age: 100}
    go printUser(c)
    go modifyUser(g)
    time.Sleep(5 * time.Second)
    fmt.Println(g)
}


/*
&{Ankur 25}
modifyUser Received Vaule &{Ankur Anand 100}
printUser goRoutine called &{Ankur 25}
&{Anand 100}
*/
```

ä¸€å¼€å§‹æ„é€ ä¸€ä¸ªç»“æ„ä½“ uï¼Œåœ°å€æ˜¯ 0x56420ï¼Œå›¾ä¸­åœ°å€ä¸Šæ–¹å°±æ˜¯å®ƒçš„å†…å®¹ã€‚æ¥ç€æŠŠ `&u` èµ‹å€¼ç»™æŒ‡é’ˆ `g`ï¼Œg çš„åœ°å€æ˜¯ 0x565bb0ï¼Œå®ƒçš„å†…å®¹å°±æ˜¯ä¸€ä¸ªåœ°å€ï¼ŒæŒ‡å‘ uã€‚

main ç¨‹åºé‡Œï¼Œå…ˆæŠŠ g å‘é€åˆ° cï¼Œæ ¹æ® `copy value` çš„æœ¬è´¨ï¼Œè¿›å…¥åˆ° chan buf é‡Œçš„å°±æ˜¯ `0x56420`ï¼Œå®ƒæ˜¯æŒ‡é’ˆ g çš„å€¼ï¼ˆä¸æ˜¯å®ƒæŒ‡å‘çš„å†…å®¹ï¼‰ï¼Œæ‰€ä»¥æ‰“å°ä» channel æ¥æ”¶åˆ°çš„å…ƒç´ æ—¶ï¼Œå®ƒå°±æ˜¯ `&{Ankur 25}`ã€‚å› æ­¤ï¼Œè¿™é‡Œå¹¶ä¸æ˜¯å°†æŒ‡é’ˆ g â€œå‘é€â€ åˆ°äº† channel é‡Œï¼Œåªæ˜¯æ‹·è´å®ƒçš„å€¼è€Œå·²ã€‚

<img src="picture/goè¯­è¨€è¦ç‚¹/channelæ¥å—å’Œå‘é€æ•°æ®.png" alt="channelæ¥å—å’Œå‘é€æ•°æ®" style="zoom:80%;" />



å‘channelå‘é€ï¼š

- å¦‚æœæ£€æµ‹åˆ° channel æ˜¯nilçš„ï¼Œå½“å‰ goroutine ä¼šè¢«æŒ‚èµ·ã€‚
- å¯¹äºä¸é˜»å¡çš„å‘é€æ“ä½œï¼Œå¦‚æœ channel æœªå…³é—­å¹¶ä¸”æ²¡æœ‰å¤šä½™çš„ç¼“å†²ç©ºé—´ï¼ˆè¯´æ˜ï¼ša. channel æ˜¯éç¼“å†²å‹çš„ï¼Œä¸”ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—é‡Œæ²¡æœ‰ goroutineï¼›b. channel æ˜¯ç¼“å†²å‹çš„ï¼Œä½†å¾ªç¯æ•°ç»„å·²ç»è£…æ»¡äº†å…ƒç´ ï¼‰







### channelå…³é—­çš„è¿‡ç¨‹

```go
func closechan(c *hchan) {
    // å…³é—­ä¸€ä¸ª nil channelï¼Œpanic
    if c == nil {
        panic(plainError("close of nil channel"))
    }
    // ä¸Šé”
    lock(&c.lock)
    // å¦‚æœ channel å·²ç»å…³é—­
    if c.closed != 0 {
        unlock(&c.lock)
        // panicï¼Œä¸èƒ½é‡å¤å…³é—­channel
        panic(plainError("close of closed channel"))
    }
    // â€¦â€¦â€¦â€¦
    // ä¿®æ”¹å…³é—­çŠ¶æ€
    c.closed = 1
    var glist *g
    // å°† channel æ‰€æœ‰ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—çš„é‡Œ sudog é‡Šæ”¾
    for {
        // ä»æ¥æ”¶é˜Ÿåˆ—é‡Œå‡ºé˜Ÿä¸€ä¸ª sudog
        sg := c.recvq.dequeue()
        if sg == nil {
            break
        }
        // å¦‚æœ elem ä¸ä¸ºç©ºï¼Œè¯´æ˜æ­¤ receiver æœªå¿½ç•¥æ¥æ”¶æ•°æ®
        // ç»™å®ƒèµ‹ä¸€ä¸ªç›¸åº”ç±»å‹çš„é›¶å€¼
        if sg.elem != nil {
            typedmemclr(c.elemtype, sg.elem)
            sg.elem = nil
        }
        if sg.releasetime != 0 {
            sg.releasetime = cputicks()
        }
        // å–å‡º goroutine
        gp := sg.g
        gp.param = nil
        if raceenabled {
            raceacquireg(gp, unsafe.Pointer(c))
        }
        // ç›¸è¿ï¼Œå½¢æˆé“¾è¡¨ï¼Œä¸‹é¢ä¼šè¿›è¡Œç»Ÿä¸€å”¤é†’
        gp.schedlink.set(glist)
        glist = gp
    }
    
    // å°† channel ç­‰å¾…å‘é€é˜Ÿåˆ—é‡Œçš„ sudog é‡Šæ”¾
    // å¦‚æœå­˜åœ¨ï¼Œè¿™äº› goroutine ä¹‹åå°†ä¼š panic
    for {
        // ä»ç­‰å¾…å‘é€çš„é˜Ÿåˆ—é‡Œå‡ºé˜Ÿä¸€ä¸ª sudog
        sg := c.sendq.dequeue()
        if sg == nil {
            break
        }
        // å‘é€è€…ä¼š panic
        sg.elem = nil
        if sg.releasetime != 0 {
            sg.releasetime = cputicks()
        }
        gp := sg.g
        gp.param = nil
        if raceenabled {
            raceacquireg(gp, unsafe.Pointer(c))
        }
        // å½¢æˆé“¾è¡¨
        gp.schedlink.set(glist)
        glist = gp
    }
    // è§£é”
    unlock(&c.lock)
    // éå†é“¾è¡¨ï¼Œå”¤é†’æ‰€æœ‰ ç­‰å¾… çš„ g
    for glist != nil {
        // å–æœ€åä¸€ä¸ª
        gp := glist
        // å‘å‰èµ°ä¸€æ­¥ï¼Œä¸‹ä¸€ä¸ªå”¤é†’çš„ g
        glist = glist.schedlink.ptr()
        gp.schedlink = 0
        // å”¤é†’ç›¸åº” goroutine
        goready(gp, 3)
    }
}
```

close é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå¯¹äºä¸€ä¸ª channelï¼Œrecvq å’Œ sendq ä¸­åˆ†åˆ«ä¿å­˜äº†é˜»å¡çš„å‘é€è€…å’Œæ¥æ”¶è€…ã€‚å…³é—­ channel åï¼Œä¼š**è®¾ç½®å…³é—­çš„æ ‡å¿—ä½**ï¼Œ**å”¤é†’é‚£äº›ç­‰å¾…ç€çš„goroutine**ï¼Œå¯¹äº**ç­‰å¾…æ¥æ”¶è€…**è€Œè¨€ï¼Œä¼šæ”¶åˆ°ä¸€ä¸ªç›¸åº”ç±»å‹çš„**é›¶å€¼**ã€‚å¯¹äº**ç­‰å¾…å‘é€è€…ï¼Œä¼šç›´æ¥ panic**ã€‚æ‰€ä»¥ï¼Œåœ¨ä¸äº†è§£ channel è¿˜æœ‰æ²¡æœ‰æ¥æ”¶è€…çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½è´¸ç„¶å…³é—­ channelã€‚

```go
func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool {
        //  ...
        // å½“ channel close ä¹‹åï¼Œ send ä¼šç›´æ¥ panic
        if c.closed != 0 {
            unlock(&c.lock)
            panic(plainError("send on closed channel"))
        }
        //  ...
}
```

close å‡½æ•°å…ˆä¸Šä¸€æŠŠå¤§é”ï¼Œæ¥ç€æŠŠæ‰€æœ‰æŒ‚åœ¨è¿™ä¸ª channel ä¸Šçš„ sender å’Œ receiver å…¨éƒ½è¿æˆä¸€ä¸ª sudog é“¾è¡¨ï¼Œå†è§£é”ã€‚æœ€åï¼Œå†å°†æ‰€æœ‰çš„ sudog å…¨éƒ½å”¤é†’ã€‚

å”¤é†’ä¹‹åï¼Œè¯¥å¹²å˜›å¹²å˜›ã€‚sender ä¼šç»§ç»­æ‰§è¡Œ chansend å‡½æ•°é‡Œ goparkunlock å‡½æ•°ä¹‹åçš„ä»£ç ï¼Œå¾ˆä¸å¹¸ï¼Œæ£€æµ‹åˆ° channel å·²ç»å…³é—­äº†ï¼Œpanicã€‚receiver åˆ™æ¯”è¾ƒå¹¸è¿ï¼Œè¿›è¡Œä¸€äº›æ‰«å°¾å·¥ä½œåï¼Œè¿”å›ã€‚è¿™é‡Œï¼Œselected è¿”å› trueï¼Œè€Œè¿”å›å€¼ received åˆ™è¦æ ¹æ® channel æ˜¯å¦å…³é—­ï¼Œè¿”å›ä¸åŒçš„å€¼ã€‚å¦‚æœ channel å…³é—­ï¼Œreceived ä¸º falseï¼Œå¦åˆ™ä¸º trueã€‚è¿™æˆ‘ä»¬åˆ†æçš„è¿™ç§æƒ…å†µä¸‹ï¼Œreceived è¿”å› falseã€‚



## 3. goroutineè°ƒåº¦

åŠæŠ¢å å¼ï¼šå½“å‰goroutineå‘ç”Ÿé˜»å¡æ—¶æ‰ä¼šå¯¼è‡´è°ƒåº¦

å‘ç”Ÿåœ¨ç”¨æˆ·æ€ï¼šåˆ‡æ¢ä»£ä»·å°





# å…«ã€ åŸºäºå…±äº«å˜é‡çš„å¹¶å‘

ä¸€ä¸ªæä¾›å¯¹ä¸€ä¸ªæŒ‡å®šçš„å˜é‡é€šè¿‡channelæ¥è¯·æ±‚çš„goroutineå«åšè¿™ä¸ªå˜é‡çš„monitorï¼ˆç›‘æ§ï¼‰goroutine



## 1. sync.Mutexäº’æ–¥é”

é¦–å…ˆæˆ‘ä»¬å¯ä»¥ç”¨ç¼“å­˜å¤§å°ä¸º1çš„ channel æ¥å®ç°äº’æ–¥é”ï¼š

```go
var (
    sema    = make(chan struct{}, 1) // a binary semaphore guarding balance
    balance int
)

func Deposit(amount int) {  //å­˜æ¬¾
    sema <- struct{}{} // acquire token
    balance = balance + amount
    <-sema // release token
}

func Balance() int {  //æŸ¥è¯¢
    sema <- struct{}{} // acquire token
    b := balance
    <-sema // release token
    return b
}
```



**syncåŒ…ä¸­çš„Mutexç±»å‹ç›´æ¥æ”¯æŒè¿™ä¸ªæ“ä½œï¼š** é€šè¿‡ `Mutex.Lock()` å’Œ `Mutex.Unlock()` å‡½æ•°è¿›è¡ŒåŠ é”å’Œè§£é”ï¼Œè·å–é”å¤±è´¥çš„goroutineä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é”å¯ç”¨

**goé‡Œæ²¡æœ‰é‡å…¥é”**

```go
var (
    mu      sync.Mutex // guards balance
    balance int
)

func Deposit(amount int) {
    mu.Lock()
	  defer mu.Unlock()
    balance = balance + amount
}

func Balance() int {
    mu.Lock()
 		defer mu.Unlock()
    b := balance
    return b
}
```

```go
type Mutex struct {
	state int32
	sema  uint32
}
```

lockï¼š

1. å¦‚æœäº’æ–¥é”å¤„äºåˆå§‹åŒ–çŠ¶æ€ï¼Œä¼šé€šè¿‡ç½®ä½ `mutexLocked` åŠ é”ï¼›
2. å¦‚æœäº’æ–¥é”å¤„äº `mutexLocked` çŠ¶æ€å¹¶ä¸”åœ¨æ™®é€šæ¨¡å¼ä¸‹å·¥ä½œï¼Œä¼šè¿›å…¥è‡ªæ—‹ï¼Œæ‰§è¡Œ 30 æ¬¡ `PAUSE` æŒ‡ä»¤æ¶ˆè€— CPU æ—¶é—´ç­‰å¾…é”çš„é‡Šæ”¾ï¼›
3. å¦‚æœå½“å‰ Goroutine ç­‰å¾…é”çš„æ—¶é—´è¶…è¿‡äº† 1msï¼Œäº’æ–¥é”å°±ä¼šåˆ‡æ¢åˆ°é¥¥é¥¿æ¨¡å¼ï¼›
4. äº’æ–¥é”åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¼šé€šè¿‡ [`runtime.sync_runtime_SemacquireMutex`](https://draveness.me/golang/tree/runtime.sync_runtime_SemacquireMutex) å°†å°è¯•è·å–é”çš„ Goroutine åˆ‡æ¢è‡³ä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…é”çš„æŒæœ‰è€…å”¤é†’ï¼›
5. å¦‚æœå½“å‰ Goroutine æ˜¯äº’æ–¥é”ä¸Šçš„æœ€åä¸€ä¸ªç­‰å¾…çš„åç¨‹æˆ–è€…ç­‰å¾…çš„æ—¶é—´å°äº 1msï¼Œé‚£ä¹ˆå®ƒä¼šå°†äº’æ–¥é”åˆ‡æ¢å›æ­£å¸¸æ¨¡å¼ï¼›

unlockï¼š

1. å½“äº’æ–¥é”å·²ç»è¢«è§£é”æ—¶ï¼Œè°ƒç”¨ [`sync.Mutex.Unlock`](https://draveness.me/golang/tree/sync.Mutex.Unlock) ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼›
2. å½“äº’æ–¥é”å¤„äºé¥¥é¥¿æ¨¡å¼æ—¶ï¼Œå°†é”çš„æ‰€æœ‰æƒäº¤ç»™é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªç­‰å¾…è€…ï¼Œç­‰å¾…è€…ä¼šè´Ÿè´£è®¾ç½® `mutexLocked` æ ‡å¿—ä½ï¼›
3. å½“äº’æ–¥é”å¤„äºæ™®é€šæ¨¡å¼æ—¶ï¼Œå¦‚æœæ²¡æœ‰ Goroutine ç­‰å¾…é”çš„é‡Šæ”¾æˆ–è€…å·²ç»æœ‰è¢«å”¤é†’çš„ Goroutine è·å¾—äº†é”ï¼Œä¼šç›´æ¥è¿”å›ï¼›åœ¨å…¶ä»–æƒ…å†µä¸‹ä¼šé€šè¿‡ [`sync.runtime_Semrelease`](https://draveness.me/golang/tree/sync.runtime_Semrelease) å”¤é†’å¯¹åº”çš„ Goroutineï¼›



![](picture/goè¯­è¨€è¦ç‚¹/2021-08-11_210105.png)

## 2. sync.RWMutexè¯»å†™é”

å…è®¸å¤šä¸ªè¯»æ“ä½œå¹¶å‘æ‰§è¡Œï¼Œä½†æ˜¯å†™æ“ä½œå®Œå…¨äº’æ–¥ï¼Œ`RLock()`, `RUnlock()`è·å–å’Œé‡Šæ”¾å…±äº«é”ï¼Œ

```go
var mu sync.RWMutex
var balance int
func Balance() int {
    mu.RLock() // readers lock
    defer mu.RUnlock()
    return balance
}
```



```go
type RWMutex struct {
	w           Mutex
	writerSem   uint32
	readerSem   uint32
	readerCount int32
	readerWait  int32    //å½“å‰å†™æ“ä½œé˜»å¡æ—¶å‰é¢çš„è¯»æ“ä½œæ•°
}
```



**å†™é”**ï¼š

å½“èµ„æºçš„ä½¿ç”¨è€…æƒ³è¦è·å–å†™é”æ—¶ï¼Œéœ€è¦è°ƒç”¨ [``sync.RWMutex.Lock``](https://draveness.me/golang/tree/sync.RWMutex.Lock) æ–¹æ³•ï¼š

```go
func (rw *RWMutex) Lock() {
	rw.w.Lock()
	r := atomic.AddInt32(&rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders
	if r != 0 && atomic.AddInt32(&rw.readerWait, r) != 0 {
		runtime_SemacquireMutex(&rw.writerSem, false, 0)
	}
}
```

1. è°ƒç”¨ç»“æ„ä½“æŒæœ‰çš„`sync.Mutex`ç»“æ„ä½“çš„`sync.Mutex.Lock`é˜»å¡åç»­çš„å†™æ“ä½œï¼›
   - å› ä¸ºäº’æ–¥é”å·²ç»è¢«è·å–ï¼Œå…¶ä»– Goroutine åœ¨è·å–å†™é”æ—¶ä¼šè¿›å…¥è‡ªæ—‹æˆ–è€…ä¼‘çœ ï¼›
2. è°ƒç”¨ [sync/atomic.AddInt32](https://draveness.me/golang/tree/sync/atomic.AddInt32) å‡½æ•°é˜»å¡åç»­çš„è¯»æ“ä½œï¼š
3. å¦‚æœä»ç„¶æœ‰å…¶ä»– Goroutine æŒæœ‰äº’æ–¥é”çš„è¯»é”ï¼Œè¯¥ Goroutine ä¼šè°ƒç”¨ [runtime.sync_runtime_SemacquireMutex](https://draveness.me/golang/tree/runtime.sync_runtime_SemacquireMutex) è¿›å…¥ä¼‘çœ çŠ¶æ€ç­‰å¾…æ‰€æœ‰è¯»é”æ‰€æœ‰è€…æ‰§è¡Œç»“æŸåé‡Šæ”¾ `writerSem` ä¿¡å·é‡å°†å½“å‰åç¨‹å”¤é†’ï¼›

å†™é”çš„é‡Šæ”¾ä¼šè°ƒç”¨ [sync.RWMutex.Unlock](https://draveness.me/golang/tree/sync.RWMutex.Unlock)ï¼š

```go
func (rw *RWMutex) Unlock() {
	r := atomic.AddInt32(&rw.readerCount, rwmutexMaxReaders)
	if r >= rwmutexMaxReaders {
		throw("sync: Unlock of unlocked RWMutex")
	}
	for i := 0; i < int(r); i++ {
		runtime_Semrelease(&rw.readerSem, false, 0)
	}
	rw.w.Unlock()
}
```

ä¸åŠ é”çš„è¿‡ç¨‹æ­£å¥½ç›¸åï¼Œå†™é”çš„é‡Šæ”¾åˆ†ä»¥ä¸‹å‡ ä¸ªæ‰§è¡Œï¼š

1. è°ƒç”¨ [sync/atomic.AddInt32](https://draveness.me/golang/tree/sync/atomic.AddInt32) å‡½æ•°å°† `readerCount` å˜å›æ­£æ•°ï¼Œé‡Šæ”¾è¯»é”ï¼›
2. é€šè¿‡ for å¾ªç¯é‡Šæ”¾æ‰€æœ‰å› ä¸ºè·å–è¯»é”è€Œé™·å…¥ç­‰å¾…çš„ Goroutineï¼š
3. è°ƒç”¨ [sync.Mutex.Unlock](https://draveness.me/golang/tree/sync.Mutex.Unlock) é‡Šæ”¾å†™é”ï¼›

è·å–å†™é”æ—¶ä¼šå…ˆé˜»å¡å†™é”çš„è·å–ï¼Œåé˜»å¡è¯»é”çš„è·å–ï¼Œè¿™ç§ç­–ç•¥èƒ½å¤Ÿä¿è¯è¯»æ“ä½œä¸ä¼šè¢«è¿ç»­çš„å†™æ“ä½œã€é¥¿æ­»ã€ã€‚





**è¯»é”** ï¼š

è¯»é”çš„åŠ é”æ–¹æ³• [sync.RWMutex.RLock](https://draveness.me/golang/tree/sync.RWMutex.RLock) å¾ˆç®€å•ï¼Œè¯¥æ–¹æ³•ä¼šé€šè¿‡ [sync/atomic.AddInt32](https://draveness.me/golang/tree/sync/atomic.AddInt32) å°† `readerCount` åŠ ä¸€ï¼š

```go
func (rw *RWMutex) RLock() {
	if atomic.AddInt32(&rw.readerCount, 1) < 0 {
		runtime_SemacquireMutex(&rw.readerSem, false, 0)
	}
}
```

1. å¦‚æœè¯¥æ–¹æ³•è¿”å›è´Ÿæ•° â€” å…¶ä»– Goroutine è·å¾—äº†å†™é”ï¼Œå½“å‰ Goroutine å°±ä¼šè°ƒç”¨ [runtime.sync_runtime_SemacquireMutex](https://draveness.me/golang/tree/runtime.sync_runtime_SemacquireMutex) é™·å…¥ä¼‘çœ ç­‰å¾…é”çš„é‡Šæ”¾ï¼›
2. å¦‚æœè¯¥æ–¹æ³•çš„ç»“æœä¸ºéè´Ÿæ•° â€” æ²¡æœ‰ Goroutine è·å¾—å†™é”ï¼Œå½“å‰æ–¹æ³•ä¼šæˆåŠŸè¿”å›ï¼›

å½“ Goroutine æƒ³è¦é‡Šæ”¾è¯»é”æ—¶ï¼Œä¼šè°ƒç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ [sync.RWMutex.RUnlock](https://draveness.me/golang/tree/sync.RWMutex.RUnlock) æ–¹æ³•ï¼š

```go
func (rw *RWMutex) RUnlock() {
	if r := atomic.AddInt32(&rw.readerCount, -1); r < 0 {
		rw.rUnlockSlow(r)
	}
}
```



è¯¥æ–¹æ³•ä¼šå…ˆå‡å°‘æ­£åœ¨è¯»èµ„æºçš„ `readerCount` æ•´æ•°ï¼Œæ ¹æ® [sync/atomic.AddInt32](https://draveness.me/golang/tree/sync/atomic.AddInt32) çš„è¿”å›å€¼ä¸åŒä¼šåˆ†åˆ«è¿›è¡Œå¤„ç†ï¼š

- å¦‚æœè¿”å›å€¼å¤§äºç­‰äºé›¶ â€” è¯»é”ç›´æ¥è§£é”æˆåŠŸï¼›
- å¦‚æœè¿”å›å€¼å°äºé›¶ â€” æœ‰ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„å†™æ“ä½œï¼Œåœ¨è¿™æ—¶ä¼šè°ƒç”¨[sync.RWMutex.rUnlockSlow](https://draveness.me/golang/tree/sync.RWMutex.rUnlockSlow) æ–¹æ³•ï¼›

```go
func (rw *RWMutex) rUnlockSlow(r int32) {
	if r+1 == 0 || r+1 == -rwmutexMaxReaders {
		throw("sync: RUnlock of unlocked RWMutex")
	}
	if atomic.AddInt32(&rw.readerWait, -1) == 0 {
		runtime_Semrelease(&rw.writerSem, false, 1)
	}
}
```

[sync.RWMutex.rUnlockSlow](https://draveness.me/golang/tree/sync.RWMutex.rUnlockSlow) ä¼šå‡å°‘è·å–é”çš„å†™æ“ä½œç­‰å¾…çš„è¯»æ“ä½œæ•° `readerWait` å¹¶åœ¨æ‰€æœ‰è¯»æ“ä½œéƒ½è¢«é‡Šæ”¾ä¹‹åè§¦å‘å†™æ“ä½œçš„ä¿¡å·é‡ `writerSem`ï¼Œè¯¥ä¿¡å·é‡è¢«è§¦å‘æ—¶ï¼Œè°ƒåº¦å™¨å°±ä¼šå”¤é†’å°è¯•è·å–å†™é”çš„ Goroutineã€‚



è‡ªå·±å®ç°çš„è¯»å†™é”ï¼š

```go
type RWLock struct {
	m sync.Mutex
	readChan chan struct{}
	writeChan chan struct{}
	readerCount int32
	readerToWait int32
}

func (l *RWLock) WLock() {
	l.m.Lock()
	r := atomic.AddInt32(&l.readerCount, -math.MaxInt32) + math.MaxInt32
	if r != 0 && atomic.AddInt32(&l.readerToWait, r) != 0 {
		<- l.writeChan
	}
	return
}

func (l *RWLock) WUnLock() {
	r := atomic.AddInt32(&l.readerCount, math.MaxInt32)
	if r >= math.MaxInt32 {
		panic("unlock of unlocked RWLock")
	}
	for i := 0; i < int(r); i++ {
		l.readChan <- struct{}{}
	}
	l.m.Unlock()
	return
}

func (l *RWLock) RLock() {
	if atomic.AddInt32(&l.readerCount, 1) <= 0 {
		<- l.readChan
	}
	return
}

func (l *RWLock) RUnLock() {
	if r := atomic.AddInt32(&l.readerCount, -1); r <= 0 {
		if r + 1 == 0 || r + 1 == -math.MaxInt32 {
			panic("unlock of unlocked RWLock")
		}
		if atomic.AddInt32(&l.readerToWait, -1) == 0 {
			l.writeChan <- struct{}{}
		}
	}
}
```



## 3. sync.Once æƒ°æ€§åˆå§‹åŒ–

```go
var loadIconsOnce sync.Once
var icons map[string]image.Image
// Concurrency-safe.
func Icon(name string) image.Image {
    loadIconsOnce.Do(loadIcons)
    return icons[name]
}
```

ä¿è¯åªåˆå§‹åŒ–ä¸€æ¬¡

```go
type Once struct {
	done uint32
	m    Mutex
}

func (o *Once) Do(f func()) {
	if atomic.LoadUint32(&o.done) == 0 {
		o.doSlow(f)
	}
}

func (o *Once) doSlow(f func()) {
	o.m.Lock()
	defer o.m.Unlock()
	if o.done == 0 {
		defer atomic.StoreUint32(&o.done, 1)
		f()
	}
}
```



## 4. atomicåŸå­æ“ä½œ

```go
atomic.AddInt64(&counter, 1)   //åŸå­åœ°å¯¹counteråŠ 1
```

å¼ºåˆ¶åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªgoroutineè¿è¡Œå¹¶å®Œæˆè¿™ä¸ªåŠ æ³•æ“ä½œ



`atomic.LoadInt64` å’Œ `atomic.StoreInt64` ä¸¤ä¸ªå‡½æ•°æä¾›äº†å®‰å…¨è¯»å†™ä¸€ä¸ªæ•´å‹å€¼çš„æ–¹å¼ã€‚è¿™ä¸¤è€…ä¹‹é—´ä¼šäº’ç›¸åŒæ­¥ï¼Œä¿è¯å®‰å…¨ï¼Œä¸ä¼šè¿›å…¥ç«äº‰çŠ¶æ€

```go
var (
   // shutdown is a flag to alert running goroutines to shutdown.
   shutdown int64

   // wg is used to wait for the program to finish.
   wg sync.WaitGroup
)

func main() {
   wg.Add(2)

   go doWork("A")
   go doWork("B")

   // Give the goroutines time to run.
   time.Sleep(1 * time.Second)

   // Safely flag it is time to shutdown.
   fmt.Println("Shutdown Now")
   atomic.StoreInt64(&shutdown, 1)

   // Wait for the goroutines to finish.
   wg.Wait()
}

// doWork simulates a goroutine performing work and
// checking the Shutdown flag to terminate early.
func doWork(name string) {
   defer wg.Done()

   for {
      fmt.Printf("Doing %s Work\n", name)
      time.Sleep(250 * time.Millisecond)

      // Do we need to shutdown.
      if atomic.LoadInt64(&shutdown) == 1 {
         fmt.Printf("Shutting %s Down\n", name)
         break
      }
   }
}
```



### å•ä¾‹ï¼šsync.Onceå°±åŸºäºatomicå®ç°

```go
type Once struct {
	done uint32
	m    Mutex
}

func (o *Once) Do(f func()) {
	if atomic.LoadUint32(&o.done) == 0 {
		o.doSlow(f)
	}
}

func (o *Once) doSlow(f func()) {
	o.m.Lock()
	defer o.m.Unlock()
	if o.done == 0 {     // DLC
    //é‡è¦ï¼šå¿…é¡»è¦ä¿è¯fæ‰§è¡Œå®Œæ‰èƒ½è¿›è¡Œstoreï¼Œå¦åˆ™å…¶ä»–çº¿ç¨‹å¯èƒ½è·å–åˆ°æ²¡æœ‰åˆå§‹åŒ–çš„å¯¹è±¡
		defer atomic.StoreUint32(&o.done, 1)   
		f()
	}
}
```



## 5. é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹

```go
var a string
var done bool

func setup() {
  a = "hello"
  done = true
}

func main() {
  go setup()
  for !done {}
  fmt.Println(a)
}
```

å¹¶å‘çš„äº‹ä»¶æ˜¯æ— æ³•ç¡®å®šå‘ç”Ÿé¡ºåºçš„ã€‚ä¸ºäº†æœ€å¤§åŒ–å¹¶è¡Œï¼Œgoç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šåœ¨å¯¹è¯­å¥/æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œå‰ææ˜¯ä¿è¯ as-if-serialï¼Œä¿è¯ `happens before` åŸåˆ™



## 6. happens-before

[Golang å¹¶å‘ç¼–ç¨‹æ ¸å¿ƒâ€”å†…å­˜å¯è§æ€§](https://juejin.cn/post/6911126210340716558)

happens-before æ˜¯æ¯” **æŒ‡ä»¤é‡æ’ã€å†…å­˜å±éšœ**è¿™äº›æ¦‚å¿µæ›´ä¸Šå±‚çš„ä¸œè¥¿ï¼Œæ˜¯è¯­è¨€å±‚é¢ç»™æˆ‘ä»¬çš„æ‰¿è¯ºã€‚æˆ‘ä»¬æ²¡æœ‰åŠæ³•ç©·ä¸¾åœ¨æ‰€æœ‰è®¡ç®—æœºæ¶æ„ä¸‹é‡æ’åºä¼šå¦‚ä½•å‘ç”Ÿï¼Œä¹Ÿæ²¡åŠæ³•ä¸ºé‡æ’åºå®šä¹‰è¯¥åœ¨ä»€ä¹ˆæ—¶å€™æ’å…¥å±éšœæ¥é˜»æ­¢é‡æ’åºã€åˆ·æ–° cache çš„é¡ºåºï¼Œè¿™ä¸ªæ˜¯æ— æ³•åšåˆ°çš„äº‹æƒ…ã€‚

happens-beforeè¡¨ç¤ºçš„æ˜¯**å‰ä¸€ä¸ªæ“ä½œçš„ç»“æœå¯¹äºåç»­æ“ä½œæ˜¯å¯è§çš„**ï¼Œå®ƒè¡¨è¾¾äº†**å¤šä¸ªçº¿ç¨‹ä¹‹é—´å¯¹äºå†…å­˜çš„å¯è§æ€§**ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ç§ååºå…³ç³»ï¼Œæ‰€ä»¥æ»¡è¶³ä¼ é€’æ€§

> ä¸ºä»€ä¹ˆè¦æœ‰happens-beforeåŸåˆ™ï¼š
>
> å¦‚æœJavaã€Goè¯­è¨€æä¾›å†…å­˜å±éšœæ“ä½œï¼Œè®©å¼€å‘è€…è‡ªå·±å†³å®šä½•æ—¶æ’å…¥å±éšœï¼Œé‚£ä¹ˆå¹¶å‘ä»£ç çš„å¼€å‘å°†å¾ˆéš¾å†™ï¼Œæ˜“å‡ºé”™(Cå°±æ˜¯)
>
> å¯¹äºç¼–è¯‘å™¨å’ŒCPUæ¥è¯´ï¼Œè¿™äº›å†…å­˜å±éšœï¼Œä¼˜åŒ–å±éšœéƒ½æ˜¯çº¦æŸï¼Œè®©åº•å±‚æ— æ³•éšå¿ƒæ‰€æ¬²è¿›è¡Œä¼˜åŒ–ï¼Œè¿™äº›çº¦æŸè‚¯å®šè¶Šå°‘è¶Šå¥½

happens-beforeåƒæ˜¯å‡ æ¡å…¬ç†ï¼Œåªæœ‰æˆ‘ä»¬å¼€å‘çš„æ—¶å€™éµå®ˆè¿™äº›è§„åˆ™ï¼Œæ‰èƒ½ä¿è¯æ­£ç¡®çš„è¯­ä¹‰ï¼Œæ»¡è¶³æ­£ç¡®çš„å¯è§æ€§

Channelæ¶‰åŠåˆ°çš„happens-beforeè§„åˆ™æœ‰4è·³ï¼Œæœ€å¤šï¼ŒGolangé‡Œé¢channelæ‰æ˜¯ä¿è¯å†…å­˜å¯è§æ€§ã€æœ‰åºæ€§ã€ä»£ç åŒæ­¥çš„ç¬¬ä¸€é€‰æ‹©ï¼š

1. `import package` çš„æ—¶å€™ï¼Œå¦‚æœ package p é‡Œé¢æ‰§è¡Œ `import q` ï¼Œé‚£ä¹ˆé€»è¾‘é¡ºåºä¸Š package q çš„ init å‡½æ•°æ‰§è¡Œå…ˆäº package p åé¢æ‰§è¡Œä»»ä½•å…¶ä»–ä»£ç ã€‚
2. `goroutineåˆ›å»º`ï¼šgoroutineçš„åˆ›å»ºå‡½æ•°æœ¬èº« happens before äº goroutine å†…çš„ç¬¬ä¸€è¡Œä»£ç æ‰§è¡Œ
3. `goroutineé”€æ¯`ï¼šgoroutine çš„ exit äº‹ä»¶å¹¶ä¸ä¿è¯å…ˆäºæ‰€æœ‰çš„ç¨‹åºå†…çš„å…¶ä»–äº‹ä»¶ï¼Œæˆ–è€…è¯´æŸä¸ª goroutine exit çš„ç»“æœå¹¶ä¸ä¿è¯å¯¹å…¶ä»–goroutineå¯è§
4. `channelå†™å…¥`ï¼šå‘channelå†™å…¥ happens before äºå¯¹åº”å…ƒç´ çš„è¯»å–æ“ä½œï¼Œæ— è®ºæœ‰æ²¡æœ‰ç¼“å†²çš„channel
5. `channelå…³é—­`ï¼šchannelçš„å…³é—­ happens before äºchannelçš„æ¥æ”¶(<-chan)çš„è¿”å›ï¼Œä¹Ÿå°±æ˜¯è¯´channelä¸€å®šæ˜¯å…ˆå…³é—­äº†ï¼Œæ¥æ”¶è€…æ‰èƒ½æ”¶åˆ°å…³é—­çš„é€šçŸ¥
6. `æ— ç¼“å†²channel`ï¼šæ— ç¼“å†²channelçš„æ¥æ”¶æ“ä½œ happens before å‘é€æ“ä½œã€‚æ¥æ”¶æ“ä½œæ²¡æœ‰åˆ°æ¥ä¹‹å‰ï¼Œå‘é€æ“ä½œè‚¯å®šä¼šè¢«é˜»å¡ä½ï¼Œä¸ä¼šå®Œæˆ
7. `æœ‰ç¼“å†²channel`ï¼šç¼“å†²é•¿åº¦ä¸ºCçš„channelï¼Œç¬¬Kä¸ªå…ƒç´ çš„æ¥æ”¶å…ˆäºç¬¬K+Cä¸ªå…ƒç´ çš„å‘é€
8. `é”`ï¼šé’ˆå¯¹ä»»æ„ `sync.Mutex` å’Œ `sync.RWMutex` çš„é”å˜é‡ Lï¼Œç¬¬ n æ¬¡è°ƒç”¨ `L.Unlock()` é€»è¾‘å…ˆäºï¼ˆç»“æœå¯è§äºï¼‰ç¬¬ m æ¬¡è°ƒç”¨ `L.Lock()` æ“ä½œ ï¼ˆn<mï¼‰ã€‚ä¹Ÿå°±æ˜¯ä¸‹æ¬¡åŠ é”å¿…é¡»ç­‰å¾…ä¸Šæ¬¡çš„é”é‡Šæ”¾
9. `è¯»å†™é”`ï¼šé’ˆå¯¹ `sync.RWMutex` ç±»å‹çš„é”å˜é‡ Lï¼Œ `L.Unlock( )` å¯è§äº `L.Rlock( )` ï¼Œç¬¬ n æ¬¡çš„ `L.Rlock( )` å…ˆäº ç¬¬ n+1 æ¬¡çš„ `L.Lock()`
10. `once`ï¼š`f( )` å‡½æ•°æ‰§è¡Œå…ˆäº `once.Do(f)` çš„è¿”å›ã€‚æ¢å¥è¯è¯´ï¼Œ`f( )` å¿…å®šå…ˆæ‰§è¡Œå®Œï¼Œ`once.Do(f)` å‡½æ•°è°ƒç”¨æ‰èƒ½è¿”å›







# ä¹ã€æµ‹è¯•

`go test`å‘½ä»¤æ˜¯ä¸€ä¸ªæŒ‰ç…§ä¸€å®šçš„çº¦å®šå’Œç»„ç»‡æ¥æµ‹è¯•ä»£ç çš„ç¨‹åºã€‚åœ¨åŒ…ç›®å½•å†…ï¼Œæ‰€æœ‰ä»¥`_test.go`ä¸ºåç¼€åçš„æºæ–‡ä»¶åœ¨æ‰§è¡Œgo buildæ—¶ä¸ä¼šè¢«æ„å»ºæˆåŒ…çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä»¬æ˜¯go testæµ‹è¯•çš„ä¸€éƒ¨åˆ†

`*_test.go`æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸‰ç§ç±»å‹çš„å‡½æ•°ï¼š

- **æµ‹è¯•å‡½æ•°**ï¼šä»¥`Test`ä½œä¸ºå‡½æ•°å‰ç¼€å(ä¹‹åå¿…é¡»ç´§è·Ÿ**å¤§å†™å­—æ¯**)ï¼Œå‡½æ•°å¿…é¡»æ¥æ”¶`*testing.T`ï¼Œå¹¶ä¸”ä¸èƒ½æœ‰è¿”å›å€¼ï¼Œgo testä¼šè°ƒç”¨è¿™äº›æµ‹è¯•å‡½æ•°ï¼Œå¹¶æŠ¥å‘Šç»“æœä¸ºPASSæˆ–FAIL

```go
func TestDownload(t *testing.T) {
  ...
}
```



- **åŸºå‡†æµ‹è¯•ï¼ˆbenchmarkï¼‰å‡½æ•°**ï¼šä»¥Benchmarkä¸ºå‡½æ•°å‰ç¼€åï¼Œç”¨äºè¡¡é‡ä¸€äº›å‡½æ•°çš„æ€§èƒ½ã€‚go testä¼šå¤šæ¬¡è¿è¡ŒåŸºå‡†æµ‹è¯•å‡½æ•°ï¼Œè®¡ç®—å¹³å‡æ—¶é—´
- **ç¤ºä¾‹å‡½æ•°**

go testå‘½ä»¤ä¼šéå†æ‰€æœ‰çš„`*_test.go`æ–‡ä»¶ä¸­ç¬¦åˆä¸Šè¿°å‘½åè§„åˆ™çš„å‡½æ•°ï¼Œç”Ÿæˆä¸€ä¸ª**ä¸´æ—¶çš„mainåŒ…**ç”¨äºè°ƒç”¨ç›¸åº”çš„æµ‹è¯•å‡½æ•°ï¼Œæ¥ç€æ„å»ºå¹¶è¿è¡Œã€æŠ¥å‘Šæµ‹è¯•ç»“æœï¼Œæœ€åæ¸…ç†æµ‹è¯•ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶



## 1. å•å…ƒæµ‹è¯•

å‚æ•°`-v`å¯ç”¨äºæ‰“å°**æ¯ä¸ªæµ‹è¯•å‡½æ•°çš„åå­—å’Œè¿è¡Œæ—¶é—´**

å‚æ•°`-run`å¯¹åº”ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œåªæœ‰**æµ‹è¯•å‡½æ•°åè¢«å®ƒæ­£ç¡®åŒ¹é…çš„å•å…ƒæµ‹è¯•å‡½æ•°**æ‰ä¼šè¢«`go test`æµ‹è¯•å‘½ä»¤è¿è¡Œ

å‚æ•°`-cover` å±•ç¤ºæµ‹è¯•ç”¨ä¾‹å¯¹ä»£ç çš„è¦†ç›–ç‡



è¡¨æ ¼é©±åŠ¨çš„æµ‹è¯•æ¡ˆä¾‹ï¼š

```Go
func TestIsPalindrome(t *testing.T) {
    var tests = []struct {
        input string
        want  bool
    }{
        {"", true},
        {"a", true},
        {"A man, a plan, a canal: Panama", true},
        {"Evil I did dwell; lewd did I live.", true},
        {"Able was I ere I saw Elba", true},
        {"Ã©tÃ©", true},
        {"Et se resservir, ivresse reste.", true},
    }
    for _, test := range tests {
        if got := IsPalindrome(test.input); got != test.want {
            t.Errorf("IsPalindrome(%q) = %v", test.input, got)
        }
    }
}
```



`testing.T`ç»“æ„æ‹¥æœ‰å‡ ä¸ªéå¸¸æœ‰ç”¨çš„å‡½æ•°ï¼š

- `Log` å°†ç»™å®šæ–‡æœ¬è®°å½•åˆ°é”™è¯¯æ—¥å¿—ï¼Œä¸fmt.Println ç±»ä¼¼
- `Logf` 
- `Fail` å°†æµ‹è¯•å‡½æ•°æ ‡è®°ä¸ºâ€œå·²å¤±è´¥â€ï¼Œä½†å…è®¸æµ‹è¯•å‡½æ•°ç»§ç»­æ‰§è¡Œ
- `FailNow` å°†æµ‹è¯•å‡½æ•°æ ‡è®°ä¸ºâ€œå·²å¤±è´¥â€ï¼Œå¹¶ä¸”åœæ­¢æµ‹è¯•å‡½æ•°
- `Error = Log + Fail`ï¼Œæ ‡è®°å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œã€‚ã€‚ã€‚ã€‚Errorf = Logf + Fail
- `Fatal = Log + FailNow`ï¼Œæ ‡è®°å¤±è´¥ï¼Œç«‹å³ç»“æŸã€‚ã€‚ã€‚Fatalf = Logf + FailNow



**è·³è¿‡æµ‹è¯•ç”¨ä¾‹**

`t.Skip()` 

```go
func TestEncode(t *testing.T) {
	t.Skip("Skipping encoding for now")
}
```



**å¹¶è¡Œæ–¹å¼è¿è¡Œæµ‹è¯•**

`t.Parallel()`ï¼Œï¼ŒåŒæ—¶è¿è¡Œæ—¶å‘½ä»¤`go test -v -parallel 3` è¡¨ç¤ºå¹¶è¡Œæ–¹å¼è¿è¡Œï¼Œæœ€å¤š3ä¸ªä»»åŠ¡å¹¶è¡Œ

```go
func TestParallel_1(t *testing.T) {
  t.Parallel()    //ä¸‰ä¸ªæµ‹è¯•ä»»åŠ¡å¹¶è¡Œ
  time.Sleep(1 * time.Second)   //æ¨¡æ‹Ÿéœ€è¦è€—æ—¶1ç§’çš„ä»»åŠ¡
}

func TestParallel_2(t *testing.T) {
  t.Parallel()
  time.Sleep(2 * time.Second)   //æ¨¡æ‹Ÿéœ€è¦è€—æ—¶2ç§’çš„ä»»åŠ¡
}

func TestParallel_3(t *testing.T) {
  t.Parallel()
  time.Sleep(3 * time.Second)   //æ¨¡æ‹Ÿéœ€è¦è€—æ—¶3ç§’çš„ä»»åŠ¡
}
```



## 2. åŸºå‡†æµ‹è¯•

åŸºå‡†æµ‹è¯•ä¹Ÿå®šä¹‰åœ¨ xxx_test.go å½¢å¼çš„æ–‡ä»¶ä¸­ï¼ŒåŸºå‡†æµ‹è¯•çš„å‡½æ•°åä¸º`BenchmarkXxxx(b *testing.B)`

æµ‹è¯•ç¨‹åºè¦åšçš„å°±æ˜¯å°†è¢«æµ‹è¯•çš„ä»£ç æ‰§è¡Œ b.N æ¬¡ï¼Œä»¥ä¾¿æ£€æµ‹ä»£ç çš„å“åº”æ—¶é—´ï¼Œb.Nçš„å€¼æ˜¯æ ¹æ®è¢«æ‰§è¡Œä»£ç è€Œæ”¹å˜çš„ï¼Œç”±Goè‡ªè¡Œå†³å®š

è¿è¡Œæ—¶çš„å‘½ä»¤`go test -v -bench .` å…¶ä¸­ -bench ä¼ å…¥ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ç”¨äºåŒ¹é…åŸºå‡†æµ‹è¯•å‡½æ•°

```go
func BenchmarkDecode(b *testing.B) {
  for i := 0; i < b.N; i++ {
    decode("post.json") 
  }
}

func BenchmarkUnmarshal(b *testing.B) {
  for i := 0; i < b.N; i++ {
    unmarshal("post.json")
  }
}
```



åŒæ—¶è¯¥å‘½ä»¤ä¹Ÿä¼šæ‰§è¡Œå•å…ƒæµ‹è¯•å‡½æ•°ï¼Œå¦‚æœæƒ³è¦å¿½ç•¥å•å…ƒæµ‹è¯•ï¼Œåªè¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œå¯ä»¥æŒ‡å®š -run çš„å‚æ•°ä¸ºä¸€ä¸ªä¸å­˜åœ¨çš„æ­£åˆ™æ¨¡å¼ï¼Œè¿™æ ·æ‰€æœ‰çš„åŠŸèƒ½æµ‹è¯•å‡½æ•°éƒ½ä¼šè¢«å¿½ç•¥

```shell
âœ  unit_testing git:(master) âœ— go test -v -cover -run x -bench .     
goos: darwin
goarch: amd64
pkg: github.com/sausheong/gwp/Chapter_8_Testing_Web_Applications/unit_testing
BenchmarkDecode
BenchmarkDecode-8          55884             21660 ns/op
BenchmarkUnmarshal
BenchmarkUnmarshal-8       49724             25388 ns/op
PASS
coverage: 42.4% of statements
ok      github.com/sausheong/gwp/Chapter_8_Testing_Web_Applications/unit_testing        4.143s

```





# åã€æ¥å£å’Œåå°„

```go
func TypeOf(i interface{}) Type {
	eface := *(*emptyInterface)(unsafe.Pointer(&i))
	return toType(eface.typ)
}


func ValueOf(i interface{}) Value {
	if i == nil {
		return Value{}
	}

	// TODO: Maybe allow contents of a Value to live on the stack.
	// For now we make the contents always escape to the heap. It
	// makes life easier in a few places (see chanrecv/mapassign
	// comment below).
	escapes(i)

	return unpackEface(i)
}

type Value struct {
	// typ holds the type of the value represented by a Value.
	typ *rtype
	ptr unsafe.Pointer
	flag
}

// emptyInterface is the header for an interface{} value.
type emptyInterface struct {
	typ  *rtype
	word unsafe.Pointer
}

// nonEmptyInterface is the header for an interface value with methods.
type nonEmptyInterface struct {
	// see ../runtime/iface.go:/Itab
	itab *struct {
		ityp *rtype // static interface type
		typ  *rtype // dynamic concrete type
		hash uint32 // copy of typ.hash
		_    [4]byte
		fun  [100000]unsafe.Pointer // method table
	}
	word unsafe.Pointer
}
```



```go
func (t *rtype) Field(i int) StructField {
	if t.Kind() != Struct {
		panic("reflect: Field of non-struct type " + t.String())
	}
	tt := (*structType)(unsafe.Pointer(t))
	return tt.Field(i)
}
```





ç¨‹åºåœ¨ç¼–è¯‘æ—¶ï¼Œå˜é‡è¢«è½¬æ¢ä¸ºå†…å­˜åœ°å€ï¼Œå˜é‡åä¸ä¼šè¢«ç¼–è¯‘å™¨å†™å…¥åˆ°å¯æ‰§è¡Œéƒ¨åˆ†ã€‚åœ¨è¿è¡Œç¨‹åºæ—¶ï¼Œç¨‹åºæ— æ³•è·å–è‡ªèº«çš„ä¿¡æ¯

åå°„æ˜¯æŒ‡**åœ¨ç¨‹åºè¿è¡ŒæœŸé—´å¯¹ç¨‹åºæœ¬èº«è¿›è¡Œè®¿é—®å’Œä¿®æ”¹çš„èƒ½åŠ›**

æ”¯æŒåå°„çš„è¯­è¨€å¯ä»¥**åœ¨ç¨‹åºç¼–è¯‘æœŸ**å°†å˜é‡çš„**åå°„ä¿¡æ¯**ï¼Œå¦‚**å­—æ®µåç§°ã€ç±»å‹ä¿¡æ¯ã€ç»“æ„ä½“ä¿¡æ¯ç­‰**æ•´åˆåˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå¹¶ç»™ç¨‹åºæä¾›æ¥å£è®¿é—®åå°„ä¿¡æ¯ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ç¨‹åºè¿è¡ŒæœŸè·å–ç±»å‹çš„åå°„ä¿¡æ¯ï¼Œå¹¶ä¸”æœ‰èƒ½åŠ›ä¿®æ”¹å®ƒä»¬

Goè¯­è¨€ä½¿ç”¨reflectåŒ…è®¿é—®ç¨‹åºçš„åå°„ä¿¡æ¯

reflectåŒ…æä¾›äº†ä¸¤ä¸ªé‡è¦çš„ç±»å‹ï¼š`Type`å’Œ`Value`ï¼Œä»»æ„æ¥å£å€¼åœ¨åå°„ä¸­éƒ½å¯ä»¥ç†è§£ä¸ºç”± `reflect.Type` å’Œ `reflect.Value` ä¸¤éƒ¨åˆ†ç»„æˆã€‚ã€‚reflect åŒ…æä¾›äº† `reflect.TypeOf` å’Œ `reflect.ValueOf` ä¸¤ä¸ªå‡½æ•°æ¥è·å–ä»»æ„å¯¹è±¡çš„ Value å’Œ Type



## 1. unsafe.Pointer

æŒ‡é’ˆç±»å‹çš„è½¬æ¢ï¼š

```go
func main() {
	var i *int
	p := 10
	i = &p

	m := (*float64)(i)
}

/*
cannot convert i (type *int) to type *float64
*/
```

æ­£å¸¸æˆ‘ä»¬è¿›è¡ŒæŒ‡é’ˆç±»å‹è½¬æ¢çš„æ—¶å€™ï¼Œä¸åŒçš„ç±»å‹æ˜¯ä¸èƒ½è½¬æ¢çš„

unsafe.Pointeræ˜¯ä¸€ç§ç‰¹åˆ«å®šä¹‰çš„æŒ‡é’ˆç±»å‹ï¼Œå¯ä»¥åŒ…å«ä»»æ„ç±»å‹å˜é‡çš„åœ°å€ï¼Œæ˜¯å„ä¸ªæŒ‡é’ˆç±»å‹è½¬æ¢çš„æ¡¥æ¢ï¼Œä¸Šè¿°è½¬æ¢å¯ä»¥é€šè¿‡unsafe.Pointerå®ç°ï¼š

```go
func main() {
	var i *int
	p := 10
	i = &p

	m := (*float64)(unsafe.Pointer(i))
}
```

> unsafe.PointeræŒ‡é’ˆè½¬æ¢çš„è§„åˆ™ï¼š
>
> - å®‰å…¨æŒ‡é’ˆå¯ä»¥æ˜¾ç¤ºè½¬æ¢ä¸ºä¸å®‰å…¨æŒ‡é’ˆï¼Œåä¹‹äº¦ç„¶
>
> - uintptrå€¼å¯ä»¥æ˜¾ç¤ºè½¬æ¢ä¸ºä¸å®‰å…¨æŒ‡é’ˆï¼Œåä¹‹äº¦ç„¶



## 2. uintptr

uintptræ˜¯ä¸€ä¸ªå¯ä»¥å®¹çº³ä»»ä½•æŒ‡é’ˆç±»å‹çš„æ•´å½¢ï¼Œå¯ä»¥è¿›è¡ŒæŒ‡é’ˆè¿ç®—

æ­£å¸¸goçš„æŒ‡é’ˆæ˜¯ä¸æ”¯æŒè¿ç®—çš„ï¼Œæ‰€ä»¥å¯ä»¥è½¬æ¢æˆuintptrè¿›è¡ŒæŒ‡é’ˆè¿ç®—ï¼Œç„¶åå†è½¬æ¢ä¸ºå¯¹åº”ç±»å‹çš„æŒ‡é’ˆ

```go
type User struct {
	Name string
	Age int
}

func main() {
	u := new(User)
	name :=(*string)(unsafe.Pointer(u))
	*name = "test"

	age := (*int)(unsafe.Pointer(uintptr(unsafe.Pointer(u)) + unsafe.Offsetof(u.Age)))
	*age = 18
	fmt.Println(u)
}
```

æ€è·¯ï¼šå¦‚æœå¯¹Nameå’ŒAgeèµ‹å€¼ï¼Œé¦–å…ˆè¦æ‹¿åˆ°åœ°å€ï¼Œç„¶åå¯¹åœ°å€çš„å†…å®¹è¿›è¡Œä¿®æ”¹

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ†åˆ«å®šä¹‰ä¸€ä¸ª`string`å’Œ`int`çš„æŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘è¿™ä¸ªå®ä¾‹çš„Nameå’ŒAgeå­—æ®µçš„åœ°å€

uçš„é¦–åœ°å€å°±æ˜¯Nameçš„åœ°å€ï¼Œä½†æ˜¯uæ˜¯ç»“æ„ä½“æŒ‡é’ˆï¼Œæ‰€ä»¥åªéœ€è¦å°†uè½¬æ¢æˆ*stringå³å¯

å¯¹äºageï¼Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†Nameçš„åœ°å€ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œåç§»å³å¯ï¼Œä¹Ÿå°±æ˜¯`unsafe.Offsetof(u.Age)`çš„åç§»é‡ï¼Œä½†æ˜¯`Pointer`ä¸èƒ½è¿›è¡ŒæŒ‡é’ˆè¿ç®—ï¼Œæ‰€ä»¥éœ€è¦å°†`Pointer`è½¬æ¢æˆ`uintptr`



## 3. interface{}ã€eface

<img src="picture/goè¯­è¨€è¦ç‚¹/61f23b6970d518a7bd3c5aa2a55c6444.png" alt="eface ç»“æ„ä½“å…¨æ™¯" style="zoom:50%;" />

`runtime.eface` (empty interface) ï¼š ä½¿ç”¨interface{}å£°æ˜çš„éƒ½æ˜¯empty interfaceï¼Œç”±äºefaceä¸åŒ…å«æ–¹æ³•ï¼Œæ‰€ä»¥ç»“æ„æ¯”è¾ƒç®€å•.

ç”±äº`interface{}`å€¼åŒ…å«äº†æŒ‡å‘åº•å±‚æ•°æ®å’Œç±»å‹çš„ä¸¤ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥ä»»ä½•ç±»å‹éƒ½å¯ä»¥è½¬æ¢æˆ`interafce{}`

```go
type eface struct {
	_type *_type
	data  unsafe.Pointer
}
```



`runtime._type`æ˜¯goè¯­è¨€ç±»å‹çš„è¿è¡Œæ—¶è¡¨ç¤ºï¼ŒåŒ…å«äº†å¾ˆå¤šç±»å‹çš„å…ƒä¿¡æ¯ï¼šä¾‹å¦‚ç±»å‹çš„å¤§å°ã€å“ˆå¸Œã€å¯¹é½ã€ç§ç±»ç­‰

```go
type _type struct {
	size       uintptr // å­˜å‚¨è¯¥typeçš„valueéœ€è¦çš„ç©ºé—´å¤§å°
	ptrdata    uintptr 
	hash       uint32 // ç±»å‹çš„hashå€¼ï¼Œæ‰€æœ‰çš„typeä¼šå­˜æ”¾åœ¨hashTypeè¡¨ä¸­ï¼Œä»¥hashä¸ºç´¢å¼•ï¼Œå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿç¡®å®šç±»å‹æ˜¯å¦ç›¸ç­‰
	tflag      tflag 
	align      uint8 // æ­¤ç±»å‹typeçš„å¯¹é½
	fieldalign uint8 // è¿™ä¸ªtypeçš„ç»“æ„ä½“å­—æ®µçš„å¯¹é½
	kind       uint8 // ç±»å‹ç¼–å· å®šä¹‰äºruntime/typekind.go
	equal      func(unsafe.Pointer, unsafe.Pointer) bool  // ç”¨äºåˆ¤æ–­å½“å‰ç±»å‹çš„å¤šä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰

	gcdata    *byte
	str       nameOff // ç±»å‹åå­—çš„åç§»
	ptrToThis typeOff
}
```



## 4. ifaceå’Œæ¥å£è½¬æ¢

### iface

<img src="picture/goè¯­è¨€è¦ç‚¹/724f1808f70187aa1fcbbf82e497e828.png" alt="iface ç»“æ„ä½“å…¨æ™¯" style="zoom:67%;" />

tabæ˜¯æ¥å£è¡¨æŒ‡é’ˆï¼ŒæŒ‡å‘ç±»å‹ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯æ¥å£çš„**åŠ¨æ€ç±»å‹**

dataæ˜¯æ•°æ®æŒ‡é’ˆï¼ŒæŒ‡å‘å…·ä½“æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æ¥å£çš„**åŠ¨æ€å€¼**



`runtime.iface`(å¸¦å‡½æ•°çš„interface)ï¼š

```go
type iface struct {
	tab  *itab			// æ¥å£ç±»å‹çš„ä¿¡æ¯
	data unsafe.Pointer
}
```

`runtime.itab`ä¸­å­˜æ”¾äº†æ¥å£ç±»å‹çš„æ ¸å¿ƒæ•°æ®ï¼Œæ¯ä¸ªitabéƒ½å 32å­—èŠ‚

```go
type itab struct {
	inter *interfacetype // interfaceçš„ç±»å‹
	_type *_type // åŒä¸Šçš„type
	hash  uint32 // å¯¹_typeä¸­çš„hashçš„æ‹·è´ï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­æ¥å£å’Œå…·ä½“ç±»å‹èƒ½å¦è½¬æ¢
	_     [4]byte
	fun   [1]uintptr //å…·ä½“ç±»å‹çš„å®ç°æ¥å£çš„å…·ä½“æ–¹æ³•ï¼Œfunåœ¨æ ˆä¸Šåç§»åœ°å€ï¼Œå› ä¸ºfunéƒ½æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥é•¿åº¦éƒ½æ˜¯4ä¸ªå­—èŠ‚ï¼Œæ‰¾åˆ°funçš„é¦–åœ°å€åï¼Œæ¯åç§»4ä¸ªåœ°å€ä¾¿å­˜å‚¨ä¸€ä¸ªå‡½æ•°åœ°å€
}
```

`interfacetype`ä¸­å­˜æ”¾äº†æ¥å£çš„ç›¸å…³ä¿¡æ¯

```go
type interfacetype struct {
	typ     _type
	pkgpath name // åŒ…ä¿¡æ¯
	mhdr    []imethod // åŸæœ¬æ¥å£çš„æ–¹æ³•ï¼Œmethod sliceï¼Œè¿™é‡Œæ˜¯æ’åºåçš„ï¼Œæ–¹ä¾¿æ£€æµ‹ structæ˜¯å¦ç»§æ‰¿äº† interface
}
```

`imethod`å­˜æ”¾æ–¹æ³•ç›¸å…³ä¿¡æ¯

```go
type imethod struct {
	name nameOff // å‡½æ•°åå­—çš„åç§»ï¼Œè¿™é‡Œæ˜¯int32,åé¢æŸ¥æ‰¾çš„æ—¶å€™ä¼šæ ¹æ®è¿™ä¸ªæ•°å€¼ï¼Œè®¡ç®—å‡ºåç§»é‡ï¼Œ å­˜æ”¾åœ¨ firstmoduledata è¿™ä¸ªç¬¦å·è¡¨ä¸­
	ityp typeOff // typeç±»å‹çš„åç§»é‡ï¼Œå¯¹åº”interfaceçš„_type
}
```



### æ¥å£è½¬æ¢

ç”±äºifaceåŒ…å«äº†æ¥å£çš„ç±»å‹ interfacetype å’Œå®ä½“ç±»å‹çš„ç±»å‹ _typeã€‚ä¹Ÿå°±æ˜¯è¯´ç”Ÿæˆä¸€ä¸ªitabåŒæ—¶éœ€è¦æ¥å£çš„ç±»å‹å’Œå®ä½“çš„ç±»å‹

å½“åˆ¤å®šä¸€ç§ç±»å‹æ˜¯å¦æ»¡è¶³æŸä¸ªæ¥å£æ—¶ï¼Œgoä½¿ç”¨ç±»å‹çš„æ–¹æ³•é›†å’Œæ¥å£æ‰€éœ€è¦çš„æ–¹æ³•é›†è¿›è¡ŒåŒ¹é…ï¼Œå®Œå…¨åŒ…å«æ¥å£çš„æ–¹æ³•é›†å°±è®¤ä¸ºå®ç°äº†è¯¥æ¥å£

```go
r.tab = getitab(inter, tab._type, false)

func getitab(inter *interfacetype, typ *_type, canfail bool) *itab {
    // â€¦â€¦
    // æ ¹æ® inter, typ è®¡ç®—å‡º hash å€¼
    h := itabhash(inter, typ)
    // look twice - once without lock, once with.
    // common case will be no lock contention.
    var m *itab
    var locked int
    for locked = 0; locked < 2; locked++ {
        if locked != 0 {
            lock(&ifaceLock)
        }
        // éå†å“ˆå¸Œè¡¨çš„ä¸€ä¸ª slot
        for m = (*itab)(atomic.Loadp(unsafe.Pointer(&hash[h]))); m != nil; m = m.link {
            // å¦‚æœåœ¨ hash è¡¨ä¸­å·²ç»æ‰¾åˆ°äº† itabï¼ˆinter å’Œ typ æŒ‡é’ˆéƒ½ç›¸åŒï¼‰
            if m.inter == inter && m._type == typ {
                // â€¦â€¦
                if locked != 0 {
                    unlock(&ifaceLock)
                }
                return m
            }
        }
    }
    // åœ¨ hash è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ° itabï¼Œé‚£ä¹ˆæ–°ç”Ÿæˆä¸€ä¸ª itab
    m = (*itab)(persistentalloc(unsafe.Sizeof(itab{})+uintptr(len(inter.mhdr)-1)*sys.PtrSize, 0, &memstats.other_sys))
    m.inter = inter
    m._type = typ
    // æ·»åŠ åˆ°å…¨å±€çš„ hash è¡¨ä¸­
    additab(m, true, canfail)
    unlock(&ifaceLock)
    if m.bad {
        return nil
    }
    return m
}
```



getitab å‡½æ•°ä¼šæ ¹æ® `interfacetype` å’Œ `_type` å»å…¨å±€çš„ itab å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœèƒ½æ‰¾åˆ°ï¼Œåˆ™ç›´æ¥è¿”å›ï¼›å¦åˆ™ï¼Œä¼šæ ¹æ®ç»™å®šçš„ `interfacetype` å’Œ `_type` æ–°ç”Ÿæˆä¸€ä¸ª `itab`ï¼Œå¹¶æ’å…¥åˆ° itab å“ˆå¸Œè¡¨ï¼Œè¿™æ ·ä¸‹ä¸€æ¬¡å°±å¯ä»¥ç›´æ¥æ‹¿åˆ° `itab`

è¿™é‡ŒæŸ¥æ‰¾äº†ä¸¤æ¬¡ï¼Œå¹¶ä¸”ç¬¬äºŒæ¬¡ä¸Šé”äº†ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœç¬¬ä¸€æ¬¡æ²¡æ‰¾åˆ°ï¼Œåœ¨ç¬¬äºŒæ¬¡ä»ç„¶æ²¡æœ‰æ‰¾åˆ°ç›¸åº”çš„ `itab` çš„æƒ…å†µä¸‹ï¼Œéœ€è¦æ–°ç”Ÿæˆä¸€ä¸ªï¼Œå¹¶ä¸”å†™å…¥å“ˆå¸Œè¡¨ï¼Œå› æ­¤éœ€è¦åŠ é”ã€‚è¿™æ ·ï¼Œå…¶ä»–åç¨‹åœ¨æŸ¥æ‰¾ç›¸åŒçš„ `itab` å¹¶ä¸”ä¹Ÿæ²¡æœ‰æ‰¾åˆ°æ—¶ï¼Œç¬¬äºŒæ¬¡æŸ¥æ‰¾æ—¶ï¼Œä¼šè¢«æŒ‚ä½ï¼Œä¹‹åï¼Œå°±ä¼šæŸ¥åˆ°ç¬¬ä¸€ä¸ªåç¨‹å†™å…¥å“ˆå¸Œè¡¨çš„ `itab`



## 5. reflect.Type

å‡½æ•° reflect.TypeOf æ¥å— interface{} ç±»å‹ï¼Œå¹¶ä»¥ `reflect.Type` å½¢å¼è¿”å›å…¶ **åŠ¨æ€ç±»å‹**ï¼š

```Go
t := reflect.TypeOf(3)  // a reflect.Type
fmt.Println(t.String()) // "int"
fmt.Println(t)          // "int"
```

è¿™é‡Œå°†3ä½œä¸ºæ¥å£ä¼ é€’ç»™TypeOfå‡½æ•°ï¼Œå³**å°†ä¸€ä¸ªå…·ä½“çš„å€¼è½¬ä¸ºæ¥å£ç±»å‹**ï¼Œä¼šæœ‰ä¸€ä¸ª**éšå¼çš„æ¥å£è½¬æ¢**æ“ä½œï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«ä¸¤ä¸ªä¿¡æ¯çš„æ¥å£å€¼ï¼šæ“ä½œæ•°çš„**åŠ¨æ€ç±»å‹**ï¼ˆè¿™é‡Œæ˜¯ intï¼‰å’Œå®ƒçš„**åŠ¨æ€çš„å€¼**ï¼ˆè¿™é‡Œæ˜¯ 3ï¼‰

```go
    var a int
    typeOfA := reflect.TypeOf(a)
    fmt.Println(typeOfA.Name(), typeOfA.Kind())    //int  int
```



### 5.1 Kindå’ŒName

reflectåŒ…å®šä¹‰çš„å¯¹è±¡çš„**åå°„ç§ç±»(Kind)**ï¼šç³»ç»Ÿçš„åŸç”Ÿæ•°æ®ç±»å‹ä»¥åŠä½¿ç”¨typeå…³é”®å­—å®šä¹‰çš„ç±»å‹

```go
const (
    Invalid Kind = iota  // éæ³•ç±»å‹
    Bool                 // å¸ƒå°”å‹
    Int                  // æœ‰ç¬¦å·æ•´å‹
    Int8                 // æœ‰ç¬¦å·8ä½æ•´å‹
    Int16                // æœ‰ç¬¦å·16ä½æ•´å‹
    Int32                // æœ‰ç¬¦å·32ä½æ•´å‹
    Int64                // æœ‰ç¬¦å·64ä½æ•´å‹
    Uint                 // æ— ç¬¦å·æ•´å‹
    Uint8                // æ— ç¬¦å·8ä½æ•´å‹
    Uint16               // æ— ç¬¦å·16ä½æ•´å‹
    Uint32               // æ— ç¬¦å·32ä½æ•´å‹
    Uint64               // æ— ç¬¦å·64ä½æ•´å‹
    Uintptr              // æŒ‡é’ˆ
    Float32              // å•ç²¾åº¦æµ®ç‚¹æ•°
    Float64              // åŒç²¾åº¦æµ®ç‚¹æ•°
    Complex64            // 64ä½å¤æ•°ç±»å‹
    Complex128           // 128ä½å¤æ•°ç±»å‹
    Array                // æ•°ç»„
    Chan                 // é€šé“
    Func                 // å‡½æ•°
    Interface            // æ¥å£
    Map                  // æ˜ å°„
    Ptr                  // æŒ‡é’ˆ
    Slice                // åˆ‡ç‰‡
    String               // å­—ç¬¦ä¸²
    Struct               // ç»“æ„ä½“
    UnsafePointer        // åº•å±‚æŒ‡é’ˆ
)
```

Mapã€Sliceã€Chan å±äºå¼•ç”¨ç±»å‹ï¼Œä½¿ç”¨èµ·æ¥ç±»ä¼¼äºæŒ‡é’ˆï¼Œä½†æ˜¯åœ¨ç§ç±»å¸¸é‡å®šä¹‰ä¸­ä»ç„¶å±äºç‹¬ç«‹çš„ç§ç±»ï¼Œä¸å±äº Ptrã€‚type A struct{} å®šä¹‰çš„ç»“æ„ä½“å±äº Struct ç§ç±»ï¼Œ*A å±äº Ptrã€‚



è·å–å¯¹è±¡åç§°å’Œç§ç±»ç­‰ä¿¡æ¯ï¼š

```go
	m := mmmm{}
	typeOfm := reflect.TypeOf(m)
	fmt.Println(typeOfm.Name())       //mmmm åç§°
	fmt.Println(typeOfm.Kind())				//struct ç§ç±»
	fmt.Println(typeOfm.String())     //main.mmmm

type Enum int
var Zero Enum = 0
    
	typeOfA := reflect.TypeOf(Zero)
  fmt.Println(typeOfA.Name(), typeOfA.Kind())  // Enum int
```



### 5.2 æŒ‡é’ˆå’ŒElem

å¯¹äºæŒ‡é’ˆè·å–åå°„å¯¹è±¡æ—¶ï¼Œå¯ä»¥é€šè¿‡`reflect.Elem()`è·å–**æŒ‡é’ˆæŒ‡å‘çš„å…ƒç´ çš„åå°„å¯¹è±¡`reflect.Value`**ï¼Œç›¸å½“äºäº`*`æ“ä½œ

**æŒ‡é’ˆå˜é‡çš„`Name`æ˜¯ç©º**

```go
	m2 := &mmmm{}
	typeOfm2 := reflect.TypeOf(m2)
	fmt.Println(typeOfm2.Name())    //æŒ‡é’ˆå˜é‡çš„Nameéƒ½æ˜¯ç©º
	fmt.Println(typeOfm2.Kind(), typeOfm2.String(), typeOfm2.Elem())  //ptr *main.mmmm main.mmmm
	
	typeOfm2Elem := typeOfm2.Elem()  //è·å–åˆ°æŒ‡é’ˆæŒ‡å‘å…ƒç´ çš„ç±»å‹
	fmt.Println(typeOfm2Elem.Name(), typeOfm2Elem.Kind())   //mmmm struct
```



### 5.3 åå°„è·å–ç»“æ„ä½“æˆå‘˜ç±»å‹

ä»»æ„å€¼é€šè¿‡ reflect.TypeOf() è·å¾—åå°„å¯¹è±¡ä¿¡æ¯åï¼Œå¦‚æœå®ƒçš„ç±»å‹æ˜¯**ç»“æ„ä½“**ï¼Œå¯ä»¥é€šè¿‡åå°„å€¼å¯¹è±¡ reflect.Type çš„ `NumField()` å’Œ `Field()` æ–¹æ³•è·å¾—ç»“æ„ä½“æˆå‘˜çš„è¯¦ç»†ä¿¡æ¯

StructField çš„ç»“æ„å¦‚ä¸‹ï¼š

```go
type StructField struct {
    Name string          // å­—æ®µå
    PkgPath string       // å­—æ®µè·¯å¾„
    Type      Type       // å­—æ®µåå°„ç±»å‹å¯¹è±¡
    Tag       StructTag  // å­—æ®µçš„ç»“æ„ä½“æ ‡ç­¾
    Offset    uintptr    // å­—æ®µåœ¨ç»“æ„ä½“ä¸­çš„ç›¸å¯¹åç§»
    Index     []int      // Type.FieldByIndexä¸­çš„è¿”å›çš„ç´¢å¼•å€¼
    Anonymous bool       // æ˜¯å¦ä¸ºåŒ¿åå­—æ®µ
}
```



- `Field(i int) StructField`	æ ¹æ®ç´¢å¼• i è¿”å›ç´¢å¼•å¯¹åº”çš„ç»“æ„ä½“å­—æ®µçš„ä¿¡æ¯ï¼Œå½“å€¼ä¸æ˜¯ç»“æ„ä½“æˆ–ç´¢å¼•è¶…ç•Œæ—¶å‘ç”Ÿå®•æœº
- `NumField() int`	è¿”å›ç»“æ„ä½“æˆå‘˜å­—æ®µæ•°é‡ï¼Œå½“ç±»å‹ä¸æ˜¯ç»“æ„ä½“æ—¶å‘ç”Ÿå®•æœº
- `FieldByName(name string) (StructField, bool)`	æ ¹æ®ç»™å®šå­—ç¬¦ä¸²è¿”å›å­—ç¬¦ä¸²å¯¹åº”çš„ç»“æ„ä½“å­—æ®µçš„ä¿¡æ¯ï¼Œæ²¡æœ‰æ‰¾åˆ°æ—¶ bool è¿”å› falseï¼Œå½“ç±»å‹ä¸æ˜¯ç»“æ„ä½“æˆ–ç´¢å¼•è¶…ç•Œæ—¶å‘ç”Ÿå®•æœº
- `FieldByIndex(index []int) StructField`	å¤šå±‚æˆå‘˜è®¿é—®æ—¶ï¼Œæ ¹æ® []int æä¾›çš„æ¯ä¸ªç»“æ„ä½“çš„å­—æ®µç´¢å¼•ï¼Œè¿”å›å­—æ®µçš„ä¿¡æ¯ï¼Œæ²¡æœ‰æ‰¾åˆ°æ—¶è¿”å›é›¶å€¼ã€‚å½“ç±»å‹ä¸æ˜¯ç»“æ„ä½“æˆ–ç´¢å¼•è¶…ç•Œæ—¶å‘ç”Ÿå®•
- `FieldByNameFunc(match func(string) bool) (StructField,bool)`	æ ¹æ®åŒ¹é…å‡½æ•°åŒ¹é…éœ€è¦çš„å­—æ®µï¼Œå½“å€¼ä¸æ˜¯ç»“æ„ä½“æˆ–ç´¢å¼•è¶…ç•Œæ—¶å‘ç”Ÿå®•æœº

```go
	type cat struct {
		Name string
		// å¸¦æœ‰ç»“æ„ä½“tagçš„å­—æ®µ
		Type int `json:"type" id:"100"`
	}
	mycat := cat{Name: "mimi", Type: 1}
	typeOfCat := reflect.TypeOf(mycat)
	// éå†ç»“æ„ä½“æ‰€æœ‰æˆå‘˜
	for i := 0; i < typeOfCat.NumField(); i++ {
		fieldType := typeOfCat.Field(i)
		// è¾“å‡ºæˆå‘˜åå’Œtag
		fmt.Printf("name: %v  tag: '%v'\n", fieldType.Name, fieldType.Tag)
	}
	// é€šè¿‡å­—æ®µå, æ‰¾åˆ°å­—æ®µç±»å‹ä¿¡æ¯
	if catType, ok := typeOfCat.FieldByName("Type"); ok {
		// ä»tagä¸­å–å‡ºéœ€è¦çš„tag
		fmt.Println(catType.Tag.Get("json"), catType.Tag.Get("id"))
	}

/* ç»“æœå¦‚ä¸‹ï¼š
  name: Name  tag: ''
  name: Type  tag: 'json:"type" id:"100"'
  type 100
*/
```



### 5.4 reflect.Typeæ˜¯ä¸€ä¸ªæ¥å£ç±»å‹

```go
type Type interface {
        Align() int
        FieldAlign() int
        Method(int) Method
        MethodByName(string) (Method, bool)   //è·å–æŒ‡å®šåå­—çš„methodçš„å¼•ç”¨
        NumMethod() int
        ...
        Implements(u Type) bool   //åˆ¤æ–­æ˜¯å¦å®ç°äº†æŸä¸ªæ¥å£
        ...
}
```



## 6. reflect.Value

- reflect.Valueæ˜¯ä¸€ä¸ª**ç»“æ„ä½“ç±»å‹**ï¼Œè¿™ä¸ªç»“æ„ä½“æ²¡æœ‰å¯¹å¤–æš´éœ²çš„å­—æ®µï¼Œä½†æ˜¯æä¾›äº†è·å–æˆ–è€…å†™å…¥æ•°æ®çš„æ–¹æ³•

```go
type Value struct {
        // åŒ…å«è¿‡æ»¤çš„æˆ–è€…æœªå¯¼å‡ºçš„å­—æ®µ
}

func (v Value) Addr() Value
func (v Value) Bool() bool
func (v Value) Bytes() []byte
```



å› ä¸º reflect.TypeOf è¿”å›çš„æ˜¯ä¸€ä¸ªåŠ¨æ€ç±»å‹çš„æ¥å£å€¼ï¼Œå®ƒæ€»æ˜¯**è¿”å›å…·ä½“çš„ç±»å‹**ã€‚å› æ­¤ï¼Œä¸‹é¢çš„ä»£ç å°†æ‰“å° "*os.File" è€Œä¸æ˜¯ "io.Writer"

åŒæ ·çš„reflect.Valueofä¹Ÿæ¥æ”¶ä»»æ„çš„interface{}ç±»å‹ï¼Œè¿”å›çŠ¶æ€å…¶åŠ¨æ€å€¼çš„reflect.Valueï¼Œä¹Ÿæ˜¯å…·ä½“çš„ç±»å‹

reflect.Type å’Œ reflect.Value éƒ½å®ç°äº† fmt.Stringer æ¥å£ï¼Œä½†æ˜¯é™¤é Value æŒæœ‰çš„æ˜¯å­—ç¬¦ä¸²ï¼Œå¦åˆ™ String æ–¹æ³•åªè¿”å›å…¶ç±»å‹ã€‚è€Œä½¿ç”¨ fmt åŒ…çš„ %v æ ‡å¿—å‚æ•°ä¼šå¯¹ reflect.Values ç‰¹æ®Šå¤„ç†

```Go
var w io.Writer = os.Stdout
fmt.Println(reflect.TypeOf(w)) // "*os.File"

v := reflect.ValueOf(3) // a reflect.Value
x := v.Interface()      // an interface{}
i := x.(int)            // an int  ç±»å‹æ–­è¨€
fmt.Printf("%d\n", i)   // "3"
```

 **fmt.Printf æä¾›çš„ %T å‚æ•°ï¼Œå†…éƒ¨å°±æ˜¯ä½¿ç”¨ reflect.TypeOf æ¥è¾“å‡º**

Type å’Œ Value éƒ½æœ‰ä¸€ä¸ªåä¸º Kind çš„æ–¹æ³•ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªå¸¸é‡ï¼Œè¡¨ç¤ºåº•å±‚æ•°æ®çš„ç±»å‹ï¼Œå¸¸è§å€¼æœ‰ï¼šUintã€Float64ã€Slice ç­‰ã€‚

### 6.1 è·å–å€¼

```go
    // å£°æ˜æ•´å‹å˜é‡aå¹¶èµ‹åˆå€¼
    var a int = 1024
    // è·å–å˜é‡açš„åå°„å€¼å¯¹è±¡
    valueOfA := reflect.ValueOf(a)
    // è·å–interface{}ç±»å‹çš„å€¼, é€šè¿‡ç±»å‹æ–­è¨€è½¬æ¢
    var getA int = valueOfA.Interface().(int)
    // è·å–64ä½çš„å€¼, å¼ºåˆ¶ç±»å‹è½¬æ¢ä¸ºintç±»å‹
    var getA2 int = int(valueOfA.Int())
    fmt.Println(getA, getA2)               // 1024 1024
```



### 6.2 ä¿®æ”¹æ•°æ®

Value ç±»å‹ä¹Ÿæœ‰ä¸€äº›ç±»ä¼¼äº Intã€Float çš„æ–¹æ³•ï¼Œç”¨æ¥æå–åº•å±‚çš„æ•°æ®ï¼š

- Int æ–¹æ³•ç”¨æ¥æå– int64
- Float æ–¹æ³•ç”¨æ¥æå– float64

```go
    var x float64 = 3.4
    v := reflect.ValueOf(x)
    fmt.Println("type:", v.Type())		//type: float64
    fmt.Println("kind is float64:", v.Kind() == reflect.Float64)  //kind is float64: true
    fmt.Println("value:", v.Float())  //value: 3.4
```

è¿˜æœ‰ä¸€äº›ç”¨æ¥ä¿®æ”¹æ•°æ®çš„æ–¹æ³•ï¼Œæ¯”å¦‚ SetIntã€SetFloatã€‚ã€‚ã€‚ä½†æ˜¯éœ€è¦æœ‰`â€œå¯ä¿®æ”¹æ€§â€ï¼ˆsettabilityï¼‰`,

é¦–å…ˆè¦æ±‚**å¯è¢«å¯»å€**(åå°„ç¬¬ä¸‰å¤§æ³•åˆ™)ï¼Œå…¶æ¬¡å¿…é¡»æ˜¯**å¯¼å‡ºçš„**

 Value çš„ getter å’Œ setter æ–¹æ³•ï¼šä¸ºäº†ä¿è¯ API çš„ç²¾ç®€ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ“ä½œçš„æ˜¯æŸä¸€ç»„ç±»å‹**èŒƒå›´æœ€å¤§çš„é‚£ä¸ª**ã€‚æ¯”å¦‚ï¼Œå¤„ç†ä»»ä½•å«ç¬¦å·æ•´å‹æ•°ï¼Œéƒ½ä½¿ç”¨ `int64`ä¹Ÿå°±æ˜¯è¯´ Value ç±»å‹çš„ Int æ–¹æ³•è¿”å›å€¼ä¸º int64 ç±»å‹ï¼ŒSetInt æ–¹æ³•æ¥æ”¶çš„å‚æ•°ç±»å‹ä¹Ÿæ˜¯ int64 ç±»å‹ã€‚å®é™…ä½¿ç”¨æ—¶ï¼Œå¯èƒ½éœ€è¦è½¬åŒ–ä¸ºå®é™…çš„ç±»å‹

```go
    var x uint8 = 'x'
    v := reflect.ValueOf(x)
    fmt.Println("type:", v.Type())                            // uint8.
    fmt.Println("kind is uint8: ", v.Kind() == reflect.Uint8) // true.
    x = uint8(v.Uint())                                       // v.Uint returns a uint64.
```



### 6.3 ä¿®æ”¹ç»“æ„ä½“å­—æ®µå€¼

æ ¹æ®åå°„çš„ç¬¬ä¸‰æ³•åˆ™ï¼Œæˆ‘ä»¬éœ€è¦æœ‰ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œæ‰å¯ä»¥ä¿®æ”¹å®ƒçš„å­—æ®µ

```go
    type T struct {
        A int
        B string
    }
    t := T{23, "skidoo"}
    s := reflect.ValueOf(&t).Elem()  // è·å–æŒ‡é’ˆæŒ‡å‘å…ƒç´ ç±»å‹çš„åå°„å¯¹è±¡ reflect.Value
    typeOfT := s.Type()     // è·å–æŒ‡é’ˆæŒ‡å‘å…ƒç´ ç±»å‹çš„åå°„å¯¹è±¡ reflect.Type
    for i := 0; i < s.NumField(); i++ {
        f := s.Field(i)
        fmt.Printf("%d: %s %s = %v\n", i,
            typeOfT.Field(i).Name, f.Type(), f.Interface())
    }

// 0: A int = 23
// 1: B string = skidoo
```

ä¿®æ”¹:

```go
    type T struct {
        A int
        B string
    }
    t := T{23, "skidoo"}
    s := reflect.ValueOf(&t).Elem()
    s.Field(0).SetInt(77)
    s.Field(1).SetString("Sunset Strip")
    fmt.Println("t is now", t)    // t is now {77 Sunset Strip}
```



## 7. åå°„ä¸‰å¤§æ³•åˆ™

 Go è¯­è¨€åå°„çš„ä¸‰å¤§æ³•åˆ™ï¼š

1. ä» `interface{}` å˜é‡å¯ä»¥åå°„å‡ºåå°„å¯¹è±¡ï¼›
2. ä»åå°„å¯¹è±¡å¯ä»¥è·å– `interface{}` å˜é‡ï¼›
3. è¦ä¿®æ”¹åå°„å¯¹è±¡ï¼Œå…¶å€¼å¿…é¡»æ˜¯å¯è®¾ç½®çš„ï¼›



### 7.1 åå°„å¯ä»¥å°†æ¥å£ç±»å‹å˜é‡è½¬æ¢ä¸ºåå°„ç±»å‹å¯¹è±¡

`reflect.TypeOf()` å’Œ `reflect.ValueOf()` å¯ä»¥**å°†goè¯­è¨€çš„ interface{} å¯¹è±¡è½¬åŒ–ä¸ºåå°„å¯¹è±¡**ï¼Œä»–ä»¬çš„å‚æ•°ç±»å‹éƒ½æ˜¯ interface{}ã€‚ã€‚æ‰€ä»¥è¿™å¯èƒ½ä¼šè¿›è¡Œéšå¼çš„ç±»å‹è½¬æ¢ã€‚ å¦‚æœæˆ‘ä»¬è®¤ä¸º **Go è¯­è¨€çš„ç±»å‹** å’Œ **åå°„ç±»å‹**å¤„äºä¸¤ä¸ªä¸åŒçš„ä¸–ç•Œï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå‡½æ•°å°±æ˜¯è¿æ¥è¿™ä¸¤ä¸ªä¸–ç•Œçš„æ¡¥æ¢

```go
func TypeOf(i interface{}) Type     //æ¥æ”¶ä¸€åˆ‡ interface{},è¿”å›reflect.Type
func ValueOf(i interface{}) Value 
```



![golang-interface-to-reflection](picture/goè¯­è¨€è¦ç‚¹/golang-interface-to-reflection.png)

```go
func main() {
	author := "draven"
	fmt.Println("TypeOf author:", reflect.TypeOf(author))   //TypeOf author: string
	fmt.Println("ValueOf author:", reflect.ValueOf(author)) //ValueOf author: draven
}
```

æœ‰äº†å˜é‡çš„ç±»å‹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `Method` æ–¹æ³•è·å¾—ç±»å‹å®ç°çš„æ–¹æ³•ï¼Œé€šè¿‡ `Field` è·å–ç±»å‹åŒ…å«çš„å…¨éƒ¨å­—æ®µã€‚å¯¹äºä¸åŒçš„ç±»å‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è°ƒç”¨ä¸åŒçš„æ–¹æ³•è·å–ç›¸å…³ä¿¡æ¯ï¼š

- ç»“æ„ä½“ï¼šè·å–å­—æ®µçš„æ•°é‡å¹¶é€šè¿‡ä¸‹æ ‡å’Œå­—æ®µåè·å–å­—æ®µ `StructField`ï¼›
- å“ˆå¸Œè¡¨ï¼šè·å–å“ˆå¸Œè¡¨çš„ `Key` ç±»å‹ï¼›
- å‡½æ•°æˆ–æ–¹æ³•ï¼šè·å–å…¥å‚å’Œè¿”å›å€¼çš„ç±»å‹ï¼›
- â€¦



### 7.2 åå°„å¯ä»¥å°†åå°„ç±»å‹å¯¹è±¡è½¬æ¢ä¸ºæ¥å£ç±»å‹å˜é‡

åå°„çš„ç¬¬äºŒæ³•åˆ™æ˜¯æˆ‘ä»¬å¯ä»¥ä»åå°„å¯¹è±¡å¯ä»¥è·å– `interface{}` å˜é‡ã€‚æ—¢ç„¶èƒ½å¤Ÿå°†æ¥å£ç±»å‹çš„å˜é‡è½¬æ¢æˆåå°„å¯¹è±¡ï¼Œé‚£ä¹ˆä¸€å®šéœ€è¦å…¶ä»–æ–¹æ³•å°†åå°„å¯¹è±¡è¿˜åŸæˆæ¥å£ç±»å‹çš„å˜é‡ï¼Œ `reflect.Value.Interface`å°±èƒ½å®Œæˆè¿™é¡¹å·¥ä½œï¼š

```go
func (v Value) Interface() interface{}    //è¿”å›interface{}
```



![golang-reflection-to-interface](picture/goè¯­è¨€è¦ç‚¹/golang-reflection-to-interface.png)

```go
v := reflect.ValueOf(1)
v.Interface().(int)   //é€šè¿‡ç±»å‹æ–­è¨€ï¼Œå°† interface{} ç±»å‹è½¬åŒ–ä¸ºäº† int ç±»å‹
```



**æ— è®ºæ˜¯æ¥å£å€¼åˆ°åå°„å¯¹è±¡è¿˜æ˜¯åå°„å¯¹è±¡åˆ°æ¥å£å€¼ï¼Œéƒ½æ˜¯éœ€è¦ä¸¤æ¬¡ç±»å‹è½¬æ¢çš„**ï¼š

![img](picture/goè¯­è¨€è¦ç‚¹/golang-bidirectional-reflection.png)

å½“ç„¶å¦‚æœå˜é‡æœ¬èº«å°±æ˜¯ `interface{}` ç±»å‹çš„ï¼Œé‚£ä¹ˆå®ƒä¸éœ€è¦ç±»å‹è½¬æ¢ï¼Œå› ä¸ºç±»å‹è½¬æ¢è¿™ä¸€è¿‡ç¨‹ä¸€èˆ¬éƒ½æ˜¯éšå¼çš„ï¼Œæ‰€ä»¥æˆ‘ä¸å¤ªéœ€è¦å…³å¿ƒå®ƒï¼Œ**åªæœ‰åœ¨æˆ‘ä»¬éœ€è¦å°†åå°„å¯¹è±¡è½¬æ¢å›åŸºæœ¬ç±»å‹æ—¶æ‰éœ€è¦æ˜¾å¼çš„è½¬æ¢æ“ä½œ**



æ ‡å‡†åº“ä¸­çš„ fmt.Println å’Œ fmt.Printf ç­‰å‡½æ•°éƒ½æ¥æ”¶ç©ºæ¥å£å˜é‡ä½œä¸ºå‚æ•°ï¼Œ**fmt åŒ…å†…éƒ¨ä¼šå¯¹æ¥å£å˜é‡è¿›è¡Œæ‹†åŒ…**ï¼Œå› æ­¤ fmt åŒ…çš„æ‰“å°å‡½æ•°åœ¨æ‰“å° reflect.Value ç±»å‹å˜é‡çš„æ•°æ®æ—¶ï¼Œåªéœ€è¦æŠŠ Interface æ–¹æ³•çš„ç»“æœä¼ ç»™æ ¼å¼åŒ–æ‰“å°ç¨‹åºï¼š

```go
	fmt.Println(v.Interface())
```



### 7.3 è¦ä¿®æ”¹åå°„ç±»å‹å¯¹è±¡ï¼Œå…¶å€¼å¿…é¡»æ˜¯å¯å†™çš„

æœ€åä¸€æ¡æ³•åˆ™æ˜¯ä¸å€¼æ˜¯å¦å¯ä»¥è¢«æ›´æ”¹æœ‰å…³ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦æ›´æ–°ä¸€ä¸ª `reflect.Value`ï¼Œé‚£ä¹ˆå®ƒæŒæœ‰çš„å€¼ä¸€å®šæ˜¯å¯ä»¥è¢«æ›´æ–°çš„ã€‚å¯ä»¥é€šè¿‡ `CanSet()` æ–¹æ³•æ£€æŸ¥ä¸€ä¸ª `reflect.Value` ç±»å‹å˜é‡çš„å¯å†™æ€§

```go
func main() {
	i := 1
	v := reflect.ValueOf(i)
  fmt.Println(v.CanSet())  // false
	v.SetInt(10)     //panic: reflect: reflect.flag.mustBeAssignable using unaddressable value
	fmt.Println(i)
}
```

ç”±äºgoè¯­è¨€çš„å‡½æ•°è°ƒç”¨éƒ½æ˜¯**å€¼ä¼ é€’**ï¼Œ`reflect.ValueOf` å‡½æ•°çš„å˜é‡ i å®é™…ä¸Šåªæ˜¯ i çš„ä¸€ä¸ªæ‹·è´ï¼Œè€Œéiæœ¬èº«ã€‚**æˆ‘ä»¬å¾—åˆ°çš„åå°„å¯¹è±¡å’Œæœ€å¼€å§‹çš„å˜é‡æ²¡æœ‰ä»»ä½•å…³ç³»**ï¼Œæ‰€ä»¥ç›´æ¥ä¿®æ”¹åå°„å¯¹è±¡æ— æ³•æ”¹å˜åŸå§‹å˜é‡ï¼Œç¨‹åºä¸ºäº†é˜²æ­¢é”™è¯¯å°±ä¼šå´©æºƒ

**è¦ä¿®æ”¹åŸå˜é‡åªèƒ½ä½¿ç”¨å¦‚ä¸‹çš„æ–¹æ³•ï¼š**

```go
	i := 1
	v := reflect.ValueOf(&i) //è°ƒç”¨ reflect.ValueOf       è·å–å˜é‡æŒ‡é’ˆçš„åå°„å¯¹è±¡
	elem := v.Elem()         //è°ƒç”¨ reflect.Value.Elem    è·å–æŒ‡é’ˆæŒ‡å‘çš„å˜é‡
	elem.SetInt(10)          //è°ƒç”¨ reflect.Value.SetInt  ä¿®æ”¹å˜é‡çš„å€¼   okï¼Œ i=10
  elem.Set(reflect.ValueOf(20))    //ok, i = 20
  elem.Set(reflect.ValueOf("abc"))   //panic: string is not assignable to int
  
  //æˆ–è€…é€šè¿‡æŒ‡é’ˆä¿®æ”¹
	x := 2
	d := reflect.ValueOf(&x).Elem()   // d refers to the variable x
	px := d.Addr().Interface().(*int) // px := &x
	*px = 3                           // x = 3
```

## 8. ç±»å‹å’Œå€¼

Go è¯­è¨€çš„ `interface{}` ç±»å‹åœ¨è¯­è¨€å†…éƒ¨æ˜¯é€šè¿‡ `reflect.emptyInterface` ç»“ä½“è¡¨ç¤ºçš„ï¼Œå…¶ä¸­çš„ `rtype` å­—æ®µç”¨äºè¡¨ç¤ºå˜é‡çš„ç±»å‹ï¼Œå¦ä¸€ä¸ª `word` å­—æ®µæŒ‡å‘å†…éƒ¨å°è£…çš„æ•°æ®ï¼š

```go
type emptyInterface struct {
	typ  *rtype
	word unsafe.Pointer
}
```

ç”¨äºè·å–å˜é‡ç±»å‹çš„ `reflect.TypeOf` å‡½æ•°å°†ä¼ å…¥çš„å˜é‡éšå¼è½¬æ¢æˆ `reflect.emptyInterface`ç±»å‹å¹¶è·å–å…¶ä¸­å­˜å‚¨çš„ç±»å‹ä¿¡æ¯ `reflect.rtype`ï¼š

```go
func TypeOf(i interface{}) Type {
	eface := *(*emptyInterface)(unsafe.Pointer(&i))
	return toType(eface.typ)
}

func toType(t *rtype) Type {
	if t == nil {
		return nil
	}
	return t
} 
```

[Goè¯­è¨€interfaceå®ç°åŸç†è¯¦è§£ - jimshi - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/shijingxiang/articles/12201984.html)

[Golangåå°„æœºåˆ¶çš„å®ç°åˆ†æâ€”â€”reflect.Typeç±»å‹åç§°_æ–¹äº®çš„ä¸“æ -CSDNåšå®¢](https://blog.csdn.net/breaksoftware/article/details/85995767)

## 9. é€šè¿‡ç±»å‹ä¿¡æ¯åˆ›å»ºå®ä¾‹

å½“å·²çŸ¥ reflect.Type æ—¶ï¼Œå¯ä»¥åŠ¨æ€åœ°åˆ›å»ºè¿™ä¸ªç±»å‹çš„å®ä¾‹ï¼Œå®ä¾‹çš„ç±»å‹ä¸ºæŒ‡é’ˆã€‚ä¾‹å¦‚ reflect.Type çš„ç±»å‹ä¸º int æ—¶ï¼Œåˆ›å»º int çš„æŒ‡é’ˆï¼Œå³`*int`

```go
    var a int

    // å–å˜é‡açš„åå°„ç±»å‹å¯¹è±¡
    typeOfA := reflect.TypeOf(a)

		// æ ¹æ®åå°„ç±»å‹å¯¹è±¡åˆ›å»ºç±»å‹å®ä¾‹
    aIns := reflect.New(typeOfA)
    
		// è¾“å‡ºValueçš„ç±»å‹å’Œç§ç±»
    fmt.Println(aIns.Type(), aIns.Kind())     //*int  ptr
```



## 10. é€šè¿‡åå°„è°ƒç”¨å‡½æ•°

éœ€è¦æ„å»ºå¤§é‡çš„ reflect.Value å’Œä¸­é—´å˜é‡ï¼Œæ£€æŸ¥å‚æ•°ï¼Œè¿˜è¦å°†å‚æ•°å¤åˆ¶åˆ°è°ƒç”¨å‡½æ•°çš„å‚æ•°å†…å­˜ä¸­ï¼Œè°ƒç”¨å®Œæ¯•å†å°†è¿”å›å€¼è½¬æ¢ä¸º reflect.Value ï¼Œæ€§èƒ½éå¸¸å·®

```go
// æ™®é€šå‡½æ•°
func add(a, b int) int {
    return a + b
}

func main() {
    // å°†å‡½æ•°åŒ…è£…ä¸ºåå°„å€¼å¯¹è±¡
    funcValue := reflect.ValueOf(add)

  	// æ„é€ å‡½æ•°å‚æ•°, ä¼ å…¥ä¸¤ä¸ªæ•´å‹å€¼
    paramList := []reflect.Value{reflect.ValueOf(10), reflect.ValueOf(20)}
    
  	// åå°„è°ƒç”¨å‡½æ•°
    retList := funcValue.Call(paramList)
    
  	// è·å–ç¬¬ä¸€ä¸ªè¿”å›å€¼, å–æ•´æ•°å€¼
    fmt.Println(retList[0].Int())
}
```







# åä¸€ã€æ ‡å‡†åº“



## 1. logåŒ…

log.Println()  æ‰“å°åˆ°æ ‡å‡†æ—¥å¿—è®°å½•å™¨

log.Fatalln()  è°ƒç”¨åä¼šç´§æ¥ç€è°ƒç”¨os.Exit(1)

log.Panicln() è°ƒç”¨åä¼šç´§æ¥ç€è°ƒç”¨panic()



## 2. jsonç›¸å…³



**ä¸¤ç§ç¼–ç å’Œè§£ç æ–¹å¼ï¼š**

1. ç¼–ç 
   `json.NewEncoder(<Writer>).encode(v)`    
   `json.Marshal(&v)`  è¿”å›å­—èŠ‚åˆ‡ç‰‡ []byte ï¼Œä¸ºäº†è®©ç¼–ç åçš„jsonæ›´åŠ æ˜“è¯»ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ `MatshalIndent(&v, "", "\t")`   ä»¥æ›´æ˜“è¯»çš„æ–¹å¼è§£ç ï¼Œç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯æŒ‡å®šå‰ç¼€ï¼Œåé¢ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡å®šç¼©è¿›ç¬¦
2. è§£ç 
   `json.NewDecoder(<Reader>).decode(&v)`     
   `json.Unmarshal([]byte, &v)`     éœ€è¦ä¼ å…¥å­—èŠ‚åˆ‡ç‰‡



```go
type Person struct {
    Name string `json:"name"`
    Age int `json:"age"`
}

func main()  {
    // 1. ä½¿ç”¨ json.Marshal ç¼–ç 
    person1 := Person{"å¼ ä¸‰", 24}
    bytes1, err := json.Marshal(&person1)
    if err == nil {
        // è¿”å›çš„æ˜¯å­—èŠ‚åˆ‡ç‰‡ []byte
        fmt.Println("json.Marshal ç¼–ç ç»“æœ: ", string(bytes1))
    }

    // 2. ä½¿ç”¨ json.Unmarshal è§£ç 
    str := `{"name":"æå››","age":25}`
    // json.Unmarshal éœ€è¦å­—èŠ‚æ•°ç»„å‚æ•°, éœ€è¦æŠŠå­—ç¬¦ä¸²è½¬ä¸º []byte ç±»å‹
    bytes2 := []byte(str) // å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡
    var person2 Person    // ç”¨æ¥æ¥æ”¶è§£ç åçš„ç»“æœ
    if json.Unmarshal(bytes2, &person2) == nil {
        fmt.Println("json.Unmarshal è§£ç ç»“æœ: ", person2.Name, person2.Age)
    }

    // 3. ä½¿ç”¨ json.NewEncoder ç¼–ç 
    person3 := Person{"ç‹äº”", 30}
    // ç¼–ç ç»“æœæš‚å­˜åˆ° buffer(ä¸ºäº†å˜æˆ io.Writer)
    bytes3 := new(bytes.Buffer)
    err = json.NewEncoder(bytes3).Encode(person3)
    if err == nil {
        fmt.Print("json.NewEncoder ç¼–ç ç»“æœ: ", string(bytes3.Bytes()))
    }

    // 4. ä½¿ç”¨ json.NewDecoder è§£ç 
    str4 := `{"name":"èµµå…­","age":28}`
    var person4 Person
    // åˆ›å»ºä¸€ä¸ª string reader ä½œä¸ºå‚æ•°
    err = json.NewDecoder(strings.NewReader(str4)).Decode(&person4)
    if err == nil {
        fmt.Println("json.NewDecoder è§£ç ç»“æœ: ", person4.Name, person4.Age)
    }
}

//json.Marshal ç¼–ç ç»“æœ:  {"name":"å¼ ä¸‰","age":24}
//json.Unmarshal è§£ç ç»“æœ:  æå›› 25
//json.NewEncoder ç¼–ç ç»“æœ: {"name":"ç‹äº”","age":30}
//json.NewDecoder è§£ç ç»“æœ:  èµµå…­ 28
```





- å¯¹äº**jsonåŸç”Ÿå­—ç¬¦ä¸²**ï¼Œ**ååºåˆ—åŒ–åˆ°å¯¹è±¡**ï¼Œéœ€è¦ä½¿ç”¨ `json.Unmarshal()` å‡½æ•°ï¼ŒåŒæ—¶ï¼Œéœ€è¦ä¼ å…¥çš„æ˜¯åŸç”Ÿå­—ç¬¦ä¸²çš„å­—èŠ‚æ•°ç»„ï¼Œéœ€è¦è¿›è¡Œè½¬æ¢

```go
type Cat struct {
	Color string `json:"color"`
	Name  string `json:"name"`
}

type CatGroup struct {
	Cats  []Cat  `json:"cats"`
	Owner string `json:"owner"`
}

func main() {
	catsOfXiaoming := `{
		"cats" : [
			{"color":"é»„è‰²","name":"å°é»„çŒ«"},
			{"color":"èŠ±è‰²","name":"å°èŠ±çŒ«"}
		],
		"owner" : "å°æ˜"
	}`
	var cg CatGroup

	err := json.Unmarshal([]byte(catsOfXiaoming), &cg)
	if err != nil {
		log.Fatal("è§£ç å¤±è´¥")
	}
	fmt.Printf("%+v", cg)
}
```



- å¯¹äºå®ç°äº† `io.Reader` æ¥å£çš„å¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `json.NewDecoder()` è¿›è¡Œååºåˆ—åŒ–

```go
	catsOfXiaoming := `{
		"cats" : [
			{"color":"é»„è‰²","name":"å°é»„çŒ«"},
			{"color":"èŠ±è‰²","name":"å°èŠ±çŒ«"}
		],
		"owner" : "å°æ˜"
	}`
	var cg CatGroup
	
	json.NewDecoder(strings.NewReader(catsOfXiaoming)).Decode(&cg)
	fmt.Printf("%+v", cg)
```



## 3. io.Readerå’Œio.Writeræ¥å£

```go
type Writer interface {
  Write(p []byte) (n int, err error)
}
```

**Writeæ–¹æ³•**

- å°†å­—èŠ‚åˆ‡ç‰‡pé‡Œçš„ **len(p) å­—èŠ‚**çš„æ•°æ®å†™å…¥åˆ°**åº•å±‚æ•°æ®æµ**
- æ–¹æ³•è¿”å›ä»pé‡Œ**æˆåŠŸå†™å…¥åˆ°åº•å±‚æ•°æ®æµçš„å­—èŠ‚æ•°n (0<=n<=len(p)) **å’Œå¯èƒ½çš„é”™è¯¯error
- **å½“n<len(p)æ—¶ï¼Œå¿…é¡»è¿”å›ä¸€ä¸ªénilçš„error**

- ä¸ç®¡ä»€ä¹ˆæƒ…å†µéƒ½**ä¸èƒ½ä¿®æ”¹byteåˆ‡ç‰‡é‡Œçš„æ•°æ®**



```go
type Reader interface {
  Read(p []byte) (n int, err error)
}
```

**Readæ–¹æ³•**

- **æœ€å¤šè¯»å…¥len(p)å­—èŠ‚çš„æ•°æ®åˆ°åˆ‡ç‰‡pé‡Œ**
- æ–¹æ³•è¿”å›**æˆåŠŸè¯»å…¥çš„å­—èŠ‚æ•°n (0<=n<=len(p))** å’Œå¯èƒ½çš„é”™è¯¯error
- å¦‚æœ n<len(p) ï¼ŒReadä¼š**ç«‹å³è¿”å›å¯ç”¨çš„æ•°æ®**ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ›´å¤šçš„æ•°æ®
- n>0æ—¶ï¼Œé‡åˆ°é”™è¯¯ï¼Œæˆ–è€…è¯»å–å®Œæ¯•çš„æ—¶å€™ï¼ŒReadæ–¹æ³•å‡ä¼šè¿”å›æˆåŠŸè¯»å…¥çš„å­—èŠ‚æ•°ï¼Œ**è¯»å–å®Œæ¯•è¿”å›EOFé”™è¯¯**
- è°ƒç”¨è€…åœ¨è¿”å›çš„n>0çš„æ—¶å€™ï¼Œåº”è¯¥**å…ˆå¤„ç†è¯»å…¥çš„æ•°æ®ï¼Œå†å¤„ç†err**ï¼ŒEOFä¹Ÿè¦è¿™æ ·å¤„ç†
- ä¸è¦è¿”å›n=0çš„æ—¶å€™è¿”å›nilçš„é”™è¯¯,ä¹Ÿå°±æ˜¯è¯´ï¼Œæ²¡æœ‰è¯»åˆ°æ•°æ®çš„æ—¶å€™åº”è¯¥è¿”å›ä¸€ä¸ªé”™è¯¯



**åº”ç”¨çš„æ¡ˆä¾‹**

`bytes.Buffer` å’Œ `os.File` éƒ½å®ç°äº† `Writer` å’Œ `Reader` æ¥å£

```go
func main() {
	// bytes.Bufferå®ç°äº†io.Writeræ¥å£
	var b bytes.Buffer
	b.Write([]byte("Hello "))

	// ä½¿ç”¨Fprintfå°†ä¸€ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥åˆ°bufferé‡Œ
	fmt.Fprintf(&b, "World!")

	// å°†bufferè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º
	b.WriteTo(os.Stdout)
}
```

å‡ ä¸ªå‡½æ•°çš„è¯´æ˜

```go
func (b *Buffer) Write(p []byte) (n int, err error) {
	b.lastRead = opInvalid
	m, ok := b.tryGrowByReslice(len(p))
	if !ok {
		m = b.grow(len(p))     //ç¼“å†²åŒºä¼šè‡ªåŠ¨å¢å¤§
	}
	return copy(b.buf[m:], p), nil   //è¿½åŠ å†™
}

func Fprintf(w io.Writer, format string, a ...interface{}) (n int, err error) {...}

func (b *Buffer) WriteTo(w io.Writer) (n int64, err error) {...}
```

å…³äº `os.Stdout`

```go
var (
	Stdin  = NewFile(uintptr(syscall.Stdin), "/dev/stdin")
	Stdout = NewFile(uintptr(syscall.Stdout), "/dev/stdout")   //å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶
	Stderr = NewFile(uintptr(syscall.Stderr), "/dev/stderr")
)

func NewFile(fd uintptr, name string) *File {...}

func (f *File) Write(b []byte) (n int, err error) {  //Fileä¹Ÿå®ç°äº†io.Writeræ¥å£
	if err := f.checkValid("write"); err != nil {
		return 0, err
	}
	n, e := f.write(b)
	if n < 0 {
		n = 0
	}
	if n != len(b) {
		err = io.ErrShortWrite
	}

	epipecheck(f, e)

	if e != nil {
		err = f.wrapErr("write", e)
	}

	return n, err
}
```



## 4. jsonå’Œgobç¼–è§£ç 

```go
type MyInfo struct {
	S       string
	I, J, K int
}

type MyReadWriter struct {
	Buf *bytes.Buffer
}

func (m MyReadWriter) Write(p []byte) (n int, err error) {
	return m.Buf.Write(p)
}

func (m MyReadWriter) Read(p []byte) (n int, err error) {
	return m.Buf.Read(p)
}

func main() {
	ms := MyInfo{
		S: "aabbccdd",
		I: 1000,
		J: 200,
		K: 10,
	}
	s := MyReadWriter{
		Buf: new(bytes.Buffer),
	}
	var enc = gob.NewEncoder(s.Buf)    //éœ€è¦ä¸€ä¸ªwriterï¼Œå°†ç¼–ç ç»“æœå†™å…¥
	var dec = gob.NewDecoder(s.Buf)    //éœ€è¦ä¸€ä¸ªreaderï¼Œè¯»å–è§£ç ä¿¡æ¯
	if err := enc.Encode(&ms); err != nil {
		fmt.Println("encode error:", err)
	}
	fmt.Println("ç¼–ç åï¼š", s.Buf)
	var decMsg MyInfo
	dec.Decode(&decMsg)
	fmt.Println("è§£ç å¾—ï¼š", decMsg)

	var enc2 = json.NewEncoder(s.Buf)
	var dec2 = json.NewDecoder(s.Buf)
	if err := enc2.Encode(&ms); err != nil {
		fmt.Println("encode error:", err)
	}
	fmt.Println("ç¼–ç åï¼š", s.Buf)
	var decMsg2 MyInfo
	dec2.Decode(&decMsg2)
	fmt.Println("è§£ç å¾—ï¼š", decMsg2)
}
```



## 5. Context

`Context` æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº† 4 ä¸ªæ–¹æ³•ï¼Œå®ƒä»¬éƒ½æ˜¯`å¹‚ç­‰`çš„ã€‚ä¹Ÿå°±æ˜¯è¯´è¿ç»­å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªæ–¹æ³•ï¼Œå¾—åˆ°çš„ç»“æœéƒ½æ˜¯ç›¸åŒçš„ã€‚

```go
type Context interface {
    // å½“ context è¢«å–æ¶ˆæˆ–è€…åˆ°äº† deadlineï¼Œè¿”å›ä¸€ä¸ªè¢«å…³é—­çš„ channel
    Done() <-chan struct{}
    // åœ¨ channel Done å…³é—­åï¼Œè¿”å› context å–æ¶ˆåŸå› 
    Err() error
    // è¿”å› context æ˜¯å¦ä¼šè¢«å–æ¶ˆä»¥åŠè‡ªåŠ¨å–æ¶ˆæ—¶é—´ï¼ˆå³ deadlineï¼‰
    Deadline() (deadline time.Time, ok bool)
    // è·å– key å¯¹åº”çš„ value
    Value(key interface{}) interface{}
}
```

- `Done()` è¿”å›ä¸€ä¸ª channelï¼Œå¯ä»¥è¡¨ç¤º context è¢«å–æ¶ˆçš„ä¿¡å·ï¼šå½“è¿™ä¸ª channel è¢«å…³é—­æ—¶ï¼Œè¯´æ˜ context è¢«å–æ¶ˆäº†ã€‚æ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªåªè¯»çš„channelã€‚ æˆ‘ä»¬åˆçŸ¥é“ï¼Œè¯»ä¸€ä¸ªå…³é—­çš„ channel ä¼šè¯»å‡ºç›¸åº”ç±»å‹çš„é›¶å€¼ã€‚å¹¶ä¸”æºç é‡Œæ²¡æœ‰åœ°æ–¹ä¼šå‘è¿™ä¸ª channel é‡Œé¢å¡å…¥å€¼ã€‚æ¢å¥è¯è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ª `receive-only` çš„ channelã€‚å› æ­¤åœ¨å­åç¨‹é‡Œè¯»è¿™ä¸ª channelï¼Œé™¤éè¢«å…³é—­ï¼Œå¦åˆ™è¯»ä¸å‡ºæ¥ä»»ä½•ä¸œè¥¿ã€‚ä¹Ÿæ­£æ˜¯åˆ©ç”¨äº†è¿™ä¸€ç‚¹ï¼Œå­åç¨‹ä» channel é‡Œè¯»å‡ºäº†å€¼ï¼ˆé›¶å€¼ï¼‰åï¼Œå°±å¯ä»¥åšä¸€äº›æ”¶å°¾å·¥ä½œï¼Œå°½å¿«é€€å‡ºã€‚

- `Err()` è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œè¡¨ç¤º channel è¢«å…³é—­çš„åŸå› ã€‚ä¾‹å¦‚æ˜¯è¢«å–æ¶ˆï¼Œè¿˜æ˜¯è¶…æ—¶ã€‚

- `Deadline()` è¿”å› context çš„æˆªæ­¢æ—¶é—´ï¼Œé€šè¿‡æ­¤æ—¶é—´ï¼Œå‡½æ•°å°±å¯ä»¥å†³å®šæ˜¯å¦è¿›è¡Œæ¥ä¸‹æ¥çš„æ“ä½œï¼Œå¦‚æœæ—¶é—´å¤ªçŸ­ï¼Œå°±å¯ä»¥ä¸å¾€ä¸‹åšäº†ï¼Œå¦åˆ™æµªè´¹ç³»ç»Ÿèµ„æºã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç”¨è¿™ä¸ª deadline æ¥è®¾ç½®ä¸€ä¸ª I/O æ“ä½œçš„è¶…æ—¶æ—¶é—´ã€‚

- `Value()` è·å–ä¹‹å‰è®¾ç½®çš„ key å¯¹åº”çš„ valueã€‚

### Contextçš„ä½œç”¨

åœ¨ Go çš„ server é‡Œï¼Œé€šå¸¸æ¯æ¥ä¸€ä¸ªè¯·æ±‚éƒ½ä¼šå¯åŠ¨è‹¥å¹²ä¸ª goroutine åŒæ—¶å·¥ä½œï¼šæœ‰äº›å»æ•°æ®åº“æ‹¿æ•°æ®ï¼Œæœ‰äº›è°ƒç”¨ä¸‹æ¸¸æ¥å£è·å–ç›¸å…³æ•°æ®â€¦â€¦

![request](picture/goè¯­è¨€è¦ç‚¹/e5e80e875d3484ec90d14165cf40f861.png)

è¿™äº› goroutine éœ€è¦å…±äº«è¿™ä¸ªè¯·æ±‚çš„åŸºæœ¬æ•°æ®ï¼Œä¾‹å¦‚ç™»é™†çš„ tokenï¼Œå¤„ç†è¯·æ±‚çš„æœ€å¤§è¶…æ—¶æ—¶é—´ï¼ˆå¦‚æœè¶…è¿‡æ­¤å€¼å†è¿”å›æ•°æ®ï¼Œè¯·æ±‚æ–¹å› ä¸ºè¶…æ—¶æ¥æ”¶ä¸åˆ°ï¼‰ç­‰ç­‰ã€‚å½“è¯·æ±‚è¢«å–æ¶ˆæˆ–æ˜¯å¤„ç†æ—¶é—´å¤ªé•¿ï¼Œè¿™æœ‰å¯èƒ½æ˜¯ä½¿ç”¨è€…å…³é—­äº†æµè§ˆå™¨æˆ–æ˜¯å·²ç»è¶…è¿‡äº†è¯·æ±‚æ–¹è§„å®šçš„è¶…æ—¶æ—¶é—´ï¼Œè¯·æ±‚æ–¹ç›´æ¥æ”¾å¼ƒäº†è¿™æ¬¡è¯·æ±‚ç»“æœã€‚è¿™æ—¶ï¼Œæ‰€æœ‰æ­£åœ¨ä¸ºè¿™ä¸ªè¯·æ±‚å·¥ä½œçš„ goroutine éœ€è¦å¿«é€Ÿé€€å‡ºï¼Œå› ä¸ºå®ƒä»¬çš„â€œå·¥ä½œæˆæœâ€ä¸å†è¢«éœ€è¦äº†ã€‚åœ¨ç›¸å…³è”çš„ goroutine éƒ½é€€å‡ºåï¼Œç³»ç»Ÿå°±å¯ä»¥å›æ”¶ç›¸å…³çš„èµ„æºã€‚

context åŒ…å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šé¢æ‰€è¯´çš„è¿™äº›é—®é¢˜è€Œå¼€å‘çš„ï¼šåœ¨ ä¸€ç»„ goroutine ä¹‹é—´ä¼ é€’å…±äº«çš„å€¼ã€å–æ¶ˆä¿¡å·ã€deadlineâ€¦â€¦

![img](picture/goè¯­è¨€è¦ç‚¹/6d1b552b07ca2769a50c31a9446e3afa.png)



**ä¼ é€’å…±äº«çš„æ•°æ®ï¼š**

å¯¹äº Web æœåŠ¡ç«¯å¼€å‘ï¼Œå¾€å¾€å¸Œæœ›å°†ä¸€ä¸ªè¯·æ±‚å¤„ç†çš„æ•´ä¸ªè¿‡ç¨‹ä¸²èµ·æ¥ï¼Œè¿™å°±éå¸¸ä¾èµ–äº Thread Localï¼ˆå¯¹äº Go å¯ç†è§£ä¸ºå•ä¸ªåç¨‹æ‰€ç‹¬æœ‰ï¼‰ çš„å˜é‡ï¼Œè€Œåœ¨ Go è¯­è¨€ä¸­å¹¶æ²¡æœ‰è¿™ä¸ªæ¦‚å¿µï¼Œå› æ­¤éœ€è¦åœ¨å‡½æ•°è°ƒç”¨çš„æ—¶å€™ä¼ é€’ contextã€‚



**å–æ¶ˆgoroutineï¼š**

å¦‚æœéœ€è¦å®ç°â€œå–æ¶ˆâ€åŠŸèƒ½ï¼Œå¹¶ä¸”åœ¨ä¸äº†è§£ context åŠŸèƒ½çš„å‰æä¸‹ï¼Œå¯èƒ½ä¼šè¿™æ ·åšï¼šç»™å‡½æ•°å¢åŠ ä¸€ä¸ªæŒ‡é’ˆå‹çš„ bool å˜é‡ï¼Œåœ¨ for è¯­å¥çš„å¼€å§‹å¤„åˆ¤æ–­ bool å˜é‡æ˜¯å¦ç”± true å˜ä¸º falseï¼Œå¦‚æœæ”¹å˜ï¼Œåˆ™é€€å‡ºå¾ªç¯

ä¸Šé¢ç»™å‡ºçš„ç®€å•åšæ³•ï¼Œå¯ä»¥å®ç°æƒ³è¦çš„æ•ˆæœï¼Œæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¹¶ä¸ä¼˜é›…ï¼Œå¹¶ä¸”ä¸€æ—¦åç¨‹æ•°é‡å¤šäº†ä¹‹åï¼Œå¹¶ä¸”å„ç§åµŒå¥—ï¼Œå°±ä¼šå¾ˆéº»çƒ¦ã€‚ä¼˜é›…çš„åšæ³•ï¼Œè‡ªç„¶å°±è¦ç”¨åˆ° contextã€‚

```go
func main(){
    ctx, cancel := context.WithTimeout(context.Background(), time.Hour)
    go Perform(ctx)
    // â€¦â€¦
    // app ç«¯è¿”å›é¡µé¢ï¼Œè°ƒç”¨cancel å‡½æ•°
    cancel()
}

func Perform(ctx context.Context) {
    for {
        calculatePos()
        sendResult()
        select {
        case <-ctx.Done():
            // è¢«å–æ¶ˆï¼Œç›´æ¥è¿”å›
            return
        case <-time.After(time.Second):
            // block 1 ç§’é’Ÿ 
        }
    }
}
```



### Context.Valueçš„æŸ¥æ‰¾è¿‡ç¨‹

é€šè¿‡å±‚å±‚ä¼ é€’ contextï¼Œæœ€ç»ˆå½¢æˆè¿™æ ·ä¸€æ£µæ ‘ï¼š

![img](picture/goè¯­è¨€è¦ç‚¹/c76997f2936b84c36848f9ac7efb020f.png)



å’Œé“¾è¡¨æœ‰ç‚¹åƒï¼Œåªæ˜¯å®ƒçš„æ–¹å‘ç›¸åï¼šContext æŒ‡å‘å®ƒçš„çˆ¶èŠ‚ç‚¹ï¼Œé“¾è¡¨åˆ™æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚é€šè¿‡ WithValue å‡½æ•°ï¼Œå¯ä»¥åˆ›å»ºå±‚å±‚çš„ valueCtxï¼Œå­˜å‚¨ goroutine é—´å¯ä»¥å…±äº«çš„å˜é‡ã€‚

å–å€¼çš„è¿‡ç¨‹ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªé€’å½’æŸ¥æ‰¾çš„è¿‡ç¨‹ï¼š

```go
func (c *valueCtx) Value(key interface{}) interface{} {
    if c.key == key {
        return c.val
    }
    return c.Context.Value(key)
}
```



# åäºŒã€ IO

Go åŸºäº I/O multiplexing å’Œ goroutine scheduler æ„å»ºäº†ä¸€ä¸ªç®€æ´è€Œé«˜æ€§èƒ½çš„åŸç”Ÿç½‘ç»œæ¨¡å‹(åŸºäº Go çš„ I/O å¤šè·¯å¤ç”¨ `netpoller` )ï¼Œæä¾›äº† `goroutine-per-connection` è¿™æ ·ç®€å•çš„ç½‘ç»œç¼–ç¨‹æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¼€å‘è€… **ä½¿ç”¨çš„æ˜¯åŒæ­¥çš„æ¨¡å¼å»ç¼–å†™å¼‚æ­¥çš„é€»è¾‘**ï¼Œæå¤§åœ°é™ä½äº†å¼€å‘è€…ç¼–å†™ç½‘ç»œåº”ç”¨æ—¶çš„è´Ÿæ‹…ï¼Œä¸”å€ŸåŠ©äº Go runtime scheduler å¯¹ goroutines çš„é«˜æ•ˆè°ƒåº¦ï¼Œè¿™ä¸ªåŸç”Ÿç½‘ç»œæ¨¡å‹ä¸è®ºä»é€‚ç”¨æ€§è¿˜æ˜¯æ€§èƒ½ä¸Šéƒ½è¶³ä»¥æ»¡è¶³ç»å¤§éƒ¨åˆ†çš„åº”ç”¨åœºæ™¯ã€‚

äº‹å®ä¸Š `Go netpoller` åº•å±‚å°±æ˜¯åŸºäº `epoll(Linux)`/kqueue(freeBSD)/iocp(Windows) è¿™äº› I/O å¤šè·¯å¤ç”¨æŠ€æœ¯æ¥åšå°è£…çš„ï¼Œæœ€ç»ˆæš´éœ²å‡º `goroutine-per-connection` è¿™æ ·çš„æç®€çš„å¼€å‘æ¨¡å¼ç»™ä½¿ç”¨è€…



IOå¤šè·¯å¤ç”¨ï¼šæ‰€è°“ I/O å¤šè·¯å¤ç”¨æŒ‡çš„å°±æ˜¯ `select/poll/epoll` è¿™ä¸€ç³»åˆ—çš„å¤šè·¯é€‰æ‹©å™¨ï¼šæ”¯æŒ **å•ä¸€çº¿ç¨‹åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦**ï¼ˆI/O äº‹ä»¶ï¼‰ï¼Œé˜»å¡ç­‰å¾…ï¼Œå¹¶åœ¨å…¶ä¸­æŸä¸ªæ–‡ä»¶æè¿°ç¬¦å¯è¯»å†™æ—¶æ”¶åˆ°é€šçŸ¥ã€‚ I/O å¤ç”¨å…¶å®å¤ç”¨çš„ä¸æ˜¯ I/O è¿æ¥ï¼Œè€Œæ˜¯å¤ç”¨çº¿ç¨‹ï¼Œè®©ä¸€ä¸ª thread of control èƒ½å¤Ÿå¤„ç†å¤šä¸ªè¿æ¥ï¼ˆI/O äº‹ä»¶ï¼‰



## 1. åŸºæœ¬åŸç†

> Go netpoller é€šè¿‡åœ¨åº•å±‚å¯¹ `epoll/kqueue/iocp` çš„å°è£…ï¼Œä»è€Œå®ç°äº†ä½¿ç”¨ **åŒæ­¥ç¼–ç¨‹æ¨¡å¼è¾¾åˆ°å¼‚æ­¥æ‰§è¡Œçš„æ•ˆæœ**ã€‚
>
> æ€»ç»“æ¥è¯´ï¼Œæ‰€æœ‰çš„ç½‘ç»œæ“ä½œéƒ½ä»¥ç½‘ç»œæè¿°ç¬¦ netFD ä¸ºä¸­å¿ƒå®ç°ã€‚netFD ä¸åº•å±‚ PollDesc ç»“æ„ç»‘å®š
>
> å½“åœ¨ä¸€ä¸ª netFD ä¸Šè¯»å†™é‡åˆ° EAGAIN é”™è¯¯æ—¶ï¼Œå°± **å°†å½“å‰ goroutine å­˜å‚¨åˆ°è¿™ä¸ª netFD å¯¹åº”çš„ PollDesc ä¸­ï¼ŒåŒæ—¶è°ƒç”¨ gopark æŠŠå½“å‰ goroutine ç»™ park ä½**ï¼Œç›´åˆ°è¿™ä¸ª netFD ä¸Šå†æ¬¡å‘ç”Ÿè¯»å†™äº‹ä»¶ï¼Œæ‰å°†æ­¤ goroutine ç»™ ready æ¿€æ´»é‡æ–°è¿è¡Œã€‚æ˜¾ç„¶ï¼Œåœ¨åº•å±‚é€šçŸ¥ goroutine å†æ¬¡å‘ç”Ÿè¯»å†™ç­‰äº‹ä»¶çš„æ–¹å¼å°±æ˜¯ epoll/kqueue/iocp ç­‰äº‹ä»¶é©±åŠ¨æœºåˆ¶ã€‚



## 2. æ•°æ®ç»“æ„

### netFD å’Œ poll.FD

```go
// Network file descriptor.
type netFD struct {
    pfd poll.FD

    // immutable until Close
    family      int
    sotype      int
    isConnected bool // handshake completed or use of association with peer
    net         string
    laddr       Addr  // è¿æ¥çš„ä¸¤ä¸ªåœ°å€
    raddr       Addr
}

// FD æ˜¯æ–‡ä»¶æè¿°ç¬¦çš„ç»“æ„ä½“
type FD struct {
    // Lock sysfd and serialize access to Read and Write methods.
    fdmu fdMutex

    // System file descriptor. Immutable until Close.
    Sysfd int

    // I/O poller.
    pd pollDesc

    // Writev cache.
    iovecs *[]syscall.Iovec

    // Semaphore signaled when file is closed.
    csema uint32

    // Non-zero if this file has been set to blocking mode.
    isBlocking uint32

    // Whether this is a streaming descriptor, as opposed to a
    // packet-based descriptor like a UDP socket. Immutable.
    IsStream bool

    // Whether a zero byte read indicates EOF. This is false for a
    // message based socket connection.
    ZeroReadIsEOF bool

    // Whether this is a file rather than a network socket.
    isFile bool
}
```



### pollDesc

pollDesc æ˜¯åº•å±‚ **äº‹ä»¶é©±åŠ¨** çš„å°è£…ï¼Œ`netFD` é€šè¿‡å®ƒæ¥å®Œæˆå„ç§IOç›¸å…³çš„æ“ä½œï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```go
type pollDesc struct {
    runtimeCtx uintptr
}

// å…·ä½“å®šä¹‰åœ¨runtime.pollDesc
type pollDesc struct {
    link *pollDesc // in pollcache, protected by pollcache.lock

    // The lock protects pollOpen, pollSetDeadline, pollUnblock and deadlineimpl operations.
    // This fully covers seq, rt and wt variables. fd is constant throughout the PollDesc lifetime.
    // pollReset, pollWait, pollWaitCanceled and runtimeÂ·netpollready (IO readiness notification)
    // proceed w/o taking the lock. So closing, everr, rg, rd, wg and wd are manipulated
    // in a lock-free way by all operations.
    // NOTE(dvyukov): the following code uses uintptr to store *g (rg/wg),
    // that will blow up when GC starts moving objects.
    lock    mutex // protects the following fields
    fd      uintptr
    closing bool
    everr   bool    // marks event scanning error happened
    user    uint32  // user settable cookie
    rseq    uintptr // protects from stale read timers
    rg      uintptr // pdReady, pdWait, G waiting for read or nil
    rt      timer   // read deadline timer (set if rt.f != nil)
    rd      int64   // read deadline
    wseq    uintptr // protects from stale write timers
    wg      uintptr // pdReady, pdWait, G waiting for write or nil
    wt      timer   // write deadline timer
    wd      int64   // write deadline
}
```

å…¶ä¸­ `rg` å’Œ `wg`ï¼Œæ˜¯ä¸¤ä¸ªä¸‡èƒ½æŒ‡é’ˆï¼Œå–å€¼åˆ†åˆ«æ˜¯ `pdReady, pdWait, ç­‰å¾…fdå°±ç»ªçš„ gï¼Œ nil ç­‰`ï¼Œä»–ä»¬æ˜¯å®ç°å”¤é†’ goroutine çš„å…³é”®

`runtime.pollDesc` åŒ…å«è‡ªèº«ç±»å‹çš„æŒ‡é’ˆ `link` ï¼Œç”¨æ¥ä¿å­˜ä¸‹ä¸€ä¸ª runtime.pollDesc çš„åœ°å€ï¼Œå®ç°é“¾è¡¨

æ‰€æœ‰çš„ runtime.pollDesc ä¿å­˜åœ¨ `runtime.pollCache` ç»“æ„ä½“ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```go
type pollCache struct {
   lock  mutex
   first *pollDesc
   // PollDesc objects must be type-stable,
   // because we can get ready notification from epoll/kqueue
   // after the descriptor is closed/reused.
   // Stale notifications are detected using seq variable,
   // seq is incremented when deadlines are changed or descriptor is reused.
}
```

runtime.pollCache æ˜¯ä¸€ä¸ªåœ¨ runtime åŒ…ä¸­çš„å…¨å±€å˜é‡ï¼Œç”¨äºç¼“å­˜

Go runtime ä¼šåœ¨è°ƒç”¨ `poll_runtime_pollOpen` å¾€ epoll å®ä¾‹æ³¨å†Œ fd ä¹‹æ—¶é¦–æ¬¡è°ƒç”¨ `runtime.pollCache.alloc`æ–¹æ³•æ—¶æ‰¹é‡åˆå§‹åŒ–å¤§å° 4KB çš„ `runtime.pollDesc` ç»“æ„ä½“çš„é“¾è¡¨ï¼Œåˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ `runtime.persistentalloc` æ¥ä¸ºè¿™äº›æ•°æ®ç»“æ„åˆ†é…ä¸ä¼šè¢« GC å›æ”¶çš„å†…å­˜ï¼Œç¡®ä¿è¿™äº›æ•°æ®ç»“æ„åªèƒ½è¢« `epoll`å’Œ`kqueue` åœ¨å†…æ ¸ç©ºé—´å»å¼•ç”¨ã€‚

å†å¾€åæ¯æ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•åˆ™ä¼šå…ˆåˆ¤æ–­é“¾è¡¨å¤´æ˜¯å¦å·²ç»åˆ†é…è¿‡å€¼äº†ï¼Œè‹¥æ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›è¡¨å¤´è¿™ä¸ª `pollDesc`ï¼Œè¿™ç§æ‰¹é‡åˆå§‹åŒ–æ•°æ®è¿›è¡Œç¼“å­˜è€Œåæ¯æ¬¡éƒ½ç›´æ¥ä»ç¼“å­˜å–æ•°æ®çš„æ–¹å¼æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼Œåœ¨è¿™é‡Œè¿™ç§æ–¹å¼å¯ä»¥æœ‰æ•ˆåœ°æå‡ netpoller çš„ååé‡ã€‚



## 3. åŸç†è§£æ

[ä»æºä»£ç è§’åº¦çœ‹epollåœ¨Goä¸­çš„ä½¿ç”¨ï¼ˆä¸€ï¼‰](https://segmentfault.com/a/1190000021812996)

[Go netpoller åŸç”Ÿç½‘ç»œæ¨¡å‹ä¹‹æºç å…¨é¢æ­ç§˜ - SegmentFault æ€å¦](https://segmentfault.com/a/1190000038690758?utm_source=sf-similar-article)



### é˜»å¡

é‡ç‚¹çœ‹ä»¥ä¸‹ FD çš„ readï¼š

é€šè¿‡ç±»ä¼¼ `pollDesc.waitRead` çš„ `pollDesc.waitWrite` æ¥ park ä½ goroutine ç›´è‡³æœŸå¾…çš„ I/O äº‹ä»¶å‘ç”Ÿæ‰è¿”å›æ¢å¤æ‰§è¡Œ

```go
func (fd *FD) Read(p []byte) (int, error) {
    if err := fd.readLock(); err != nil {
        return 0, err
    }
    defer fd.readUnlock()
    if len(p) == 0 {
        return 0, nil
    }
    if err := fd.pd.prepareRead(fd.isFile); err != nil {
        return 0, err
    }
    if fd.IsStream && len(p) > maxRW {
        p = p[:maxRW]
    }
    for {
        // å°è¯•ä»è¯¥ socket è¯»å–æ•°æ®ï¼Œå› ä¸º socket åœ¨è¢« listener accept çš„æ—¶å€™è®¾ç½®æˆ
        // äº†éé˜»å¡ I/Oï¼Œæ‰€ä»¥è¿™é‡ŒåŒæ ·ä¹Ÿæ˜¯ç›´æ¥è¿”å›ï¼Œä¸ç®¡æœ‰æ²¡æœ‰å¯è¯»çš„æ•°æ®
        n, err := syscall.Read(fd.Sysfd, p)
        if err != nil {
            n = 0
            // err == syscall.EAGAIN è¡¨ç¤ºå½“å‰æ²¡æœ‰æœŸå¾…çš„ I/O äº‹ä»¶å‘ç”Ÿï¼Œä¹Ÿå°±æ˜¯ socket ä¸å¯è¯»
            if err == syscall.EAGAIN && fd.pd.pollable() {
                // å¦‚æœå½“å‰æ²¡æœ‰å‘ç”ŸæœŸå¾…çš„ I/O äº‹ä»¶ï¼Œé‚£ä¹ˆ waitRead 
                // ä¼šé€šè¿‡ park goroutine è®©é€»è¾‘ block åœ¨è¿™é‡Œ
                if err = fd.pd.waitRead(fd.isFile); err == nil {
                    continue
                }
            }

            // On MacOS we can see EINTR here if the user
            // pressed ^Z.  See issue #22838.
            if runtime.GOOS == "darwin" && err == syscall.EINTR {
                continue
            }
        }
        err = fd.eofError(n, err)
        return n, err
    }
}
```

`pollDesc.waitRead` å†…éƒ¨è°ƒç”¨äº† `poll.runtime_pollWait` --> `runtime.poll_runtime_pollWait` æ¥è¾¾æˆæ—  I/O äº‹ä»¶æ—¶ park ä½ goroutine çš„ç›®çš„ï¼š

```go
func poll_runtime_pollWait(pd *pollDesc, mode int) int {
    ...
    // è¿›å…¥ netpollblock å¹¶ä¸”åˆ¤æ–­æ˜¯å¦æœ‰æœŸå¾…çš„ I/O äº‹ä»¶å‘ç”Ÿï¼Œè¿™é‡Œçš„ for å¾ªç¯æ˜¯ä¸ºäº†ä¸€ç›´ç­‰åˆ° io ready
    for !netpollblock(pd, int32(mode), false) {
        err = netpollcheckerr(pd, int32(mode))
        if err != 0 {
            return err
        }
    }
    return 0
}

func netpollblock(pd *pollDesc, mode int32, waitio bool) bool {
    // gpp ä¿å­˜çš„æ˜¯ goroutine çš„æ•°æ®ç»“æ„ gï¼Œè¿™é‡Œä¼šæ ¹æ® mode çš„å€¼å†³å®šæ˜¯ rg è¿˜æ˜¯ wgï¼Œ
  // å‰é¢æåˆ°è¿‡ï¼Œrg å’Œ wg æ˜¯ç”¨æ¥ä¿å­˜ç­‰å¾… I/O å°±ç»ªçš„ gorouine çš„ï¼Œåé¢è°ƒç”¨ gopark ä¹‹åï¼Œ
  // ä¼šæŠŠå½“å‰çš„ goroutine çš„æŠ½è±¡æ•°æ®ç»“æ„ g å­˜å…¥ gpp è¿™ä¸ªæŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ rg æˆ–è€… wg
    gpp := &pd.rg
    if mode == 'w' {
        gpp = &pd.wg
    }

    // è¿™ä¸ª for å¾ªç¯æ˜¯ä¸ºäº†ç­‰å¾… io ready æˆ–è€… io wait
    for {
        old := *gpp
        // gpp == pdReady è¡¨ç¤ºæ­¤æ—¶å·²æœ‰æœŸå¾…çš„ I/O äº‹ä»¶å‘ç”Ÿï¼Œ
        // å¯ä»¥ç›´æ¥è¿”å› unblock å½“å‰ goroutine å¹¶æ‰§è¡Œå“åº”çš„ I/O æ“ä½œ
        if old == pdReady {
            *gpp = 0
            return true
        }
        if old != 0 {
            throw("runtime: double wait")
        }
        // å¦‚æœæ²¡æœ‰æœŸå¾…çš„ I/O äº‹ä»¶å‘ç”Ÿï¼Œåˆ™é€šè¿‡åŸå­æ“ä½œæŠŠ gpp çš„å€¼ç½®ä¸º pdWait å¹¶é€€å‡º for å¾ªç¯
        if atomic.Casuintptr(gpp, 0, pdWait) {
            break
        }
    }
    
    // waitio æ­¤æ—¶æ˜¯ falseï¼Œnetpollcheckerr æ–¹æ³•ä¼šæ£€æŸ¥å½“å‰ pollDesc å¯¹åº”çš„ fd æ˜¯å¦æ˜¯æ­£å¸¸çš„ï¼Œ
    // é€šå¸¸æ¥è¯´  netpollcheckerr(pd, mode) == 0 æ˜¯æˆç«‹çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæ‰§è¡Œ gopark 
    // æŠŠå½“å‰ goroutine ç»™ park ä½ï¼Œç›´è‡³å¯¹åº”çš„ fd ä¸Šå‘ç”Ÿå¯è¯»/å¯å†™æˆ–è€…å…¶ä»–ã€æœŸå¾…çš„ã€I/O äº‹ä»¶ä¸ºæ­¢ï¼Œ
    // ç„¶å unpark è¿”å›ï¼Œåœ¨ gopark å†…éƒ¨ä¼šæŠŠå½“å‰ goroutine çš„æŠ½è±¡æ•°æ®ç»“æ„ g å­˜å…¥
    // gpp(pollDesc.rg/pollDesc.wg) æŒ‡é’ˆé‡Œï¼Œä»¥ä¾¿åœ¨åé¢çš„ netpoll å‡½æ•°å–å‡º pollDesc ä¹‹åï¼Œ
    // æŠŠ g æ·»åŠ åˆ°é“¾è¡¨é‡Œè¿”å›ï¼Œæ¥ç€é‡æ–°è°ƒåº¦ goroutine
    if waitio || netpollcheckerr(pd, mode) == 0 {
        // æ³¨å†Œ netpollblockcommit å›è°ƒç»™ goparkï¼Œåœ¨ gopark å†…éƒ¨ä¼šæ‰§è¡Œå®ƒï¼Œä¿å­˜å½“å‰ goroutine åˆ° gpp
        gopark(netpollblockcommit, unsafe.Pointer(gpp), waitReasonIOWait, traceEvGoBlockNet, 5)
    }
    old := atomic.Xchguintptr(gpp, 0)
    if old > pdWait {
        throw("runtime: corrupted polldesc")
    }
    return old == pdReady
}
```



### å”¤é†’

> é¦–å…ˆï¼Œclient è¿æ¥ server çš„æ—¶å€™ï¼Œlistener é€šè¿‡ accept è°ƒç”¨æ¥æ”¶æ–° connection
>
> æ¯ä¸€ä¸ªæ–° connection éƒ½å¯åŠ¨ä¸€ä¸ª goroutine å¤„ç†ï¼Œaccept è°ƒç”¨ä¼šæŠŠè¯¥ connection çš„ fd è¿å¸¦æ‰€åœ¨çš„ goroutine ä¸Šä¸‹æ–‡ä¿¡æ¯å°è£…æ³¨å†Œåˆ° epoll çš„ç›‘å¬åˆ—è¡¨é‡Œå»
>
> å½“ goroutine è°ƒç”¨ `conn.Read` æˆ–è€… `conn.Write` ç­‰éœ€è¦é˜»å¡ç­‰å¾…çš„å‡½æ•°æ—¶ï¼Œä¼šè¢« `gopark` ç»™å°å­˜èµ·æ¥å¹¶ä½¿ä¹‹ä¼‘çœ ï¼Œè®© P å»æ‰§è¡Œæœ¬åœ°è°ƒåº¦é˜Ÿåˆ—é‡Œçš„ä¸‹ä¸€ä¸ªå¯æ‰§è¡Œçš„ goroutine
>
> å¾€å Go scheduler ä¼šåœ¨å¾ªç¯è°ƒåº¦çš„ `runtime.schedule()` å‡½æ•°ä»¥åŠ sysmon ç›‘æ§çº¿ç¨‹ä¸­è°ƒç”¨ `runtime.nepoll` ä»¥è·å–å¯è¿è¡Œçš„ goroutine åˆ—è¡¨å¹¶é€šè¿‡è°ƒç”¨ injectglist æŠŠå‰©ä¸‹çš„ g æ”¾å…¥å…¨å±€è°ƒåº¦é˜Ÿåˆ—æˆ–è€…å½“å‰ P æœ¬åœ°è°ƒåº¦é˜Ÿåˆ—å»é‡æ–°æ‰§è¡Œ

![netpoll](picture/goè¯­è¨€è¦ç‚¹/netpoll.png)



é‚£ä¹ˆå½“ I/O äº‹ä»¶å‘ç”Ÿä¹‹åï¼Œnetpoller æ˜¯é€šè¿‡ä»€ä¹ˆæ–¹å¼å”¤é†’é‚£äº›åœ¨ I/O wait çš„ goroutine çš„ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡ `runtime.netpoll`ã€‚

`runtime.netpoll` çš„æ ¸å¿ƒé€»è¾‘æ˜¯ï¼š

1. æ ¹æ®è°ƒç”¨æ–¹çš„å…¥å‚ delayï¼Œè®¾ç½®å¯¹åº”çš„è°ƒç”¨ `epollwait` çš„ timeout å€¼ï¼›
2. è°ƒç”¨ `epollwait` ç­‰å¾…å‘ç”Ÿäº†å¯è¯»/å¯å†™äº‹ä»¶çš„ fdï¼›
3. å¾ªç¯ `epollwait` è¿”å›çš„äº‹ä»¶åˆ—è¡¨ï¼Œå¤„ç†å¯¹åº”çš„äº‹ä»¶ç±»å‹ï¼Œ **ç»„è£…å¯è¿è¡Œçš„ goroutine é“¾è¡¨å¹¶è¿”å›**ã€‚

æ¥ä¸‹æ¥å°†å°±ç»ªçš„ goroutine é€šè¿‡è°ƒç”¨ `injectglist` åŠ å…¥åˆ°å…¨å±€è°ƒåº¦é˜Ÿåˆ—æˆ–è€… P çš„æœ¬åœ°è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œå¯åŠ¨ M ç»‘å®š P å»æ‰§è¡Œã€‚

Go scheduler çš„æ ¸å¿ƒæ–¹æ³• `runtime.schedule()` é‡Œä¼šè°ƒç”¨ä¸€ä¸ªå« `runtime.findrunable()` çš„æ–¹æ³•è·å–å¯è¿è¡Œçš„ goroutine æ¥æ‰§è¡Œï¼Œè€Œåœ¨ `runtime.findrunable()` æ–¹æ³•é‡Œå°±è°ƒç”¨äº† `runtime.netpoll` è·å–å·²å°±ç»ªçš„ fd åˆ—è¡¨å¯¹åº”çš„ goroutine åˆ—è¡¨

```go
func netpoll(delay int64) gList {
    ...
retry:
    // epollwait è¶…æ—¶ç­‰å¾…å°±ç»ªçš„ fd è¯»å†™äº‹ä»¶
    n := epollwait(epfd, &events[0], int32(len(events)), waitms)
    if n < 0 {
        ...
        goto retry
    }

    // toRun æ˜¯ä¸€ä¸ª g çš„é“¾è¡¨ï¼Œå­˜å‚¨è¦æ¢å¤çš„ goroutinesï¼Œæœ€åè¿”å›ç»™è°ƒç”¨æ–¹
    var toRun gList
    for i := int32(0); i < n; i++ {
        ev := &events[i]   // æ‹¿åˆ° events æ•°ç»„
        ...

        // Go scheduler åœ¨è°ƒç”¨ findrunnable() å¯»æ‰¾ goroutine å»æ‰§è¡Œçš„æ—¶å€™ï¼Œ
        // åœ¨è°ƒç”¨ netpoll ä¹‹æ—¶ä¼šæ£€æŸ¥å½“å‰æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹åŒæ­¥é˜»å¡åœ¨ netpollï¼Œ
        // è‹¥æ˜¯ï¼Œåˆ™è°ƒç”¨ netpollBreak æ¥å”¤é†’é‚£ä¸ªçº¿ç¨‹ï¼Œé¿å…å®ƒé•¿æ—¶é—´é˜»å¡
        if *(**uintptr)(unsafe.Pointer(&ev.data)) == &netpollBreakRd {
            ...
            if delay != 0 {
                var tmp [16]byte
                read(int32(netpollBreakRd), noescape(unsafe.Pointer(&tmp[0])), int32(len(tmp)))
                atomic.Store(&netpollWakeSig, 0)
            }
            continue
        }

        // åˆ¤æ–­å‘ç”Ÿçš„äº‹ä»¶ç±»å‹ï¼Œè¯»ç±»å‹æˆ–è€…å†™ç±»å‹ç­‰ï¼Œç„¶åç»™ mode å¤åˆ¶ç›¸åº”çš„å€¼ï¼Œ
    	// mode ç”¨æ¥å†³å®šä» pollDesc é‡Œçš„ rg è¿˜æ˜¯ wg é‡Œå–å‡º goroutine
        var mode int32
        if ev.events&(_EPOLLIN|_EPOLLRDHUP|_EPOLLHUP|_EPOLLERR) != 0 {
            mode += 'r'
        }
        if ev.events&(_EPOLLOUT|_EPOLLHUP|_EPOLLERR) != 0 {
            mode += 'w'
        }
        if mode != 0 {
            // å–å‡ºä¿å­˜åœ¨ epollevent é‡Œçš„ pollDesc
            pd := *(**pollDesc)(unsafe.Pointer(&ev.data))
            pd.everr = false
            if ev.events == _EPOLLERR {
                pd.everr = true
            }
            // è°ƒç”¨ netpollreadyï¼Œä¼ å…¥å°±ç»ª fd çš„ pollDescï¼Œ
            // æŠŠ fd å¯¹åº”çš„ goroutine æ·»åŠ åˆ°é“¾è¡¨ toRun ä¸­
            netpollready(&toRun, pd, mode)
        }
    }
    return toRun
}

// netpollready è°ƒç”¨ netpollunblock è¿”å›å°±ç»ª fd å¯¹åº”çš„ goroutine çš„æŠ½è±¡æ•°æ®ç»“æ„ g
func netpollready(toRun *gList, pd *pollDesc, mode int32) {
    var rg, wg *g
    if mode == 'r' || mode == 'r'+'w' {
        rg = netpollunblock(pd, 'r', true)
    }
    if mode == 'w' || mode == 'r'+'w' {
        wg = netpollunblock(pd, 'w', true)
    }
    if rg != nil {
        toRun.push(rg)
    }
    if wg != nil {
        toRun.push(wg)
    }
}

// netpollunblock ä¼šä¾æ®ä¼ å…¥çš„ mode å†³å®šä» pollDesc çš„ rg æˆ–è€… wg å–å‡ºå½“æ—¶ gopark ä¹‹æ—¶å­˜å…¥çš„
// goroutine æŠ½è±¡æ•°æ®ç»“æ„ g å¹¶è¿”å›
func netpollunblock(pd *pollDesc, mode int32, ioready bool) *g {
    // mode == 'r' ä»£è¡¨å½“æ—¶ gopark æ˜¯ä¸ºäº†ç­‰å¾…è¯»äº‹ä»¶ï¼Œè€Œ mode == 'w' åˆ™ä»£è¡¨æ˜¯ç­‰å¾…å†™äº‹ä»¶
    gpp := &pd.rg
    if mode == 'w' {
        gpp = &pd.wg
    }

    for {
        // å–å‡º gpp å­˜å‚¨çš„ g
        old := *gpp
        if old == pdReady {
            return nil
        }
        if old == 0 && !ioready {
            // Only set READY for ioready. runtime_pollWait
            // will check for timeout/cancel before waiting.
            return nil
        }
        var new uintptr
        if ioready {
            new = pdReady
        }
        // é‡ç½® pollDesc çš„ rg æˆ–è€… wg
        if atomic.Casuintptr(gpp, old, new) {
      // å¦‚æœè¯¥ goroutine è¿˜æ˜¯å¿…é¡»ç­‰å¾…ï¼Œåˆ™è¿”å› nil
            if old == pdWait {
                old = 0
            }
            // é€šè¿‡ä¸‡èƒ½æŒ‡é’ˆè¿˜åŸæˆ g å¹¶è¿”å›
            return (*g)(unsafe.Pointer(old))
        }
    }
}

// netpollBreak å¾€é€šä¿¡ç®¡é“é‡Œå†™å…¥ä¿¡å·å»å”¤é†’ epollwait
func netpollBreak() {
    // é€šè¿‡ CAS é¿å…é‡å¤çš„å”¤é†’ä¿¡å·è¢«å†™å…¥ç®¡é“ï¼Œ
    // ä»è€Œå‡å°‘ç³»ç»Ÿè°ƒç”¨å¹¶èŠ‚çœä¸€äº›ç³»ç»Ÿèµ„æº
    if atomic.Cas(&netpollWakeSig, 0, 1) {
        for {
            var b byte
            n := write(netpollBreakWr, unsafe.Pointer(&b), 1)
            if n == 1 {
                break
            }
            if n == -_EINTR {
                continue
            }
            if n == -_EAGAIN {
                return
            }
            println("runtime: netpollBreak write failed with", -n)
            throw("runtime: netpollBreak write failed")
        }
    }
}
```



### ä¸ºä»€ä¹ˆ netpoll ä¸€å®šè¦ä½¿ç”¨éé˜»å¡IO

ä¸ºäº†é¿å…è®©æ“ä½œç½‘ç»œ I/O çš„ goroutine é™·å…¥åˆ°ç³»ç»Ÿè°ƒç”¨ä»è€Œè¿›å…¥å†…æ ¸æ€ï¼Œå› ä¸ºä¸€æ—¦è¿›å…¥å†…æ ¸æ€ï¼Œæ•´ä¸ªç¨‹åºçš„æ§åˆ¶æƒå°±ä¼šå‘ç”Ÿè½¬ç§»(åˆ°å†…æ ¸)ï¼Œä¸å†å±äºç”¨æˆ·è¿›ç¨‹äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ— æ³•å€ŸåŠ©äº Go å¼ºå¤§çš„ runtime scheduler æ¥è°ƒåº¦ä¸šåŠ¡ç¨‹åºçš„å¹¶å‘äº†ï¼›è€Œæœ‰äº† netpoll ä¹‹åï¼Œå€ŸåŠ©äºéé˜»å¡ I/O ï¼ŒG å°±å†ä¹Ÿä¸ä¼šå› ä¸ºç³»ç»Ÿè°ƒç”¨çš„è¯»å†™è€Œ (é•¿æ—¶é—´) é™·å…¥å†…æ ¸æ€ï¼Œå½“ G è¢«é˜»å¡åœ¨æŸä¸ª network I/O æ“ä½œä¸Šæ—¶ï¼Œå®é™…ä¸Šå®ƒä¸æ˜¯å› ä¸ºé™·å…¥å†…æ ¸æ€è¢«é˜»å¡ä½äº†ï¼Œè€Œæ˜¯è¢« Go runtime è°ƒç”¨ gopark ç»™ park ä½äº†ï¼Œæ­¤æ—¶ G ä¼šè¢«æ”¾ç½®åˆ°æŸä¸ª wait queue ä¸­ï¼Œè€Œ M ä¼šå°è¯•è¿è¡Œä¸‹ä¸€ä¸ª `_Grunnable` çš„ Gï¼Œå¦‚æœæ­¤æ—¶æ²¡æœ‰ `_Grunnable` çš„ G ä¾› M è¿è¡Œï¼Œé‚£ä¹ˆ M å°†è§£ç»‘ Pï¼Œå¹¶è¿›å…¥ sleep çŠ¶æ€ã€‚å½“ I/O availableï¼Œåœ¨ epoll çš„ `eventpoll.rdr` ä¸­ç­‰å¾…çš„ G ä¼šè¢«æ”¾åˆ° `eventpoll.rdllist` é“¾è¡¨é‡Œå¹¶é€šè¿‡ `netpoll` ä¸­çš„ `epoll_wait` ç³»ç»Ÿè°ƒç”¨è¿”å›æ”¾ç½®åˆ°å…¨å±€è°ƒåº¦é˜Ÿåˆ—æˆ–è€… P çš„æœ¬åœ°è°ƒåº¦é˜Ÿåˆ—ï¼Œæ ‡è®°ä¸º `_Grunnable` ï¼Œç­‰å¾… P ç»‘å®š M æ¢å¤æ‰§è¡Œ









# åä¸‰ã€Goå†…å­˜ç®¡ç†ã€GC

## 1. TCMallocä»‹ç»

Golangçš„å†…å­˜åˆ†é…ç®—æ³•ç»å¤§éƒ¨åˆ†éƒ½æ˜¯æ¥è‡ª [TCMalloc](https://www.jianshu.com/p/11082b443ddf)ï¼ŒGolangåªé’ˆå¯¹å…¶ä¸­æ”¹åŠ¨äº†ä¸€å°éƒ¨åˆ†ã€‚å¯ä»¥è¯´TCMallocå°±æ˜¯Golangå†…å­˜åˆ†é…çš„æ¡†æ¶ã€‚

Thread-Caching Mallocã€‚æ˜¯è°·æ­Œå¼€å‘çš„å†…å­˜åˆ†é…å™¨ã€‚å…·æœ‰ç°ä»£åŒ–å†…å­˜åˆ†é…çš„åŸºæœ¬ç‰¹å¾ï¼š**å¯¹æŠ—å†…å­˜ç¢ç‰‡ã€åœ¨å¤šæ ¸å¤„ç†å™¨èƒ½å¤Ÿscale**

ä¸»è¦ç‰¹ç‚¹ï¼šå†…å­˜åˆ†é…å¿«ï¼Œå¤šçº¿ç¨‹å‡å°‘äº†é”æœºåˆ¶(å°å¯¹è±¡æ²¡æœ‰é”ï¼Œå¤§å¯¹è±¡è‡ªæ—‹é”)ï¼Œå¯¹å°å¯¹è±¡çš„å¤„ç†ç©ºé—´æ•ˆç‡æ›´å¥½

![TCMalloc](picture/goè¯­è¨€è¦ç‚¹/TCMalloc.png)

TCMallocåˆ†ä¸ºä¸‰å±‚ï¼šFront-End, Middle-End, Back-End å±‚å±‚é€’è¿›ï¼Œæœ€åæ˜¯OS

- å‰ç«¯æ˜¯ä¸€ä¸ªé«˜é€Ÿç¼“å­˜ï¼Œä¸ºåº”ç”¨ç¨‹åºæä¾›å¿«é€Ÿçš„å†…å­˜åˆ†é…å’Œé‡æ–°åˆ†é…

- ä¸­ç«¯è´Ÿè´£é‡æ–°å¡«å……å‰ç«¯ç¼“å­˜
- åç«¯å¤„ç†ä»OSæå–çš„å†…å­˜



æˆ‘ä»¬è¿è¡Œçš„ç¨‹åºé¦–å…ˆå‘å‰ç«¯ç”³è¯·å†…å­˜ï¼Œå‰ç«¯å†…å­˜ç¼“å­˜ä¸è¶³æ—¶ï¼Œä¼šå‘ä¸­ç«¯è¯·æ±‚å†…å­˜ï¼Œä¸­ç«¯å†…å­˜ä¸è¶³æ—¶ä¼šæƒ³åç«¯è¯·æ±‚å†…å­˜ï¼Œåç«¯ä¹Ÿå†…å­˜ä¸è¶³å°±ä¼šå‘OSç”³è¯·å†…å­˜

![TCMalloc](picture/goè¯­è¨€è¦ç‚¹/TCMalloc2.png)

è™šæ‹Ÿå†…å­˜çš„æ¦‚å¿µå¼•å…¥åï¼Œè®©å†…å­˜çš„å¹¶å‘è®¿é—®é—®é¢˜çš„ç²’åº¦ä»å¤šè¿›ç¨‹çº§åˆ«ï¼Œé™ä½åˆ°å¤šçº¿ç¨‹çº§åˆ«ã€‚TCMalloc**ä¸ºæ¯ä¸ªçº¿ç¨‹é¢„åˆ†é…ä¸€å—ç¼“å­˜ï¼Œçº¿ç¨‹ç”³è¯·å°å†…å­˜æ—¶ï¼Œå¯ä»¥ä»ç¼“å­˜åˆ†é…å†…å­˜**ï¼Œè¿™æ ·æœ‰2ä¸ªå¥½å¤„ï¼š

1. ä¸ºçº¿ç¨‹é¢„åˆ†é…ç¼“å­˜éœ€è¦è¿›è¡Œ1æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œåç»­çº¿ç¨‹ç”³è¯·å°å†…å­˜æ—¶ï¼Œä»ç¼“å­˜åˆ†é…ï¼Œéƒ½æ˜¯åœ¨ç”¨æˆ·æ€æ‰§è¡Œï¼Œæ²¡æœ‰ç³»ç»Ÿè°ƒç”¨ï¼Œ**ç¼©çŸ­äº†å†…å­˜æ€»ä½“çš„åˆ†é…å’Œé‡Šæ”¾æ—¶é—´**
2. å¤šä¸ªçº¿ç¨‹åŒæ—¶ç”³è¯·å°å†…å­˜æ—¶ï¼Œä»å„è‡ªçš„ç¼“å­˜åˆ†é…ï¼Œè®¿é—®çš„æ˜¯ä¸åŒçš„åœ°å€ç©ºé—´ï¼Œæ— éœ€åŠ é”ï¼Œ**æŠŠå†…å­˜å¹¶å‘è®¿é—®çš„ç²’åº¦è¿›ä¸€æ­¥é™ä½äº†**ã€‚



### 1.1 ä¸€äº›åŸºç¡€æ¦‚å¿µ

#### Page

æ“ä½œç³»ç»Ÿå¯¹å†…å­˜ç®¡ç†çš„å•ä½ï¼ŒTCMallocä¹Ÿä¼šæ˜¯ä»¥é¡µä¸ºå•ä½ç®¡ç†å†…å­˜ï¼Œä½†æ˜¯TCMallocä¸­çš„Pageå¤§å°æ˜¯OSä¸­Pageçš„å€æ•°ã€‚TCMallocé»˜è®¤Pageå¤§å°æ˜¯8KBï¼Œè€ŒLinuxæ˜¯4KBã€‚

TCMallocå¹¶éåªå°†å †å†…å­˜çœ‹åšæ˜¯ä¸€ä¸ªä¸ªçš„pageï¼Œè€Œæ˜¯å°†æ•´ä¸ªè™šæ‹Ÿå†…å­˜ç©ºé—´éƒ½çœ‹åšæ˜¯pageçš„é›†åˆã€‚ä»å†…å­˜åœ°å€0x0å¼€å§‹ï¼Œæ¯ä¸ªpageå¯¹åº”ä¸€ä¸ªé€’å¢çš„PageIDï¼Œå¦‚ä¸‹å›¾ï¼ˆä»¥32ä½ç³»ç»Ÿä¸ºä¾‹ï¼‰ï¼š

![page](picture/goè¯­è¨€è¦ç‚¹/page.png)

#### Span

Spanæ˜¯ PageHeap ä¸­ç®¡ç†å†…å­˜é¡µçš„å•ä½ï¼Œç”±**è¿ç»­çš„**ä¸€ä¸ªæˆ–è€…å¤šä¸ªPageç»„æˆï¼Œå¤šä¸ªSpanç”¨é“¾è¡¨è¿›è¡Œç®¡ç†

**TCMalloc ä»¥ Spanä¸ºå•ä½å‘ OS ç”³è¯·å†…å­˜**

ä¸€ä¸ªSpanè®°å½•äº†èµ·å§‹pageçš„ PageIDï¼Œä»¥åŠæ‰€åŒ…å«çš„pageæ•°é‡

Spanä¸€èˆ¬ç”¨æ¥ç®¡ç†å¤§å¯¹è±¡(å å¤šä¸ªPage)ï¼Œæˆ–è€…å·²æ‹†åˆ†ä¸ºä¸€ç³»åˆ—å°å¯¹è±¡çš„ä¸€ç»„Page (ä¸€ä¸ªæˆ–å¤šä¸ªPageè¢«Size-Classæ‹†åˆ†ä¸ºå›ºå®šå¤§å°çš„Objecté“¾è¡¨ï¼Œå¦‚æœSpanç®¡ç†çš„æ˜¯å°å¯¹è±¡ï¼Œä¼šåœ¨Spanä¸­è®°å½•å¯¹è±¡çš„Size-Classä¿¡æ¯)

![span](picture/goè¯­è¨€è¦ç‚¹/span.png)

ä¸€ä¸ªspanå¯ä»¥å¤„äºä¸‰ç§çŠ¶æ€ï¼š

- `IN_USE`ï¼šè¦ä¹ˆè¢«æ‹†åˆ†æˆå°å¯¹è±¡åˆ†é…ç»™äº†ThreadCacheæˆ–CentralCacheï¼Œè¦ä¹ˆåˆ†é…ç»™äº†åº”ç”¨ç¨‹åºã€‚å› ä¸ºspanæ˜¯ç”±PageHeapæ¥ç®¡ç†çš„ï¼Œå› æ­¤å³ä½¿åªæ˜¯åˆ†é…ç»™äº†CentralCacheï¼Œè¿˜æ²¡æœ‰è¢«åº”ç”¨ç¨‹åºæ‰€ç”³è¯·ï¼Œåœ¨PageHeapçœ‹æ¥ï¼Œä¹Ÿæ˜¯IN_USEäº†

- `ON_NORMAL_FREELIST`ï¼šç©ºé—²ï¼Œä½†æœªå½’è¿˜ç»™OS
- `ON_RETURNED_FREELIST`ï¼šç©ºé—²ï¼Œspanå¯¹åº”å†…å­˜é‡Šæ”¾ç»™OSäº†ï¼Œè™½ç„¶å½’è¿˜äº†ï¼Œä½†æ˜¯ä¸‹æ¬¡è¯¥è™šæ‹Ÿåœ°å€ä¾ç„¶å¯ä»¥è®¿é—®ï¼Œåªæ˜¯ä¼šå¯¼è‡´ page fault



#### Size-Class

ç”±Spanåˆ†è£‚å‡ºçš„å¯¹è±¡ï¼Œç”±**åŒä¸€ä¸ªSpanåˆ†è£‚å‡ºçš„SizeClasså¤§å°ç›¸åŒ**ï¼ŒSizeClassæ˜¯å¯¹è±¡å†…å­˜å®é™…çš„è½½ä½“

å°å¯¹è±¡è¢«åˆ†é…åˆ°å¤§å°ä¸åŒçš„Size-Classä¸Šï¼Œä¾‹å¦‚ä¸€ä¸ª12å­—èŠ‚çš„å¯¹è±¡ä¼šè¢«å››èˆäº”å…¥åˆ†é…åˆ°16å­—èŠ‚çš„Size-Classã€‚

Size-Classçš„è®¾è®¡æ˜¯ä¸ºäº†åœ¨èˆå…¥åˆ°ä¸‹ä¸€ä¸ªæœ€å¤§çš„sizeæ—¶å°½é‡å‡å°‘å†…å­˜æµªè´¹

æ¯ä¸ªSize-Classå¯¹åº”çš„ FreeList é“¾è¡¨ä¸­çš„Objectå¤§å°ç›¸åŒï¼Œæ˜¯ç”±Spanåˆ†å‰²å‡ºæ¥çš„

![SizeClass](picture/goè¯­è¨€è¦ç‚¹/SizeClass.png)

#### ThreadCache

æ¯ä¸ªçº¿ç¨‹å„è‡ªçš„Cacheï¼Œä¸€ä¸ªCacheåŒ…å«å¤šä¸ªç©ºé—²å†…å­˜å—é“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨è¿æ¥çš„éƒ½æ˜¯å†…å­˜å—ï¼ŒåŒä¸€ä¸ªé“¾è¡¨ä¸Šå†…å­˜å—çš„å¤§å°æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå¯ä»¥è¯´æŒ‰å†…å­˜å—å¤§å°ï¼Œç»™å†…å­˜å—åˆ†äº†ä¸ªç±»ï¼Œè¿™æ ·å¯ä»¥æ ¹æ®ç”³è¯·çš„å†…å­˜å¤§å°ï¼Œå¿«é€Ÿä»åˆé€‚çš„é“¾è¡¨é€‰æ‹©ç©ºé—²å†…å­˜å—ã€‚ç”±äºæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ThreadCacheï¼Œæ‰€ä»¥ThreadCacheè®¿é—®æ˜¯**æ— é”çš„**

![ThreadCache2](picture/goè¯­è¨€è¦ç‚¹/ThreadCache.png)

#### CentralCache

æ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ç¼“å­˜ï¼Œä¹Ÿæ˜¯ä¿å­˜çš„ç©ºé—²å†…å­˜å—é“¾è¡¨ï¼Œé“¾è¡¨çš„æ•°é‡ä¸ThreadCacheä¸­é“¾è¡¨æ•°é‡ç›¸åŒï¼Œå½“ThreadCacheå†…å­˜å—ä¸è¶³æ—¶ï¼Œå¯ä»¥ä»CentralCacheå–ï¼Œå½“ThreadCacheå†…å­˜å—å¤šæ—¶ï¼Œå¯ä»¥æ”¾å›CentralCacheã€‚ç”±äºCentralCacheæ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥å®ƒçš„è®¿é—®æ˜¯è¦**åŠ é”çš„**

<img src="picture/goè¯­è¨€è¦ç‚¹/CentralCache.png" alt="CentralCache" style="zoom: 25%;" />

#### Page Heap

PageHeapæ˜¯å †å†…å­˜çš„æŠ½è±¡ï¼ŒPageHeapå­˜çš„ä¹Ÿæ˜¯è‹¥å¹²é“¾è¡¨ï¼Œé“¾è¡¨ä¿å­˜çš„æ˜¯Spanï¼Œå½“CentralCacheæ²¡æœ‰å†…å­˜çš„æ—¶ï¼Œä¼šä»PageHeapå–ï¼ŒæŠŠ1ä¸ªSpanæ‹†æˆè‹¥å¹²å†…å­˜å—ï¼Œæ·»åŠ åˆ°å¯¹åº”å¤§å°çš„é“¾è¡¨ä¸­ï¼Œå½“CentralCacheå†…å­˜å¤šçš„æ—¶å€™ï¼Œä¼šæ”¾å›PageHeapã€‚å¦‚ä¸‹å›¾ï¼Œåˆ†åˆ«æ˜¯1é¡µPageçš„Spané“¾è¡¨ï¼Œ2é¡µPageçš„Spané“¾è¡¨ç­‰ï¼Œæœ€åæ˜¯large span setï¼Œè¿™ä¸ªæ˜¯ç”¨æ¥ä¿å­˜ä¸­å¤§å¯¹è±¡çš„ã€‚æ¯«æ— ç–‘é—®ï¼ŒPageHeapä¹Ÿæ˜¯è¦**åŠ é”çš„**

<img src="picture/goè¯­è¨€è¦ç‚¹/PageHeap.png" alt="PageHeap" style="zoom: 25%;" />



#### Pagemap and Spans

æ‰€æœ‰è¢«TCMallocä»æ“ä½œç³»ç»Ÿè¢«ç”³è¯·åˆ°çš„å†…å­˜ä¼šè¢«åˆ’åˆ†æˆç¼–è¯‘æ—¶å°±è¢«ç¡®è®¤å¥½çš„Pageå¤§å°,

pagemapç”¨äºæŸ¥æ‰¾ä¸€ä¸ªpageæ‰€å±çš„Spanï¼Œæˆ–æ ‡è¯†ç»™å®šå¯¹è±¡çš„Size-class(ä¾‹å¦‚ä¸€ä¸ªå¤§å¯¹è±¡è¢«åˆ†é…äº†å¤šä¸ªPageçš„Span,æˆ–è€…ä¸€ä¸ªSpanè¢«æ‹†åˆ†æˆSize-classå¤§å°ååˆ†é…ç»™å°å¯¹è±¡)ã€‚ TCMallocä½¿ç”¨2çº§æˆ–3çº§åŸºæ•°æ ‘æ¥æ˜ å°„æ‰€æœ‰ç”³è¯·åˆ°çš„å†…å­˜.

![Pagemap](picture/goè¯­è¨€è¦ç‚¹/Pagemap.png)



### 1.2 Front-End (ThreadCache)

æ˜¯ä¸€ä¸ªå†…å­˜ç¼“å­˜

ç¨‹åºéœ€è¦å†…å­˜æ—¶é¦–å…ˆå‘Front-Endç”³è¯·

æä¾›å¿«é€Ÿåˆ†é…å’Œé‡æ–°åˆ†é…å†…å­˜ç»™åº”ç”¨çš„åŠŸèƒ½



å¯ä»¥åŸºäºçº¿ç¨‹åˆ†é…(per-thread cache) æˆ–è€… åŸºäºCPUåˆ†é…(per-cpu cache) å†…å­˜

å½“ç”³è¯·çš„å†…å­˜å°äº `kMaxSize` æ—¶ï¼Œç›´æ¥ç”±å‰ç«¯åˆ†é…å†…å­˜ï¼Œå‰ç«¯å¯¹ç”³è¯·çš„å†…å­˜å¤§å°è¿›è¡Œæ˜ å°„åˆ°å¯¹åº”çš„ `Size-Class`(å¦‚12KBæ˜ å°„åˆ°16KB)ï¼Œç„¶åå°†Size-Classåˆ†é…ç»™å¯¹è±¡ã€‚

å½“ç”³è¯·çš„å†…å­˜å¤§äº `kMaxSize`æ—¶ï¼Œä¼šäº¤ç»™åç«¯ç›´æ¥åˆ†é… `Span` ç»™å¤§å¯¹è±¡



å‰ç«¯é«˜é€Ÿç¼“å­˜ä¸€æ¬¡åªèƒ½ç”±å•ä¸ªçº¿ç¨‹(CPU)è®¿é—®ï¼Œå› æ­¤æ— éœ€åŠ é”ï¼Œåˆ†é…å’Œé‡Šæ”¾å†…å­˜å¾ˆå¿«



### 1.3 Middle-End (CentralHeap)

å¦‚æœå‰ç«¯å·²ç¼“å­˜é€‚å½“å¤§å°çš„å†…å­˜,å®ƒå¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†çš„è¯·æ±‚ã€‚ä½†æ˜¯å¦‚æœæŸç§ç‰¹å®šå¤§å°çš„ç¼“å­˜ä¸ºç©ºï¼Œåˆ™å‰ç«¯å°†å‘ä¸­ç«¯(Middle-End)è¯·æ±‚ä¸€æ‰¹å†…å­˜ä»¥é‡æ–°å¡«å……ç¼“å­˜ã€‚ ä¸­é—´ç«¯åŒ…æ‹¬Central Free Listå’ŒTransfer Cacheã€‚



#### Transfer Cache(ä¼ è¾“ç¼“å­˜)

å½“å‰ç«¯è¯·æ±‚å†…å­˜æˆ–è¿”å›å†…å­˜æ—¶ï¼Œå®ƒå°†åˆ°è¾¾ä¼ è¾“ç¼“å­˜ã€‚

ä¼ è¾“ç¼“å­˜åŒ…å«ä¸€ä¸ªæŒ‡å‘å¯ç”¨å†…å­˜çš„æŒ‡é’ˆæ•°ç»„ï¼Œå¯ä»¥å¿«é€Ÿå°†å¯¹è±¡ç§»åŠ¨åˆ°è¯¥æ•°ç»„ä¸­ï¼Œæˆ–è€…ä»£è¡¨å‰ç«¯ä»è¯¥æ•°ç»„ä¸­è·å–å¯¹è±¡ã€‚

ä¼ è¾“ç¼“å­˜çš„å­˜åœ¨æ˜¯ç”±äº**ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨åˆ†é…ç”±å¦ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾çš„å†…å­˜çš„æƒ…å†µ**ã€‚ ä¼ è¾“ç¼“å­˜å…è®¸å†…å­˜åœ¨ä¸¤ä¸ªä¸åŒçº¿ç¨‹ä¹‹é—´å¿«é€ŸæµåŠ¨ã€‚

å¦‚æœä¼ è¾“ç¼“å­˜æ— æ³•æ»¡è¶³å†…å­˜è¯·æ±‚ï¼Œæˆ–è€…æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´å®¹çº³è¿”å›çš„å¯¹è±¡ï¼Œå®ƒå°†è®¿é—®Central Free List



#### Central Free List

Central Free Listæ˜¯å½“Front-Endå†…å­˜ä¸è¶³æ—¶,æä¾›å†…å­˜ä¾›å…¶ä½¿ç”¨

Central Free List ä»¥Spanä¸ºåŸºç¡€ç®¡ç†å†…å­˜,å½“éœ€è¦å†…å­˜æ—¶,ä¼šä»ä¸åŒçš„Spanä¸­æå–å†…å­˜.

å½“å¯¹è±¡è¿”å›åˆ°Central Free Listæ—¶ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½å°†æ˜ å°„åˆ°å®ƒæ‰€å±çš„Spanï¼ˆä½¿ç”¨pagemapï¼Œç„¶å**é‡Šæ”¾åˆ°è¯¥Spanä¸­ã€‚å¦‚æœé©»ç•™åœ¨ç‰¹å®šSpanä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½è¿”å›ç»™å®ƒï¼Œåˆ™æ•´ä¸ªSpan è¿”å›åˆ°åç«¯**ï¼‰

å¦‚æœä¸­ç«¯å·²ç”¨å°½ï¼Œå°†è¯·æ±‚åç«¯åˆ†é…Pageå¡«å……åˆ°ä¸­ç«¯. åç«¯ä¹Ÿç§°ä¸ºPageHeap.

![CentralFreeList](picture/goè¯­è¨€è¦ç‚¹/CentralFreeList.png)

### 1.4 Back-End (PageHeap)

TCMallocçš„åç«¯æœ‰ä¸‰ä¸ªä»»åŠ¡:

- ç®¡ç†æœªä½¿ç”¨çš„å†…å­˜ã€‚
- å½“æ²¡æœ‰åˆé€‚å¤§å°çš„å¯ç”¨å†…å­˜æ¥æ»¡è¶³åˆ†é…è¯·æ±‚æ—¶, å®ƒè´Ÿè´£ä»æ“ä½œç³»ç»Ÿè·å–å†…å­˜ã€‚
- å°†ä¸éœ€è¦çš„å†…å­˜è¿”å›ç»™æ“ä½œç³»ç»Ÿã€‚

TCMallocæœ‰ä¸¤ä¸ªç±»å‹çš„åç«¯:

- Legacy Pageheap

ç”¨äºç®¡ç†ä¸€å®šå¤§å°çš„Span.

- Hugepage Aware Allocator

ç”¨äºç®¡ç†å¤§å¯¹è±¡,é€šå¸¸è¶…è¿‡2MB

å½“ä¸­ç«¯å†…å­˜ä¸å¤Ÿçš„è¯·æ±‚æ¥åˆ°åç«¯æ—¶,åç«¯ä¼šè¿”å›å¯¹åº”Spançš„å†…å­˜ç»™ä¸­ç«¯



### 1.5 TCMallocçš„å†…å­˜åˆ†é…å’Œå›æ”¶

TCMallocçš„å®šä¹‰ï¼š

1. å°å¯¹è±¡å¤§å°ï¼š0~256KB
2. ä¸­å¯¹è±¡å¤§å°ï¼š257~1MB
3. å¤§å¯¹è±¡å¤§å°ï¼š>1MB

å°å¯¹è±¡çš„åˆ†é…æµç¨‹ï¼šThreadCache -> CentralCache -> PageHeapï¼Œå¤§éƒ¨åˆ†æ—¶å€™ï¼ŒThreadCacheç¼“å­˜éƒ½æ˜¯è¶³å¤Ÿçš„( FreeListéç©º )ï¼Œä¸éœ€è¦å»è®¿é—®CentralCacheå’ŒHeapPageï¼Œæ— é”åˆ†é…åŠ æ— ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ†é…æ•ˆç‡æ˜¯éå¸¸é«˜çš„ã€‚

ä¸­å¯¹è±¡åˆ†é…æµç¨‹ï¼šç›´æ¥åœ¨PageHeapä¸­é€‰æ‹©é€‚å½“çš„å¤§å°å³å¯ï¼Œ128 Pageçš„Spanæ‰€ä¿å­˜çš„æœ€å¤§å†…å­˜å°±æ˜¯1MBã€‚

å¤§å¯¹è±¡åˆ†é…æµç¨‹ï¼šä»large span seté€‰æ‹©åˆé€‚æ•°é‡çš„é¡µé¢ç»„æˆspanï¼Œç”¨æ¥å­˜å‚¨æ•°æ®



åº”ç”¨ç¨‹åºè°ƒç”¨free()æˆ–deleteä¸€ä¸ªå°å¯¹è±¡æ—¶ï¼Œä»…ä»…æ˜¯å°†å…¶æ’å…¥åˆ°ThreadCacheä¸­å…¶size classå¯¹åº”çš„FreeListä¸­è€Œå·²ï¼Œä¸éœ€è¦åŠ é”ï¼Œå› æ­¤é€Ÿåº¦ä¹Ÿæ˜¯éå¸¸å¿«çš„ã€‚

åªæœ‰å½“æ»¡è¶³ä¸€å®šçš„æ¡ä»¶æ—¶ï¼ŒThreadCacheä¸­çš„ç©ºé—²å¯¹è±¡æ‰ä¼šé‡æ–°æ”¾å›CentralCacheä¸­ï¼Œä»¥ä¾›å…¶ä»–çº¿ç¨‹å–ç”¨ã€‚åŒæ ·çš„ï¼Œå½“æ»¡è¶³ä¸€å®šæ¡ä»¶æ—¶ï¼ŒCentralCacheä¸­çš„ç©ºé—²å¯¹è±¡ä¹Ÿä¼šè¿˜ç»™PageHeapï¼ŒPageHeapå†è¿˜ç»™ç³»ç»Ÿã€‚



## 2. Golangå†…å­˜ç®¡ç†

å®è§‚æ¥çœ‹ï¼Œ[Goçš„å†…å­˜ç®¡ç†](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/)å°±æ˜¯ä¸‹å›¾çš„æ ·å­ï¼Œé‡ç‚¹åœ¨äºå †å†…å­˜çš„éƒ¨åˆ†

![Goå†…å­˜ç®¡ç†](picture/goè¯­è¨€è¦ç‚¹/Goå†…å­˜ç®¡ç†.png)

Goè¿™é—¨è¯­è¨€æŠ›å¼ƒäº†C/C++ä¸­çš„å¼€å‘è€…ç®¡ç†å†…å­˜çš„æ–¹å¼ï¼šä¸»åŠ¨ç”³è¯·ä¸ä¸»åŠ¨é‡Šæ”¾ï¼Œå¢åŠ äº†é€ƒé€¸åˆ†æå’ŒGCï¼Œå°†å¼€å‘è€…ä»å†…å­˜ç®¡ç†ä¸­é‡Šæ”¾å‡ºæ¥ï¼Œè®©å¼€å‘è€…æœ‰æ›´å¤šçš„ç²¾åŠ›å»å…³æ³¨è½¯ä»¶è®¾è®¡ï¼Œè€Œä¸æ˜¯åº•å±‚çš„å†…å­˜é—®é¢˜ã€‚è¿™æ˜¯Goè¯­è¨€æˆä¸ºé«˜ç”Ÿäº§åŠ›è¯­è¨€çš„åŸå› ä¹‹ä¸€



æ ˆå†…å­˜å’Œå †å†…å­˜çš„å‡ ç‚¹åŒºåˆ«ï¼š

1. æ ˆçš„å†…å­˜ç®¡ç†ç®€å•ï¼Œåˆ†é…æ¯”å †ä¸Šå¿«ã€‚
2. æ ˆçš„å†…å­˜ä¸éœ€è¦å›æ”¶ï¼Œè€Œå †éœ€è¦ï¼Œæ— è®ºæ˜¯ä¸»åŠ¨freeï¼Œè¿˜æ˜¯è¢«åŠ¨çš„åƒåœ¾å›æ”¶ï¼Œè¿™éƒ½éœ€è¦èŠ±è´¹é¢å¤–çš„CPUã€‚
3. æ ˆä¸Šçš„å†…å­˜æœ‰æ›´å¥½çš„å±€éƒ¨æ€§ï¼Œå †ä¸Šå†…å­˜è®¿é—®å°±ä¸é‚£ä¹ˆå‹å¥½äº†ï¼ŒCPUè®¿é—®çš„2å—æ•°æ®å¯èƒ½åœ¨ä¸åŒçš„é¡µä¸Šï¼ŒCPUè®¿é—®æ•°æ®çš„æ—¶é—´å¯èƒ½å°±ä¸Šå»äº†ã€‚

å½“æˆ‘ä»¬è¯´å†…å­˜ç®¡ç†çš„æ—¶å€™ï¼Œä¸»è¦æ˜¯æŒ‡**å †å†…å­˜çš„ç®¡ç†**ï¼Œæ ˆå†…å­˜ç®¡ç†ä¸éœ€è¦ç¨‹åºå»æ“å¿ƒã€‚

### 2.1 å†…å­˜åˆ†é…çš„è®¾è®¡

ä¸¤ç§å†…å­˜åˆ†é…æ–¹å¼ï¼š

#### 1. çº¿æ€§åˆ†é…

çº¿æ€§åˆ†é…éå¸¸é«˜æ•ˆã€‚**åªéœ€è¦ç»´æŠ¤ä¸€ä¸ªæŒ‡å‘å†…å­˜ç‰¹å®šä½ç½®çš„æŒ‡é’ˆ**ï¼Œå½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œåˆ†é…å™¨æ£€æŸ¥å‰©ä½™ç©ºé—²å†…å­˜ï¼Œè¿”å›åˆ†é…çš„å†…å­˜åŒºåŸŸå¹¶ä¿®æ”¹æŒ‡é’ˆä½ç½®ï¼ˆç§»åŠ¨æŒ‡é’ˆï¼‰

ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œæ‰§è¡Œé«˜æ•ˆ

ç¼ºé™·ï¼šå½“å·²åˆ†é…å†…å­˜è¢«å›æ”¶åï¼Œå•é å•ä¸ªæŒ‡é’ˆæ²¡æœ‰åŠæ³•ç»§ç»­åˆ†é…å‰é¢ç©ºé—²çš„åŒºåŸŸ(çº¢è‰²åŒºåŸŸ)

é€‚ç”¨åœºæ™¯ï¼šé€‚åˆæ‹·è´çš„åƒåœ¾å›æ”¶ç®—æ³•ï¼Œåƒæ ‡è®°æ•´ç†ã€æ ‡è®°å¤åˆ¶ç­‰ç®—æ³•ï¼Œå› ä¸ºä»–ä»¬ä¼šæ•´ç†å¯¹è±¡ä½ç½®ï¼Œå°†ç©ºé—²å†…å­˜åˆå¹¶ã€‚

![çº¿æ€§åˆ†é…](picture/goè¯­è¨€è¦ç‚¹/çº¿æ€§åˆ†é….png)



#### 2. ç©ºé—²é“¾è¡¨åˆ†é…

é‡ç”¨å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œåœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªç©ºé—²é“¾è¡¨ã€‚ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œä¸€æ¬¡éå†ç©ºé—²é“¾è¡¨ï¼Œæ‰¾åˆ°è¶³å¤Ÿå¤§çš„å†…å­˜ï¼Œç„¶ååˆ†é…ç»™ç”¨æˆ·ï¼Œä¿®æ”¹é“¾è¡¨

![free-list-allocator](picture/goè¯­è¨€è¦ç‚¹/275bbc5fa363a80c495b32fbe32ed66b.png)

å¸¸è§çš„ç©ºé—²é“¾è¡¨åˆ†é…æ–¹æ³•ï¼š

- é¦–æ¬¡é€‚åº”ï¼šæ¯æ¬¡ä»å¤´å¼€å§‹ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„å°±è¿”å›
- å¾ªç¯é¦–æ¬¡é€‚åº”ï¼šä»ä¸Šä¸€æ¬¡ç»“æŸä½ç½®å¼€å§‹éå†
- æœ€ä¼˜é€‚åº”ï¼šéå†æ•´ä¸ªé“¾è¡¨ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å†…å­˜å—
- **éš”ç¦»é€‚åº”(Golangé‡‡ç”¨çš„æ–¹æ³•)**ï¼šå°†å†…å­˜åˆ†éš”æˆå¤šä¸ªé“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨å†…éƒ¨çš„å†…å­˜å—å¤§å°ç›¸åŒï¼Œé“¾è¡¨å½¼æ­¤ç®¡ç†ä¸åŒå¤§å°çš„å†…å­˜å—ï¼Œç”³è¯·å†…å­˜æ—¶å…ˆæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„é“¾è¡¨ï¼Œå†ä»é“¾è¡¨ä¸­é€‰æ‹©åˆé€‚çš„å†…å­˜å—

ä¼˜ç‚¹ï¼šå¯ä»¥é‡ç”¨è¢«ä½¿ç”¨çš„å†…å­˜ï¼Œè€Œä¸”æ— éœ€æ•´ç†å’Œå¤åˆ¶

ç¼ºç‚¹ï¼šåˆ†é…å†…å­˜æ—¶éœ€è¦éå†é“¾è¡¨

#### 3. Golangå†…å­˜åˆ†é…

Golangçš„å†…å­˜åˆ†é…æ³•å’Œéš”ç¦»é€‚åº”ç®—æ³•ç±»ä¼¼ï¼Œå¹¶ä¸”å€Ÿé‰´äº†TCMallocçš„è®¾è®¡å®ç°é«˜é€Ÿçš„å†…å­˜åˆ†é…ã€‚æ ¸å¿ƒç†å¿µæ˜¯**ä½¿ç”¨å¤šçº§ç¼“å­˜å°†å¯¹è±¡æ ¹æ®å¤§å°åˆ†ç±»ï¼ŒæŒ‰ç…§ç±»åˆ«å®æ–½ä¸åŒçš„åˆ†é…ç­–ç•¥**

å¯¹è±¡è¢«åˆ†ä¸ºä¸‰ç§å¤§å°ï¼š

- å°äº16Bï¼šå¾®å¯¹è±¡
- 16KBåˆ°32KBï¼šå°å¯¹è±¡
- å¤§äº32KBï¼šå¤§å¯¹è±¡

å…¶ä¸­å¾®å¯¹è±¡å’Œå°å¯¹è±¡ä¼˜å…ˆåˆ†é…åˆ°çº¿ç¨‹ç¼“å­˜ä¸­ï¼Œå¤§å¯¹è±¡ç›´æ¥åˆ†é…åˆ°å †ä¸­

Goè¯­è¨€ä¹Ÿé‡‡ç”¨äº†TCMallocçš„**å¤šçº§ç¼“å­˜ç­–ç•¥**ï¼Œå¹¶ä¸”é‡‡ç”¨çš„æ˜¯ `Per-Thread Cache` æ¨¡å¼ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ç¼“å­˜ï¼ˆå³æ¯ä¸ªPï¼‰

![golangå†…å­˜åˆ†é…](picture/goè¯­è¨€è¦ç‚¹/golangå†…å­˜åˆ†é….png)



### 2.2 Goå†…å­˜å¸ƒå±€

#### å†…å­˜å¸ƒå±€çš„æ¼”å˜

Go1.10åŠä»¥å‰é‡‡ç”¨çº¿æ€§åˆ†é…çš„æ–¹å¼ï¼Œç®¡ç†ç®€å•ï¼Œå †å†…å­˜éƒ½æ˜¯è¿ç»­çš„ï¼ˆéƒ½æ˜¯è™šæ‹Ÿå†…å­˜ï¼‰ã€‚

spansåŒºåŸŸå­˜å‚¨äº†æŒ‡å‘å†…å­˜ç®¡ç†å•å…ƒçš„`runtime.mspan`çš„æŒ‡é’ˆï¼Œæ¯ä¸ªmspanç®¡ç†å‡ é¡µçš„å†…å­˜ç©ºé—´

bitmapç”¨äºæ ‡è¯†arenaåŒºåŸŸä¸­å“ªäº›åœ°å€ä¿å­˜äº†å¯¹è±¡

areaæ˜¯çœŸæ­£çš„å †åŒºï¼Œè¿è¡Œæ—¶8KBä¸ºä¸€é¡µï¼Œæœ€å¤§ä¸º512GB

å¯¹äºä»»æ„åœ°å€ï¼Œé€šè¿‡arenaçš„åŸºåœ°å€å¯ä»¥è®¡ç®—å‡ºè¯¥åœ°å€æ‰€åœ¨é¡µï¼Œç„¶åé€šè¿‡spansæ•°ç»„è·å¾—ç®¡ç†è¯¥é¡µçš„mspanå¯¹è±¡ï¼ˆå¤šä¸ªè¿ç»­çš„é¡µå¯ä»¥å¯¹åº”ä¸€ä¸ªmspanï¼‰ã€‚è¿™ä¸€ç³»åˆ—æ“ä½œçš„å‰ææ˜¯å †åŒºarenaå¿…é¡»æ˜¯è¿ç»­çš„

- ä¼˜ç‚¹ï¼šåƒåœ¾å›æ”¶å¯ä»¥æ ¹æ®æŒ‡é’ˆåœ°å€åˆ¤æ–­å¯¹è±¡æ˜¯å¦åœ¨å †ä¸­ï¼Œå†…å­˜ç®¡ç†ç®€å•æ–¹ä¾¿
- ç¼ºç‚¹ï¼šéœ€è¦é¢„ç•™å¤§å—çš„å†…å­˜ç©ºé—´ï¼Œå¯èƒ½ç”³è¯·å¤§å—å†…å­˜ç©ºé—´å´ä¸ä½¿ç”¨ã€‚å¦‚æœä¸é¢„ç•™å¤§å—ç©ºé—´ï¼ŒæŸäº›åœºæ™¯åˆä¼šOOM

![heap-before-go-1-10](picture/goè¯­è¨€è¦ç‚¹/heap-before-go-1-10.png)

1.11ä¹‹åï¼Œè½¬ä¸ºäº†ç¨€ç–å†…å­˜ç®¡ç†ï¼ˆåŸºäºéš”ç¦»é€‚åº”çš„ç©ºé—²é“¾è¡¨ç®¡ç†ï¼‰

- ä¼˜ç‚¹ï¼šè§£å†³äº†å †å¤§å°çš„ä¸Šé™
- ç¼ºç‚¹ï¼šå¤±å»äº†å†…å­˜çš„è¿ç»­æ€§ï¼Œä½¿å†…å­˜ç®¡ç†å˜å¾—éå¸¸å¤æ‚ï¼Œå¢åŠ äº†ä¸€ç‚¹åƒåœ¾å›æ”¶çš„æˆæœ¬

![Goå†…å­˜å¸ƒå±€](picture/goè¯­è¨€è¦ç‚¹/Goå†…å­˜å¸ƒå±€.png)

è¯¦ç»†çš„å†…å­˜å¸ƒå±€å›¾å¦‚ä¸‹ï¼š

![Goå†…å­˜ç®¡ç†è¯¦è§£](picture/goè¯­è¨€è¦ç‚¹/Goå†…å­˜ç®¡ç†è¯¦è§£.png)



#### heapArena

ç¨€ç–å†…å­˜ç®¡ç†ä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªäºŒç»´çš„ `runtime.heapArena` æ•°ç»„å¯¹å†…å­˜è¿›è¡Œç®¡ç†ï¼Œæ¯ä¸ªheapArenaç®¡ç†64MBçš„å†…å­˜ç©ºé—´ï¼Œæ•´ä¸ªå †åŒºæœ€å¤šå¯ä»¥ç®¡ç†256TBå†…å­˜ï¼Œæ¯”ä¹‹å‰çš„512GBå¤šå¤šäº†

```go
type heapArena struct {
	// å‰ä¸¤è€…ä¸çº¿æ€§åˆ†é…ä¸­çš„bitmapä»¥åŠspanså¯¹åº”,ç”¨äºæ˜ å°„å†…å­˜åœ°å€ä¸Span.
	bitmap [heapArenaBitmapBytes]byte
	spans [pagesPerArena]*mspan
	
	// ä¸€ä¸ªä½å›¾ç”¨äºè¡¨ç¤ºåœ¨å½“å‰heapArenaç®¡ç†çš„Spanä¸­,å“ªäº›Spanæ˜¯æ­£åœ¨è¢«ä½¿ç”¨çš„.
	// åªä½¿ç”¨äº†æ¯ä¸ªSpançš„ç¬¬ä¸€ä¸ªPage(Spanå¯ä»¥ç”±å¤šé¡µæ„æˆ) å¹¶ä¸”è¯»å†™æ˜¯åŸå­æ€§çš„
	pageInUse [pagesPerArena / 8]uint8
	
	// ä¸pageInUseç±»ä¼¼,ä¹Ÿæ˜¯ä¸€ä¸ªä½å›¾,ç”¨äºè¡¨ç¤ºå“ªäº›Spanä¸Šæœ‰è¢«æ ‡è®°çš„å¯¹è±¡,ç”¨äºåƒåœ¾å›æ”¶.
	pageMarks [pagesPerArena / 8]uint8
	
	// è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„æ˜¯æ•´ä¸ªheapArenaç»“æ„ç®¡ç†çš„é¦–åœ°å€,é€šè¿‡CASçš„æ–¹å¼è¿›è¡Œä¿®æ”¹
	zeroedBase uintptr
}
```



#### mspan

```go
type mspan struct {
    next *mspan		// åŒé“¾è¡¨
    prev *mspan
    
	startAddr uintptr // æ‰€ç®¡ç†å†…å­˜çš„èµ·å§‹åœ°å€
	npages    uintptr // æ‰€ç®¡ç†å†…å­˜çš„é¡µæ•°
    freeindex uintptr // é¡µä¸­ç©ºé—²å¯¹è±¡çš„åˆå§‹ç´¢å¼•(å¿«é€Ÿåˆ†é…)

	allocBits  *gcBits  // å†…å­˜åˆ†é…çš„ä½å›¾
	gcmarkBits *gcBits	// gcæ ‡å¿—çš„ä½å›¾
	allocCache uint64   // allocBitsçš„è¡¥ç ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾å†…å­˜ä¸­æœªè¢«ä½¿ç”¨çš„å†…å­˜
	
    state mSpanStateBox  // spançš„çŠ¶æ€ï¼Œç©ºé—²(å †ä¸­)ã€inuse(è¢«åˆ†é…äº†)ã€manualã€‚ã€‚ã€‚
    
    spanclass spanClass  // mspançš„è·¨åº¦ç±»
}
```



mspanæ˜¯å†…å­˜ç®¡ç†å•å…ƒï¼ˆå†…å­˜ç®¡ç†çš„åŸºæœ¬å•ä½ï¼‰ï¼Œæ˜¯åŒå‘é“¾è¡¨ï¼Œprevå’Œnextåˆ†åˆ«æŒ‡å‘å‰åçš„`runtime.mspan`ï¼Œæœ€åä½¿ç”¨runtime.mspanListå­˜å‚¨äº†åŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹ï¼Œåœ¨**çº¿ç¨‹ç¼“å­˜mcacheå’Œä¸­å¿ƒç¼“å­˜mcentralä¸­ä½¿ç”¨**

![mspan-and-linked-list](picture/goè¯­è¨€è¦ç‚¹/2020-02-29-15829868066485-mspan-and-linked-list.png)

**ä¸€ç»„è¿ç»­çš„Pageç»„æˆ1ä¸ªSpan**ï¼Œä¸€ä¸ªmspançš„å¤§å°ä»8Båˆ°åˆ°32KB (sizeClass)

`startAddr`å’Œ`npages`ç¡®å®šäº†è¯¥mspanç»“æ„ä½“ç®¡ç†çš„å¤šä¸ªé¡µæ‰€åœ¨çš„å†…å­˜ï¼ˆä¸€ä¸ªmspanç®¡ç†ä¸€æ®µè¿ç»­çš„é¡µç©ºé—´ï¼‰

![img{512x368}](picture/goè¯­è¨€è¦ç‚¹/52a93c8e9a2cd2be8d7e970091109c5d.png)

`spanClass`æ˜¯è·¨åº¦ç±»ï¼Œå®ƒå†³å®šäº†mspanä¸­å­˜å‚¨çš„å¯¹è±¡çš„å¤§å°å’Œä¸ªæ•°ï¼ˆæŒ‰spanClassçš„å¤§å°è¿›è¡Œå†…å­˜å¯¹é½ï¼‰

Goä¸€å…±æœ‰67ç§è·¨åº¦ç±»ï¼ˆsize classï¼‰ï¼Œæ¯ä¸ªè·¨åº¦ç±»éƒ½å¯¹åº”ç‰¹å®šå¤§å°çš„å¯¹è±¡(obj size)ï¼Œä»¥åŠå¯¹åº”spançš„å¤§å°(span size)ï¼Œé€šè¿‡è®¡ç®—å¯ä»¥å¾—å‡ºè¯¥è·¨åº¦ç±»æ‰€å¯¹åº”spanå¯ä»¥å­˜å‚¨çš„objectsçš„æ•°é‡(num of object)ï¼Œä»¥åŠæµªè´¹çš„ç©ºé—´

æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªç±»åˆ«ä¸º0çš„è·¨åº¦ç±»ï¼Œå®ƒèƒ½å¤Ÿç®¡ç†å¤§äº32KBçš„ç‰¹æ®Šå¯¹è±¡ï¼ˆå¤§å¯¹è±¡åˆ†é…çš„æ—¶å€™ä½¿ç”¨ï¼‰

**ä¸€ä¸ªsizeClasså¯¹åº”ä¸¤ä¸ªspanClass**ï¼Œæ‰€ä»¥spanClassæœ‰134ä¸ªï¼Œä»0åˆ°133ï¼Œæ¯ä¸ªspan classæŒ‡å‘ä¸€ä¸ªspanï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªmcacheæœ‰134ä¸ªmspané“¾è¡¨

> ```go
> numSpanClasses = _NumSizeClasses << 1
> _NumSizeClasses = 68
> ```

![Goå†…å­˜åˆ†é…è¡¨](picture/goè¯­è¨€è¦ç‚¹/Goå†…å­˜åˆ†é…è¡¨.png)

sizeè½¬æ¢æ˜¯æ²¡æœ‰å›ºå®šçš„è®¡ç®—è§„å¾‹çš„ï¼Œç›´æ¥è¿›è¡Œäº†ç¡¬ç¼–ç ï¼Œé€šè¿‡æŸ¥è¡¨å¾—åˆ°ï¼š

`size-class`ï¼šä»1åˆ°66(ä»8Båˆ°32KB)ï¼Œä¸€å…±æœ‰66ä¸ªï¼ŒåŠ ä¸Šæœªä½¿ç”¨çš„ size class 0ï¼Œå®é™…ä¸Šæœ‰67ä¸ª

`span-class`ï¼šä¸€ä¸ªsizeClasså¯¹åº”ä¸¤ä¸ªspan-classï¼Œæ‰€ä»¥span-classæœ‰134ä¸ªï¼Œä»0åˆ°133ï¼Œæ¯ä¸ªspan classæŒ‡å‘ä¸€ä¸ªspanï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªmcacheæœ‰æœ€å¤š134ä¸ª span class é“¾è¡¨

![Sizeè½¬æ¢](picture/goè¯­è¨€è¦ç‚¹/Sizeè½¬æ¢.png)



å½“ç”¨æˆ·ç¨‹åºå‘runtime.mspanç”³è¯·å†…å­˜æ—¶ï¼Œå®ƒä¼šä½¿ç”¨`allocCache`å­—æ®µ**ä»¥å¯¹è±¡ä¸ºå•ä½(object size)**åœ¨ç®¡ç†çš„å†…å­˜ä¸­å¿«é€ŸæŸ¥æ‰¾å¾…åˆ†é…çš„ç©ºé—´

![mspan-and-objects](picture/goè¯­è¨€è¦ç‚¹/2020-02-29-15829868066499-mspan-and-objects.png)

å½“mspanç®¡ç†çš„å†…å­˜ä¸è¶³ä»¥å®Œæˆæ–°å¯¹è±¡çš„åˆ†é…æ—¶ï¼Œruntimeä¼š**ä»¥é¡µä¸ºå•ä½å‘mheapç”³è¯·å†…å­˜**

![mspan-and-pages](picture/goè¯­è¨€è¦ç‚¹/2020-02-29-15829868066492-mspan-and-pages.png)



#### mcache

mcacheä¸TCMallocä¸­çš„ThreadCacheç±»ä¼¼ï¼ŒæŒ‰spanClassåˆ’åˆ†ï¼Œæ¯ä¸ªçº¿ç¨‹ï¼ˆPï¼‰æŒæœ‰ 67 * 2 = 134 ä¸ª`runtime.mspan`ï¼Œmcacheå¯ä»¥æ— é”è®¿é—®ï¼Œ**å¾®å¯¹è±¡å’Œå°å¯¹è±¡(<=32KB)ç›´æ¥ä»mcacheç®¡ç†çš„mspanåˆ†é…å†…å­˜**ã€‚mcacheä¾ç„¶æ˜¯å±äºå †çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºåŠ¨æ€æ•°æ®

runtimeåœ¨åˆå§‹åŒ–Pæ—¶ï¼Œä¼šè°ƒç”¨runtime.allocmcacheåˆå§‹åŒ–çº¿ç¨‹ç¼“å­˜ï¼Œä¼šåœ¨ç³»ç»Ÿæ ˆä¸­ä½¿ç”¨`runtime.mheap`çš„çº¿ç¨‹ç¼“å­˜åˆ†é…å™¨åˆå§‹åŒ–å‡ºä¸€ä¸ªæ–°çš„`runtime.mcache`

`runtime.mcache.refill(spc spanClass)`ä¼šä¸ºmcacheè·å–ä¸€ä¸ªæŒ‡å®šè·¨åº¦ç±»çš„mspanï¼Œæ›¿æ¢æ‰è‡ªå·±è¿™ä¸ªè·¨åº¦ç±»æœ¬æ¥çš„mspanï¼Œè¢«æ›¿æ¢çš„mspanä¸èƒ½åŒ…å«ç©ºé—²ç©ºé—´ï¼Œè·å–çš„mspanå¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªç©ºé—²ç©ºé—´ç”¨äºå¯¹è±¡åˆ†é…



mcacheä¸­è¿˜æœ‰ç”¨äºåˆ†é…å¾®å¯¹è±¡çš„å­—æ®µï¼Œä¸“é—¨ç®¡ç†**16Bä»¥ä¸‹çš„éæŒ‡é’ˆç±»å‹çš„å¯¹è±¡**

```go
type mcache struct {
    alloc [numSpanClasses]*mspan // æŒ‰spanClassåˆ†ç±»çš„mspanï¼ŒnumSpanClasses = _NumSizeClasses << 1 = 67 << 1
    
    
    // å¾®å¯¹è±¡åˆ†é…ç›¸å…³
	tiny             uintptr	// å†…å­˜çš„èµ·å§‹åœ°å€
	tinyoffset       uintptr	// ä¸‹ä¸€ä¸ªç©ºé—²å†…å­˜çš„åç§»é‡
	local_tinyallocs uintptr	// åˆ†é…çš„å¯¹è±¡ä¸ªæ•°
}
```





#### mcentral

mcentralä¸TCMallocä¸­çš„CentralCacheç±»ä¼¼ï¼Œ**æ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ç¼“å­˜ï¼Œéœ€è¦åŠ é”è®¿é—®**

mspanæŒ‰è‡ªå·±ç®¡ç†çš„spanClassè·¨åº¦ç±»è¿›è¡Œå½’ç±»ï¼Œç”±å¯¹åº”çš„mcentralè¿›è¡Œç®¡ç†ï¼Œæ‰€ä»¥ä¹Ÿæœ‰ 134 ä¸ª mcentral

```go
type mcentral struct {
	spanclass spanClass		// æ‰€ç®¡ç†çš„mspançš„spanClass
    
    
    // Go115ä¹‹å
	partial  [2]spanSet		// æœ‰ç©ºé—²å¯¹è±¡çš„spansï¼šåŒ…å«æ‰«æè¿‡çš„å’Œæœªæ‰«æçš„
	full     [2]spanSet		// æ— ç©ºé—²å¯¹è±¡çš„spansï¼šåŒ…å«æ‰«æè¿‡çš„å’Œæœªæ‰«æçš„
    
    // Go115ä¹‹å‰
    nonempty mSpanList // list of spans with a free object, ie a nonempty free list
	empty    mSpanList // list of spans with no free objects (or cached in an mcache)
}
```

å½“mcacheçš„æŸä¸ªçº§åˆ«mspançš„å†…å­˜ä¸å¤Ÿåˆ†é…æ—¶ï¼Œå®ƒä¼šå‘mcentralç”³è¯·1ä¸ªå¯¹åº”spanClassçš„mspanï¼š

- é¦–å…ˆä»**æœ‰ç©ºé—²ç©ºé—´çš„ã€æ¸…æ‰«è¿‡çš„**spanSetä¸­æŸ¥æ‰¾å¯ä»¥ä½¿ç”¨çš„å†…å­˜ç®¡ç†å•å…ƒ
- ç„¶åä»**æœ‰ç©ºé—²ç©ºé—´çš„ã€æœªæ¸…æ‰«çš„**spanSetä¸­æŸ¥æ‰¾å¯ä»¥ä½¿ç”¨çš„å†…å­˜ç®¡ç†å•å…ƒ
- ç„¶åä»**æ— ç©ºé—²ç©ºé—´çš„ã€æœªæ¸…æ‰«çš„**spanSetä¸­è·å–å†…å­˜ç®¡ç†å•å…ƒï¼Œå¹¶æ¸…ç†ä»–çš„å†…å­˜ç©ºé—´
- å¦‚æœä»¥ä¸Šå‡å¤±è´¥ï¼Œåˆ™è°ƒç”¨`runtime.mcentral.grow`ä»å †ä¸­ç”³è¯·æ–°çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œå †æ ¹æ®**npageså’ŒsizeClass**ä¸ºmcentralåˆ†é…æ–°çš„mspan

æ— è®ºå“ªä¸€æ­¥æˆåŠŸï¼Œè·å–åˆ°mspanä¹‹åï¼Œæœ€åéƒ½æ›´æ–°mspanä¸­çš„allocBitså’ŒallocCacheç­‰å­—æ®µï¼Œè®©runtimeåœ¨åˆ†é…å†…å­˜æ—¶å¯ä»¥å¿«é€Ÿæ‰¾åˆ°ç©ºé—²å¯¹è±¡



> Go115ä¹‹å‰ï¼Œmcacheæ˜¯**ä¸ºmspanç»´æŠ¤2ä¸ªé“¾è¡¨**ï¼Œè¿™**å’Œmcacheç”³è¯·å†…å­˜æœ‰å…³**
>
> - `empty`ï¼šemptyé“¾è¡¨å­˜æ”¾çš„æ˜¯æ²¡æœ‰ç©ºé—²å¯¹è±¡çš„å½“å‰sizeclassçš„mspanï¼Œå½“æ­¤å¤„çš„**mspanè¢«é‡Šæ”¾æ—¶**ï¼Œä¼šè¢«ç§»åŠ¨åˆ° `non-empty` é“¾è¡¨
> - `non-empty`ï¼šæœ‰ç©ºé—²å¯¹è±¡çš„é“¾è¡¨ï¼Œå½“ä»mcentralç”³è¯·æ–°çš„spanæ—¶ï¼Œé¦–å…ˆä»è¯¥é“¾è¡¨ä¸­è·å–spanï¼Œç„¶åç§»å…¥ `empty`é“¾è¡¨



#### mheap

mheapæ˜¯å†…å­˜åˆ†é…çš„æ ¸å¿ƒç»“æ„ä½“ï¼ŒGoè¯­è¨€ç¨‹åºå°†å…¶ä½œä¸ºå…¨å±€å˜é‡å­˜å‚¨ï¼Œå †ä¸Šåˆå§‹åŒ–çš„å¯¹è±¡éƒ½æœ‰è¯¥ç»“æ„ä½“ç»Ÿä¸€è¿›è¡Œç®¡ç†

mheapåŒ…å«äº†é•¿åº¦ä¸º134çš„`mcentral`çš„åˆ—è¡¨ï¼Œä»¥åŠç®¡ç†å †åŒºå†…å­˜çš„`arenas`

```go
type mheap struct {
    central [numSpanClasses]struct {		// 134ä¸ªmcentral
		mcentral mcentral
		pad      [cpu.CacheLinePadSize - unsafe.Sizeof(mcentral{})%cpu.CacheLinePadSize]byte
	}
	arenas [1 << arenaL1Bits]*[1 << arenaL2Bits]*heapArena  // heapArena
}
```

æ¯ä¸ªheapAreaç®¡ç†64MBçš„å†…å­˜(64ä½éwindowså¹³å°)

mheapä¸TCMallocä¸­çš„PageHeapç±»ä¼¼ï¼Œ**å®ƒæ˜¯å †å†…å­˜çš„æŠ½è±¡ï¼ŒæŠŠä»OSç”³è¯·å‡ºçš„å†…å­˜é¡µç»„ç»‡æˆSpanï¼Œå¹¶ä¿å­˜èµ·æ¥**ã€‚å½“mcentralçš„Spanä¸å¤Ÿç”¨æ—¶ä¼šå‘mheapç”³è¯·ï¼Œmheapçš„Spanä¸å¤Ÿç”¨æ—¶ä¼šå‘OSç”³è¯·ï¼Œå‘OSçš„å†…å­˜ç”³è¯·æ˜¯æŒ‰é¡µæ¥çš„ï¼Œç„¶åæŠŠç”³è¯·æ¥çš„å†…å­˜é¡µæŒ‰spançš„sizeclassç”ŸæˆSpanç»„ç»‡èµ·æ¥ï¼ŒåŒæ ·ä¹Ÿæ˜¯éœ€è¦åŠ é”è®¿é—®çš„ã€‚



ä¸ºäº†é˜²æ­¢å†…å­˜çš„å¤§é‡å ç”¨å’Œå †å¢é•¿ï¼Œåœ¨å‘OSç”³è¯·å†…å­˜é¡µæ—¶ï¼Œè¦å…ˆè°ƒç”¨`runtime.mheap.reclaim`æ–¹æ³•å›æ”¶ä¸€éƒ¨åˆ†å†…å­˜ï¼Œéšåé€šè¿‡`mheap.allocSpan`åˆ†é…mspanï¼š

- é¦–å…ˆ**åœ¨å †ä¸Šåˆ†é…npagesæ•°é‡çš„å†…å­˜é¡µ**
- å¦‚æœå †ä¸Šåˆ†é…npagesçš„å†…å­˜é¡µå¤±è´¥ï¼Œæ‰ä¼š**å‘OSç”³è¯·å†…å­˜é¡µ**(`runtime.mheap.grow`)
- ç„¶åå°†è¿™äº›å†…å­˜é¡µåˆå§‹åŒ–ä¸º`mspan`è¿”å›ã€‚



mheapé‡Œä¿å­˜äº†2æ£µ**äºŒå‰æ’åºæ ‘**ï¼ŒæŒ‰spançš„pageæ•°é‡è¿›è¡Œæ’åºï¼š

1. `free`ï¼šfreeä¸­ä¿å­˜çš„spanæ˜¯ç©ºé—²å¹¶ä¸”éåƒåœ¾å›æ”¶çš„spanã€‚
2. `scav`ï¼šscavä¸­ä¿å­˜çš„æ˜¯ç©ºé—²å¹¶ä¸”å·²ç»åƒåœ¾å›æ”¶çš„spanã€‚

å¦‚æœæ˜¯åƒåœ¾å›æ”¶å¯¼è‡´çš„spané‡Šæ”¾ï¼Œspanä¼šè¢«åŠ å…¥åˆ°`scav`ï¼Œå¦åˆ™åŠ å…¥åˆ°`free`ï¼Œæ¯”å¦‚åˆšä»OSç”³è¯·çš„çš„å†…å­˜ä¹Ÿç»„æˆçš„Spanã€‚

<img src="picture/goè¯­è¨€è¦ç‚¹/2019-07-go-mheap.png" alt="mheap" style="zoom: 67%;" />

å½“mheapæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜æ—¶ï¼Œmheapä¼šå‘OSç”³è¯·å†…å­˜ï¼ŒæŠŠç”³è¯·çš„å†…å­˜é¡µä¿å­˜åˆ°spanï¼Œç„¶åæŠŠspanæ’å…¥åˆ°`free`æ ‘ ã€‚

åœ¨32ä½ç³»ç»Ÿä¸Šï¼Œmheapè¿˜ä¼šé¢„ç•™ä¸€éƒ¨åˆ†ç©ºé—´ï¼Œå½“mheapæ²¡æœ‰ç©ºé—´æ—¶ï¼Œå…ˆä»é¢„ç•™ç©ºé—´ç”³è¯·ï¼Œå¦‚æœé¢„ç•™ç©ºé—´å†…å­˜ä¹Ÿæ²¡æœ‰äº†ï¼Œæ‰å‘OSç”³è¯·ã€‚





### 2.3 å¯¹è±¡å¤§å°è½¬æ¢

> ```go
> numSpanClasses = _NumSizeClasses << 1
> _NumSizeClasses = 68
> ```
>
> 

<img src="picture/goè¯­è¨€è¦ç‚¹/Goå†…å­˜å¤§å°è½¬æ¢.png" alt="Goå†…å­˜å¤§å°è½¬æ¢" style="zoom: 50%;" />

sizeè½¬æ¢æ˜¯æ²¡æœ‰å›ºå®šçš„è®¡ç®—è§„å¾‹çš„ï¼Œç›´æ¥è¿›è¡Œäº†ç¡¬ç¼–ç ï¼Œé€šè¿‡æŸ¥è¡¨å¾—åˆ°ï¼š

`size-class`ï¼šä»1åˆ°66(ä»8Båˆ°32KB)ï¼Œä¸€å…±æœ‰66ä¸ªï¼ŒåŠ ä¸Šæœªä½¿ç”¨çš„ size class 0ï¼Œå®é™…ä¸Šæœ‰67ä¸ª

`span-class`ï¼šä¸€ä¸ªsizeClasså¯¹åº”ä¸¤ä¸ªspan-classï¼Œæ‰€ä»¥span-classæœ‰134ä¸ªï¼Œä»0åˆ°133ï¼Œæ¯ä¸ªspan classæŒ‡å‘ä¸€ä¸ªspanï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªmcacheæœ‰æœ€å¤š134ä¸ª span class é“¾è¡¨

![Sizeè½¬æ¢](picture/goè¯­è¨€è¦ç‚¹/Sizeè½¬æ¢.png)



### 2.4 Goå†…å­˜åˆ†é…

![Goå†…å­˜å¯¹è±¡åˆ†ç±»](picture/goè¯­è¨€è¦ç‚¹/Goå†…å­˜å¯¹è±¡åˆ†ç±».png)

Goä¸­çš„å†…å­˜åˆ†ç±»å¹¶ä¸åƒTCMallocé‚£æ ·åˆ†æˆå°ã€ä¸­ã€å¤§å¯¹è±¡ï¼Œä½†æ˜¯å®ƒçš„å°å¯¹è±¡é‡Œåˆç»†åˆ†äº†ä¸€ä¸ªTinyå¯¹è±¡ï¼ŒTinyå¯¹è±¡æŒ‡å¤§å°åœ¨1Byteåˆ°16Byteä¹‹é—´å¹¶ä¸”ä¸åŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ã€‚å°å¯¹è±¡å’Œå¤§å¯¹è±¡åªç”¨å¤§å°åˆ’å®šï¼Œæ— å…¶ä»–åŒºåˆ†ã€‚

å°å¯¹è±¡æ˜¯åœ¨mcacheä¸­åˆ†é…çš„ï¼Œè€Œå¤§å¯¹è±¡æ˜¯ç›´æ¥ä»mheapåˆ†é…çš„

#### å¾®å¯¹è±¡çš„åˆ†é…

**å¾®å¯¹è±¡(<16Bï¼Œä¸å¯ä»¥æ˜¯æŒ‡é’ˆç±»å‹)**ï¼šç›´æ¥åœ¨å¾®åˆ†é…å™¨åˆ†é…ï¼Œåªæœ‰16å­—èŠ‚çš„å†…å­˜å—ã€‚å¦‚å›¾å¦‚æœåˆ†é…äº†12å­—èŠ‚ï¼Œä¸‹ä¸€ä¸ªå¾®å¯¹è±¡å°äº4å­—èŠ‚æ‰ä¼šåˆ†é…åˆ°å‰©ä½™éƒ¨åˆ†ï¼Œå¦åˆ™å½“æˆå°å¯¹è±¡åˆ†é…äº†

å¾®å¯¹è±¡ä¸»è¦æ˜¯ï¼š**å°å­—ç¬¦ä¸²å’Œé€ƒé€¸çš„å¾®å°å¯¹è±¡**ï¼ˆæœªé€ƒé€¸ç›´æ¥æ ˆä¸Šåˆ†é…äº†ï¼‰

![tiny-allocator](picture/goè¯­è¨€è¦ç‚¹/2020-02-29-15829868066543-tiny-allocator.png)

#### å°å¯¹è±¡çš„åˆ†é…

**å°å¯¹è±¡(<32KB)**ï¼šé¦–å…ˆç¡®å®šå¯¹è±¡å¤§å°ä»¥åŠè·¨åº¦ç±»(spanClass)ï¼Œç„¶ååœ¨mspanä¸­è¿›è¡Œåˆ†é…ï¼š

<img src="picture/goè¯­è¨€è¦ç‚¹/Spanå†…å¯¹è±¡.png" alt="Spanå†…å¯¹è±¡" style="zoom: 67%;" />

éšç€å†…å­˜çš„åˆ†é…ï¼Œspanä¸­çš„å¯¹è±¡å†…å­˜å—ï¼Œæœ‰äº›è¢«å ç”¨ï¼Œæœ‰äº›æœªè¢«å ç”¨ï¼Œæ¯”å¦‚ä¸Šå›¾ï¼Œæ•´ä½“ä»£è¡¨1ä¸ªspanï¼Œè“è‰²å—ä»£è¡¨å·²è¢«å ç”¨å†…å­˜ï¼Œç»¿è‰²å—ä»£è¡¨æœªè¢«å ç”¨å†…å­˜ã€‚å½“åˆ†é…å†…å­˜æ—¶ï¼Œåªè¦å¿«é€Ÿæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨çš„ç»¿è‰²å—(é€šè¿‡ä½å›¾)ï¼Œå¹¶è®¡ç®—å‡ºå†…å­˜åœ°å€å³å¯ï¼Œå¦‚æœéœ€è¦è¿˜å¯ä»¥å¯¹å†…å­˜å—æ•°æ®æ¸…é›¶ã€‚

åˆ†é…å®Œä¹‹åæ›´æ–°allocCacheå’Œfreeindexç­‰å­—æ®µã€‚



åœ¨mspanä¸­åˆ†é…æ—¶ï¼Œæœ‰ä¸¤ä¸ªåˆ†é…æ–¹æ³•ï¼š`nextFreeFast`å’Œ`nextFree`

- `nextFreeFast`ä¼šç›´æ¥åœ¨å½“å‰mspanä¸­é€šè¿‡allocCacheä½å›¾æŸ¥æ‰¾åˆ°ç©ºé—²ä½ï¼Œè®¡ç®—å¯¹åº”åœ°å€ï¼Œè¿›è¡Œåˆ†é…ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç©ºé—²å†…å­˜ï¼Œå°±è¦è°ƒç”¨nextFreeäº†
- `nextFree`è´Ÿè´£æ‰¾åˆ°æ–°çš„å†…å­˜ç®¡ç†å•å…ƒï¼šè°ƒç”¨`refill`å»mcentralä¸­ä¸ºmcacheåˆ†é…æ–°çš„mspanï¼Œç„¶ååœ¨è¿›è¡Œåˆ†é…



#### å¤§å¯¹è±¡çš„åˆ†é…

**å¤§å¯¹è±¡(>32KB)**ï¼šä¼šå•ç‹¬å¤„ç†ï¼Œä¸ä¼šä»mcacheå’Œmcentralä¸­è·å–mspanï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨`runtime.mcache.allocLarge`åˆ†é…å¤§ç‰‡å†…å­˜

è¯¥æ–¹æ³•ä¼šè®¡ç®—åˆ†é…è¯¥å¯¹è±¡æ‰€éœ€è¦çš„é¡µæ•°ï¼Œç„¶åæŒ‰ç…§8KBçš„å€æ•°åœ¨å †ä¸Šç”³è¯·å†…å­˜ï¼Œç”³è¯·æ—¶åˆ›å»ºä¸€ä¸ª**è·¨åº¦ç±»ä¸º0çš„spanClass**ï¼Œå¹¶åˆ†é…ä¸€ä¸ªmspanç®¡ç†è¿™ä¸ªè·¨åº¦ç±»





### 2.5 å¯¹è±¡é‡Šæ”¾

Goä½¿ç”¨åƒåœ¾å›æ”¶æ”¶é›†ä¸å†ä½¿ç”¨çš„spanï¼Œè°ƒç”¨`mspan.scavenge()`æŠŠspané‡Šæ”¾ç»™OSï¼ˆå¹¶éçœŸé‡Šæ”¾ï¼Œåªæ˜¯å‘Šè¯‰OSè¿™ç‰‡å†…å­˜çš„ä¿¡æ¯æ— ç”¨äº†ï¼Œå¦‚æœä½ éœ€è¦çš„è¯ï¼Œæ”¶å›å»å¥½äº†ï¼‰ï¼Œç„¶åäº¤ç»™mheapï¼Œmheapå¯¹spanè¿›è¡Œspançš„åˆå¹¶ï¼ŒæŠŠåˆå¹¶åçš„spanåŠ å…¥`scav`æ ‘ä¸­ï¼Œç­‰å¾…å†åˆ†é…å†…å­˜æ—¶ï¼Œç”±mheapè¿›è¡Œå†…å­˜å†åˆ†é…



æ³¨æ„ï¼ŒGCåªæ˜¯ç»™å†…æ ¸æä¾›ä¸€ä¸ªå»ºè®®ï¼š**è¿™ä¸ªå†…å­˜åœ°å€åŒºé—´çš„å†…å­˜å·²ç»ä¸å†ä½¿ç”¨ï¼Œå¯ä»¥å›æ”¶ã€‚ä½†å†…æ ¸æ˜¯å¦å›æ”¶ï¼Œä»¥åŠä»€ä¹ˆæ—¶å€™å›æ”¶ï¼Œè¿™å°±æ˜¯å†…æ ¸çš„äº‹æƒ…äº†**ã€‚å¦‚æœå†…æ ¸çœŸæŠŠè¿™ç‰‡å†…å­˜å›æ”¶äº†ï¼Œå½“Goç¨‹åºå†ä½¿ç”¨è¿™ä¸ªåœ°å€æ—¶ï¼Œå†…æ ¸ä¼šé‡æ–°è¿›è¡Œè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ã€‚æ‰€ä»¥åœ¨å†…å­˜å……è¶³çš„æƒ…å†µä¸‹ï¼Œå†…æ ¸ä¹Ÿæ²¡æœ‰å¿…è¦ç«‹åˆ»å›æ”¶å†…å­˜



## 3. GoGC

ä¼ ç»Ÿç¼–ç¨‹è¯­è¨€(c/c++)éœ€è¦æ‰‹åŠ¨é‡Šæ”¾å†…å­˜ï¼Œå­˜åœ¨å†…å­˜æ³„æ¼æˆ–è€…è¯¯é‡Šæ”¾å†…å­˜çš„é—®é¢˜ã€‚åæ¥çš„å˜æˆéœ€è¦éƒ½å¼•å…¥äº†è¯­è¨€å±‚é¢çš„è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œå†…å­˜çš„é‡Šæ”¾ç”±`è™šæ‹Ÿæœº(VM)`æˆ–è€…`è¿è¡Œæ—¶(runtime)`è‡ªåŠ¨è¿›è¡Œ



### 3.1 å¸¸è§GCç®—æ³•å’ŒGoGC

- **æ ‡è®°æ¸…é™¤ï¼š** ä»æ ¹å¯¹è±¡å‡ºå‘ï¼Œå°†ç¡®å®šå­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œå¹¶æ¸…é™¤å¯ä»¥å›æ”¶çš„å¯¹è±¡ã€‚ç®€å•å¿«é€Ÿï¼Œä½†ä¼šé€ æˆå†…å­˜ç¢ç‰‡ï¼Œå¯¼è‡´å¤§å¯¹è±¡åˆ›å»ºä¸äº†ã€‚
- **å¤åˆ¶ç®—æ³•ï¼š** å†…å­˜åˆ†ä¸ºå¤§å°ç›¸åŒçš„ä¸¤å—ï¼Œåªä½¿ç”¨ä¸€å—ï¼Œäº’ç›¸å¤åˆ¶ã€‚è§£å†³äº†ç¢ç‰‡é—®é¢˜ï¼Œä½†æ˜¯æµªè´¹èµ„æºï¼Œä¸”ç§»åŠ¨è€—è´¹æ—¶é—´ï¼Œæ•ˆç‡ä½
- **æ ‡è®°æ•´ç†ï¼š** ä¸ºäº†è§£å†³å†…å­˜ç¢ç‰‡é—®é¢˜è€Œæå‡ºï¼Œåœ¨æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œå°†å¯¹è±¡å°½å¯èƒ½æ•´ç†åˆ°ä¸€å—è¿ç»­çš„å†…å­˜ä¸Šã€‚æ€§èƒ½ä½ã€‚
- **åˆ†ä»£å¼ï¼š** å°†å¯¹è±¡æ ¹æ®å­˜æ´»æ—¶é—´çš„é•¿çŸ­è¿›è¡Œåˆ†ç±»ï¼Œå­˜æ´»æ—¶é—´å°äºæŸä¸ªå€¼çš„ä¸ºå¹´è½»ä»£ï¼Œå­˜æ´»æ—¶é—´å¤§äºæŸä¸ªå€¼çš„ä¸ºè€å¹´ä»£ï¼Œæ°¸è¿œä¸ä¼šå‚ä¸å›æ”¶çš„å¯¹è±¡ä¸ºæ°¸ä¹…ä»£ã€‚å¹¶æ ¹æ®åˆ†ä»£å‡è®¾ï¼ˆå¦‚æœä¸€ä¸ªå¯¹è±¡å­˜æ´»æ—¶é—´ä¸é•¿åˆ™å€¾å‘äºè¢«å›æ”¶ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡å·²ç»å­˜æ´»å¾ˆé•¿æ—¶é—´åˆ™å€¾å‘äºå­˜æ´»æ›´é•¿æ—¶é—´ï¼‰å¯¹å¯¹è±¡è¿›è¡Œå›æ”¶ã€‚
- **å¼•ç”¨è®¡æ•°ï¼š** æ ¹æ®å¯¹è±¡è‡ªèº«çš„å¼•ç”¨è®¡æ•°æ¥å›æ”¶ï¼Œå½“å¼•ç”¨è®¡æ•°å½’é›¶æ—¶ç«‹å³å›æ”¶ã€‚è®¡æ•°é¢‘ç¹æ›´æ–°ä¼šå¸¦æ¥å¾ˆå¤šé¢å¤–å¼€é”€ï¼Œæ— æ³•è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚



**GCçš„éš¾ç‚¹**åœ¨äºï¼Œæ— æ³•é¢„æ–™ç¨‹åºæ˜¯å¦æ˜¯æš‚åœæ—¶é—´æ•æ„Ÿçš„(æ‰¹å¤„ç†ä½œä¸šè¿˜æ˜¯äº¤äº’å¼ç¨‹åº)ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä¸ºäº†å¹³è¡¡ï¼Œæœ€å¥½ä½¿ç”¨ä¸€ç§ååé‡æœ€å¤§åŒ–çš„ç®—æ³•ï¼Œå³æœ‰ç”¨å·¥ä½œä¸ç”¨äºåƒåœ¾å›æ”¶çš„æ—¶é—´ä¹‹æ¯”ã€‚æ²¡æœ‰ä¸€ç§åƒåœ¾å›æ”¶ç®—æ³•æ˜¯å„æ–¹é¢éƒ½å®Œç¾çš„ã€‚



Goç¨‹åºé€šå¸¸æ˜¯è¯·æ±‚/å“åº”å¤„ç†ï¼Œå¦‚HTTPæœåŠ¡å™¨ï¼Œè¡¨ç°å‡ºå¼ºçƒˆçš„åˆ†ä»£æ”¶é›†è¡Œä¸ºï¼Œä½†æ˜¯Goå¹¶æ²¡æœ‰é‡‡ç”¨åˆ†ä»£ï¼Œè€Œæ˜¯ç”¨äº†å¤è€çš„æ ‡è®°æ¸…é™¤ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥è·å¾—**éå¸¸çŸ­çš„æš‚åœæ—¶é—´**ã€‚ä½†æ˜¯æ¯è½®GCéƒ½éœ€è¦å¤§é‡å·¥ä½œï¼Œååé‡ä¼šé™ä½ã€‚è€Œä¸”ä¸ºäº†é¿å…å‡ºç°**å¹¶å‘æ¨¡å¼æ•…éšœ**(åƒåœ¾ç”Ÿäº§é€Ÿåº¦å¤§äºGCæ¸…ç†é€Ÿåº¦)ï¼ŒGoé»˜è®¤å †å¼€é”€ä¸º100%ï¼Œä½¿ç¨‹åºæ‰€éœ€å†…å­˜å¢åŠ ä¸€å€ã€‚



ç›®å‰Goè¯­è¨€ä½¿ç”¨çš„æ˜¯ï¼š**æ— åˆ†ä»£ã€ä¸æ•´ç†ã€å¹¶å‘** çš„ä¸‰è‰²æ ‡è®°ç®—æ³•

æ— åˆ†ä»£ï¼šGo çš„ç¼–è¯‘å™¨ä¼šé€šè¿‡**é€ƒé€¸åˆ†æ**å°†**å¤§éƒ¨åˆ†æ–°ç”Ÿå¯¹è±¡å­˜å‚¨åœ¨æ ˆä¸Š**ï¼ˆå½“ goroutine æ­»äº¡åæ ˆä¹Ÿä¼šè¢«ç›´æ¥å›æ”¶ï¼‰ï¼Œåªæœ‰é‚£äº›éœ€è¦é•¿æœŸå­˜åœ¨çš„å¯¹è±¡æ‰ä¼šè¢«åˆ†é…åˆ°éœ€è¦è¿›è¡Œåƒåœ¾å›æ”¶çš„å †ä¸­ã€‚åˆ†ä»£ä¼šæ¶ˆè€—é¢å¤–çš„èµ‹å€¼å™¨æ—¶é—´ï¼ŒGoå›¢é˜Ÿè®¤ä¸ºä¸‹ä¸€ä¸ª10å¹´å†…å­˜ä¼šæ¯”CPUå¢é•¿å¿«çš„å¤šï¼Œæ‰€ä»¥ä¸å…è®¸æ¶ˆè€—ä¸€ç‚¹CPUã€‚

ä¸æ•´ç†ï¼šæ•´ç†æ˜¯ä¸ºäº†è§£å†³å†…å­˜ç¢ç‰‡é—®é¢˜ä»¥åŠâ€œå…è®¸â€ä½¿ç”¨é¡ºåºå†…å­˜åˆ†é…å™¨ã€‚ä½† Go è¿è¡Œæ—¶çš„åˆ†é…ç®—æ³•åŸºäº **tcmalloc**ï¼ŒåŸºæœ¬ä¸Šæ²¡æœ‰ç¢ç‰‡é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜å¯¹äºGoæ¥è®²ä¸€ç‚¹éƒ½ä¸éœ€è¦æ‹…å¿ƒ



### 3.2 ä¸‰è‰²æ ‡è®°æ³•åŸç†

ä¸‰è‰²æ ‡è®°ç®—æ³•ï¼š

![ä¸‰è‰²æ ‡è®°](picture/goè¯­è¨€è¦ç‚¹/ä¸‰è‰²æ ‡è®°.png)

- **é»‘è‰²å¯¹è±¡ï¼šç¡®å®šå­˜æ´»çš„å¯¹è±¡**ï¼Œå·²è¢«å›æ”¶å™¨è®¿é—®åˆ°çš„å¯¹è±¡ï¼Œå…¶ä¸­æ‰€æœ‰çš„å­—æ®µéƒ½å·²è¢«æ‰«æï¼é»‘è‰²å¯¹è±¡ä¸­çš„ä»»ä½•ä¸€ä¸ªæŒ‡é’ˆéƒ½ä¸å¯èƒ½ç›´æ¥æŒ‡å‘ç™½è‰²å¯¹è±¡
- **ç°è‰²å¯¹è±¡ï¼šæ³¢é¢ï¼Œå·²è¢«å›æ”¶å™¨è®¿é—®åˆ°çš„å¯¹è±¡**ï¼Œä½†æ˜¯å›æ”¶å™¨è¿˜å¾—å¯¹å…¶ä¸­çš„æŒ‡é’ˆè¿›è¡Œæ‰«æï¼Œå› ä¸ºè¿™äº›æŒ‡é’ˆå¯èƒ½æŒ‡å‘å½“å‰çš„æŸäº›ç™½è‰²å¯¹è±¡
- **ç™½è‰²å¯¹è±¡ï¼šæœªè¢«å›æ”¶å™¨è®¿é—®åˆ°çš„å¯¹è±¡**ï¼Œå›æ”¶å¼€å§‹æ—¶æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ç™½è‰²ï¼Œç­‰æ ‡è®°ç»“æŸåï¼Œç™½è‰²å¯¹è±¡å°±æ˜¯ä¸å¯è¾¾çš„åƒåœ¾å¯¹è±¡

åƒåœ¾å›æ”¶çš„è¿‡ç¨‹å¯ä»¥ç†è§£ä¸ºæ³¢é¢ä¸æ–­å‰è¿›çš„è¿‡ç¨‹ã€‚åƒåœ¾å›æ”¶**å¼€å§‹æ—¶åªæœ‰ç™½è‰²å¯¹è±¡**ï¼Œå½“**ä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹æ‰«æå®Œåï¼Œè¯¥èŠ‚ç‚¹ä¼šå˜æˆé»‘è‰²èŠ‚ç‚¹**ã€‚ç­‰å †éå†å®Œæˆåï¼Œåªæœ‰é»‘è‰²èŠ‚ç‚¹ä¸ç™½è‰²èŠ‚ç‚¹ï¼Œé»‘è‰²ä¸ºå¯åˆ°è¾¾å¯¹è±¡ï¼Œå³å­˜æ´»ï¼Œç™½è‰²ä¸ºä¸å¯åˆ°è¾¾å¯¹è±¡ï¼Œå³æ­»äº¡ã€‚

1. å¼€å§‹ï¼šæ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ç™½è‰²
2. ä»æ ¹å¯¹è±¡å‡ºå‘ï¼Œæ‰«ææ‰€æœ‰å¯è¾¾å¯¹è±¡ï¼Œæ ‡è®°ä¸ºç°è‰²ï¼Œæ”¾å…¥å¾…å¤„ç†é˜Ÿåˆ—
3. ä»å¾…å¤„ç†é˜Ÿåˆ—å–å‡ºç°è‰²å¯¹è±¡ï¼Œå°†å…¶å¼•ç”¨çš„å¯¹è±¡ä¹Ÿæ ‡è®°ä¸ºç°è‰²å¹¶æ”¾å…¥å¾…å¤„ç†é˜Ÿåˆ—ä¸­ï¼Œå®Œæˆåå°†è‡ªèº«æ ‡è®°ä¸ºé»‘è‰²
4. é‡å¤3ï¼Œç›´åˆ°å¾…å¤„ç†é˜Ÿåˆ—ç©ºï¼Œæ­¤æ—¶çš„ç™½è‰²å¯¹è±¡å³ä¸ºä¸å¯è¾¾çš„åƒåœ¾

>æ ¹å¯¹è±¡åœ¨åƒåœ¾å›æ”¶çš„æœ¯è¯­ä¸­åˆå«åšæ ¹é›†åˆï¼Œå®ƒæ˜¯åƒåœ¾å›æ”¶å™¨åœ¨æ ‡è®°è¿‡ç¨‹æ—¶æœ€å…ˆæ£€æŸ¥çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬ï¼š 
>
>ï¼ˆ1ï¼‰å…¨å±€å˜é‡ï¼šç¨‹åºåœ¨ç¼–è¯‘æœŸå°±èƒ½ç¡®å®šçš„é‚£äº›å­˜åœ¨äºç¨‹åºæ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„å˜é‡ã€‚ 
>
>ï¼ˆ2ï¼‰æ‰§è¡Œæ ˆï¼šæ¯ä¸ª goroutine éƒ½åŒ…å«è‡ªå·±çš„æ‰§è¡Œæ ˆï¼Œè¿™äº›æ‰§è¡Œæ ˆä¸ŠåŒ…å«æ ˆä¸Šçš„å˜é‡åŠæŒ‡å‘åˆ†é…çš„å †å†…å­˜åŒºå—çš„æŒ‡é’ˆã€‚ 
>
>ï¼ˆ3ï¼‰å¯„å­˜å™¨ï¼šå¯„å­˜å™¨çš„å€¼å¯èƒ½è¡¨ç¤ºä¸€ä¸ªæŒ‡é’ˆï¼Œå‚ä¸è®¡ç®—çš„è¿™äº›æŒ‡é’ˆå¯èƒ½æŒ‡å‘æŸäº›èµ‹å€¼å™¨åˆ†é…çš„å †å†…å­˜åŒºå—



### 3.3 å±éšœæœºåˆ¶

#### 1. æ²¡æœ‰STWå­˜åœ¨çš„é—®é¢˜

åƒåœ¾å›æ”¶åŸåˆ™æ˜¯ä¸å‡ºç°å¯¹è±¡çš„ä¸¢å¤±ï¼Œä¸é”™è¯¯å›æ”¶ä¸éœ€è¦å›æ”¶çš„å¯¹è±¡ã€‚

> å¦‚æœæ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ï¼Œ**ä¼šç ´ååƒåœ¾å›æ”¶åŸåˆ™**ï¼Œå‡ºç°å¯¹è±¡ä¸¢å¤±
>
> 1. èµ‹å€¼å™¨ä¿®æ”¹å¯¹è±¡å›¾ï¼Œå¯¼è‡´ä¸€é»‘è‰²å¯¹è±¡çªç„¶å¼•ç”¨ç™½è‰²å¯¹è±¡(ç™½è‰²è¢«æŒ‚åœ¨é»‘è‰²ä¸‹)
> 2. ä»ç°è‰²å¯¹è±¡å‡ºå‘ï¼Œåˆ°è¾¾ç™½è‰²å¯¹è±¡ä¸”æœªç»è®¿é—®çš„è·¯å¾„è¢«èµ‹å€¼å™¨ç ´å(ç°è‰²åŒæ—¶ä¸¢äº†è¯¥ç™½è‰²)



**æ²¡æœ‰STWçš„ä¾‹å­ï¼š**

å‡è®¾ç°è‰²å¯¹è±¡2(æœªè¢«æ‰«æ)å¼•ç”¨äº†ç™½è‰²å¯¹è±¡3

æ­¤æ—¶é»‘è‰²å¯¹è±¡4(å·²æ‰«æå®Œæ¯•)å¼•ç”¨å¯¹è±¡3çš„åŒæ—¶ï¼Œç°è‰²å¯¹è±¡2åˆ é™¤äº†å¯¹å¯¹è±¡3çš„å¼•ç”¨

é‚£ä¹ˆç™½è‰²å¯¹è±¡3å°±ä¸ä¼šè¢«æ‰«æåˆ°ï¼Œå¯¼è‡´æœ€åå¯¹è±¡3æ˜¯ç™½è‰²ï¼Œè¢«è¯¯å½“åšåƒåœ¾æ¸…é™¤

![NoSTW](picture/goè¯­è¨€è¦ç‚¹/NoSTW.png)

å¯èƒ½çš„è§£å†³åŠæ³•ï¼šæ•´ä¸ªè¿‡ç¨‹STWï¼Œæµªè´¹èµ„æºä¸”å¯¹ç”¨æˆ·ç¨‹åºå½±å“å¤§ï¼Œæ‰€ä»¥å¼•å…¥äº†**å±éšœæœºåˆ¶**

æŠŠå›æ”¶å™¨è§†ä¸ºå¯¹è±¡ï¼ŒæŠŠèµ‹å€¼å™¨è§†ä¸ºå½±å“å›æ”¶å™¨è¿™ä¸€å¯¹è±¡çš„å®é™…è¡Œä¸ºï¼ˆå³å½±å“ GC å‘¨æœŸçš„é•¿çŸ­ï¼‰ï¼Œä»è€Œå¼•å…¥èµ‹å€¼å™¨çš„é¢œè‰²ï¼š

- é»‘è‰²èµ‹å€¼å™¨ï¼šå·²ç»ç”±å›æ”¶å™¨æ‰«æè¿‡ï¼Œä¸ä¼šå†æ¬¡å¯¹å…¶è¿›è¡Œæ‰«æã€‚
- ç°è‰²èµ‹å€¼å™¨ï¼šå°šæœªè¢«å›æ”¶å™¨æ‰«æè¿‡æˆ–å°½ç®¡å·²ç»æ‰«æè¿‡ï¼Œä½†ä»éœ€è¦é‡æ–°æ‰«æã€‚



#### 2. å¼ºå¼±ä¸‰è‰²ä¸å˜å¼

**å¼ºä¸‰è‰²ä¸å˜å¼ï¼š** é»‘è‰²å¯¹è±¡ä¸èƒ½æŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œåªèƒ½æŒ‡å‘ç°è‰²æˆ–é»‘è‰²å¯¹è±¡

<img src="picture/goè¯­è¨€è¦ç‚¹/å¼ºä¸‰è‰²ä¸å˜å¼.png" alt="å¼ºä¸‰è‰²ä¸å˜å¼" style="zoom: 50%;" />

**å¼±ä¸‰è‰²ä¸å˜å¼ï¼š** é»‘è‰²å¯¹è±¡å¯ä»¥æŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œä½†æ­¤ç™½è‰²å¯¹è±¡é“¾è·¯çš„ä¸Šæ¸¸ä¸­å¿…é¡»æœ‰ä¸€ä¸ªç°è‰²å¯¹è±¡(ç™½è‰²å¯¹è±¡å¿…é¡»è¢«ç°è‰²å¯¹è±¡"ä¿æŠ¤")

<img src="picture/goè¯­è¨€è¦ç‚¹/å¼±ä¸‰è‰²ä¸å˜å¼.png" alt="å¼±ä¸‰è‰²ä¸å˜å¼" style="zoom: 25%;" />



ä¸ºäº†éµå¾ªä¸Šè¿°çš„ä¸¤ä¸ªæ–¹å¼,Golangå›¢é˜Ÿåˆæ­¥å¾—åˆ°äº†å¦‚ä¸‹å…·ä½“çš„ä¸¤ç§å±éšœæ–¹å¼â€œæ’å…¥å±éšœâ€, â€œåˆ é™¤å±éšœâ€.



#### 3. æ’å…¥å†™å±éšœ(Dijkstra)-ç°è‰²èµ‹å€¼å™¨

>  Dijkstra å¿…é¡»**ä¸ºæ ˆä¸Šçš„å¯¹è±¡å¢åŠ å†™å±éšœ**æˆ–è€…**åœ¨æ ‡è®°é˜¶æ®µå®Œæˆé‡æ–°å¯¹æ ˆä¸Šçš„å¯¹è±¡è¿›è¡Œæ‰«æ**ï¼Œè¿™ä¸¤ç§æ–¹æ³•å„æœ‰å„çš„ç¼ºç‚¹ï¼Œå‰è€…ä¼šå¤§å¹…åº¦å¢åŠ å†™å…¥æŒ‡é’ˆçš„é¢å¤–å¼€é”€ï¼Œåè€…é‡æ–°æ‰«ææ ˆå¯¹è±¡æ—¶éœ€è¦æš‚åœç¨‹åºï¼Œåƒåœ¾æ”¶é›†ç®—æ³•çš„è®¾è®¡è€…éœ€è¦åœ¨è¿™ä¸¤è€…ä¹‹é—´åšå‡ºæƒè¡¡ã€‚

GO V1.5 é‡‡ç”¨çš„æ–¹æ³• (GO V1.3æ˜¯æ™®é€šæ ‡è®°æ¸…é™¤ï¼Œæ•´ä¸ªè¿‡ç¨‹STWï¼Œæ•ˆç‡æä½)

**å…·ä½“æ“ä½œ**: åœ¨Aå¯¹è±¡å¼•ç”¨Bå¯¹è±¡çš„æ—¶å€™ï¼ŒBå¯¹è±¡è¢«æ ‡è®°ä¸ºç°è‰²ã€‚(å°†BæŒ‚åœ¨Aä¸‹æ¸¸ï¼ŒBå¿…é¡»è¢«æ ‡è®°ä¸ºç°è‰²)

**æ»¡è¶³**: **å¼ºä¸‰è‰²ä¸å˜å¼**. (ä¸å­˜åœ¨é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡çš„æƒ…å†µäº†ï¼Œ å› ä¸ºç™½è‰²ä¼šå¼ºåˆ¶å˜æˆç°è‰²)

>  ç ´åæ¡ä»¶1ï¼ˆ èµ‹å€¼å™¨ä¿®æ”¹å¯¹è±¡å›¾ï¼Œå¯¼è‡´æŸä¸€é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼›ï¼‰å› ä¸ºåœ¨å¯¹è±¡A å¼•ç”¨å¯¹è±¡B çš„æ—¶å€™ï¼ŒB å¯¹è±¡è¢«æ ‡è®°ä¸ºç°è‰²

![dijkstra-insert-write-barrier](picture/goè¯­è¨€è¦ç‚¹/2020-03-16-15843705141840-dijkstra-insert-write-barrier.png)

é»‘è‰²å¯¹è±¡çš„å†…å­˜æ§½æœ‰ä¸¤ç§ä½ç½®, `æ ˆ`å’Œ`å †`. æ ˆç©ºé—´çš„ç‰¹ç‚¹æ˜¯å®¹é‡å°,ä½†æ˜¯**è¦æ±‚å“åº”é€Ÿåº¦å¿«**,å› ä¸ºå‡½æ•°è°ƒç”¨å¼¹å‡ºé¢‘ç¹ä½¿ç”¨, æ‰€ä»¥â€œæ’å…¥å±éšœâ€æœºåˆ¶,åœ¨**æ ˆç©ºé—´çš„å¯¹è±¡æ“ä½œä¸­ä¸ä½¿ç”¨**. è€Œä»…ä»…ä½¿ç”¨åœ¨å †ç©ºé—´å¯¹è±¡çš„æ“ä½œä¸­



Dijkstra æ’å…¥å±éšœçš„å¥½å¤„åœ¨äºå¯ä»¥ç«‹åˆ»å¼€å§‹å¹¶å‘æ ‡è®°ã€‚ä½†å­˜åœ¨ä¸¤ä¸ªç¼ºç‚¹ï¼š

- ç”±äº Dijkstra æ’å…¥å±éšœçš„â€œ**ä¿å®ˆ**â€ï¼ˆå°†å¯èƒ½å­˜æ´»çš„å¯¹è±¡éƒ½æ ‡è®°ä¸ºäº†ç°è‰²ï¼Œä¾‹å¦‚ä¸Šå›¾Bå¯¹è±¡æœ€åæ²¡æœ‰è¢«å›æ”¶ï¼‰ï¼Œåœ¨ä¸€æ¬¡å›æ”¶è¿‡ç¨‹ä¸­å¯èƒ½ä¼šæ®‹ç•™ä¸€éƒ¨åˆ†å¯¹è±¡æ²¡æœ‰å›æ”¶æˆåŠŸï¼Œåªæœ‰åœ¨ä¸‹ä¸€ä¸ªå›æ”¶è¿‡ç¨‹ä¸­æ‰ä¼šè¢«å›æ”¶ï¼›
- åœ¨æ ‡è®°é˜¶æ®µä¸­ï¼Œæ¯æ¬¡è¿›è¡Œ**æŒ‡é’ˆèµ‹å€¼æ“ä½œ**æ—¶ï¼Œéƒ½éœ€è¦**å¼•å…¥å†™å±éšœ**ï¼Œè¿™æ— ç–‘ä¼šå¢åŠ å¤§é‡æ€§èƒ½å¼€é”€ï¼›ä¸ºäº†é¿å…é€ æˆæ€§èƒ½é—®é¢˜ï¼ŒGo å›¢é˜Ÿåœ¨æœ€ç»ˆå®ç°æ—¶ï¼Œ**æ²¡æœ‰ä¸ºæ ˆä¸Šçš„æŒ‡é’ˆçš„å†™æ“ä½œå¯ç”¨å†™å±éšœ**ï¼Œè€Œæ˜¯å½“å‘ç”Ÿæ ˆä¸Šçš„å†™æ“ä½œæ—¶ï¼Œå°†æ ˆæ ‡è®°ä¸ºç°è‰²ï¼Œä½†æ­¤ä¸¾äº§ç”Ÿäº†**ç°è‰²èµ‹å€¼å™¨**ï¼Œå°†ä¼š**éœ€è¦åœ¨æ ‡è®°ç»ˆæ­¢é˜¶æ®µ STW** æ—¶å¯¹è¿™äº›æ ˆè¿›è¡Œ**é‡æ–°æ‰«æ**ã€‚

![æ’å…¥å±éšœ](picture/goè¯­è¨€è¦ç‚¹/æ’å…¥å±éšœ.png)

ä½†æ˜¯å¦‚æœæ ˆä¸æ·»åŠ ,å½“å…¨éƒ¨ä¸‰è‰²æ ‡è®°æ‰«æä¹‹å,æ ˆä¸Šæœ‰å¯èƒ½ä¾ç„¶å­˜åœ¨ç™½è‰²å¯¹è±¡è¢«å¼•ç”¨çš„æƒ…å†µ(å¦‚ä¸Šå›¾çš„å¯¹è±¡9). æ‰€ä»¥è¦å¯¹æ ˆé‡æ–°è¿›è¡Œä¸‰è‰²æ ‡è®°æ‰«æ, ä½†è¿™æ¬¡ä¸ºäº†å¯¹è±¡ä¸ä¸¢å¤±, è¦å¯¹æœ¬æ¬¡æ ‡è®°æ‰«æå¯åŠ¨STWæš‚åœ. ç›´åˆ°æ ˆç©ºé—´çš„ä¸‰è‰²æ ‡è®°ç»“æŸ

![æ’å…¥å±éšœ-STW](picture/goè¯­è¨€è¦ç‚¹/æ’å…¥å±éšœ-STW.png)

#### 4. åˆ é™¤å†™å±éšœ(Yuasa)-é»‘è‰²èµ‹å€¼å™¨

**å…·ä½“æ“ä½œ**: è¢«åˆ é™¤çš„å¯¹è±¡ï¼Œå¦‚æœè‡ªèº«ä¸ºç°è‰²æˆ–è€…ç™½è‰²ï¼Œé‚£ä¹ˆè¢«æ ‡è®°ä¸ºç°è‰²ã€‚

**æ»¡è¶³**: **å¼±ä¸‰è‰²ä¸å˜å¼**. (ä¿æŠ¤ç°è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„è·¯å¾„ä¸ä¼šæ–­)

> ç ´åæ¡ä»¶2ï¼ˆä»ç°è‰²å¯¹è±¡å‡ºå‘ï¼Œåˆ°è¾¾ç™½è‰²å¯¹è±¡çš„ã€æœªç»è®¿é—®è¿‡çš„è·¯å¾„è¢«èµ‹å€¼å™¨ç ´åï¼‰ï¼Œå› ä¸ºè¢«åˆ é™¤å¯¹è±¡ï¼Œå¦‚æœè‡ªèº«æ˜¯ç°è‰²æˆ–è€…ç™½è‰²ï¼Œåˆ™è¢«æ ‡è®°ä¸ºç°è‰²

ä¾‹å¦‚A->Bçš„å¼•ç”¨è¢«åˆ é™¤è§¦å‘åˆ é™¤å†™å±éšœï¼ŒBå˜ä¸ºç°è‰²ï¼ˆæœ¬æ¥å°±æ˜¯ç°è‰²ï¼‰

B->Cçš„å¼•ç”¨è¢«åˆ é™¤è§¦å‘åˆ é™¤å†™å±éšœï¼ŒCç”±ç™½è‰²å˜ä¸ºäº†ç°è‰²

![yuasa-delete-write-barrier](picture/goè¯­è¨€è¦ç‚¹/2021-01-02-16095599123266-yuasa-delete-write-barrier.png)

**ç‰¹ç‚¹**ï¼šæ ‡è®°ç»“æŸä¸éœ€è¦STWï¼Œä½†æ˜¯å›æ”¶ç²¾åº¦ä½(**ä¸€ä¸ªå¯¹è±¡å³ä½¿è¢«åˆ é™¤äº†æœ€åä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆä¹Ÿä¾æ—§å¯ä»¥æ´»è¿‡è¿™ä¸€è½®ï¼Œåœ¨ä¸‹ä¸€è½®GCä¸­æ‰ä¼šè¢«æ¸…ç†æ‰**)ï¼Œå®¹æ˜“äº§ç”Ÿâ€œå†—ä½™â€æ‰«æï¼›

![åˆ é™¤å±éšœ](picture/goè¯­è¨€è¦ç‚¹/åˆ é™¤å±éšœ.png)

#### 4. æ··åˆå†™å±éšœ

Go V1.8 æ–°å¢çš„æ··åˆå†™å±éšœæœºåˆ¶ï¼Œ**å¤§å¤§ç¼©çŸ­äº†STWæ—¶é—´**

- **æ’å…¥å†™å±éšœçŸ­æ¿**ï¼šç»“æŸæ—¶éœ€è¦STWæ¥é‡æ–°æ‰«ææ ˆï¼Œæ ‡è®°æ ˆä¸Šå¼•ç”¨çš„ç™½è‰²å¯¹è±¡çš„å­˜æ´»ï¼›
- **åˆ é™¤å†™å±éšœçŸ­æ¿**ï¼šåŸºäºèµ·å§‹å¿«ç…§ï¼Œå›æ”¶ç²¾åº¦ä½ï¼ŒGCå¼€å§‹æ—¶STWæ‰«æå †æ ˆæ¥è®°å½•åˆå§‹å¿«ç…§ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šä¿æŠ¤å¼€å§‹æ—¶åˆ»çš„æ‰€æœ‰å­˜æ´»å¯¹è±¡ã€‚



æ··åˆå†™å±éšœæœºåˆ¶æ•´ä½“æµç¨‹ï¼š

- GC å¼€å§‹å°†**æ ˆä¸Š**çš„å¯¹è±¡å…¨éƒ¨æ‰«æå¹¶æ ‡è®°ä¸º**é»‘è‰²** (ä¹‹åä¸å†è¿›è¡Œç¬¬äºŒæ¬¡é‡å¤æ‰«æï¼Œæ— éœ€STW)
- GC markæœŸé—´ï¼Œä»»ä½•åœ¨**æ ˆä¸Šæˆ–å †ä¸Š**åˆ›å»ºçš„æ–°å¯¹è±¡ï¼Œå‡ä¸º**é»‘è‰²**
- å¯¹å †å¯¹è±¡è¿›è¡Œæ··åˆå†™å±éšœ
- å¯¹æ ˆå¯¹è±¡ä¸é€‚ç”¨æ··åˆå†™å±éšœ



**å†™å±éšœä»£ç è§¦å‘ç‚¹**

é‡ç‚¹ï¼š

1. å†™å±éšœçš„ä»£ç åœ¨ç¼–è¯‘æœŸé—´ç”Ÿæˆå¥½ï¼Œä¹‹åä¸ä¼šå†å˜åŒ–ï¼›
2. å †ä¸Šå¯¹è±¡èµ‹å€¼æ‰ä¼šç”Ÿæˆå†™å±éšœï¼›
3. å“ªäº›å¯¹è±¡åˆ†é…åœ¨æ ˆä¸Šï¼Œå“ªäº›åˆ†é…åœ¨å †ä¸Šï¼Ÿä¹Ÿæ˜¯ç¼–è¯‘æœŸé—´ç”±ç¼–è¯‘å™¨å†³å®šï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšâ€œé€ƒé€¸åˆ†æâ€ï¼›

åœ¨åˆé€‚çš„ä½ç½®ï¼Œç¼–è¯‘å™¨ç»™ä½ ç¨‹åºæ·»åŠ çš„æŒ‡ä»¤å‡½æ•° `runtimeÂ·gcWriteBarrier`ï¼Œè¿™ä¸ªå°±æ˜¯å…¥å£ï¼Œæ¯æ¬¡å †å¯¹è±¡èµ‹å€¼ï¼Œå¦‚æœå¼€å¯äº†åƒåœ¾å›æ”¶å¼€å…³ï¼Œéƒ½ä¼šå»é‡Œé¢è½¬ä¸€åœˆã€‚

å®ç°ä¼ªä»£ç å¦‚ä¸‹ï¼š

```go
if runtime.writeBarrier.enabled {
    runtime.gcWriteBarrier(ptr, val)
} else {
    *ptr = val
}
```

æ³¨æ„å‚æ•° `gcWriteBarrier` ä¼ å€¼åœ¨ golang é‡Œæ˜¯ä¸ªç‰¹ä¾‹ï¼Œè¿™é‡Œç”¨çš„æ˜¯å¯„å­˜å™¨ï¼ˆ golang çš„æƒ¯ä¾‹æ˜¯ç”¨æ ˆæ¥ä¼ é€’çš„ï¼Œä½†æ˜¯è€ƒè™‘æ€§èƒ½åŸå› ï¼Œè¿™é‡Œå¿…é¡»ç”¨å¯„å­˜å™¨äº†ï¼‰ï¼Œ

`runtimeÂ·gcWriteBarrier` å‡½æ•°å¹²å•¥çš„ï¼š

1. å…ˆæŠŠslotå’Œptrå…¥é˜Ÿ `wbBuffer`
2. å¦‚æœ `wbBuffer` æ»¡äº†å°±è°ƒç”¨ `runtime.wbBufFlush` è¿›è¡Œæ‰¹é‡ç½®ç°ï¼Œç„¶åèµ‹å€¼ï¼›å¦åˆ™å°±åªæ˜¯å…¥é˜Ÿï¼Œç„¶åèµ‹å€¼
3. ç„¶åèµ‹å€¼ `*slot = ptr`

é‚£ä¸ºä»€ä¹ˆä¸Šé¢ `gcWriteBarrier` è¿™ä¸ªå‡½æ•°æ€ä¹ˆå¤æ‚ï¼Ÿ

å…¶å®æ˜¯åšçš„ä¸€ä¸ªä¼˜åŒ–å¤„ç†ï¼Œæ¯æ¬¡è§¦å‘å†™å±éšœçš„æ—¶å€™ï¼ˆ hook ï¼‰ï¼Œæˆ‘ä»¬å½“ç„¶å¯ä»¥ç›´æ¥shadeï¼ˆptrï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼Œæ¯•ç«Ÿè¿™æ®µå†™å±éšœçš„ä»£ç æ˜¯æ¯”ä¸šåŠ¡å¤šå‡ºæ¥çš„ï¼Œè¿™äº›éƒ½æ˜¯å¼€é”€ï¼Œæˆ‘ä»¬èƒ½å¿«å°±å¿«ï¼Œæ¯æ¬¡è¿™æ ·åšå¤ªé›¶æ•£ï¼Œæˆ‘ä»¬å¯ä»¥æ”’ä¸€æ‰¹ï¼Œä¸€æ‰¹é˜Ÿåˆ—æ»¡äº†ï¼Œä¸€æ‰¹å»å…¥é˜Ÿï¼Œç½®ç°è‰²ã€‚è¿™æ ·æ•ˆç‡æ›´é«˜ã€‚`ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªéœ€è¦ç®€å•å…¥é˜Ÿå°±è¡Œäº†ï¼Œbuf æ»¡äº†ä¹‹åï¼Œæ‰ flush å»æ‰¹é‡ç½®ç°ï¼Œè¿™æ ·å†™å±éšœå¯¹ä¸šåŠ¡çš„å½±å“å°±æ›´å°äº†ï¼ŒwbBuffer å°±æ˜¯è¿™ä¸ªé˜Ÿåˆ—çš„å®ç°ã€‚`



**å¯¹è±¡ç½®ç°**ï¼š

è¿™ä¸ªå‡½æ•° `wbBufFlush` æ˜¯ golang å®ç°çš„ï¼Œåœ¨æ–‡ä»¶ `src/runtime/mwbbuf.go` é‡Œã€‚æœ¬è´¨ä¸Šæ˜¯å°è£…è°ƒç”¨ wbBufFlush1 ï¼Œè¿™ä¸ªå‡½æ•°æ‰æ˜¯ hook å†™æ“ä½œæƒ³è¦åšçš„äº‹æƒ…ï¼Œè¿™ä¸ªå‡½æ•°åšä¸¤ä¸ªäº‹æƒ…ï¼š

1. æ‰¹é‡å¾ªç¯å¤„ç† buf é˜Ÿåˆ—é‡Œçš„å€¼ï¼›
2. shadeï¼ˆè¿™ä¸ªå€¼ï¼‰ï¼›

è¯´äº†è¿™ä¹ˆä¹…â€œç½®ç°è‰²â€ï¼Œé‚£ä¹ˆåˆ°åº•å†™å±éšœæ˜¯æ€ä¹ˆç½®ç°è‰²çš„ï¼Ÿå®ç°å¦‚ä½•ã€‚å…¶å®æœ¬è´¨ä¸‹å°±ä¸‹é¢ä¸€è¡Œä»£ç ï¼Œåœ¨æ–‡ä»¶ `src/runtime/mwbbuf.go` çš„å‡½æ•° `wbBufFlush1`ï¼š

```go
// Enqueue the greyed objects.
gcw.putBatch(ptrs[:pos])
```

åœ¨ golang é‡Œé¢ï¼Œåˆ°åº•ä»€ä¹ˆæ ·çš„æ˜¯ç°è‰²å¯¹è±¡ï¼Ÿ

1. åªè¦åœ¨æ‰«æé˜Ÿåˆ—ä¸­çš„å¯¹è±¡ï¼Œå°±æ˜¯ç°è‰²çš„ã€‚

å…¶å®ï¼Œç™½ï¼Œç°ï¼Œé»‘ ä¸‰è‰²è¿™ä¸ªæ˜¯æˆ‘ä»¬è®¤ä¸ºæŠ½è±¡å‡ºæ¥çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ä¸‰è‰²æ ‡è®°æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¦‚å¿µè½åˆ°å®å¤„ï¼Œåˆæ˜¯æ€ä¹ˆæ ·çš„å®ç°ã€‚

golang å†…éƒ¨å¯¹è±¡å¹¶æ²¡æœ‰ä¿å­˜é¢œè‰²çš„å±æ€§ï¼Œä¸‰è‰²åªæ˜¯å¯¹ä»–ä»¬çš„çŠ¶æ€çš„æè¿°ï¼Œæ˜¯é€šè¿‡ä¸€ä¸ªé˜Ÿåˆ— + æ©ç ä½å›¾ æ¥å®ç°çš„ï¼š

- ç™½è‰²å¯¹è±¡ï¼šå¯¹è±¡æ‰€åœ¨ span çš„ gcmarkBits ä¸­å¯¹åº”çš„ bit ä¸º 0ï¼Œä¸åœ¨é˜Ÿåˆ—ï¼›
- ç°è‰²å¯¹è±¡ï¼šå¯¹è±¡æ‰€åœ¨ span çš„ gcmarkBits ä¸­å¯¹åº”çš„ bit ä¸º 1ï¼Œä¸”å¯¹è±¡åœ¨æ‰«æé˜Ÿåˆ—ä¸­ï¼›
- é»‘è‰²å¯¹è±¡ï¼šå¯¹è±¡æ‰€åœ¨ span çš„ gcmarkBits ä¸­å¯¹åº”çš„ bit ä¸º 1ï¼Œä¸”å¯¹è±¡å·²ç»ä»æ‰«æé˜Ÿåˆ—ä¸­å¤„ç†å¹¶æ‘˜é™¤æ‰ï¼›









**æ»¡è¶³**ï¼šå˜å½¢çš„å¼±ä¸‰è‰²ä¸å˜å¼

è¿™é‡Œæˆ‘ä»¬æ³¨æ„ï¼Œ **å±éšœæŠ€æœ¯æ˜¯ä¸åœ¨æ ˆä¸Šåº”ç”¨çš„ï¼Œå› ä¸ºè¦ä¿è¯æ ˆçš„è¿è¡Œæ•ˆç‡**

Golang ä¸­çš„æ··åˆå±éšœç»“åˆäº†åˆ é™¤å†™å±éšœå’Œæ’å…¥å†™å±éšœçš„ä¼˜ç‚¹ï¼Œ**åªéœ€è¦åœ¨å¼€å§‹æ—¶å¹¶å‘æ‰«æå„goroutineçš„æ ˆï¼Œä½¿å…¶å˜é»‘å¹¶ä¸€ç›´ä¿æŒï¼Œæ ‡è®°ç»“æŸåï¼Œå› ä¸ºæ ˆç©ºé—´åœ¨æ‰«æåå§‹ç»ˆæ˜¯é»‘è‰²çš„ï¼Œæ— éœ€è¿›è¡Œre-scan**ï¼Œå‡å°‘äº†STW çš„æ—¶é—´ã€‚

å¦å¤–æ³¨æ„ï¼šæ··åˆå†™å±éšœæ˜¯GCçš„ä¸€ç§å±éšœæœºåˆ¶ï¼Œæ‰€ä»¥åªæ˜¯å½“ç¨‹åºæ‰§è¡ŒGCçš„æ—¶å€™æ‰ä¼šè§¦å‘è¿™ç§æœºåˆ¶

**GCå¼€å§‹ï¼š** æ‰«ææ ˆåŒºï¼Œå°†æ ˆåŒºå¯è¾¾çš„å¯¹è±¡å…¨éƒ¨æ ‡è®°ä¸º**é»‘è‰²**ï¼ˆSTWå…¨éƒ¨æ ‡è®°ï¼‰

![æ··åˆå±éšœ-å‡†å¤‡](picture/goè¯­è¨€è¦ç‚¹/æ··åˆå±éšœ-å‡†å¤‡.png)



**åœºæ™¯ä¸€ï¼šå¯¹è±¡è¢«ä¸€ä¸ªå †å¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºäº†æ ˆå¯¹è±¡çš„ä¸‹æ¸¸**

ç”±äºå±éšœçš„ä½œç”¨ï¼Œå¯¹è±¡7ä¸ä¼šè¢«è¯¯åˆ é™¤

![æ··åˆå±éšœ-åœºæ™¯ä¸€](picture/goè¯­è¨€è¦ç‚¹/æ··åˆå±éšœ-åœºæ™¯ä¸€.png)



**åœºæ™¯äºŒï¼šå¯¹è±¡è¢«ä¸€ä¸ªæ ˆå¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºæ ˆå¯¹è±¡çš„ä¸‹æ¸¸**

![æ··åˆå±éšœ-åœºæ™¯äºŒ](picture/goè¯­è¨€è¦ç‚¹/æ··åˆå±éšœ-åœºæ™¯äºŒ.png)



**åœºæ™¯ä¸‰ï¼šå¯¹è±¡è¢«ä¸€ä¸ªå †å¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºå †å¯¹è±¡çš„ä¸‹æ¸¸**

![æ··åˆå±éšœ-åœºæ™¯ä¸‰](picture/goè¯­è¨€è¦ç‚¹/æ··åˆå±éšœ-åœºæ™¯ä¸‰.png)



**åœºæ™¯å››ï¼šå¯¹è±¡è¢«ä¸€ä¸ªæ ˆå¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºå¦ä¸€ä¸ªå †å¯¹è±¡çš„ä¸‹æ¸¸**

![æ··åˆå±éšœ-åœºæ™¯å››](picture/goè¯­è¨€è¦ç‚¹/æ··åˆå±éšœ-åœºæ™¯å››.png)

### 3.4 GoGC-æ ‡è®°æ¸…é™¤ç®—æ³•

1.5ç‰ˆæœ¬åŠä¹‹åçš„GCä¸»è¦åˆ†å››ä¸ªé˜¶æ®µï¼Œå…¶ä¸­æ ‡è®°å’Œæ¸…ç†éƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œä½†æ˜¯æ ‡è®°å‰åéœ€è¦STWæ¥åš**GCçš„å‡†å¤‡å·¥ä½œå’Œæ ˆçš„rescan**




**GCè§¦å‘ï¼š**
| é˜¶æ®µ             | è¯´æ˜                                                         | èµ‹å€¼å™¨çŠ¶æ€ |
| ---------------- | ------------------------------------------------------------ | ---------- |
| SweepTermination | æ¸…æ‰«ç»ˆæ­¢é˜¶æ®µï¼Œè¿›å…¥å®‰å…¨ç‚¹ï¼Œå¤„ç†ä¸Šä¸€æ¬¡GCè¿˜æœªè¢«æ¸…ç†çš„å†…å­˜ç®¡ç†å•å…ƒ | STW        |
| Mark             | æ‰«ææ ‡è®°é˜¶æ®µï¼Œå†™å±éšœå¼€å¯ï¼Œæ ¹å¯¹è±¡å…¥é˜Ÿï¼Œæ¢å¤ç¨‹åºæ‰§è¡Œï¼Œå¼€å§‹æ‰«æ(æ‰«æGæ ˆæ—¶ä¼šæš‚åœå½“å‰Gçš„P) | å¹¶å‘       |
| MarkTermination  | æ ‡è®°ç»ˆæ­¢é˜¶æ®µï¼Œå…³é—­è¾…åŠ©æ ‡è®°çš„ç”¨æˆ·ç¨‹åºï¼Œæ¸…ç†å¤„ç†å™¨ä¸Šçš„çº¿ç¨‹ç¼“å­˜ | STW        |
| GCoff            | å†…å­˜æ¸…æ‰«é˜¶æ®µï¼Œå¼€å§‹æ¸…ç†ï¼Œå…³é—­å†™å±éšœï¼Œæ¢å¤ç”¨æˆ·ç¨‹åºçš„æ‰§è¡Œï¼Œåå°å¹¶å‘æ¸…ç†æ‰€æœ‰å†…å­˜ç®¡ç†å•å…ƒ | å¹¶å‘       |

- `ç”³è¯·å†…å­˜`ï¼šå½“è¿›è¡Œ `mallocgc`æ—¶å¦‚æœç”¨åˆ°äº†mcentral ä¹‹åçš„ç¼“å­˜ï¼Œå°±å°è¯•è°ƒç”¨ `gcTrigger{kind: gcTriggerHeap}.test()` è¿›è¡Œæ£€æŸ¥ã€‚å½“å‰åˆ†é…çš„å†…å­˜è¾¾åˆ°ä¸€å®š**é˜ˆå€¼**ï¼ˆä¸Šä¸€æ¬¡gcæ—¶å†…å­˜çš„2å€ï¼‰æ—¶è§¦å‘ï¼Œè¿™ä¸ªé˜ˆå€¼åœ¨æ¯æ¬¡GCè¿‡åéƒ½ä¼šæ ¹æ®å †å†…å­˜çš„å¢é•¿æƒ…å†µå’ŒCPUå ç”¨ç‡æ¥è°ƒæ•´ï¼ˆç›®å‰å”¯ä¸€**å¯ä»¥è°ƒæ•´çš„å‚æ•°GCPercent, ä»¥åå¯èƒ½ä¼šæœ‰MaxHeap**ï¼‰runtime.mallocgcï¼Œå¾®å¯¹è±¡ã€å°å¯¹è±¡ã€å¤§å¯¹è±¡çš„åˆ›å»ºéƒ½å¯èƒ½ä¼šè§¦å‘æ–°çš„åƒåœ¾æ”¶é›†å¾ªç¯
    - `nextFree()`ä»mcentralæˆ–è€…mheapè·å–æ–°çš„mspanæ—¶å¯èƒ½ä¼šè§¦å‘åƒåœ¾æ”¶é›†
    - åˆ†é…å¤§å¯¹è±¡çš„æ—¶å€™ï¼Œä¸€å®šä¼šå°è¯•è§¦å‘åƒåœ¾æ”¶é›†
- `runtime.forcegcperiod`: ç”±  `sysmon` å¾ªç¯æ£€æŸ¥ï¼Œå½“ä¸€å®šæ—¶é—´æ²¡æœ‰æ‰§è¡Œè¿‡GCå°±å¼ºåˆ¶è§¦å‘GCï¼ˆ2åˆ†é’Ÿï¼‰
- `runtime.GC()`: æ‰‹åŠ¨è§¦å‘

![](picture/goè¯­è¨€è¦ç‚¹/2021-08-11_190443.png)


```go
// å°è¯•åƒåœ¾å›æ”¶
func (t gcTrigger) test() bool {
	if !memstats.enablegc || panicking != 0 || gcphase != _GCoff {
		return false
	}
	switch t.kind {
	case gcTriggerHeap:
		return memstats.heap_live >= memstats.gc_trigger	// å †ç©ºé—´è¶…è¿‡è®¾å®šçš„é˜ˆå€¼
	case gcTriggerTime:
		if gcpercent < 0 {
			return false
		}
		lastgc := int64(atomic.Load64(&memstats.last_gc_nanotime))
		return lastgc != 0 && t.now-lastgc > forcegcperiod	// è¶…è¿‡2åˆ†é’Ÿæ²¡æœ‰åƒåœ¾å›æ”¶äº†
	case gcTriggerCycle:
		return int32(t.n-work.cycles) > 0		// æ²¡æœ‰å¼€å¯åƒåœ¾æ”¶é›†åˆ™è§¦å‘æ–°çš„å¾ªç¯
	}
	return true
}
```



#### 1. SweepTermination(STW)

1. **æš‚åœç¨‹åº**ï¼Œæ‰€æœ‰çš„å¤„ç†å™¨åœ¨è¿™æ—¶ä¼šè¿›å…¥å®‰å…¨ç‚¹ï¼ˆSafe pointï¼‰ï¼›
2. å¦‚æœå½“å‰åƒåœ¾æ”¶é›†å¾ªç¯æ˜¯å¼ºåˆ¶è§¦å‘çš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¤„ç†è¿˜æœªè¢«æ¸…ç†çš„å†…å­˜ç®¡ç†å•å…ƒï¼›

#### 2. Mark(å¹¶å‘æ ‡è®°)

1. å°†çŠ¶æ€åˆ‡æ¢è‡³ `_GCmark`ã€å¼€å¯å†™å±éšœã€ç”¨æˆ·ç¨‹åºååŠ©ï¼ˆMutator Assistsï¼‰å¹¶å°†æ ¹å¯¹è±¡å…¥é˜Ÿï¼›
2. æ¢å¤æ‰§è¡Œç¨‹åºï¼Œæ ‡è®°è¿›ç¨‹å’Œç”¨äºååŠ©çš„ç”¨æˆ·ç¨‹åºä¼šå¼€å§‹å¹¶å‘æ ‡è®°å†…å­˜ä¸­çš„å¯¹è±¡ï¼Œå†™å±éšœä¼šå°†è¢«è¦†ç›–çš„æŒ‡é’ˆå’Œæ–°æŒ‡é’ˆéƒ½æ ‡è®°æˆç°è‰²ï¼Œè€Œæ‰€æœ‰æ–°åˆ›å»ºçš„å¯¹è±¡éƒ½ä¼šè¢«ç›´æ¥æ ‡è®°æˆé»‘è‰²ï¼›
3. å¼€å§‹æ‰«ææ ¹å¯¹è±¡ï¼ŒåŒ…æ‹¬æ‰€æœ‰ Goroutine çš„æ ˆã€å…¨å±€å¯¹è±¡ä»¥åŠä¸åœ¨å †ä¸­çš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼Œæ‰«æ Goroutine æ ˆæœŸé—´ä¼šæš‚åœå½“å‰å¤„ç†å™¨ï¼›
4. ä¾æ¬¡å¤„ç†ç°è‰²é˜Ÿåˆ—ä¸­çš„å¯¹è±¡ï¼Œå°†å¯¹è±¡æ ‡è®°æˆé»‘è‰²å¹¶å°†å®ƒä»¬æŒ‡å‘çš„å¯¹è±¡æ ‡è®°æˆç°è‰²ï¼›
5. ä½¿ç”¨åˆ†å¸ƒå¼çš„ç»ˆæ­¢ç®—æ³•æ£€æŸ¥å‰©ä½™çš„å·¥ä½œï¼Œå‘ç°æ ‡è®°é˜¶æ®µå®Œæˆåè¿›å…¥æ ‡è®°ç»ˆæ­¢é˜¶æ®µï¼›

#### 3. MarkTermination(STW)

1. **æš‚åœç¨‹åº**ã€å°†çŠ¶æ€åˆ‡æ¢è‡³ `_GCmarktermination` å¹¶å…³é—­è¾…åŠ©æ ‡è®°çš„ç”¨æˆ·ç¨‹åºï¼›
2. æ¸…ç†å¤„ç†å™¨ä¸Šçš„çº¿ç¨‹ç¼“å­˜ï¼›

Go1.7æ˜¯ Dijkstraå†™å±éšœ(æ’å…¥å†™å±éšœ)ï¼Œåªç›‘æ§å †ä¸­æŒ‡é’ˆå˜åŠ¨ï¼Œæ‰€ä»¥éœ€è¦**å†æ¬¡æ‰«æå…¨å±€å˜é‡å’Œæ ˆ**

Go1.8ä¹‹åæ˜¯æ··åˆå†™å±éšœï¼Œä¹Ÿä¸ç›‘æ§æ ˆä¸ŠæŒ‡é’ˆå˜åŠ¨ï¼Œä½†æ˜¯è¿™ä¸ªç­–ç•¥å¯ä»¥**æ— éœ€å†æ‰«ææ ˆå’Œå…¨å±€å˜é‡**ï¼Œä½†æ˜¯ä»éœ€è¦STWè¿›è¡Œä¸€äº›æ£€æŸ¥



#### 4. GCoff

1. å°†çŠ¶æ€åˆ‡æ¢è‡³ `_GCoff` å¼€å§‹æ¸…ç†é˜¶æ®µï¼Œåˆå§‹åŒ–æ¸…ç†çŠ¶æ€å¹¶å…³é—­å†™å±éšœï¼›
2. æ¢å¤ç”¨æˆ·ç¨‹åºï¼Œæ‰€æœ‰æ–°åˆ›å»ºçš„å¯¹è±¡ä¼šæ ‡è®°æˆç™½è‰²ï¼›
3. åå°å¹¶å‘æ¸…ç†æ‰€æœ‰çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œå½“ Goroutine ç”³è¯·æ–°çš„å†…å­˜ç®¡ç†å•å…ƒæ—¶å°±ä¼šè§¦å‘æ¸…ç†ï¼›

è´Ÿè´£æ¸…æ‰«åƒåœ¾çš„goroutine æ˜¯ **åº”ç”¨ç¨‹åºå¯åŠ¨åå°±ç«‹å³åˆ›å»ºçš„ä¸€ä¸ªåå°goroutine**ï¼Œå¹¶ä¸”ç«‹åˆ»è¿›å…¥ç¡çœ ï¼Œç­‰å¾…è¢«å”¤é†’åæ‰§è¡Œåƒåœ¾æ¸…ç†ï¼ŒæŠŠç™½è‰²å¯¹è±¡æŒ¨ä¸ªæ¸…ç†æ‰ï¼Œæ¸…æ‰«goroutine å’Œ åº”ç”¨ goroutine æ˜¯å¹¶å‘è¿›è¡Œçš„ï¼Œæ¸…æ‰«å®Œæˆåå†æ¬¡è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…ä¸‹æ¬¡è¢«å”¤é†’

æœ€åæ‰§è¡Œä¸€äº›æ•°æ®ç»Ÿè®¡å’ŒçŠ¶æ€ä¿®æ”¹çš„å·¥ä½œï¼Œè®¾ç½®å¥½ä¸‹ä¸€è½®GCçš„é˜ˆå€¼ï¼ŒæŠŠGCçŠ¶æ€è®¾ç½®ä¸º off



### 3.5 å†…å­˜çš„æ¸…ç†

åƒåœ¾æ”¶é›†çš„æ¸…ç†åŒ…å«**å¯¹è±¡å›æ”¶å™¨**å’Œ**å†…å­˜å•å…ƒå›æ”¶å™¨**

- å¯¹è±¡å›æ”¶å™¨åœ¨mspanä¸­æŸ¥æ‰¾å¹¶é‡Šæ”¾æœªè¢«æ ‡è®°çš„å¯¹è±¡ï¼ˆç™½è‰²å¯¹è±¡ï¼‰ï¼Œå¦‚æœæ‰€æœ‰å¯¹è±¡éƒ½æ²¡æœ‰è¢«æ ‡è®°ï¼Œé‚£ä¹ˆæ•´ä¸ªå•å…ƒéƒ½ä¼šè¢«ç›´æ¥å›æ”¶

- å†…å­˜å•å…ƒå›æ”¶å™¨ä¼šåœ¨å†…å­˜ä¸­æŸ¥æ‰¾æ‰€æœ‰å¯¹è±¡éƒ½æœªè¢«æ ‡è®°çš„mspan



# åå››ã€GMPè°ƒåº¦å™¨

## 1. cpuå’Œåç¨‹

### 1.1 CPU

ç‰©ç†cpuï¼šä¸»æ¿ä¸Šå®é™…æ’å…¥çš„ cpu æ•°é‡

cpuæ ¸å¿ƒæ•°ï¼šå•å—cpuä¸Šé¢èƒ½å¤„ç†æ•°æ®çš„èŠ¯ç‰‡æ•°é‡ï¼Œä¾‹å¦‚åŒæ ¸ã€å››æ ¸

é€»è¾‘cpuæ•°ï¼šä¸€èˆ¬é€»è¾‘cpuæ•°=ç‰©ç†cpuæ•°Ã—æ¯é¢—çš„æ ¸æ•°ï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜cpuæ”¯æŒè¶…çº¿ç¨‹æŠ€æœ¯ï¼Œæé«˜äº†ç³»ç»Ÿæ€§èƒ½ï¼Œæ­¤æ—¶é€»è¾‘cpuæ•°=ç‰©ç†cpuæ•°Ã—æ¯é¢—cpuçš„æ ¸å¿ƒæ•°Ã—2



å¤šæ ¸ CPU çš„æ¯ä¸€ä¸ªæ ¸å¿ƒæ‹¥æœ‰è‡ªå·±**ç‹¬ç«‹çš„è¿ç®—å•å…ƒã€å¯„å­˜å™¨ã€L1æ ¸L2ç¼“å­˜**ï¼Œæ‰€æœ‰æ ¸å¿ƒ**å…±ç”¨åŒä¸€æ¡å†…å­˜æ€»çº¿**ï¼ŒåŒä¸€æ®µå†…å­˜ã€‚



### 1.2 åç¨‹

åœ¨å¤šè¿›ç¨‹/å¤šçº¿ç¨‹çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹é˜»å¡ï¼Œcpuå¯ä»¥ç«‹å³åˆ‡æ¢åˆ°å…¶ä»–è¿›ç¨‹ä¸­å»æ‰§è¡Œï¼Œè¿™æ ·ä»å®è§‚æ¥çœ‹ï¼Œä¼¼ä¹å¤šä¸ªè¿›ç¨‹æ˜¯åœ¨åŒæ—¶è¢«è¿è¡Œ

ä½†æ–°çš„é—®é¢˜å°±åˆå‡ºç°äº†ï¼Œè¿›ç¨‹æ‹¥æœ‰å¤ªå¤šçš„èµ„æºï¼Œè¿›ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢ã€é”€æ¯ï¼Œéƒ½ä¼šå ç”¨å¾ˆé•¿çš„æ—¶é—´ï¼ŒCPUè™½ç„¶åˆ©ç”¨èµ·æ¥äº†ï¼Œä½†å¦‚æœè¿›ç¨‹è¿‡å¤šï¼Œ**CPUæœ‰å¾ˆå¤§çš„ä¸€éƒ¨åˆ†éƒ½è¢«ç”¨æ¥è¿›è¡Œè¿›ç¨‹è°ƒåº¦**

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±å‡ºç°äº†ç”¨æˆ·æ€çº¿ç¨‹ï¼Œä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹å¿…é¡»è¦ç»‘å®šåˆ°ä¸€ä¸ªå†…æ ¸æ€çº¿ç¨‹ï¼Œä½†æ˜¯cpuå¹¶ä¸çŸ¥é“æœ‰ç”¨æˆ·æ€çº¿ç¨‹çš„å­˜åœ¨ï¼Œå®ƒåªçŸ¥é“å®ƒåœ¨è¿è¡Œçš„æ˜¯ä¸€ä¸ªå†…æ ¸æ€çº¿ç¨‹ã€‚å’Œå†…æ ¸çº¿ç¨‹(`thread`)ä¸åŒï¼Œç”¨æˆ·æ€çº¿ç¨‹å«åš**åç¨‹**(`co-routine`)

ä¸‹é¢ç»Ÿä¸€ç”¨çº¿ç¨‹æŒ‡ä»£å†…æ ¸çº¿ç¨‹ï¼Œåç¨‹æŒ‡ä»£ç”¨æˆ·çº¿ç¨‹



åç¨‹å’Œçº¿ç¨‹çš„æ˜ å°„å…³ç³»æœ‰ä¸‰ç§ï¼š

**åç¨‹ï¼šçº¿ç¨‹ = N : 1ï¼ŒNä¸ªåç¨‹ç»‘å®š1ä¸ªçº¿ç¨‹**

![N-1æ¨¡å‹](picture/goè¯­è¨€è¦ç‚¹/N-1æ¨¡å‹.png)

- ä¼˜ç‚¹ï¼šåç¨‹åœ¨ç”¨æˆ·æ€çº¿ç¨‹å®Œæˆäº†åˆ‡æ¢ï¼Œä¸ä¼šé™·å…¥å†…æ ¸æ€ï¼Œæ‰€ä»¥**åˆ‡æ¢è½»é‡å¿«é€Ÿ**
- ç¼ºç‚¹ï¼š1ä¸ªè¿›ç¨‹çš„æ‰€æœ‰åç¨‹éƒ½ç»‘å®šåœ¨1ä¸ªçº¿ç¨‹ä¸Šï¼Œè¿›ç¨‹**ç”¨ä¸äº†ç¡¬ä»¶çš„å¤šæ ¸åŠ é€Ÿèƒ½åŠ›**ï¼Œ**ä¸€æ—¦æŸä¸ªåç¨‹é˜»å¡å°±ä¼šé€ æˆçº¿ç¨‹é˜»å¡**ï¼Œæœ¬è¿›ç¨‹çš„å…¶ä»–åç¨‹éƒ½æ— æ³•æ‰§è¡Œäº†ï¼Œæ²¡æœ‰äº†å¹¶å‘èƒ½åŠ›



**åç¨‹ï¼šçº¿ç¨‹ = 1 : 1ï¼Œ1ä¸ªåç¨‹ç»‘å®š1ä¸ªçº¿ç¨‹**

![1-1æ¨¡å‹](picture/goè¯­è¨€è¦ç‚¹/1-1æ¨¡å‹.png)

- ä¼˜ç‚¹ï¼šæœ€å®¹æ˜“å®ç°ï¼Œåç¨‹çš„è°ƒåº¦éƒ½ç”±CPUå®Œæˆäº†ï¼Œä¸å­˜åœ¨N:1çš„ç¼ºç‚¹
- ç¼ºç‚¹ï¼šåç¨‹çš„åˆ›å»ºã€åˆ é™¤ã€åˆ‡æ¢çš„ä»£ä»·éƒ½ç”±CPUå®Œæˆï¼Œä»£ä»·ç•¥æ˜¾æ˜‚è´µ



**åç¨‹ï¼šçº¿ç¨‹ = M : Nï¼ŒMä¸ªåç¨‹ç»‘å®šNä¸ªçº¿ç¨‹**

![M-Næ¨¡å‹](picture/goè¯­è¨€è¦ç‚¹/M-Næ¨¡å‹.png)

è¿™ç§æ¨¡å‹å…‹æœäº†å‰é¢ä¸¤ç§æ¨¡å‹çš„ç¼ºç‚¹ï¼Œä½†æ˜¯å®ç°èµ·æ¥æœ€ä¸ºå¤æ‚



### 1.3 Goroutine

goroutineæ¥è‡ªåç¨‹çš„æ¦‚å¿µï¼Œä¸€ç»„åç¨‹è¿è¡Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¹‹ä¸Šï¼Œå³ä½¿æœ‰åç¨‹é˜»å¡ï¼Œè¯¥çº¿ç¨‹çš„å…¶ä»–åç¨‹ä¹Ÿå¯ä»¥è¢«`runtime`è°ƒåº¦ï¼Œè½¬ç§»åˆ°å…¶ä»–å¯è¿è¡Œçš„çº¿ç¨‹ä¸Šã€‚æœ€å…³é”®çš„æ˜¯ï¼Œç¨‹åºå‘˜çœ‹ä¸åˆ°è¿™äº›åº•å±‚çš„ç»†èŠ‚ï¼Œè¿™å°±é™ä½äº†ç¼–ç¨‹çš„éš¾åº¦ï¼Œæä¾›äº†æ›´å®¹æ˜“çš„å¹¶å‘ã€‚ 

goroutineéå¸¸è½»é‡ï¼Œä¸€ä¸ªgoroutineåªå å‡ KBï¼Œå¹¶ä¸”è¿™å‡ KBå°±è¶³å¤Ÿgoroutineè¿è¡Œå®Œï¼Œè¿™å°±èƒ½åœ¨æœ‰é™çš„å†…å­˜ç©ºé—´å†…æ”¯æŒå¤§é‡goroutineï¼Œæ”¯æŒäº†æ›´å¤šçš„å¹¶å‘ã€‚è™½ç„¶ä¸€ä¸ªgoroutineçš„æ ˆåªå å‡ KBï¼Œä½†å®é™…æ˜¯**å¯ä¼¸ç¼©çš„**ï¼Œå¦‚æœéœ€è¦æ›´å¤šå†…å®¹ï¼Œ`runtime`ä¼šè‡ªåŠ¨ä¸ºgoroutineåˆ†é…ã€‚

ç‰¹ç‚¹ï¼š

- å ç”¨å†…å­˜æ›´å°ï¼šå‡ KB
- è°ƒåº¦æ›´çµæ´»ï¼šruntimeè°ƒåº¦



### 1.4 GMPæ¦‚å¿µ

Gï¼šgoroutine

Mï¼šworker threadï¼Œ or machineï¼Œå³OSçº¿ç¨‹ï¼ˆå¯¹åº”äº†åˆ›å»ºçš„çº¿ç¨‹æ•°ï¼‰

Pï¼šprocessorï¼Œå¤„ç†å™¨ï¼ŒåŒ…å«äº†è¿è¡Œgoroutineçš„èµ„æºï¼ˆå¯¹åº”äº†å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ€»æ•°çš„æœ€å¤§å€¼ï¼‰

å¦‚æœçº¿ç¨‹Mæƒ³è¿è¡Œgoroutineï¼Œå¿…é¡»å…ˆè·å–Pï¼ŒPä¸­åŒ…å«äº†å¯è¿è¡Œçš„Gé˜Ÿåˆ—ï¼Œä»é˜Ÿåˆ—ä¸­è·å¾—G



## 2. æ—©æœŸçš„GMè°ƒåº¦å™¨

Go1.1ç‰ˆæœ¬ä¹‹å‰å°±æ˜¯ç”¨çš„GMæ¨¡å‹

é™¤äº†Gå’ŒMä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª**å…¨å±€åç¨‹é˜Ÿåˆ—**ï¼Œå­˜æ”¾çš„æ˜¯å¤šä¸ªå¤„äº**å¯è¿è¡ŒçŠ¶æ€çš„G**ï¼ŒMå¦‚æœæƒ³è¦è¿è¡ŒGï¼Œå°±å¿…é¡»è®¿é—®å…¨å±€é˜Ÿåˆ—

![æ—©æœŸçš„è°ƒåº¦å™¨](picture/goè¯­è¨€è¦ç‚¹/æ—©æœŸçš„è°ƒåº¦å™¨.png)

Mæƒ³è¦æ‰§è¡Œã€æ”¾å›Géƒ½å¿…é¡»è®¿é—®**å…¨å±€Gé˜Ÿåˆ—**ï¼Œå¹¶ä¸”Mæœ‰å¤šä¸ªï¼Œå³å¤šçº¿ç¨‹è®¿é—®åŒä¸€èµ„æºéœ€è¦åŠ é”è¿›è¡Œä¿è¯äº’æ–¥/åŒæ­¥ï¼Œæ‰€ä»¥**å…¨å±€Gé˜Ÿåˆ—æ˜¯æœ‰äº’æ–¥é”è¿›è¡Œä¿æŠ¤çš„**ã€‚å½“å¹¶å‘é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œè¿™æŠŠå¤§é”å°±æˆäº†æ€§èƒ½ç“¶é¢ˆ



ç¼ºç‚¹ï¼š

1. åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦Géƒ½éœ€è¦æ¯ä¸ªMè·å–é”ï¼Œè¿™å°±å½¢æˆäº†**æ¿€çƒˆçš„é”ç«äº‰**ã€‚

2. Mè½¬ç§»Gä¼šé€ æˆ**å»¶è¿Ÿå’Œé¢å¤–çš„ç³»ç»Ÿè´Ÿè½½**ã€‚æ¯”å¦‚å½“Gä¸­åŒ…å«åˆ›å»ºæ–°åç¨‹çš„æ—¶å€™ï¼ŒMåˆ›å»ºäº†Gâ€™ï¼Œä¸ºäº†ç»§ç»­æ‰§è¡ŒGï¼Œéœ€è¦æŠŠGâ€™äº¤ç»™Mâ€™æ‰§è¡Œï¼Œä¹Ÿé€ æˆäº†å¾ˆå·®çš„å±€éƒ¨æ€§ï¼Œå› ä¸ºGâ€™å’ŒGæ˜¯ç›¸å…³çš„ï¼Œæœ€å¥½æ”¾åœ¨Mä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯å…¶ä»–M'ã€‚

3. ç³»ç»Ÿè°ƒç”¨(CPUåœ¨Mä¹‹é—´çš„åˆ‡æ¢)å¯¼è‡´é¢‘ç¹çš„çº¿ç¨‹é˜»å¡å’Œå–æ¶ˆé˜»å¡æ“ä½œ**å¢åŠ äº†ç³»ç»Ÿå¼€é”€**ã€‚



## 3. GMPè°ƒåº¦å™¨

è€çš„è°ƒåº¦å™¨å­˜åœ¨è¯¸å¤šä¸è¶³ï¼Œäºæ˜¯å°±å¼ƒç”¨äº†ï¼ŒGolangé‡æ–°è®¾è®¡äº†è°ƒåº¦å™¨ï¼Œåœ¨GMä¹‹é—´å¼•è¿›äº†`P`

Pçš„åŠ å…¥ï¼Œè¿˜å¸¦æ¥äº†ä¸€ä¸ª**æœ¬åœ°åç¨‹é˜Ÿåˆ—**ï¼Œè·Ÿå‰é¢çš„**å…¨å±€é˜Ÿåˆ—**ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”¨äºå­˜æ”¾å¯è¿è¡Œçš„Gï¼ŒMæƒ³è¦è¿è¡ŒGçš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆä»æœ¬åœ°é˜Ÿåˆ—æ‹¿ï¼Œè®¿é—®æœ¬åœ°é˜Ÿåˆ—å½“ç„¶æ˜¯æ— éœ€åŠ é”äº†ã€‚å…¨å±€åç¨‹é˜Ÿåˆ—ä¾ç„¶æ˜¯å­˜åœ¨çš„ï¼Œä½†æ˜¯åŠŸèƒ½è¢«å¼±åŒ–äº†ï¼Œä¸åˆ°ä¸‡ä¸å¾—å·²çš„æ—¶å€™æ˜¯ä¸ä¼šå»å…¨å±€é˜Ÿåˆ—é‡Œæ‹¿Gçš„

> **Mæƒ³è¦è¿è¡ŒGï¼Œå°±å¾—å…ˆè·å–Pï¼Œç„¶åä»Pçš„æœ¬åœ°é˜Ÿåˆ—è·å–G**

æœ€ç»ˆå½¢æˆäº†GMPæ¨¡å‹ï¼š

![GMPæ¨¡å‹](picture/goè¯­è¨€è¦ç‚¹/GMPæ¨¡å‹.jpg)

1. **å…¨å±€é˜Ÿåˆ—**ï¼šå­˜æ”¾ç­‰å¾…è¿è¡Œçš„ Gã€‚
2. **P çš„æœ¬åœ°é˜Ÿåˆ—**ï¼šåŒå…¨å±€é˜Ÿåˆ—ç±»ä¼¼ï¼Œå­˜æ”¾çš„ä¹Ÿæ˜¯ç­‰å¾…è¿è¡Œçš„ Gï¼Œå­˜çš„æ•°é‡æœ‰é™ï¼Œ` ä¸è¶…è¿‡ 256 ä¸ª`ã€‚æ–°å»º Gâ€™æ—¶ï¼ŒGâ€™ä¼˜å…ˆåŠ å…¥åˆ° P çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼š`æŠŠG'åŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—(Go1.13)`ã€‚
3. **P åˆ—è¡¨**ï¼š**æ‰€æœ‰çš„ P éƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰ GOMAXPROCS(å¯é…ç½®) ä¸ª**ã€‚ `allp []*p`
4. **M**ï¼šçº¿ç¨‹æƒ³è¿è¡Œä»»åŠ¡å°±å¾—è·å– Pï¼Œä» P çš„æœ¬åœ°é˜Ÿåˆ—è·å– Gï¼ŒP é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒM ä¹Ÿä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—æ‹¿ä¸€æ‰¹ G æ”¾åˆ° P çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæˆ–ä»å…¶ä»– P çš„æœ¬åœ°é˜Ÿåˆ—å·ä¸€åŠæ”¾åˆ°è‡ªå·± P çš„æœ¬åœ°é˜Ÿåˆ—ã€‚M è¿è¡Œ Gï¼ŒG æ‰§è¡Œä¹‹åï¼ŒM ä¼šä» P è·å–ä¸‹ä¸€ä¸ª Gï¼Œä¸æ–­é‡å¤ä¸‹å»

![GMP](picture/goè¯­è¨€è¦ç‚¹/GMPçš„æœ¬åœ°é˜Ÿåˆ—.gif)



**æ–°å»ºGæ—¶**ï¼ŒGä¼šä¼˜å…ˆåŠ å…¥åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„Gç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ã€‚å½“Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œå°±ä»å…¨å±€é˜Ÿåˆ—å»æ‹¿Gï¼š

![GMPçš„å…¨å±€é˜Ÿåˆ—](picture/goè¯­è¨€è¦ç‚¹/GMPçš„å…¨å±€é˜Ÿåˆ—.gif)



å¦‚æœ**å…¨å±€é˜Ÿåˆ—ä¹Ÿä¸ºç©º**ï¼ŒMä¼šä»å…¶ä»–Pçš„æœ¬åœ°é˜Ÿåˆ—**å·(stealing)ä¸€åŠG**æ”¾åˆ°è‡ªå·±Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼š

![GMP-stealing](picture/goè¯­è¨€è¦ç‚¹/GMP-stealing.gif)



Mè¿è¡ŒGï¼Œå½“Gæ‰§è¡Œä¹‹åï¼ŒMä¼šä»Pè·å–ä¸‹ä¸€ä¸ªGï¼Œä¸æ–­é‡å¤ä¸‹å»



### 3.1 På’ŒMçš„ä¸ªæ•°

**Pçš„æ•°é‡ï¼š**

å¯åŠ¨æ—¶ï¼Œç”±ç¯å¢ƒå˜é‡`GOMAXPROCS`æˆ–è€…æ˜¯ç”± runtime çš„æ–¹æ³• `GOMAXPROCS()` å†³å®šã€‚

è¿™æ„å‘³ç€åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»æ„æ—¶åˆ»éƒ½åªæœ‰ `GOMAXPROCS` ä¸ª goroutine åœ¨åŒæ—¶è¿è¡Œ



**Mçš„æ•°é‡**

goè¯­è¨€çš„é™åˆ¶ï¼šgoç¨‹åºå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè®¾ç½®Mçš„æœ€å¤§å€¼ä¸º10000ï¼Œä½†æ˜¯å†…æ ¸å¾ˆéš¾æ”¯æŒè¿™ä¹ˆå¤šçº¿ç¨‹ï¼Œè¿™ä¸ªé™åˆ¶å¯å¿½ç•¥

runtime/debugä¸­çš„ `SetMaxThreads` å‡½æ•°ï¼Œè®¾ç½®Mçš„æœ€å¤§æ•°é‡

**ä¸€ä¸ªMé˜»å¡äº†ï¼Œå¯èƒ½ä¼šåˆ›å»ºæ–°çš„M**



**Mçš„æ•°é‡å’ŒPçš„æ•°é‡æ²¡æœ‰ç»å¯¹å…³ç³»**ï¼Œä¸€ä¸ªMé˜»å¡ï¼Œï¼°å°±ä¼šå–åˆ›å»ºæˆ–è€…åˆ‡æ¢åˆ°å¦ä¸€ä¸ªï¼­ï¼Œæ‰€ä»¥ï¼Œå³ä½¿ï¼°çš„æ•°é‡æ˜¯ï¼‘ï¼Œä¹Ÿæœ‰å¯èƒ½åˆ›å»ºå¾ˆå¤šä¸ªMå‡ºæ¥



### 3.2 På’ŒMçš„åˆ›å»ºæ—¶æœº

åœ¨ç¡®å®šäº†Pçš„æœ€å¤§æ•°é‡nåï¼Œruntimeä¼šæ ¹æ®è¿™ä¸ªå€¼ç›´æ¥åˆ›å»ºnä¸ªPå‡ºæ¥

å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„Mæ¥å…³è”Pä»¥è¿è¡ŒGã€‚**æ¯”å¦‚æ‰€æœ‰çš„Mé˜»å¡äº†ï¼ŒPè¿˜æœ‰å°±ç»ªä»»åŠ¡Gæˆ–è€…æœ‰GC workerç­‰ï¼Œå°±ä¼šä¸ºPå¯»æ‰¾ç©ºé—²çš„Mï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çš„ï¼Œå°±ä¼šåˆ›å»ºæ–°çš„M**



### 3.3 è°ƒåº¦å™¨çš„è®¾è®¡ç­–ç•¥

**å¤ç”¨çº¿ç¨‹**ï¼š é¿å…é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œè€Œæ˜¯ç›´æ¥å¯¹çº¿ç¨‹çš„å¤ç”¨

1. `work stealingæœºåˆ¶`ï¼šå½“M**æ²¡æœ‰Gå¯è¿è¡Œæ—¶**ï¼Œä¼šä¾æ¬¡æŒ‰ç…§ä»¥ä¸‹è§„åˆ™æ¥çªƒå–ï¼Œè€Œä¸æ˜¯é”€æ¯çº¿ç¨‹

   `runtime.schedule` å‡½æ•°ä¼šä»ä¸‹é¢å‡ ä¸ªåœ°æ–¹æŸ¥æ‰¾å¾…æ‰§è¡Œçš„ Goroutineï¼š

   1. ä¸ºäº†ä¿è¯å…¬å¹³ï¼Œå½“å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æœ‰å¾…æ‰§è¡Œçš„ Goroutine æ—¶ï¼Œé€šè¿‡ `schedtick` ä¿è¯æœ‰ä¸€å®šå‡ ç‡ä¼šä»å…¨å±€çš„è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾å¯¹åº”çš„ Goroutineï¼›
   2. ä»å¤„ç†å™¨æœ¬åœ°çš„è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾å¾…æ‰§è¡Œçš„ Goroutineï¼›
   3. å¦‚æœå‰ä¸¤ç§æ–¹æ³•éƒ½æ²¡æœ‰æ‰¾åˆ° Goroutineï¼Œä¼šé€šè¿‡ `runtime.findrunnable`è¿›è¡Œé˜»å¡åœ°æŸ¥æ‰¾ Goroutineï¼›

   `runtime.findrunnable`çš„å®ç°éå¸¸å¤æ‚ï¼Œè¿™ä¸ª 300 å¤šè¡Œçš„å‡½æ•°é€šè¿‡ä»¥ä¸‹çš„è¿‡ç¨‹è·å–å¯è¿è¡Œçš„ Goroutineï¼š

   1. ä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ã€å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾ï¼›
   2. ä»ç½‘ç»œè½®è¯¢å™¨ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰ Goroutine ç­‰å¾…è¿è¡Œï¼›
   3. é€šè¿‡ `runtime.runqsteal`å°è¯•ä»å…¶ä»–éšæœºçš„å¤„ç†å™¨ä¸­çªƒå–å¾…è¿è¡Œçš„ Goroutineï¼Œè¯¥å‡½æ•°è¿˜å¯èƒ½çªƒå–å¤„ç†å™¨çš„è®¡æ—¶å™¨ï¼›

2. `hand offæœºåˆ¶`ï¼šå½“æœ¬çº¿ç¨‹çš„**Gé˜»å¡æ—¶**ï¼Œä¼šé‡Šæ”¾ç»‘å®šçš„Pï¼Œå°†Pè½¬ç§»ä¸ºå…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œ

   ç³»ç»Ÿè°ƒç”¨å°è£…æˆ`entrysyscall->INVOKE_SYSCALL->exitsyscall`ï¼Œåœ¨è¿›å…¥çœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨ `INVOKE_SYSCALL` ä¹‹å‰ï¼Œä¼šåœ¨`entrysyscall` é‡Œé¢è¿›è¡Œä¸€äº›å‡†å¤‡å·¥ä½œï¼Œç„¶åè°ƒç”¨`handoffp`ï¼Œè¯¥å‡½æ•°ä¼šçœ‹Pæœ¬åœ°é˜Ÿåˆ—ä¸Šæˆ–å…¨å±€é˜Ÿåˆ—ä¸Šæ˜¯å¦æœ‰å¯è¿è¡Œçš„Gæˆ–è€…å¯è¿è¡Œçš„GC workerç­‰ï¼Œå¦‚æœæœ‰å°±è°ƒç”¨ `startm(p, false)`ï¼Œå°è¯•è·å–ç©ºé—²çš„Mæˆ–è€…åˆ›å»ºæ–°çš„Mï¼Œå¹¶ç»‘å®šè¯¥Pï¼Œè¿™æ ·å°±èƒ½å®ç°ä¸€ä¸ªMå› ä¸ºGé˜»å¡æ—¶ï¼Œä¸è‡³äºè¯¥Pä¸Šçš„æ‰€æœ‰Géƒ½é˜»å¡

   

ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­ï¼Œmainå‡½æ•°åœ¨P1ä¸Šè¿è¡Œå¹¶åˆ›å»ºgoroutineï¼Œå½“ç¬¬ä¸€æ‰¹goroutineè¿›å…¥P1çš„æœ¬åœ°é˜Ÿåˆ—çš„æ—¶å€™ï¼ŒP0æ­£åœ¨å¯»æ‰¾ä»»åŠ¡ã€‚ç„¶è€Œå®ƒçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œå…¨å±€é˜Ÿåˆ—å’Œç½‘ç»œè½®è¯¢å™¨éƒ½æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥æœ€åå°±ä»P1ä¸­çªƒå–ä»»åŠ¡ï¼Œä»è¿™7ä¸ªgoroutineä¸­å·èµ°äº†4ä¸ªï¼Œå…¶ä¸­ä¸€ä¸ªç«‹é©¬åœ¨P0æ‰§è¡Œäº†ï¼Œå‰©ä½™çš„3ä¸ªæ”¾åˆ°P0çš„æœ¬åœ°é˜Ÿåˆ—

![ä»»åŠ¡çªƒå–](picture/goè¯­è¨€è¦ç‚¹/9ca004b0ad5d83eccaed14ed671e20bd.png)

**åˆ©ç”¨å¹¶è¡Œ**ï¼š`GOMAXPROCS` è®¾ç½® P çš„æ•°é‡ï¼Œæœ€å¤šæœ‰ GOMAXPROCS ä¸ªçº¿ç¨‹åˆ†å¸ƒåœ¨å¤šä¸ª CPU ä¸ŠåŒæ—¶è¿è¡Œã€‚GOMAXPROCS ä¹Ÿé™åˆ¶äº†å¹¶å‘çš„ç¨‹åº¦ï¼Œæ¯”å¦‚ GOMAXPROCS = æ ¸æ•°/2ï¼Œåˆ™æœ€å¤šåˆ©ç”¨äº†ä¸€åŠçš„ CPU æ ¸è¿›è¡Œå¹¶è¡Œ



**æŠ¢å ï¼š** åœ¨coroutineä¸­è¦ç­‰å¾…ä¸€ä¸ªåç¨‹ä¸»åŠ¨è®©å‡ºcpuæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ã€‚åœ¨goä¸­ï¼Œ**ä¸€ä¸ªgoroutineæœ€å¤šå ç”¨CPU 10ms**ï¼Œé˜²æ­¢å…¶ä»–goroutineè¢«é¥¿æ­»ï¼Œè¿™å°±æ˜¯goroutineä¸åŒäºcoroutineçš„ä¸€ä¸ªåœ°æ–¹



**å…¨å±€Gé˜Ÿåˆ—**ï¼šåœ¨æ–°çš„è°ƒåº¦å™¨ä¸­ä¾ç„¶æœ‰å…¨å±€Gé˜Ÿåˆ—ï¼Œä½†æ˜¯åŠŸèƒ½è¢«å¼±åŒ–äº†ï¼Œå½“Mæ‰§è¡Œwork stealing ä»å…¶ä»–På·ä¸åˆ°Gæ—¶ï¼Œå®ƒå¯ä»¥ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–G



### 3.4 go func()è°ƒåº¦æµç¨‹

![GMP-gofuncè°ƒåº¦æµç¨‹](picture/goè¯­è¨€è¦ç‚¹/GMP-gofuncè°ƒåº¦æµç¨‹.png)

1. go func() åˆ›å»ºä¸€ä¸ª goroutine
2. æ–°åˆ›å»ºçš„Gä¼šä¼˜å…ˆä¿å­˜åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†åˆ™ä¼šä¿å­˜åˆ°å…¨å±€é˜Ÿåˆ—
3. Gåªèƒ½è¿è¡Œåœ¨Mä¸­ï¼Œä¸€ä¸ªMå¿…é¡»æŒæœ‰Pæ‰èƒ½è¿è¡ŒPä¸­çš„Gï¼ŒPçš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™å°±ä¼šè§¦å‘`work stealing`æœºåˆ¶
4. ä¸€ä¸ªMè°ƒåº¦Gæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯å¾ªç¯çš„ï¼Œä¸æ–­çš„ä»Pä¸­å–å‡ºGæ‰§è¡Œ
5. å¦‚æœMæ‰§è¡ŒæŸä¸€ä¸ªï¼§çš„æ—¶å€™å‘ç”Ÿäº†ç³»ç»Ÿè°ƒç”¨æˆ–å…¶ä»–é˜»å¡æ“ä½œï¼Œ**Mä¼šé˜»å¡ï¼Œruntimeä¼šæŠŠè¿™ä¸ªMä»Pä¸­æ‘˜é™¤ï¼Œç„¶åå»å–å‡ºä¸€ä¸ªç©ºé—²çš„ï¼­æ¥æœåŠ¡è¿™ä¸ªP (å¦‚æœæ²¡æœ‰ç©ºé—²Måˆ™åˆ›å»ºM)**
6. å½“Mçš„ç³»ç»Ÿè°ƒç”¨å®Œæˆåï¼Œä¼š**å°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„Pï¼ŒæŠŠGåŠ å…¥åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ã€‚å¦‚æœè·å–ä¸åˆ°Pï¼Œé‚£ä¹ˆè¿™ä¸ªMå°±ä¼šä¼‘çœ ï¼ŒåŠ å…¥åˆ°Mçš„ç©ºé—²é˜Ÿåˆ—ï¼Œç„¶åè¿™ä¸ªGä¼šè¢«æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­**

å½“ç³»ç»Ÿè°ƒç”¨ç»“æŸåï¼Œä¼šè°ƒç”¨é€€å‡ºç³»ç»Ÿè°ƒç”¨çš„å‡½æ•° `runtime.exitsyscall`ä¸ºå½“å‰ Goroutine é‡æ–°åˆ†é…èµ„æºï¼Œè¯¥å‡½æ•°æœ‰ä¸¤ä¸ªä¸åŒçš„æ‰§è¡Œè·¯å¾„ï¼š

1. è°ƒç”¨ `runtime.exitsyscallfast`ï¼›
2. åˆ‡æ¢è‡³è°ƒåº¦å™¨çš„ Goroutine å¹¶è°ƒç”¨ `runtime.exitsyscall0`ï¼›

è¿™ä¸¤ç§ä¸åŒçš„è·¯å¾„ä¼šåˆ†åˆ«é€šè¿‡ä¸åŒçš„æ–¹æ³•æŸ¥æ‰¾ä¸€ä¸ªç”¨äºæ‰§è¡Œå½“å‰ Goroutine å¤„ç†å™¨ Pï¼Œå¿«é€Ÿè·¯å¾„ `runtime.exitsyscallfast`ä¸­åŒ…å«ä¸¤ä¸ªä¸åŒçš„åˆ†æ”¯ï¼š

1. å¦‚æœ Goroutine çš„åŸå¤„ç†å™¨å¤„äº `_Psyscall` çŠ¶æ€ï¼Œä¼šç›´æ¥è°ƒç”¨ `wirep` å°† Goroutine ä¸å¤„ç†å™¨è¿›è¡Œå…³è”ï¼›
2. å¦‚æœè°ƒåº¦å™¨ä¸­å­˜åœ¨é—²ç½®çš„å¤„ç†å™¨ï¼Œä¼šè°ƒç”¨ `runtime.acquirep`ä½¿ç”¨é—²ç½®çš„å¤„ç†å™¨å¤„ç†å½“å‰ Goroutineï¼›

å¦ä¸€ä¸ªç›¸å¯¹è¾ƒæ…¢çš„è·¯å¾„ `runtime.exitsyscall0`ä¼šå°†å½“å‰ Goroutine åˆ‡æ¢è‡³ `_Grunnable` çŠ¶æ€ï¼Œå¹¶ç§»é™¤çº¿ç¨‹ M å’Œå½“å‰ Goroutine çš„å…³è”ï¼š

1. å½“æˆ‘ä»¬é€šè¿‡ `runtime.pidleget`è·å–åˆ°é—²ç½®çš„å¤„ç†å™¨æ—¶å°±ä¼šåœ¨è¯¥å¤„ç†å™¨ä¸Šæ‰§è¡Œ Goroutineï¼›
2. åœ¨å…¶å®ƒæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šå°†å½“å‰ Goroutine æ”¾åˆ°å…¨å±€çš„è¿è¡Œé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ï¼›

### 3.5 è°ƒåº¦çš„ç”Ÿå‘½å‘¨æœŸï¼ŒM0å’ŒG0

![GMP-è°ƒåº¦çš„ç”Ÿå‘½å‘¨æœŸ](picture/goè¯­è¨€è¦ç‚¹/GMP-è°ƒåº¦çš„ç”Ÿå‘½å‘¨æœŸ.png)

**M0**ï¼š`M0`æ˜¯goç¨‹åºå¯åŠ¨åçš„ç¼–å·ä¸º0çš„ä¸»çº¿ç¨‹ï¼Œè¿™ä¸ªMå¯¹åº”çš„å®ä¾‹åœ¨å…¨å±€å˜é‡ `runtime.m0` ä¸­ï¼Œä¸éœ€è¦åœ¨heapä¸Šåˆ†é…ï¼ŒM0è´Ÿè´£æ‰§è¡Œåˆå§‹åŒ–æ“ä½œå’Œå¯åŠ¨ç¬¬ä¸€ä¸ªGï¼Œå³`G0`ï¼Œä¹‹åM0å°±å’Œå…¶ä»–Mä¸€æ ·äº†

**G0**ï¼š`G0`æ˜¯æ¯æ¬¡å¯åŠ¨ä¸€ä¸ªMéƒ½ä¼šç¬¬ä¸€ä¸ªåˆ›å»ºçš„goroutineï¼Œ`G0ä»…ç”¨äºè´Ÿè´£è°ƒåº¦G`ï¼Œä¸æŒ‡å‘ä»»ä½•å¯æ‰§è¡Œçš„ å‡½æ•°ï¼Œ**æ¯ä¸ªMéƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„G0**ã€‚åœ¨è°ƒåº¦æˆ–è€…ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ä¼šä½¿ç”¨G0çš„æ ˆç©ºé—´ï¼Œå…¨å±€å˜é‡çš„G0æ˜¯å±äºM0çš„G0



### 3.6 è°ƒåº¦å¾ªç¯

- `schedule()`ï¼šæ‰¾åˆ°å¯ç”¨çš„gï¼Œç„¶åè°ƒç”¨ `execute()`

- `execute()`ï¼šè®¾ç½®è¯¥gçš„åˆå§‹çŠ¶æ€ï¼Œç„¶åè°ƒç”¨`gogo`
- `gogo`ï¼šç”¨æ±‡ç¼–å®ç°ï¼Œå…ˆæŠŠ `goexit` çš„PCå€¼å‹æ ˆï¼Œç„¶åæ‰§è¡Œå½“å‰gï¼Œç­‰gçš„å‡½æ•°è¿”å›æ—¶ï¼Œå°±è·å–åˆ° `goexit` çš„èµ·å§‹åœ°å€å¼¹å‡ºåˆ°PCä¸­ï¼Œå¼€å§‹æ‰§è¡Œ `goexit`
- `goexit()`ï¼šè¯¥å‡½æ•°ä¼šå°† Goroutine è½¬æ¢ä¼š `_Gdead` çŠ¶æ€ã€æ¸…ç†å…¶ä¸­çš„å­—æ®µã€ç§»é™¤ Goroutine å’Œçº¿ç¨‹çš„å…³è”å¹¶è°ƒç”¨ [runtime.gfput](https://draveness.me/golang/tree/runtime.gfput) é‡æ–°åŠ å…¥å¤„ç†å™¨çš„ Goroutine ç©ºé—²åˆ—è¡¨ `gFree`ã€‚æœ€åè°ƒç”¨ `schedule` è¿›è¡Œæ–°ä¸€è½®çš„è°ƒåº¦

## 4. Goè°ƒåº¦å™¨åœºæ™¯è§£æ

### 4.1 åˆ›å»ºG

P æ‹¥æœ‰ G1ï¼ŒM1 è·å– P åå¼€å§‹è¿è¡Œ G1ï¼ŒG1 ä½¿ç”¨ `go func()` åˆ›å»ºäº† G2ï¼Œä¸ºäº†å±€éƒ¨æ€§ G2 ä¼˜å…ˆåŠ å…¥åˆ° P1 çš„æœ¬åœ°é˜Ÿåˆ—ã€‚

![GMP-åœºæ™¯1](picture/goè¯­è¨€è¦ç‚¹/GMP-åœºæ™¯1.png)

### 4.2 æœ¬åœ°åˆ‡æ¢G

G1 è¿è¡Œå®Œæˆå (å‡½æ•°ï¼š`goexit`)ï¼ŒM ä¸Šè¿è¡Œçš„ goroutine åˆ‡æ¢ä¸º **G0**ï¼Œ**G0 è´Ÿè´£è°ƒåº¦æ—¶åç¨‹çš„åˆ‡æ¢**ï¼ˆå‡½æ•°ï¼š`schedule`ï¼‰ã€‚ä» P çš„æœ¬åœ°é˜Ÿåˆ—å– G2ï¼Œä» G0 åˆ‡æ¢åˆ° G2ï¼Œå¹¶å¼€å§‹è¿è¡Œ G2 (å‡½æ•°ï¼š`execute`)ã€‚å®ç°äº†çº¿ç¨‹ M1 çš„å¤ç”¨ã€‚

![GMP-åœºæ™¯2](picture/goè¯­è¨€è¦ç‚¹/GMP-åœºæ™¯2.png)



### 4.3 æœ¬åœ°é˜Ÿåˆ—æ»¡äº†

G2æƒ³è¦åˆ›å»º6ä¸ªGï¼Œå‡è®¾P1çš„æœ¬åœ°é˜Ÿåˆ—åªèƒ½å­˜æ”¾4ä¸ªGï¼Œè¿™æ—¶å€™ï¼ŒG3ï¼ŒG4ï¼ŒG5ï¼ŒG6éƒ½æˆåŠŸæ”¾ä¸‹äº†ï¼ŒG7åŠ å…¥çš„æ—¶å€™å‘ç°P1çš„æœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œäºæ˜¯æ‰§è¡Œ**è´Ÿè½½å‡è¡¡ï¼ŒæŠŠP1ä¸­æœ¬åœ°é˜Ÿåˆ—ä¸­çš„`å‰ä¸€åŠçš„Gæ‰“ä¹±é¡ºåº`ï¼Œè¿˜æœ‰æ–°åˆ›å»ºçš„`G7`ä¸€èµ·è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—**

![GMP-åœºæ™¯3](picture/goè¯­è¨€è¦ç‚¹/GMP-åœºæ™¯3.png)

è¿™æ—¶å€™ï¼ŒG2è¿˜è¦åˆ›å»ºG8ï¼Œ**G8è¿™æ—¶å€™P1çš„æœ¬åœ°é˜Ÿåˆ—å·²ç»ä¸æ»¡äº†**ï¼Œäºæ˜¯ç›´æ¥åŠ å…¥åˆ°äº†P1çš„æœ¬åœ°é˜Ÿåˆ—ï¼ï¼ï¼

![GMP-åœºæ™¯3-2](picture/goè¯­è¨€è¦ç‚¹/GMP-åœºæ™¯3-2.png)

### 4.4 åˆ›å»ºGä¼šå”¤é†’MP

è§„å®šï¼š**åœ¨åˆ›å»º G æ—¶ï¼Œè¿è¡Œçš„ G ä¼šå°è¯•å”¤é†’å…¶ä»–ç©ºé—²çš„ P å’Œ M ç»„åˆå»æ‰§è¡Œ**ã€‚

![GMP-åœºæ™¯4](picture/goè¯­è¨€è¦ç‚¹/GMP-åœºæ™¯4.png)

å‡è®¾G2å”¤é†’äº†M2ï¼ŒM2ç»‘å®šäº†P2ï¼Œå¼€å§‹è¿è¡ŒG0ï¼Œä½†æ˜¯P2æœ¬åœ°é˜Ÿåˆ—æ²¡æœ‰Gï¼ŒM2æ­¤æ—¶ä¸ºè‡ªæ—‹çº¿ç¨‹ï¼Œä¸æ–­çš„å¯»æ‰¾G



### 4.5 ä»å…¨å±€é˜Ÿåˆ—å–G

ç”±äº`work stealing`æœºåˆ¶ï¼ŒM2 å°è¯•ä»å…¨å±€é˜Ÿåˆ— (ç®€ç§° â€œGQâ€) å–ä¸€æ‰¹ G æ”¾åˆ° P2 çš„æœ¬åœ°é˜Ÿåˆ—ï¼ˆå‡½æ•°ï¼š`findrunnable()`ï¼‰ã€‚M2 ä»å…¨å±€é˜Ÿåˆ—å–çš„ G æ•°é‡ç¬¦åˆä¸‹é¢çš„å…¬å¼ï¼š

```go
n = min(len(GQ)/GOMAXPROCS + 1, len(GQ/2))
```

å³ï¼šè‡³å°‘è¦ä»å…¨å±€é˜Ÿåˆ—å–å‡º1ä¸ªGï¼Œä½†æ˜¯æ¯æ¬¡ä¸è¦ä»å…¨å±€é˜Ÿåˆ—ç§»åŠ¨å¤ªå¤šçš„Gåˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—(ä¸è¶…è¿‡ä¸€åŠ)ï¼Œè¦ç»™å…¶ä»–Pç•™ç‚¹ï¼Œè¿™æ—¶ä»å…¨å±€é˜Ÿåˆ—åˆ°Pæœ¬åœ°é˜Ÿåˆ—çš„è´Ÿè½½å‡è¡¡

å‡è®¾ä¸€å…±æœ‰4ä¸ªPï¼ˆ`GOMAXPROCS=4`ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…è®¸æœ€å¤šèƒ½æœ‰4ä¸ªPä¾›Mä½¿ç”¨ã€‚æ‰€ä»¥M2åªèƒ½ä»å…¨å±€é˜Ÿåˆ—å–å‡º1ä¸ªGç§»åŠ¨åˆ°P2ï¼Œç„¶åå®Œæˆä»G0åˆ°G3çš„åˆ‡æ¢ï¼Œè¿è¡ŒG3

![GMP-åœºæ™¯5](picture/goè¯­è¨€è¦ç‚¹/GMP-åœºæ™¯5.png)



### 4.6 ä»å…¶ä»–Pçªƒå–G

å‡è®¾ G2 ä¸€ç›´åœ¨ M1 ä¸Šè¿è¡Œï¼Œç»è¿‡ 2 è½®åï¼ŒM2 å·²ç»æŠŠ G7ã€G4 ä»å…¨å±€é˜Ÿåˆ—è·å–åˆ°äº† P2 çš„æœ¬åœ°é˜Ÿåˆ—å¹¶å®Œæˆè¿è¡Œï¼Œå…¨å±€é˜Ÿåˆ—å’Œ P2 çš„æœ¬åœ°é˜Ÿåˆ—éƒ½ç©ºäº†ï¼Œå¦‚ä¸‹å›¾çš„å·¦åŠéƒ¨åˆ†

![GMP-åœºæ™¯6](picture/goè¯­è¨€è¦ç‚¹/GMP-åœºæ™¯6.png)

å…¨å±€é˜Ÿåˆ—å·²ç»æ²¡æœ‰ Gï¼Œé‚£ m å°±è¦æ‰§è¡Œ work stealing (å·å–)ï¼šä»å…¶ä»–æœ‰ G çš„ P é‚£å·å–ä¸€åŠ G è¿‡æ¥ï¼Œæ”¾åˆ°è‡ªå·±çš„ P æœ¬åœ°é˜Ÿåˆ—ã€‚P2 ä» P1 çš„æœ¬åœ°é˜Ÿåˆ—**å°¾éƒ¨å–ä¸€åŠçš„ G**ï¼Œæœ¬ä¾‹ä¸­ä¸€åŠåˆ™åªæœ‰ 1 ä¸ª G8ï¼Œæ”¾åˆ° P2 çš„æœ¬åœ°é˜Ÿåˆ—å¹¶æ‰§è¡Œ



### 4.7 è‡ªæ—‹çº¿ç¨‹æ•°é‡çš„é™åˆ¶

G1 æœ¬åœ°é˜Ÿåˆ— G5ã€G6 å·²ç»è¢«å…¶ä»– M å·èµ°å¹¶è¿è¡Œå®Œæˆï¼Œå½“å‰ M1 å’Œ M2 åˆ†åˆ«åœ¨è¿è¡Œ G2 å’Œ G8ï¼ŒM3 å’Œ M4 æ²¡æœ‰ goroutine å¯ä»¥è¿è¡Œï¼ŒM3 å’Œ M4 å¤„äºè‡ªæ—‹çŠ¶æ€ï¼Œå®ƒä»¬ä¸æ–­å¯»æ‰¾ goroutine

ä¸ºä»€ä¹ˆè¦è®© m3 å’Œ m4 è‡ªæ—‹ï¼Œè‡ªæ—‹æœ¬è´¨æ˜¯åœ¨è¿è¡Œï¼Œçº¿ç¨‹åœ¨è¿è¡Œå´æ²¡æœ‰æ‰§è¡Œ Gï¼Œå°±å˜æˆäº†æµªè´¹ CPU. ä¸ºä»€ä¹ˆä¸é”€æ¯ç°åœºï¼Œæ¥èŠ‚çº¦ CPU èµ„æºã€‚å› ä¸ºåˆ›å»ºå’Œé”€æ¯ CPU ä¹Ÿä¼šæµªè´¹æ—¶é—´ï¼Œæˆ‘ä»¬å¸Œæœ›å½“æœ‰æ–° goroutine åˆ›å»ºæ—¶ï¼Œç«‹åˆ»èƒ½æœ‰ M è¿è¡Œå®ƒï¼Œå¦‚æœé”€æ¯å†æ–°å»ºå°±å¢åŠ äº†æ—¶å»¶ï¼Œé™ä½äº†æ•ˆç‡ã€‚å½“ç„¶ä¹Ÿè€ƒè™‘äº†è¿‡å¤šçš„è‡ªæ—‹çº¿ç¨‹æ˜¯æµªè´¹ CPUï¼Œæ‰€ä»¥ç³»ç»Ÿä¸­**æœ€å¤šæœ‰ GOMAXPROCS ä¸ªè‡ªæ—‹çš„çº¿ç¨‹** (å½“å‰ä¾‹å­ä¸­çš„ GOMAXPROCS=4ï¼Œæ‰€ä»¥ä¸€å…± 4 ä¸ª P)ï¼Œå¤šä½™çš„æ²¡äº‹åšçº¿ç¨‹ä¼šè®©ä»–ä»¬ä¼‘çœ ï¼ˆ`notesleep()`ï¼‰

![GMP-åœºæ™¯7](picture/goè¯­è¨€è¦ç‚¹/GMP-åœºæ™¯7.png)



### 4.8 Gé˜»å¡çš„æƒ…å†µ

å‡å®šå½“å‰é™¤äº† M3 å’Œ M4 ä¸ºè‡ªæ—‹çº¿ç¨‹ï¼Œè¿˜æœ‰ M5 å’Œ M6 ä¸ºç©ºé—²çš„çº¿ç¨‹ (æ²¡æœ‰å¾—åˆ° P çš„ç»‘å®šï¼Œæ³¨æ„æˆ‘ä»¬è¿™é‡Œ**æœ€å¤šå°±åªèƒ½å¤Ÿå­˜åœ¨ 4 ä¸ª Pï¼Œæ‰€ä»¥ P çš„æ•°é‡åº”è¯¥æ°¸è¿œæ˜¯ P<=M**, å¤§éƒ¨åˆ†éƒ½æ˜¯ **M åœ¨æŠ¢å éœ€è¦è¿è¡Œçš„ P**)

G8 åˆ›å»ºäº† G9ï¼ŒG8 è¿›è¡Œäº†é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œ**M2 å’Œ P2 ç«‹å³è§£ç»‘**ï¼ŒP2 ä¼šæ‰§è¡Œä»¥ä¸‹åˆ¤æ–­ï¼šå¦‚æœ P2 æœ¬åœ°é˜Ÿåˆ—æœ‰ G æˆ–å…¨å±€é˜Ÿåˆ—æœ‰ G æˆ–æœ‰ç©ºé—²çš„ Mï¼ŒP2 éƒ½ä¼šç«‹é©¬å”¤é†’ 1 ä¸ª M å’Œå®ƒç»‘å®šï¼Œå¦åˆ™ P2 åˆ™ä¼šåŠ å…¥åˆ°ç©ºé—² P åˆ—è¡¨ï¼Œç­‰å¾… M æ¥è·å–å¯ç”¨çš„ Pã€‚

æœ¬åœºæ™¯ä¸­ï¼ŒP2 æœ¬åœ°é˜Ÿåˆ—æœ‰ G9ï¼Œå¯ä»¥å’Œå…¶ä»–ç©ºé—²çš„çº¿ç¨‹ M5 ç»‘å®š

![GMP-åœºæ™¯8](picture/goè¯­è¨€è¦ç‚¹/GMP-åœºæ™¯8.png)





### 4.9 éé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨

G8 åˆ›å»ºäº† G9ï¼Œå‡å¦‚ G8 è¿›è¡Œäº†**éé˜»å¡ç³»ç»Ÿè°ƒç”¨**ã€‚(CGoä¼šæ˜¯è¿™ç§æ–¹å¼ï¼Œè§`cgocall()`)

![GMP-åœºæ™¯9](picture/goè¯­è¨€è¦ç‚¹/GMP-åœºæ™¯9.png)

 M2 å’Œ P2 ä¼šè§£ç»‘ï¼Œä½† M2 ä¼šè®°ä½ P2ï¼Œç„¶å G8 å’Œ M2 è¿›å…¥ç³»ç»Ÿè°ƒç”¨çŠ¶æ€ã€‚å½“ G8 å’Œ M2 é€€å‡ºç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¼šå°è¯•è·å– P2ï¼Œå¦‚æœæ— æ³•è·å–ï¼Œåˆ™è·å–ç©ºé—²çš„ Pï¼Œå¦‚æœä¾ç„¶æ²¡æœ‰ï¼ŒG8 ä¼šè¢«è®°ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—ï¼ŒM2 å› ä¸ºæ²¡æœ‰ P çš„ç»‘å®šè€Œå˜æˆä¼‘çœ çŠ¶æ€ (é•¿æ—¶é—´ä¼‘çœ ç­‰å¾… GC å›æ”¶é”€æ¯)ã€‚

### 4.10 æŸ”å’ŒæŠ¢å 

å‡è®¾æœ‰ä¸‹é¢çš„Goä»£ç ï¼Œç¨‹åºæ‰§è¡Œä¹‹åˆå°†Pè®¾ç½®ä¸º1ï¼Œå¼€ä¸¤ä¸ªgoroutineï¼Œä¸€ä¸ªæ˜¯mainï¼Œä¸€ä¸ªæ˜¯æ‰§è¡Œæ­»å¾ªç¯çš„åŒ¿åå‡½æ•°

```go
package main

import (
    "fmt"
    "runtime"
    "time"
)

func main() {
    runtime.GOMAXPROCS(1)

    fmt.Println("The program starts ...")

    go func() {
        for {
        }
    }()

    time.Sleep(time.Second)
    fmt.Println("I got scheduled!")
}
```

åœ¨go1.12å‰ï¼Œgoroutineæ˜¯åä½œå¼è°ƒåº¦ï¼Œæ‰€ä»¥mainåœ¨sleepçš„æ—¶å€™è®©å‡ºæ‰§è¡Œæƒç»™åŒ¿ågoroutineæ‰§è¡Œï¼ŒåŒ¿ågoroutineæ­»å¾ªç¯å‡ºä¸å»ï¼Œåˆæ— æ³•è¢«æŠ¢å ï¼Œå°±ä¼šä½¿å¾—ç¨‹åºé™·å…¥æ— é™å¾ªç¯ï¼Œä¸ä¼šç»“æŸ



Goè°ƒåº¦åœ¨go1.14å®ç°äº†æŠ¢å ï¼Œåº”è¯¥æ›´ç²¾ç¡®çš„ç§°ä¸º**åŸºäºç³»ç»Ÿä¿¡å·çš„å¼‚æ­¥æŠ¢å è°ƒåº¦**ï¼Œå› ä¸ºgoè°ƒåº¦å™¨çš„æŠ¢å å¾ˆæŸ”å’Œï¼Œä¸ä¼šè¯´æ—¶é—´ç‰‡åˆ°äº†æˆ–è€…æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡åˆ°äº†å°±ç›´æ¥æ‰§è¡ŒæŠ¢å è°ƒåº¦ï¼Œ**goçš„æŠ¢å æŸ”å’Œåˆ°åªç»™goroutineå‘é€1ä¸ªæŠ¢å è¯·æ±‚ï¼Œè‡³äºgoroutineä½•æ—¶åœä¸‹æ¥ï¼Œé‚£å°±ä¸ç®¡äº†**

å‘å‡ºæŠ¢å è¯·æ±‚éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€ï¼š

1. å½“å‰Gè¿›è¡Œç³»ç»Ÿè°ƒç”¨è¶…è¿‡20us
2. Gè¿è¡Œæ—¶é—´è¶…è¿‡10ms

è°ƒåº¦å™¨åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šå¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹`sysmon`ï¼Œå®ƒè´Ÿè´£æ‰€æœ‰çš„ç›‘æ§å·¥ä½œï¼Œå…¶ä¸­ä¸€é¡¹å°±æ˜¯ `æŠ¢å `ï¼Œå‘ç°æ»¡è¶³æŠ¢å æ¡ä»¶çš„Gæ—¶ï¼Œå°±ä¼šå‘å½“å‰çº¿ç¨‹å‘å‡ºæŠ¢å ä¿¡å·







## 5. goroutineæ ˆåˆ‡æ¢

![img](picture/goè¯­è¨€è¦ç‚¹/58b2f4d73241425cf979ab0db3a4f838.png)



`g0` æ ˆç”¨äºæ‰§è¡Œè°ƒåº¦å™¨çš„ä»£ç ï¼Œæ‰§è¡Œå®Œä¹‹åï¼Œè¦è·³è½¬åˆ°æ‰§è¡Œç”¨æˆ·ä»£ç çš„åœ°æ–¹ï¼Œå¦‚ä½•è·³è½¬ï¼Ÿè¿™ä¸­é—´æ¶‰åŠåˆ°æ ˆå’Œå¯„å­˜å™¨çš„åˆ‡æ¢ã€‚è¦çŸ¥é“ï¼Œå‡½æ•°è°ƒç”¨å’Œè¿”å›ä¸»è¦é çš„ä¹Ÿæ˜¯ CPU å¯„å­˜å™¨çš„åˆ‡æ¢ã€‚`goroutine` çš„åˆ‡æ¢å’Œæ­¤ç±»ä¼¼ã€‚




# é¢è¯•é¢˜



## 1. slice, map, array å’Œ string





## 2. select å’Œ chan







## 3. defer, panic å’Œ recover





## 4. æ¥å£å’Œåå°„







## 5. make å’Œ new





## 6. context å’Œ unsafe

[æ ‡å‡†åº“ - ã€ŠGo è¯­è¨€é—®é¢˜é›†(Go Questions)ã€‹ - ä¹¦æ ˆç½‘ Â· BookStack](https://www.bookstack.cn/read/qcrao-Go-Questions/stdlib.md)

## 7. å†…å­˜åˆ†é…å’ŒGC





## 8. GMP



## 9. syncåŒ…

##



